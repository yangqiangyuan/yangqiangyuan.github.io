{"meta":{"version":1,"warehouse":"4.0.2"},"models":{"Asset":[{"_id":"source/images/dm.png","path":"images/dm.png","modified":1,"renderable":0}],"Cache":[{"_id":"source/._.DS_Store","hash":"0bed7e90c2bade9763fa18f1fb4441d31f91c87c","modified":1672726671242},{"_id":"source/_posts/._Kubesphere证书过期.md","hash":"47597410ab6b9bc7ec36658d05615bbd809291fa","modified":1672726671242},{"_id":"source/_posts/._.DS_Store","hash":"0bed7e90c2bade9763fa18f1fb4441d31f91c87c","modified":1672726671242},{"_id":"source/_posts/._harbor部署.md","hash":"3414961fb5f7163be0d3eee98d34525e14e3a521","modified":1672726671242},{"_id":"source/_posts/._ingress-nginx部署.md","hash":"24e7d84df6442ead14ac9bac0a0a732f0120054c","modified":1672726671242},{"_id":"source/_posts/._postgresql常用命令.md","hash":"dd0459174a865cc02cc66dec0872aa648c7a862d","modified":1672726671243},{"_id":"source/_posts/._registry部署.md","hash":"8d57e43efa696c5359ab5a1866e5d9dc83938ddd","modified":1672726671243},{"_id":"source/_posts/._kubesphere部署.md","hash":"e834367fef33d0262011c20d4022f420d36b0615","modified":1672726671242},{"_id":"source/_posts/._达梦数据库一主两备安装步骤.md","hash":"0eaa0a6596861698dbe1a3d31c90b4b67d3bf395","modified":1672726671243},{"_id":"source/_posts/._达梦数据库单机安装.md","hash":"a5e4f3941104be6983ffda8e6a5ecfe133455518","modified":1672726671243},{"_id":"source/_posts/Zookeeper单机部署.md","hash":"88ad25a22d5218e771ce5d1829deab7773375810","modified":1672726671244},{"_id":"source/_posts/._达梦数据库常用操作.md","hash":"acc8dc4f80ff42d1b25dfe041d56379caf2e5bba","modified":1672726671243},{"_id":"source/_posts/Zookeeper集群部署.md","hash":"26746ba2808e808793b793fafd82f95a6022fa8e","modified":1672726671244},{"_id":"source/_posts/Kubesphere证书过期.md","hash":"c0d40dfc715a8cce9167198ee8ab0ac12d88cf86","modified":1672726671244},{"_id":"source/_posts/harbor部署.md","hash":"1683c24a53cae46af8bbbbcb781cc16c84b565b3","modified":1672726671244},{"_id":"source/_posts/ingress-nginx部署.md","hash":"c432d276783c164539efff2eea0477bf2672310e","modified":1672726671245},{"_id":"source/_posts/registry部署.md","hash":"137807205899ac0282c5581ff32c334f2d49b093","modified":1672726671245},{"_id":"source/_posts/kubesphere部署.md","hash":"2971e7470bb7d5a93092b946fb138d5727c957a4","modified":1672726671245},{"_id":"source/_posts/lvm磁盘扩容.md","hash":"91e1151ef82f6f184eba8abb527169c5aeafea3c","modified":1672726671245},{"_id":"source/_posts/mysql导出select语句结果.md","hash":"8e020dabfed1baa48e525760c7f4af79989e6ca9","modified":1672726671245},{"_id":"source/_posts/postgresql常用命令.md","hash":"7d64a0d20a171f719850f4ddac71f498ada981a6","modified":1672726671245},{"_id":"source/_posts/达梦数据库一主两备安装步骤.md","hash":"4111d6029d2cc68aa7af73e4f8b2178f4ec90bcb","modified":1672726671246},{"_id":"source/_posts/达梦数据库单机安装.md","hash":"b9061ff0b2d03b46c08c3e18eb717a2391bc6506","modified":1672726671246},{"_id":"source/_posts/达梦数据库常用操作.md","hash":"0ab971ff993f2ce21f3dcd432049832530a4fc9a","modified":1672726671246},{"_id":"source/images/._dm.png","hash":"552b393817b54eb752d3901a971f7ddabdea111a","modified":1672726671246},{"_id":"source/images/dm.png","hash":"607a87cb8d091ec1c99db1d7cbd873c531e2bfee","modified":1672726671248},{"_id":"public/content.json","hash":"1edd2fb4457223d71ec2d8d289072cfbd9cea46a","modified":1672727828435},{"_id":"public/2022/12/29/Zookeeper单机部署/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1672727828435},{"_id":"public/2022/12/29/Zookeeper集群部署/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1672727828435},{"_id":"public/2022/12/29/lvm磁盘扩容/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1672727828435},{"_id":"public/2022/12/16/mysql导出select语句结果/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1672727828435},{"_id":"public/2022/11/25/ingress-nginx部署/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1672727828435},{"_id":"public/2022/11/25/kubesphere部署/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1672727828435},{"_id":"public/2022/11/25/harbor部署/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1672727828435},{"_id":"public/2022/11/25/registry部署/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1672727828435},{"_id":"public/2022/11/24/达梦数据库常用操作/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1672727828435},{"_id":"public/2022/10/20/达梦数据库一主两备安装步骤/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1672727828435},{"_id":"public/2022/10/20/达梦数据库单机安装/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1672727828435},{"_id":"public/2022/10/08/postgresql常用命令/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1672727828435},{"_id":"public/2022/08/22/Kubesphere证书过期/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1672727828435},{"_id":"public/archives/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1672727828435},{"_id":"public/archives/page/2/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1672727828435},{"_id":"public/archives/2022/page/2/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1672727828435},{"_id":"public/archives/2022/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1672727828435},{"_id":"public/archives/2022/08/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1672727828435},{"_id":"public/archives/2022/10/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1672727828435},{"_id":"public/archives/2022/11/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1672727828435},{"_id":"public/archives/2022/12/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1672727828435},{"_id":"public/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1672727828435},{"_id":"public/page/2/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1672727828435},{"_id":"public/tags/Zookeeper/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1672727828435},{"_id":"public/tags/Kubesphere/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1672727828435},{"_id":"public/tags/harbor部署/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1672727828435},{"_id":"public/tags/ingress-nginx/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1672727828435},{"_id":"public/tags/kubesphere/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1672727828435},{"_id":"public/tags/lvm扩容/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1672727828435},{"_id":"public/tags/registry部署/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1672727828435},{"_id":"public/tags/达梦/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1672727828435},{"_id":"public/tags/mysql/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1672727828435},{"_id":"public/tags/postgres/index.html","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1672727828435},{"_id":"public/images/dm.png","hash":"607a87cb8d091ec1c99db1d7cbd873c531e2bfee","modified":1672727828435}],"Category":[],"Data":[],"Page":[],"Post":[{"title":"Zookeeper单机部署","date":"2022-12-29T02:25:44.000Z","_content":"\n# Zookeeper单机部署\n\n## 1 云硬盘挂载\n\n<!--more-->\n\n```\n# 查看挂盘名称\nfdisk -l\n\n# 创建物理卷\npvcreate /dev/vdb\n\n# 创建卷组\nvgcreate data_vg /dev/vdb\n\n# 创建逻辑卷\nlvcreate -l +100%free -n data data_vg\n\n# 格式化磁盘\nmkfs.xfs /dev/data_vg/data\n\n# 创建挂载目录\nmkdir -p /data1\n\n# 挂载\nmount /dev/data_vg/data /data1\n\n# 添加挂载信息\necho \"/dev/mapper/data_vg-data /data1 xfs     defaults        0 0\" >> /etc/fstab\n\n```\n\n\n\n## 2 安装Java\n\n### 2.1 检查系统是否安装了JAVA\n\n如果有以下输出，则表示已安装\n\n```\nrpm -qa | grep java\n\njava-1.8.0-openjdk-headless-1.8.0.272.b10-1.el7_9.x86_64\ntzdata-java-2020d-2.el7.noarch\npython-javapackages-3.4.1-11.el7.noarch\njava-1.8.0-openjdk-1.8.0.272.b10-1.el7_9.x86_64\njavapackages-tools-3.4.1-11.el7.noarch\n```\n\n需要进行卸载操作\n\n```\nrpm -e java-1.8.0-openjdk-1.8.0.272.b10-1.el7_9.x86_64\nrpm -e java-1.8.0-openjdk-headless-1.8.0.272.b10-1.el7_9.x86_64\nrpm -e javapackages-tools-3.4.1-11.el7.noarch\n```\n\n### 2.2 解压JAVA安装包\n\n```\ntar -zxf /usr/local/java-1.8.0.tar.gz -C /usr/local\n```\n\n### 2.3 配置JAVA环境变量\n\n```\n# 在/etc/profile，追加JAVA_HOME和PATH两个变量。\n\nvi /etc/profile\nexport JAVA_HOME=/usr/local/java-1.8.0\nexport PATH=$JAVA_HOME/bin:$PATH\n```\n\n### 2.4 检查JAVA安装\n\n```\n# 使环境变量生效，然后检查Java版本\n\nsource /etc/profile\njava -version\n```\n\n## 3 安装zookeeper\n\n```\n# 解压安装好的包\ntar -zxf /usr/local/apache-zookeeper-3.5.8-bin.tar.gz -C /usr/local/\nmv /usr/local/apache-zookeeper-3.5.8-bin /usr/local/apache-zookeeper-3.5.8\n\n# 新建数据目录\nmkdir -p /data1/zookeeper/{data,logs}\n\n# 修改配置文件\necho \"1\">/data1/zookeeper/data/myid\n\nvi /usr/local/apache-zookeeper-3.5.8/conf/zoo.cfg\n\n# The number of milliseconds of each tick\ntickTime=2000\n# The number of ticks that the initial \n# synchronization phase can take\ninitLimit=10\n# The number of ticks that can pass between \n# sending a request and getting an acknowledgement\nsyncLimit=5\n# the directory where the snapshot is stored.\n# do not use /tmp for storage, /tmp here is just \n# example sakes.\ndataDir=/data1/zookeeper/data\ndataLogDir=/data1/zookeeper/logs\n# the port at which the clients will connect\nclientPort=2181\n# the maximum number of client connections.\n# increase this if you need to handle more clients\nmaxClientCnxns=10000\n#\n# Be sure to read the maintenance section of the \n# administrator guide before turning on autopurge.\n#\n# http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance\n#\n# The number of snapshots to retain in dataDir\n#autopurge.snapRetainCount=3\n# Purge task interval in hours\n# Set to \"0\" to disable auto purge feature\n#autopurge.purgeInterval=1\nserver.1=10.8.41.21:2888:3888\n\n# 编辑启动脚本\nvi /usr/local/apache-zookeeper-3.5.8/monitor.sh\n\n#!/bin/bash\ncur_path=$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\n\nfunction log_info(){\n\techo \"[INFO] [$(date \"+%Y-%m-%d %T\")] $1\"\n}\n\nfunction log_error(){\n\techo \"[ERROR] [$(date \"+%Y-%m-%d %T\")] $1\"\n\texit 1\n}\n\nfunction check_status(){\n\tpids=$(ps -ef|grep java|grep apache-zookeeper-3.5.8|awk '{print $2}')\n\n\tif [[ -n ${pids} ]];then\n\t\techo \"True\"\n\telse \n\t\techo \"False\"\n\tfi\n}\n\nfunction stop(){\n\tlog_info \"${FUNCNAME[0]} begin.\"\n\n\tpids=$(ps -ef|grep java|grep apache-zookeeper-3.5.8|awk '{print $2}')\n\t\n\tlog_info \"kill pid ${pids} begin.\"\n\tif [[ -n ${pids} ]];then\n\t\tlog_info \"process exist,kill it ${pids}!\"\n\t\tfor i in ${pids}\n\t\tdo\n\t\t\tlog_info \"kill process $i!\"\n\t\t\tkill -9 $i\n\t\tdone\n\telse\n\t\tlog_info \"process not exist!\"\n\n\tfi\n\tlog_info \"kill pid ${pids} end.\"\n\n\tlog_info \"${FUNCNAME[0]} end.\"\n}\n\nfunction start(){\n\tlog_info \"${FUNCTION[0]} begin.\"\n\n\tif [[ $(check_status $node) == \"True\" ]];then\n\t\tlog_info \"process is exist, not need to start!\"\n\telse\n\t\tlog_info \"start zookeeper begin.\"\n\n\t\t/usr/local/apache-zookeeper-3.5.8/bin/zkServer.sh start\n\n\t\tlog_info \"start zookeeper success.\"\n\tfi\n\n\tlog_info \"${FUNCTION[0]} complete.\"\n}\n\nfunction restart(){\n\tlog_info \"${FUNCTION[0]} begin.\"\n\n\tstop\n\n\tsleep 5\n\n\tstart\n\n\tlog_info \"${FUNCTION[0]} end.\"\n}\n\nfunction main(){\n\tlog_info \"${FUNCTION[0]} begin.\"\n\n\tACTION=\"$1\"\n\n\tcase \"${ACTION}\" in\n\t    start)\n            start\n\t    ;;\n            stop)\n            stop\n            ;;\n\t    restart)\n            restart\n            ;;\n\t    *)\n            usage\n            ;;\n            esac\n\n\tlog_info \"${FUNCTION[0]} complete.\"\n}\n\nmain \"$@\"\n\n# 修改权限\nchmod a+x /usr/local/apache-zookeeper-3.5.8/monitor.sh\n\n# 启动\nsh /usr/local/apache-zookeeper-3.5.8/monitor.sh start\n\n# 查看进程\njps\n\n# 将健康检查加入crontab\nvi /etc/crontab \n*/1 * * * * root /usr/local/apache-zookeeper-3.5.8/monitor.sh start >/dev/null 2>&1\n\n# 重启crontab\nsystemctl restart crond\n\n```\n\n","source":"_posts/Zookeeper单机部署.md","raw":"---\ntitle: Zookeeper单机部署\ndate: 2022-12-29 10:25:44\ntags: Zookeeper\n---\n\n# Zookeeper单机部署\n\n## 1 云硬盘挂载\n\n<!--more-->\n\n```\n# 查看挂盘名称\nfdisk -l\n\n# 创建物理卷\npvcreate /dev/vdb\n\n# 创建卷组\nvgcreate data_vg /dev/vdb\n\n# 创建逻辑卷\nlvcreate -l +100%free -n data data_vg\n\n# 格式化磁盘\nmkfs.xfs /dev/data_vg/data\n\n# 创建挂载目录\nmkdir -p /data1\n\n# 挂载\nmount /dev/data_vg/data /data1\n\n# 添加挂载信息\necho \"/dev/mapper/data_vg-data /data1 xfs     defaults        0 0\" >> /etc/fstab\n\n```\n\n\n\n## 2 安装Java\n\n### 2.1 检查系统是否安装了JAVA\n\n如果有以下输出，则表示已安装\n\n```\nrpm -qa | grep java\n\njava-1.8.0-openjdk-headless-1.8.0.272.b10-1.el7_9.x86_64\ntzdata-java-2020d-2.el7.noarch\npython-javapackages-3.4.1-11.el7.noarch\njava-1.8.0-openjdk-1.8.0.272.b10-1.el7_9.x86_64\njavapackages-tools-3.4.1-11.el7.noarch\n```\n\n需要进行卸载操作\n\n```\nrpm -e java-1.8.0-openjdk-1.8.0.272.b10-1.el7_9.x86_64\nrpm -e java-1.8.0-openjdk-headless-1.8.0.272.b10-1.el7_9.x86_64\nrpm -e javapackages-tools-3.4.1-11.el7.noarch\n```\n\n### 2.2 解压JAVA安装包\n\n```\ntar -zxf /usr/local/java-1.8.0.tar.gz -C /usr/local\n```\n\n### 2.3 配置JAVA环境变量\n\n```\n# 在/etc/profile，追加JAVA_HOME和PATH两个变量。\n\nvi /etc/profile\nexport JAVA_HOME=/usr/local/java-1.8.0\nexport PATH=$JAVA_HOME/bin:$PATH\n```\n\n### 2.4 检查JAVA安装\n\n```\n# 使环境变量生效，然后检查Java版本\n\nsource /etc/profile\njava -version\n```\n\n## 3 安装zookeeper\n\n```\n# 解压安装好的包\ntar -zxf /usr/local/apache-zookeeper-3.5.8-bin.tar.gz -C /usr/local/\nmv /usr/local/apache-zookeeper-3.5.8-bin /usr/local/apache-zookeeper-3.5.8\n\n# 新建数据目录\nmkdir -p /data1/zookeeper/{data,logs}\n\n# 修改配置文件\necho \"1\">/data1/zookeeper/data/myid\n\nvi /usr/local/apache-zookeeper-3.5.8/conf/zoo.cfg\n\n# The number of milliseconds of each tick\ntickTime=2000\n# The number of ticks that the initial \n# synchronization phase can take\ninitLimit=10\n# The number of ticks that can pass between \n# sending a request and getting an acknowledgement\nsyncLimit=5\n# the directory where the snapshot is stored.\n# do not use /tmp for storage, /tmp here is just \n# example sakes.\ndataDir=/data1/zookeeper/data\ndataLogDir=/data1/zookeeper/logs\n# the port at which the clients will connect\nclientPort=2181\n# the maximum number of client connections.\n# increase this if you need to handle more clients\nmaxClientCnxns=10000\n#\n# Be sure to read the maintenance section of the \n# administrator guide before turning on autopurge.\n#\n# http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance\n#\n# The number of snapshots to retain in dataDir\n#autopurge.snapRetainCount=3\n# Purge task interval in hours\n# Set to \"0\" to disable auto purge feature\n#autopurge.purgeInterval=1\nserver.1=10.8.41.21:2888:3888\n\n# 编辑启动脚本\nvi /usr/local/apache-zookeeper-3.5.8/monitor.sh\n\n#!/bin/bash\ncur_path=$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\n\nfunction log_info(){\n\techo \"[INFO] [$(date \"+%Y-%m-%d %T\")] $1\"\n}\n\nfunction log_error(){\n\techo \"[ERROR] [$(date \"+%Y-%m-%d %T\")] $1\"\n\texit 1\n}\n\nfunction check_status(){\n\tpids=$(ps -ef|grep java|grep apache-zookeeper-3.5.8|awk '{print $2}')\n\n\tif [[ -n ${pids} ]];then\n\t\techo \"True\"\n\telse \n\t\techo \"False\"\n\tfi\n}\n\nfunction stop(){\n\tlog_info \"${FUNCNAME[0]} begin.\"\n\n\tpids=$(ps -ef|grep java|grep apache-zookeeper-3.5.8|awk '{print $2}')\n\t\n\tlog_info \"kill pid ${pids} begin.\"\n\tif [[ -n ${pids} ]];then\n\t\tlog_info \"process exist,kill it ${pids}!\"\n\t\tfor i in ${pids}\n\t\tdo\n\t\t\tlog_info \"kill process $i!\"\n\t\t\tkill -9 $i\n\t\tdone\n\telse\n\t\tlog_info \"process not exist!\"\n\n\tfi\n\tlog_info \"kill pid ${pids} end.\"\n\n\tlog_info \"${FUNCNAME[0]} end.\"\n}\n\nfunction start(){\n\tlog_info \"${FUNCTION[0]} begin.\"\n\n\tif [[ $(check_status $node) == \"True\" ]];then\n\t\tlog_info \"process is exist, not need to start!\"\n\telse\n\t\tlog_info \"start zookeeper begin.\"\n\n\t\t/usr/local/apache-zookeeper-3.5.8/bin/zkServer.sh start\n\n\t\tlog_info \"start zookeeper success.\"\n\tfi\n\n\tlog_info \"${FUNCTION[0]} complete.\"\n}\n\nfunction restart(){\n\tlog_info \"${FUNCTION[0]} begin.\"\n\n\tstop\n\n\tsleep 5\n\n\tstart\n\n\tlog_info \"${FUNCTION[0]} end.\"\n}\n\nfunction main(){\n\tlog_info \"${FUNCTION[0]} begin.\"\n\n\tACTION=\"$1\"\n\n\tcase \"${ACTION}\" in\n\t    start)\n            start\n\t    ;;\n            stop)\n            stop\n            ;;\n\t    restart)\n            restart\n            ;;\n\t    *)\n            usage\n            ;;\n            esac\n\n\tlog_info \"${FUNCTION[0]} complete.\"\n}\n\nmain \"$@\"\n\n# 修改权限\nchmod a+x /usr/local/apache-zookeeper-3.5.8/monitor.sh\n\n# 启动\nsh /usr/local/apache-zookeeper-3.5.8/monitor.sh start\n\n# 查看进程\njps\n\n# 将健康检查加入crontab\nvi /etc/crontab \n*/1 * * * * root /usr/local/apache-zookeeper-3.5.8/monitor.sh start >/dev/null 2>&1\n\n# 重启crontab\nsystemctl restart crond\n\n```\n\n","slug":"Zookeeper单机部署","published":1,"updated":"2023-01-03T06:17:51.244Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clcfuykye00003wrs3alxge71","content":"<h1 id=\"Zookeeper单机部署\"><a href=\"#Zookeeper单机部署\" class=\"headerlink\" title=\"Zookeeper单机部署\"></a>Zookeeper单机部署</h1><h2 id=\"1-云硬盘挂载\"><a href=\"#1-云硬盘挂载\" class=\"headerlink\" title=\"1 云硬盘挂载\"></a>1 云硬盘挂载</h2><span id=\"more\"></span>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 查看挂盘名称</span><br><span class=\"line\">fdisk -l</span><br><span class=\"line\"></span><br><span class=\"line\"># 创建物理卷</span><br><span class=\"line\">pvcreate /dev/vdb</span><br><span class=\"line\"></span><br><span class=\"line\"># 创建卷组</span><br><span class=\"line\">vgcreate data_vg /dev/vdb</span><br><span class=\"line\"></span><br><span class=\"line\"># 创建逻辑卷</span><br><span class=\"line\">lvcreate -l +100%free -n data data_vg</span><br><span class=\"line\"></span><br><span class=\"line\"># 格式化磁盘</span><br><span class=\"line\">mkfs.xfs /dev/data_vg/data</span><br><span class=\"line\"></span><br><span class=\"line\"># 创建挂载目录</span><br><span class=\"line\">mkdir -p /data1</span><br><span class=\"line\"></span><br><span class=\"line\"># 挂载</span><br><span class=\"line\">mount /dev/data_vg/data /data1</span><br><span class=\"line\"></span><br><span class=\"line\"># 添加挂载信息</span><br><span class=\"line\">echo &quot;/dev/mapper/data_vg-data /data1 xfs     defaults        0 0&quot; &gt;&gt; /etc/fstab</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"2-安装Java\"><a href=\"#2-安装Java\" class=\"headerlink\" title=\"2 安装Java\"></a>2 安装Java</h2><h3 id=\"2-1-检查系统是否安装了JAVA\"><a href=\"#2-1-检查系统是否安装了JAVA\" class=\"headerlink\" title=\"2.1 检查系统是否安装了JAVA\"></a>2.1 检查系统是否安装了JAVA</h3><p>如果有以下输出，则表示已安装</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rpm -qa | grep java</span><br><span class=\"line\"></span><br><span class=\"line\">java-1.8.0-openjdk-headless-1.8.0.272.b10-1.el7_9.x86_64</span><br><span class=\"line\">tzdata-java-2020d-2.el7.noarch</span><br><span class=\"line\">python-javapackages-3.4.1-11.el7.noarch</span><br><span class=\"line\">java-1.8.0-openjdk-1.8.0.272.b10-1.el7_9.x86_64</span><br><span class=\"line\">javapackages-tools-3.4.1-11.el7.noarch</span><br></pre></td></tr></table></figure>\n\n<p>需要进行卸载操作</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rpm -e java-1.8.0-openjdk-1.8.0.272.b10-1.el7_9.x86_64</span><br><span class=\"line\">rpm -e java-1.8.0-openjdk-headless-1.8.0.272.b10-1.el7_9.x86_64</span><br><span class=\"line\">rpm -e javapackages-tools-3.4.1-11.el7.noarch</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-2-解压JAVA安装包\"><a href=\"#2-2-解压JAVA安装包\" class=\"headerlink\" title=\"2.2 解压JAVA安装包\"></a>2.2 解压JAVA安装包</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tar -zxf /usr/local/java-1.8.0.tar.gz -C /usr/local</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-3-配置JAVA环境变量\"><a href=\"#2-3-配置JAVA环境变量\" class=\"headerlink\" title=\"2.3 配置JAVA环境变量\"></a>2.3 配置JAVA环境变量</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 在/etc/profile，追加JAVA_HOME和PATH两个变量。</span><br><span class=\"line\"></span><br><span class=\"line\">vi /etc/profile</span><br><span class=\"line\">export JAVA_HOME=/usr/local/java-1.8.0</span><br><span class=\"line\">export PATH=$JAVA_HOME/bin:$PATH</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-4-检查JAVA安装\"><a href=\"#2-4-检查JAVA安装\" class=\"headerlink\" title=\"2.4 检查JAVA安装\"></a>2.4 检查JAVA安装</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 使环境变量生效，然后检查Java版本</span><br><span class=\"line\"></span><br><span class=\"line\">source /etc/profile</span><br><span class=\"line\">java -version</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-安装zookeeper\"><a href=\"#3-安装zookeeper\" class=\"headerlink\" title=\"3 安装zookeeper\"></a>3 安装zookeeper</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 解压安装好的包</span><br><span class=\"line\">tar -zxf /usr/local/apache-zookeeper-3.5.8-bin.tar.gz -C /usr/local/</span><br><span class=\"line\">mv /usr/local/apache-zookeeper-3.5.8-bin /usr/local/apache-zookeeper-3.5.8</span><br><span class=\"line\"></span><br><span class=\"line\"># 新建数据目录</span><br><span class=\"line\">mkdir -p /data1/zookeeper/&#123;data,logs&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 修改配置文件</span><br><span class=\"line\">echo &quot;1&quot;&gt;/data1/zookeeper/data/myid</span><br><span class=\"line\"></span><br><span class=\"line\">vi /usr/local/apache-zookeeper-3.5.8/conf/zoo.cfg</span><br><span class=\"line\"></span><br><span class=\"line\"># The number of milliseconds of each tick</span><br><span class=\"line\">tickTime=2000</span><br><span class=\"line\"># The number of ticks that the initial </span><br><span class=\"line\"># synchronization phase can take</span><br><span class=\"line\">initLimit=10</span><br><span class=\"line\"># The number of ticks that can pass between </span><br><span class=\"line\"># sending a request and getting an acknowledgement</span><br><span class=\"line\">syncLimit=5</span><br><span class=\"line\"># the directory where the snapshot is stored.</span><br><span class=\"line\"># do not use /tmp for storage, /tmp here is just </span><br><span class=\"line\"># example sakes.</span><br><span class=\"line\">dataDir=/data1/zookeeper/data</span><br><span class=\"line\">dataLogDir=/data1/zookeeper/logs</span><br><span class=\"line\"># the port at which the clients will connect</span><br><span class=\"line\">clientPort=2181</span><br><span class=\"line\"># the maximum number of client connections.</span><br><span class=\"line\"># increase this if you need to handle more clients</span><br><span class=\"line\">maxClientCnxns=10000</span><br><span class=\"line\">#</span><br><span class=\"line\"># Be sure to read the maintenance section of the </span><br><span class=\"line\"># administrator guide before turning on autopurge.</span><br><span class=\"line\">#</span><br><span class=\"line\"># http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance</span><br><span class=\"line\">#</span><br><span class=\"line\"># The number of snapshots to retain in dataDir</span><br><span class=\"line\">#autopurge.snapRetainCount=3</span><br><span class=\"line\"># Purge task interval in hours</span><br><span class=\"line\"># Set to &quot;0&quot; to disable auto purge feature</span><br><span class=\"line\">#autopurge.purgeInterval=1</span><br><span class=\"line\">server.1=10.8.41.21:2888:3888</span><br><span class=\"line\"></span><br><span class=\"line\"># 编辑启动脚本</span><br><span class=\"line\">vi /usr/local/apache-zookeeper-3.5.8/monitor.sh</span><br><span class=\"line\"></span><br><span class=\"line\">#!/bin/bash</span><br><span class=\"line\">cur_path=$(cd &quot;$(dirname &quot;$&#123;BASH_SOURCE[0]&#125;&quot;)&quot; &amp;&amp; pwd)</span><br><span class=\"line\"></span><br><span class=\"line\">function log_info()&#123;</span><br><span class=\"line\">\techo &quot;[INFO] [$(date &quot;+%Y-%m-%d %T&quot;)] $1&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function log_error()&#123;</span><br><span class=\"line\">\techo &quot;[ERROR] [$(date &quot;+%Y-%m-%d %T&quot;)] $1&quot;</span><br><span class=\"line\">\texit 1</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function check_status()&#123;</span><br><span class=\"line\">\tpids=$(ps -ef|grep java|grep apache-zookeeper-3.5.8|awk &#x27;&#123;print $2&#125;&#x27;)</span><br><span class=\"line\"></span><br><span class=\"line\">\tif [[ -n $&#123;pids&#125; ]];then</span><br><span class=\"line\">\t\techo &quot;True&quot;</span><br><span class=\"line\">\telse </span><br><span class=\"line\">\t\techo &quot;False&quot;</span><br><span class=\"line\">\tfi</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function stop()&#123;</span><br><span class=\"line\">\tlog_info &quot;$&#123;FUNCNAME[0]&#125; begin.&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpids=$(ps -ef|grep java|grep apache-zookeeper-3.5.8|awk &#x27;&#123;print $2&#125;&#x27;)</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tlog_info &quot;kill pid $&#123;pids&#125; begin.&quot;</span><br><span class=\"line\">\tif [[ -n $&#123;pids&#125; ]];then</span><br><span class=\"line\">\t\tlog_info &quot;process exist,kill it $&#123;pids&#125;!&quot;</span><br><span class=\"line\">\t\tfor i in $&#123;pids&#125;</span><br><span class=\"line\">\t\tdo</span><br><span class=\"line\">\t\t\tlog_info &quot;kill process $i!&quot;</span><br><span class=\"line\">\t\t\tkill -9 $i</span><br><span class=\"line\">\t\tdone</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t\tlog_info &quot;process not exist!&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\tfi</span><br><span class=\"line\">\tlog_info &quot;kill pid $&#123;pids&#125; end.&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\tlog_info &quot;$&#123;FUNCNAME[0]&#125; end.&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function start()&#123;</span><br><span class=\"line\">\tlog_info &quot;$&#123;FUNCTION[0]&#125; begin.&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\tif [[ $(check_status $node) == &quot;True&quot; ]];then</span><br><span class=\"line\">\t\tlog_info &quot;process is exist, not need to start!&quot;</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t\tlog_info &quot;start zookeeper begin.&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t/usr/local/apache-zookeeper-3.5.8/bin/zkServer.sh start</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tlog_info &quot;start zookeeper success.&quot;</span><br><span class=\"line\">\tfi</span><br><span class=\"line\"></span><br><span class=\"line\">\tlog_info &quot;$&#123;FUNCTION[0]&#125; complete.&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function restart()&#123;</span><br><span class=\"line\">\tlog_info &quot;$&#123;FUNCTION[0]&#125; begin.&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\tstop</span><br><span class=\"line\"></span><br><span class=\"line\">\tsleep 5</span><br><span class=\"line\"></span><br><span class=\"line\">\tstart</span><br><span class=\"line\"></span><br><span class=\"line\">\tlog_info &quot;$&#123;FUNCTION[0]&#125; end.&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function main()&#123;</span><br><span class=\"line\">\tlog_info &quot;$&#123;FUNCTION[0]&#125; begin.&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\tACTION=&quot;$1&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\tcase &quot;$&#123;ACTION&#125;&quot; in</span><br><span class=\"line\">\t    start)</span><br><span class=\"line\">            start</span><br><span class=\"line\">\t    ;;</span><br><span class=\"line\">            stop)</span><br><span class=\"line\">            stop</span><br><span class=\"line\">            ;;</span><br><span class=\"line\">\t    restart)</span><br><span class=\"line\">            restart</span><br><span class=\"line\">            ;;</span><br><span class=\"line\">\t    *)</span><br><span class=\"line\">            usage</span><br><span class=\"line\">            ;;</span><br><span class=\"line\">            esac</span><br><span class=\"line\"></span><br><span class=\"line\">\tlog_info &quot;$&#123;FUNCTION[0]&#125; complete.&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">main &quot;$@&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"># 修改权限</span><br><span class=\"line\">chmod a+x /usr/local/apache-zookeeper-3.5.8/monitor.sh</span><br><span class=\"line\"></span><br><span class=\"line\"># 启动</span><br><span class=\"line\">sh /usr/local/apache-zookeeper-3.5.8/monitor.sh start</span><br><span class=\"line\"></span><br><span class=\"line\"># 查看进程</span><br><span class=\"line\">jps</span><br><span class=\"line\"></span><br><span class=\"line\"># 将健康检查加入crontab</span><br><span class=\"line\">vi /etc/crontab </span><br><span class=\"line\">*/1 * * * * root /usr/local/apache-zookeeper-3.5.8/monitor.sh start &gt;/dev/null 2&gt;&amp;1</span><br><span class=\"line\"></span><br><span class=\"line\"># 重启crontab</span><br><span class=\"line\">systemctl restart crond</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n","site":{"data":{}},"excerpt":"<h1 id=\"Zookeeper单机部署\"><a href=\"#Zookeeper单机部署\" class=\"headerlink\" title=\"Zookeeper单机部署\"></a>Zookeeper单机部署</h1><h2 id=\"1-云硬盘挂载\"><a href=\"#1-云硬盘挂载\" class=\"headerlink\" title=\"1 云硬盘挂载\"></a>1 云硬盘挂载</h2>","more":"<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 查看挂盘名称</span><br><span class=\"line\">fdisk -l</span><br><span class=\"line\"></span><br><span class=\"line\"># 创建物理卷</span><br><span class=\"line\">pvcreate /dev/vdb</span><br><span class=\"line\"></span><br><span class=\"line\"># 创建卷组</span><br><span class=\"line\">vgcreate data_vg /dev/vdb</span><br><span class=\"line\"></span><br><span class=\"line\"># 创建逻辑卷</span><br><span class=\"line\">lvcreate -l +100%free -n data data_vg</span><br><span class=\"line\"></span><br><span class=\"line\"># 格式化磁盘</span><br><span class=\"line\">mkfs.xfs /dev/data_vg/data</span><br><span class=\"line\"></span><br><span class=\"line\"># 创建挂载目录</span><br><span class=\"line\">mkdir -p /data1</span><br><span class=\"line\"></span><br><span class=\"line\"># 挂载</span><br><span class=\"line\">mount /dev/data_vg/data /data1</span><br><span class=\"line\"></span><br><span class=\"line\"># 添加挂载信息</span><br><span class=\"line\">echo &quot;/dev/mapper/data_vg-data /data1 xfs     defaults        0 0&quot; &gt;&gt; /etc/fstab</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"2-安装Java\"><a href=\"#2-安装Java\" class=\"headerlink\" title=\"2 安装Java\"></a>2 安装Java</h2><h3 id=\"2-1-检查系统是否安装了JAVA\"><a href=\"#2-1-检查系统是否安装了JAVA\" class=\"headerlink\" title=\"2.1 检查系统是否安装了JAVA\"></a>2.1 检查系统是否安装了JAVA</h3><p>如果有以下输出，则表示已安装</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rpm -qa | grep java</span><br><span class=\"line\"></span><br><span class=\"line\">java-1.8.0-openjdk-headless-1.8.0.272.b10-1.el7_9.x86_64</span><br><span class=\"line\">tzdata-java-2020d-2.el7.noarch</span><br><span class=\"line\">python-javapackages-3.4.1-11.el7.noarch</span><br><span class=\"line\">java-1.8.0-openjdk-1.8.0.272.b10-1.el7_9.x86_64</span><br><span class=\"line\">javapackages-tools-3.4.1-11.el7.noarch</span><br></pre></td></tr></table></figure>\n\n<p>需要进行卸载操作</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rpm -e java-1.8.0-openjdk-1.8.0.272.b10-1.el7_9.x86_64</span><br><span class=\"line\">rpm -e java-1.8.0-openjdk-headless-1.8.0.272.b10-1.el7_9.x86_64</span><br><span class=\"line\">rpm -e javapackages-tools-3.4.1-11.el7.noarch</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-2-解压JAVA安装包\"><a href=\"#2-2-解压JAVA安装包\" class=\"headerlink\" title=\"2.2 解压JAVA安装包\"></a>2.2 解压JAVA安装包</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tar -zxf /usr/local/java-1.8.0.tar.gz -C /usr/local</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-3-配置JAVA环境变量\"><a href=\"#2-3-配置JAVA环境变量\" class=\"headerlink\" title=\"2.3 配置JAVA环境变量\"></a>2.3 配置JAVA环境变量</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 在/etc/profile，追加JAVA_HOME和PATH两个变量。</span><br><span class=\"line\"></span><br><span class=\"line\">vi /etc/profile</span><br><span class=\"line\">export JAVA_HOME=/usr/local/java-1.8.0</span><br><span class=\"line\">export PATH=$JAVA_HOME/bin:$PATH</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-4-检查JAVA安装\"><a href=\"#2-4-检查JAVA安装\" class=\"headerlink\" title=\"2.4 检查JAVA安装\"></a>2.4 检查JAVA安装</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 使环境变量生效，然后检查Java版本</span><br><span class=\"line\"></span><br><span class=\"line\">source /etc/profile</span><br><span class=\"line\">java -version</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-安装zookeeper\"><a href=\"#3-安装zookeeper\" class=\"headerlink\" title=\"3 安装zookeeper\"></a>3 安装zookeeper</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 解压安装好的包</span><br><span class=\"line\">tar -zxf /usr/local/apache-zookeeper-3.5.8-bin.tar.gz -C /usr/local/</span><br><span class=\"line\">mv /usr/local/apache-zookeeper-3.5.8-bin /usr/local/apache-zookeeper-3.5.8</span><br><span class=\"line\"></span><br><span class=\"line\"># 新建数据目录</span><br><span class=\"line\">mkdir -p /data1/zookeeper/&#123;data,logs&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 修改配置文件</span><br><span class=\"line\">echo &quot;1&quot;&gt;/data1/zookeeper/data/myid</span><br><span class=\"line\"></span><br><span class=\"line\">vi /usr/local/apache-zookeeper-3.5.8/conf/zoo.cfg</span><br><span class=\"line\"></span><br><span class=\"line\"># The number of milliseconds of each tick</span><br><span class=\"line\">tickTime=2000</span><br><span class=\"line\"># The number of ticks that the initial </span><br><span class=\"line\"># synchronization phase can take</span><br><span class=\"line\">initLimit=10</span><br><span class=\"line\"># The number of ticks that can pass between </span><br><span class=\"line\"># sending a request and getting an acknowledgement</span><br><span class=\"line\">syncLimit=5</span><br><span class=\"line\"># the directory where the snapshot is stored.</span><br><span class=\"line\"># do not use /tmp for storage, /tmp here is just </span><br><span class=\"line\"># example sakes.</span><br><span class=\"line\">dataDir=/data1/zookeeper/data</span><br><span class=\"line\">dataLogDir=/data1/zookeeper/logs</span><br><span class=\"line\"># the port at which the clients will connect</span><br><span class=\"line\">clientPort=2181</span><br><span class=\"line\"># the maximum number of client connections.</span><br><span class=\"line\"># increase this if you need to handle more clients</span><br><span class=\"line\">maxClientCnxns=10000</span><br><span class=\"line\">#</span><br><span class=\"line\"># Be sure to read the maintenance section of the </span><br><span class=\"line\"># administrator guide before turning on autopurge.</span><br><span class=\"line\">#</span><br><span class=\"line\"># http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance</span><br><span class=\"line\">#</span><br><span class=\"line\"># The number of snapshots to retain in dataDir</span><br><span class=\"line\">#autopurge.snapRetainCount=3</span><br><span class=\"line\"># Purge task interval in hours</span><br><span class=\"line\"># Set to &quot;0&quot; to disable auto purge feature</span><br><span class=\"line\">#autopurge.purgeInterval=1</span><br><span class=\"line\">server.1=10.8.41.21:2888:3888</span><br><span class=\"line\"></span><br><span class=\"line\"># 编辑启动脚本</span><br><span class=\"line\">vi /usr/local/apache-zookeeper-3.5.8/monitor.sh</span><br><span class=\"line\"></span><br><span class=\"line\">#!/bin/bash</span><br><span class=\"line\">cur_path=$(cd &quot;$(dirname &quot;$&#123;BASH_SOURCE[0]&#125;&quot;)&quot; &amp;&amp; pwd)</span><br><span class=\"line\"></span><br><span class=\"line\">function log_info()&#123;</span><br><span class=\"line\">\techo &quot;[INFO] [$(date &quot;+%Y-%m-%d %T&quot;)] $1&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function log_error()&#123;</span><br><span class=\"line\">\techo &quot;[ERROR] [$(date &quot;+%Y-%m-%d %T&quot;)] $1&quot;</span><br><span class=\"line\">\texit 1</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function check_status()&#123;</span><br><span class=\"line\">\tpids=$(ps -ef|grep java|grep apache-zookeeper-3.5.8|awk &#x27;&#123;print $2&#125;&#x27;)</span><br><span class=\"line\"></span><br><span class=\"line\">\tif [[ -n $&#123;pids&#125; ]];then</span><br><span class=\"line\">\t\techo &quot;True&quot;</span><br><span class=\"line\">\telse </span><br><span class=\"line\">\t\techo &quot;False&quot;</span><br><span class=\"line\">\tfi</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function stop()&#123;</span><br><span class=\"line\">\tlog_info &quot;$&#123;FUNCNAME[0]&#125; begin.&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpids=$(ps -ef|grep java|grep apache-zookeeper-3.5.8|awk &#x27;&#123;print $2&#125;&#x27;)</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tlog_info &quot;kill pid $&#123;pids&#125; begin.&quot;</span><br><span class=\"line\">\tif [[ -n $&#123;pids&#125; ]];then</span><br><span class=\"line\">\t\tlog_info &quot;process exist,kill it $&#123;pids&#125;!&quot;</span><br><span class=\"line\">\t\tfor i in $&#123;pids&#125;</span><br><span class=\"line\">\t\tdo</span><br><span class=\"line\">\t\t\tlog_info &quot;kill process $i!&quot;</span><br><span class=\"line\">\t\t\tkill -9 $i</span><br><span class=\"line\">\t\tdone</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t\tlog_info &quot;process not exist!&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\tfi</span><br><span class=\"line\">\tlog_info &quot;kill pid $&#123;pids&#125; end.&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\tlog_info &quot;$&#123;FUNCNAME[0]&#125; end.&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function start()&#123;</span><br><span class=\"line\">\tlog_info &quot;$&#123;FUNCTION[0]&#125; begin.&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\tif [[ $(check_status $node) == &quot;True&quot; ]];then</span><br><span class=\"line\">\t\tlog_info &quot;process is exist, not need to start!&quot;</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t\tlog_info &quot;start zookeeper begin.&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t/usr/local/apache-zookeeper-3.5.8/bin/zkServer.sh start</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tlog_info &quot;start zookeeper success.&quot;</span><br><span class=\"line\">\tfi</span><br><span class=\"line\"></span><br><span class=\"line\">\tlog_info &quot;$&#123;FUNCTION[0]&#125; complete.&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function restart()&#123;</span><br><span class=\"line\">\tlog_info &quot;$&#123;FUNCTION[0]&#125; begin.&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\tstop</span><br><span class=\"line\"></span><br><span class=\"line\">\tsleep 5</span><br><span class=\"line\"></span><br><span class=\"line\">\tstart</span><br><span class=\"line\"></span><br><span class=\"line\">\tlog_info &quot;$&#123;FUNCTION[0]&#125; end.&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function main()&#123;</span><br><span class=\"line\">\tlog_info &quot;$&#123;FUNCTION[0]&#125; begin.&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\tACTION=&quot;$1&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\tcase &quot;$&#123;ACTION&#125;&quot; in</span><br><span class=\"line\">\t    start)</span><br><span class=\"line\">            start</span><br><span class=\"line\">\t    ;;</span><br><span class=\"line\">            stop)</span><br><span class=\"line\">            stop</span><br><span class=\"line\">            ;;</span><br><span class=\"line\">\t    restart)</span><br><span class=\"line\">            restart</span><br><span class=\"line\">            ;;</span><br><span class=\"line\">\t    *)</span><br><span class=\"line\">            usage</span><br><span class=\"line\">            ;;</span><br><span class=\"line\">            esac</span><br><span class=\"line\"></span><br><span class=\"line\">\tlog_info &quot;$&#123;FUNCTION[0]&#125; complete.&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">main &quot;$@&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"># 修改权限</span><br><span class=\"line\">chmod a+x /usr/local/apache-zookeeper-3.5.8/monitor.sh</span><br><span class=\"line\"></span><br><span class=\"line\"># 启动</span><br><span class=\"line\">sh /usr/local/apache-zookeeper-3.5.8/monitor.sh start</span><br><span class=\"line\"></span><br><span class=\"line\"># 查看进程</span><br><span class=\"line\">jps</span><br><span class=\"line\"></span><br><span class=\"line\"># 将健康检查加入crontab</span><br><span class=\"line\">vi /etc/crontab </span><br><span class=\"line\">*/1 * * * * root /usr/local/apache-zookeeper-3.5.8/monitor.sh start &gt;/dev/null 2&gt;&amp;1</span><br><span class=\"line\"></span><br><span class=\"line\"># 重启crontab</span><br><span class=\"line\">systemctl restart crond</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>"},{"title":"Kubesphere证书过期","date":"2022-08-22T03:20:56.000Z","_content":"\n# Kubesphere证书过期\n\n### 概述\n\n 因为kubesphere的证书有效期只有一年，所以需要重新生成证书。\n\n<!--more-->\n\n### 1 kubesphere证书过期现象\n\n```perl\n# 使用kubectl命令的时候会提示证书过期\n(DEV)[root@master01 ~]# kubectl get pods -n A\nUnable to connect to the server: x509: certificate has expired or is not yet valid\n\n# 检查证书有效期\n(DEV)[root@master01 ~]# kubeadm alpha certs check-expiration\n[check-expiration] Reading configuration from the cluster...\n[check-expiration] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml'\n[check-expiration] Error reading configuration from the Cluster. Falling back to default configuration\n\nW1228 10:09:37.193925    5469 configset.go:202] WARNING: kubeadm cannot validate component configs for API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io]\nCERTIFICATE                         EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED\nadmin.conf                          Dec 27, 2021 10:22 UTC   <invalid>                               no      \napiserver                           Dec 27, 2021 10:22 UTC   <invalid>       ca                      no      \n!MISSING! apiserver-etcd-client                                                                      \napiserver-kubelet-client            Dec 27, 2021 10:22 UTC   <invalid>       ca                      no      \ncontroller-manager.conf             Dec 27, 2021 10:22 UTC   <invalid>                               no      \n!MISSING! etcd-healthcheck-client                                                                    \n!MISSING! etcd-peer                                                                                  \n!MISSING! etcd-server                                                                                \nfront-proxy-client                  Dec 27, 2021 10:22 UTC   <invalid>       front-proxy-ca          no      \nscheduler.conf                      Dec 27, 2021 10:22 UTC   <invalid>                               no      \n\nCERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED\nca                      Dec 25, 2030 10:22 UTC   8y              no      \n!MISSING! etcd-ca                                                \nfront-proxy-ca          Dec 25, 2030 10:22 UTC   8y              no\n```\n\n### 2 解决方法\n\n```perl\n# 1.重新生成证书\n# 在master01上生成新的证书\n(DEV)[root@master01 ~]# kubeadm alpha certs renew all\n[renew] Reading configuration from the cluster...\n[renew] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml'\n[renew] Error reading configuration from the Cluster. Falling back to default configuration\n\nW1228 10:12:47.177137   10207 configset.go:202] WARNING: kubeadm cannot validate component configs for API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io]\ncertificate embedded in the kubeconfig file for the admin to use and for kubeadm itself renewed\ncertificate for serving the Kubernetes API renewed\nMISSING! certificate the apiserver uses to access etcd\ncertificate for the API server to connect to kubelet renewed\ncertificate embedded in the kubeconfig file for the controller manager to use renewed\nMISSING! certificate for liveness probes to healthcheck etcd\nMISSING! certificate for etcd nodes to communicate with each other\nMISSING! certificate for serving etcd\ncertificate for the front proxy client renewed\ncertificate embedded in the kubeconfig file for the scheduler manager to use renewed\n(DEV)[root@master01 ~]# \n\n# 2.将证书传到另外两个节点\n# master02和master03先备份\n(DEV)[root@master02 etc]# mv /etc/kubernetes /etc/kubernetes-bak-12-28\n(DEV)[root@master03 etc]# mv /etc/kubernetes /etc/kubernetes-bak-12-28\n\n# 将新生成的证书传到master02和master03\n(DEV)[root@master01 etc]# scp -r kubernetes root@master02:/etc/\n(DEV)[root@master01 etc]# scp -r kubernetes root@master03:/etc/\n\n# 3.重启ETCD\n# 登录master01和master02以及master03\n(DEV)[root@master01 etc]# docker ps|grep etcd\nf306a918736b   28c771d7cfbf                           \"/usr/local/bin/etcd\"    8 months ago   Up 8 months             etcd1\n(DEV)[root@master01 etc]# docker restart f306a918736b\nf306a918736b\n\n(DEV)[root@master02 etc]# docker ps |grep etcd\n11876daa3de5   30.23.8.56:5000/kubesphere/etcd:v3.3.12                            \"/usr/local/bin/etcd\"    8 months ago         Up 8 months                   etcd2\n(DEV)[root@master02 etc]# docker restart 11876daa3de5\n11876daa3de5\n\n(DEV)[root@master03 etc]# docker ps|grep etcd\n3a9ad934353b   30.23.8.56:5000/kubesphere/etcd:v3.3.12                 \"/usr/local/bin/etcd\"    7 seconds ago        Restarting (2) Less than a second ago             etcd3\n(DEV)[root@master03 etc]# docker restart 3a9ad934353b\n3a9ad934353b\n\n# 4.生成新的config文件\n# 不进行替换的话，kubectl的命令还是使用不了会提示如下错误。\n(DEV)[root@master01 ~]# kubectl get pods -n hbp\nUnable to connect to the server: x509: certificate has expired or is not yet valid\n\n# 登录master01和master02以及master03\n(DEV)[root@master01 .kube]# mv ~/.kube/config ~/.kube/config-bak-2021-12-28\n(DEV)[root@master01 .kube]# cp /etc/kubernetes/admin.conf ~/.kube/config\n\n(DEV)[root@master02 .kube]# mv ~/.kube/config ~/.kube/config-bak-2021-12-28\n(DEV)[root@master02 .kube]# cp /etc/kubernetes/admin.conf ~/.kube/config\n\n(DEV)[root@master03 etc]# mv ~/.kube/config ~/.kube/config-bak-2021-12-28\n(DEV)[root@master03 etc]# cp /etc/kubernetes/admin.conf ~/.kube/config\n```\n\n","source":"_posts/Kubesphere证书过期.md","raw":"---\ntitle: Kubesphere证书过期\ndate: 2022-08-22 11:20:56\ntags: Kubesphere\n---\n\n# Kubesphere证书过期\n\n### 概述\n\n 因为kubesphere的证书有效期只有一年，所以需要重新生成证书。\n\n<!--more-->\n\n### 1 kubesphere证书过期现象\n\n```perl\n# 使用kubectl命令的时候会提示证书过期\n(DEV)[root@master01 ~]# kubectl get pods -n A\nUnable to connect to the server: x509: certificate has expired or is not yet valid\n\n# 检查证书有效期\n(DEV)[root@master01 ~]# kubeadm alpha certs check-expiration\n[check-expiration] Reading configuration from the cluster...\n[check-expiration] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml'\n[check-expiration] Error reading configuration from the Cluster. Falling back to default configuration\n\nW1228 10:09:37.193925    5469 configset.go:202] WARNING: kubeadm cannot validate component configs for API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io]\nCERTIFICATE                         EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED\nadmin.conf                          Dec 27, 2021 10:22 UTC   <invalid>                               no      \napiserver                           Dec 27, 2021 10:22 UTC   <invalid>       ca                      no      \n!MISSING! apiserver-etcd-client                                                                      \napiserver-kubelet-client            Dec 27, 2021 10:22 UTC   <invalid>       ca                      no      \ncontroller-manager.conf             Dec 27, 2021 10:22 UTC   <invalid>                               no      \n!MISSING! etcd-healthcheck-client                                                                    \n!MISSING! etcd-peer                                                                                  \n!MISSING! etcd-server                                                                                \nfront-proxy-client                  Dec 27, 2021 10:22 UTC   <invalid>       front-proxy-ca          no      \nscheduler.conf                      Dec 27, 2021 10:22 UTC   <invalid>                               no      \n\nCERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED\nca                      Dec 25, 2030 10:22 UTC   8y              no      \n!MISSING! etcd-ca                                                \nfront-proxy-ca          Dec 25, 2030 10:22 UTC   8y              no\n```\n\n### 2 解决方法\n\n```perl\n# 1.重新生成证书\n# 在master01上生成新的证书\n(DEV)[root@master01 ~]# kubeadm alpha certs renew all\n[renew] Reading configuration from the cluster...\n[renew] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml'\n[renew] Error reading configuration from the Cluster. Falling back to default configuration\n\nW1228 10:12:47.177137   10207 configset.go:202] WARNING: kubeadm cannot validate component configs for API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io]\ncertificate embedded in the kubeconfig file for the admin to use and for kubeadm itself renewed\ncertificate for serving the Kubernetes API renewed\nMISSING! certificate the apiserver uses to access etcd\ncertificate for the API server to connect to kubelet renewed\ncertificate embedded in the kubeconfig file for the controller manager to use renewed\nMISSING! certificate for liveness probes to healthcheck etcd\nMISSING! certificate for etcd nodes to communicate with each other\nMISSING! certificate for serving etcd\ncertificate for the front proxy client renewed\ncertificate embedded in the kubeconfig file for the scheduler manager to use renewed\n(DEV)[root@master01 ~]# \n\n# 2.将证书传到另外两个节点\n# master02和master03先备份\n(DEV)[root@master02 etc]# mv /etc/kubernetes /etc/kubernetes-bak-12-28\n(DEV)[root@master03 etc]# mv /etc/kubernetes /etc/kubernetes-bak-12-28\n\n# 将新生成的证书传到master02和master03\n(DEV)[root@master01 etc]# scp -r kubernetes root@master02:/etc/\n(DEV)[root@master01 etc]# scp -r kubernetes root@master03:/etc/\n\n# 3.重启ETCD\n# 登录master01和master02以及master03\n(DEV)[root@master01 etc]# docker ps|grep etcd\nf306a918736b   28c771d7cfbf                           \"/usr/local/bin/etcd\"    8 months ago   Up 8 months             etcd1\n(DEV)[root@master01 etc]# docker restart f306a918736b\nf306a918736b\n\n(DEV)[root@master02 etc]# docker ps |grep etcd\n11876daa3de5   30.23.8.56:5000/kubesphere/etcd:v3.3.12                            \"/usr/local/bin/etcd\"    8 months ago         Up 8 months                   etcd2\n(DEV)[root@master02 etc]# docker restart 11876daa3de5\n11876daa3de5\n\n(DEV)[root@master03 etc]# docker ps|grep etcd\n3a9ad934353b   30.23.8.56:5000/kubesphere/etcd:v3.3.12                 \"/usr/local/bin/etcd\"    7 seconds ago        Restarting (2) Less than a second ago             etcd3\n(DEV)[root@master03 etc]# docker restart 3a9ad934353b\n3a9ad934353b\n\n# 4.生成新的config文件\n# 不进行替换的话，kubectl的命令还是使用不了会提示如下错误。\n(DEV)[root@master01 ~]# kubectl get pods -n hbp\nUnable to connect to the server: x509: certificate has expired or is not yet valid\n\n# 登录master01和master02以及master03\n(DEV)[root@master01 .kube]# mv ~/.kube/config ~/.kube/config-bak-2021-12-28\n(DEV)[root@master01 .kube]# cp /etc/kubernetes/admin.conf ~/.kube/config\n\n(DEV)[root@master02 .kube]# mv ~/.kube/config ~/.kube/config-bak-2021-12-28\n(DEV)[root@master02 .kube]# cp /etc/kubernetes/admin.conf ~/.kube/config\n\n(DEV)[root@master03 etc]# mv ~/.kube/config ~/.kube/config-bak-2021-12-28\n(DEV)[root@master03 etc]# cp /etc/kubernetes/admin.conf ~/.kube/config\n```\n\n","slug":"Kubesphere证书过期","published":1,"updated":"2023-01-03T06:17:51.244Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clcfuykyj00013wrs2gxph6zu","content":"<h1 id=\"Kubesphere证书过期\"><a href=\"#Kubesphere证书过期\" class=\"headerlink\" title=\"Kubesphere证书过期\"></a>Kubesphere证书过期</h1><h3 id=\"概述\"><a href=\"#概述\" class=\"headerlink\" title=\"概述\"></a>概述</h3><p> 因为kubesphere的证书有效期只有一年，所以需要重新生成证书。</p>\n<span id=\"more\"></span>\n\n<h3 id=\"1-kubesphere证书过期现象\"><a href=\"#1-kubesphere证书过期现象\" class=\"headerlink\" title=\"1 kubesphere证书过期现象\"></a>1 kubesphere证书过期现象</h3><figure class=\"highlight perl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 使用kubectl命令的时候会提示证书过期</span></span><br><span class=\"line\">(DEV)[root@master01 ~]<span class=\"comment\"># kubectl get pods -n A</span></span><br><span class=\"line\">Unable to <span class=\"keyword\">connect</span> to the server: x509: certificate has expired <span class=\"keyword\">or</span> is <span class=\"keyword\">not</span> yet valid</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 检查证书有效期</span></span><br><span class=\"line\">(DEV)[root@master01 ~]<span class=\"comment\"># kubeadm alpha certs check-expiration</span></span><br><span class=\"line\">[check-expiration] Reading configuration from the cluster...</span><br><span class=\"line\">[check-expiration] FYI: You can look at this config file with <span class=\"string\">&#x27;kubectl -n kube-system get cm kubeadm-config -oyaml&#x27;</span></span><br><span class=\"line\">[check-expiration] Error reading configuration from the Cluster. Falling back to default configuration</span><br><span class=\"line\"></span><br><span class=\"line\">W1228 <span class=\"number\">10</span>:09:<span class=\"number\">37.193925</span>    <span class=\"number\">5469</span> configset.go:<span class=\"number\">202</span>] WARNING: kubeadm cannot validate component configs <span class=\"keyword\">for</span> API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io]</span><br><span class=\"line\">CERTIFICATE                         EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED</span><br><span class=\"line\">admin.conf                          Dec <span class=\"number\">27</span>, <span class=\"number\">2021</span> <span class=\"number\">10</span>:<span class=\"number\">22</span> UTC   &lt;invalid&gt;                               <span class=\"keyword\">no</span>      </span><br><span class=\"line\">apiserver                           Dec <span class=\"number\">27</span>, <span class=\"number\">2021</span> <span class=\"number\">10</span>:<span class=\"number\">22</span> UTC   &lt;invalid&gt;       ca                      <span class=\"keyword\">no</span>      </span><br><span class=\"line\">!MISSING! apiserver-etcd-client                                                                      </span><br><span class=\"line\">apiserver-kubelet-client            Dec <span class=\"number\">27</span>, <span class=\"number\">2021</span> <span class=\"number\">10</span>:<span class=\"number\">22</span> UTC   &lt;invalid&gt;       ca                      <span class=\"keyword\">no</span>      </span><br><span class=\"line\">controller-manager.conf             Dec <span class=\"number\">27</span>, <span class=\"number\">2021</span> <span class=\"number\">10</span>:<span class=\"number\">22</span> UTC   &lt;invalid&gt;                               <span class=\"keyword\">no</span>      </span><br><span class=\"line\">!MISSING! etcd-healthcheck-client                                                                    </span><br><span class=\"line\">!MISSING! etcd-peer                                                                                  </span><br><span class=\"line\">!MISSING! etcd-server                                                                                </span><br><span class=\"line\">front-proxy-client                  Dec <span class=\"number\">27</span>, <span class=\"number\">2021</span> <span class=\"number\">10</span>:<span class=\"number\">22</span> UTC   &lt;invalid&gt;       front-proxy-ca          <span class=\"keyword\">no</span>      </span><br><span class=\"line\">scheduler.conf                      Dec <span class=\"number\">27</span>, <span class=\"number\">2021</span> <span class=\"number\">10</span>:<span class=\"number\">22</span> UTC   &lt;invalid&gt;                               <span class=\"keyword\">no</span>      </span><br><span class=\"line\"></span><br><span class=\"line\">CERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED</span><br><span class=\"line\">ca                      Dec <span class=\"number\">25</span>, <span class=\"number\">2030</span> <span class=\"number\">10</span>:<span class=\"number\">22</span> UTC   <span class=\"number\">8</span><span class=\"keyword\">y</span>              <span class=\"keyword\">no</span>      </span><br><span class=\"line\">!MISSING! etcd-ca                                                </span><br><span class=\"line\">front-proxy-ca          Dec <span class=\"number\">25</span>, <span class=\"number\">2030</span> <span class=\"number\">10</span>:<span class=\"number\">22</span> UTC   <span class=\"number\">8</span><span class=\"keyword\">y</span>              <span class=\"keyword\">no</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-解决方法\"><a href=\"#2-解决方法\" class=\"headerlink\" title=\"2 解决方法\"></a>2 解决方法</h3><figure class=\"highlight perl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.重新生成证书</span></span><br><span class=\"line\"><span class=\"comment\"># 在master01上生成新的证书</span></span><br><span class=\"line\">(DEV)[root@master01 ~]<span class=\"comment\"># kubeadm alpha certs renew all</span></span><br><span class=\"line\">[renew] Reading configuration from the cluster...</span><br><span class=\"line\">[renew] FYI: You can look at this config file with <span class=\"string\">&#x27;kubectl -n kube-system get cm kubeadm-config -oyaml&#x27;</span></span><br><span class=\"line\">[renew] Error reading configuration from the Cluster. Falling back to default configuration</span><br><span class=\"line\"></span><br><span class=\"line\">W1228 <span class=\"number\">10</span>:<span class=\"number\">12</span>:<span class=\"number\">47.177137</span>   <span class=\"number\">10207</span> configset.go:<span class=\"number\">202</span>] WARNING: kubeadm cannot validate component configs <span class=\"keyword\">for</span> API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io]</span><br><span class=\"line\">certificate embedded in the kubeconfig file <span class=\"keyword\">for</span> the admin to <span class=\"keyword\">use</span> <span class=\"keyword\">and</span> <span class=\"keyword\">for</span> kubeadm itself renewed</span><br><span class=\"line\">certificate <span class=\"keyword\">for</span> serving the Kubernetes API renewed</span><br><span class=\"line\">MISSING! certificate the apiserver uses to access etcd</span><br><span class=\"line\">certificate <span class=\"keyword\">for</span> the API server to <span class=\"keyword\">connect</span> to kubelet renewed</span><br><span class=\"line\">certificate embedded in the kubeconfig file <span class=\"keyword\">for</span> the controller manager to <span class=\"keyword\">use</span> renewed</span><br><span class=\"line\">MISSING! certificate <span class=\"keyword\">for</span> liveness probes to healthcheck etcd</span><br><span class=\"line\">MISSING! certificate <span class=\"keyword\">for</span> etcd nodes to communicate with <span class=\"keyword\">each</span> other</span><br><span class=\"line\">MISSING! certificate <span class=\"keyword\">for</span> serving etcd</span><br><span class=\"line\">certificate <span class=\"keyword\">for</span> the front proxy client renewed</span><br><span class=\"line\">certificate embedded in the kubeconfig file <span class=\"keyword\">for</span> the scheduler manager to <span class=\"keyword\">use</span> renewed</span><br><span class=\"line\">(DEV)[root@master01 ~]<span class=\"comment\"># </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.将证书传到另外两个节点</span></span><br><span class=\"line\"><span class=\"comment\"># master02和master03先备份</span></span><br><span class=\"line\">(DEV)[root@master02 etc]<span class=\"comment\"># mv /etc/kubernetes /etc/kubernetes-bak-12-28</span></span><br><span class=\"line\">(DEV)[root@master03 etc]<span class=\"comment\"># mv /etc/kubernetes /etc/kubernetes-bak-12-28</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 将新生成的证书传到master02和master03</span></span><br><span class=\"line\">(DEV)[root@master01 etc]<span class=\"comment\"># scp -r kubernetes root@master02:/etc/</span></span><br><span class=\"line\">(DEV)[root@master01 etc]<span class=\"comment\"># scp -r kubernetes root@master03:/etc/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.重启ETCD</span></span><br><span class=\"line\"><span class=\"comment\"># 登录master01和master02以及master03</span></span><br><span class=\"line\">(DEV)[root@master01 etc]<span class=\"comment\"># docker ps|grep etcd</span></span><br><span class=\"line\">f306a918736b   <span class=\"number\">28</span>c771d7cfbf                           <span class=\"string\">&quot;/usr/local/bin/etcd&quot;</span>    <span class=\"number\">8</span> months ago   Up <span class=\"number\">8</span> months             etcd1</span><br><span class=\"line\">(DEV)[root@master01 etc]<span class=\"comment\"># docker restart f306a918736b</span></span><br><span class=\"line\">f306a918736b</span><br><span class=\"line\"></span><br><span class=\"line\">(DEV)[root@master02 etc]<span class=\"comment\"># docker ps |grep etcd</span></span><br><span class=\"line\"><span class=\"number\">11876</span>daa3de5   <span class=\"number\">30.23</span>.<span class=\"number\">8.56</span>:<span class=\"number\">5000</span>/kubesphere/etcd:v3.<span class=\"number\">3.12</span>                            <span class=\"string\">&quot;/usr/local/bin/etcd&quot;</span>    <span class=\"number\">8</span> months ago         Up <span class=\"number\">8</span> months                   etcd2</span><br><span class=\"line\">(DEV)[root@master02 etc]<span class=\"comment\"># docker restart 11876daa3de5</span></span><br><span class=\"line\"><span class=\"number\">11876</span>daa3de5</span><br><span class=\"line\"></span><br><span class=\"line\">(DEV)[root@master03 etc]<span class=\"comment\"># docker ps|grep etcd</span></span><br><span class=\"line\"><span class=\"number\">3</span>a9ad934353b   <span class=\"number\">30.23</span>.<span class=\"number\">8.56</span>:<span class=\"number\">5000</span>/kubesphere/etcd:v3.<span class=\"number\">3.12</span>                 <span class=\"string\">&quot;/usr/local/bin/etcd&quot;</span>    <span class=\"number\">7</span> seconds ago        Restarting (<span class=\"number\">2</span>) Less than a second ago             etcd3</span><br><span class=\"line\">(DEV)[root@master03 etc]<span class=\"comment\"># docker restart 3a9ad934353b</span></span><br><span class=\"line\"><span class=\"number\">3</span>a9ad934353b</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.生成新的config文件</span></span><br><span class=\"line\"><span class=\"comment\"># 不进行替换的话，kubectl的命令还是使用不了会提示如下错误。</span></span><br><span class=\"line\">(DEV)[root@master01 ~]<span class=\"comment\"># kubectl get pods -n hbp</span></span><br><span class=\"line\">Unable to <span class=\"keyword\">connect</span> to the server: x509: certificate has expired <span class=\"keyword\">or</span> is <span class=\"keyword\">not</span> yet valid</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 登录master01和master02以及master03</span></span><br><span class=\"line\">(DEV)[root@master01 .kube]<span class=\"comment\"># mv ~/.kube/config ~/.kube/config-bak-2021-12-28</span></span><br><span class=\"line\">(DEV)[root@master01 .kube]<span class=\"comment\"># cp /etc/kubernetes/admin.conf ~/.kube/config</span></span><br><span class=\"line\"></span><br><span class=\"line\">(DEV)[root@master02 .kube]<span class=\"comment\"># mv ~/.kube/config ~/.kube/config-bak-2021-12-28</span></span><br><span class=\"line\">(DEV)[root@master02 .kube]<span class=\"comment\"># cp /etc/kubernetes/admin.conf ~/.kube/config</span></span><br><span class=\"line\"></span><br><span class=\"line\">(DEV)[root@master03 etc]<span class=\"comment\"># mv ~/.kube/config ~/.kube/config-bak-2021-12-28</span></span><br><span class=\"line\">(DEV)[root@master03 etc]<span class=\"comment\"># cp /etc/kubernetes/admin.conf ~/.kube/config</span></span><br></pre></td></tr></table></figure>\n\n","site":{"data":{}},"excerpt":"<h1 id=\"Kubesphere证书过期\"><a href=\"#Kubesphere证书过期\" class=\"headerlink\" title=\"Kubesphere证书过期\"></a>Kubesphere证书过期</h1><h3 id=\"概述\"><a href=\"#概述\" class=\"headerlink\" title=\"概述\"></a>概述</h3><p> 因为kubesphere的证书有效期只有一年，所以需要重新生成证书。</p>","more":"<h3 id=\"1-kubesphere证书过期现象\"><a href=\"#1-kubesphere证书过期现象\" class=\"headerlink\" title=\"1 kubesphere证书过期现象\"></a>1 kubesphere证书过期现象</h3><figure class=\"highlight perl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 使用kubectl命令的时候会提示证书过期</span></span><br><span class=\"line\">(DEV)[root@master01 ~]<span class=\"comment\"># kubectl get pods -n A</span></span><br><span class=\"line\">Unable to <span class=\"keyword\">connect</span> to the server: x509: certificate has expired <span class=\"keyword\">or</span> is <span class=\"keyword\">not</span> yet valid</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 检查证书有效期</span></span><br><span class=\"line\">(DEV)[root@master01 ~]<span class=\"comment\"># kubeadm alpha certs check-expiration</span></span><br><span class=\"line\">[check-expiration] Reading configuration from the cluster...</span><br><span class=\"line\">[check-expiration] FYI: You can look at this config file with <span class=\"string\">&#x27;kubectl -n kube-system get cm kubeadm-config -oyaml&#x27;</span></span><br><span class=\"line\">[check-expiration] Error reading configuration from the Cluster. Falling back to default configuration</span><br><span class=\"line\"></span><br><span class=\"line\">W1228 <span class=\"number\">10</span>:09:<span class=\"number\">37.193925</span>    <span class=\"number\">5469</span> configset.go:<span class=\"number\">202</span>] WARNING: kubeadm cannot validate component configs <span class=\"keyword\">for</span> API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io]</span><br><span class=\"line\">CERTIFICATE                         EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED</span><br><span class=\"line\">admin.conf                          Dec <span class=\"number\">27</span>, <span class=\"number\">2021</span> <span class=\"number\">10</span>:<span class=\"number\">22</span> UTC   &lt;invalid&gt;                               <span class=\"keyword\">no</span>      </span><br><span class=\"line\">apiserver                           Dec <span class=\"number\">27</span>, <span class=\"number\">2021</span> <span class=\"number\">10</span>:<span class=\"number\">22</span> UTC   &lt;invalid&gt;       ca                      <span class=\"keyword\">no</span>      </span><br><span class=\"line\">!MISSING! apiserver-etcd-client                                                                      </span><br><span class=\"line\">apiserver-kubelet-client            Dec <span class=\"number\">27</span>, <span class=\"number\">2021</span> <span class=\"number\">10</span>:<span class=\"number\">22</span> UTC   &lt;invalid&gt;       ca                      <span class=\"keyword\">no</span>      </span><br><span class=\"line\">controller-manager.conf             Dec <span class=\"number\">27</span>, <span class=\"number\">2021</span> <span class=\"number\">10</span>:<span class=\"number\">22</span> UTC   &lt;invalid&gt;                               <span class=\"keyword\">no</span>      </span><br><span class=\"line\">!MISSING! etcd-healthcheck-client                                                                    </span><br><span class=\"line\">!MISSING! etcd-peer                                                                                  </span><br><span class=\"line\">!MISSING! etcd-server                                                                                </span><br><span class=\"line\">front-proxy-client                  Dec <span class=\"number\">27</span>, <span class=\"number\">2021</span> <span class=\"number\">10</span>:<span class=\"number\">22</span> UTC   &lt;invalid&gt;       front-proxy-ca          <span class=\"keyword\">no</span>      </span><br><span class=\"line\">scheduler.conf                      Dec <span class=\"number\">27</span>, <span class=\"number\">2021</span> <span class=\"number\">10</span>:<span class=\"number\">22</span> UTC   &lt;invalid&gt;                               <span class=\"keyword\">no</span>      </span><br><span class=\"line\"></span><br><span class=\"line\">CERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED</span><br><span class=\"line\">ca                      Dec <span class=\"number\">25</span>, <span class=\"number\">2030</span> <span class=\"number\">10</span>:<span class=\"number\">22</span> UTC   <span class=\"number\">8</span><span class=\"keyword\">y</span>              <span class=\"keyword\">no</span>      </span><br><span class=\"line\">!MISSING! etcd-ca                                                </span><br><span class=\"line\">front-proxy-ca          Dec <span class=\"number\">25</span>, <span class=\"number\">2030</span> <span class=\"number\">10</span>:<span class=\"number\">22</span> UTC   <span class=\"number\">8</span><span class=\"keyword\">y</span>              <span class=\"keyword\">no</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-解决方法\"><a href=\"#2-解决方法\" class=\"headerlink\" title=\"2 解决方法\"></a>2 解决方法</h3><figure class=\"highlight perl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.重新生成证书</span></span><br><span class=\"line\"><span class=\"comment\"># 在master01上生成新的证书</span></span><br><span class=\"line\">(DEV)[root@master01 ~]<span class=\"comment\"># kubeadm alpha certs renew all</span></span><br><span class=\"line\">[renew] Reading configuration from the cluster...</span><br><span class=\"line\">[renew] FYI: You can look at this config file with <span class=\"string\">&#x27;kubectl -n kube-system get cm kubeadm-config -oyaml&#x27;</span></span><br><span class=\"line\">[renew] Error reading configuration from the Cluster. Falling back to default configuration</span><br><span class=\"line\"></span><br><span class=\"line\">W1228 <span class=\"number\">10</span>:<span class=\"number\">12</span>:<span class=\"number\">47.177137</span>   <span class=\"number\">10207</span> configset.go:<span class=\"number\">202</span>] WARNING: kubeadm cannot validate component configs <span class=\"keyword\">for</span> API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io]</span><br><span class=\"line\">certificate embedded in the kubeconfig file <span class=\"keyword\">for</span> the admin to <span class=\"keyword\">use</span> <span class=\"keyword\">and</span> <span class=\"keyword\">for</span> kubeadm itself renewed</span><br><span class=\"line\">certificate <span class=\"keyword\">for</span> serving the Kubernetes API renewed</span><br><span class=\"line\">MISSING! certificate the apiserver uses to access etcd</span><br><span class=\"line\">certificate <span class=\"keyword\">for</span> the API server to <span class=\"keyword\">connect</span> to kubelet renewed</span><br><span class=\"line\">certificate embedded in the kubeconfig file <span class=\"keyword\">for</span> the controller manager to <span class=\"keyword\">use</span> renewed</span><br><span class=\"line\">MISSING! certificate <span class=\"keyword\">for</span> liveness probes to healthcheck etcd</span><br><span class=\"line\">MISSING! certificate <span class=\"keyword\">for</span> etcd nodes to communicate with <span class=\"keyword\">each</span> other</span><br><span class=\"line\">MISSING! certificate <span class=\"keyword\">for</span> serving etcd</span><br><span class=\"line\">certificate <span class=\"keyword\">for</span> the front proxy client renewed</span><br><span class=\"line\">certificate embedded in the kubeconfig file <span class=\"keyword\">for</span> the scheduler manager to <span class=\"keyword\">use</span> renewed</span><br><span class=\"line\">(DEV)[root@master01 ~]<span class=\"comment\"># </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.将证书传到另外两个节点</span></span><br><span class=\"line\"><span class=\"comment\"># master02和master03先备份</span></span><br><span class=\"line\">(DEV)[root@master02 etc]<span class=\"comment\"># mv /etc/kubernetes /etc/kubernetes-bak-12-28</span></span><br><span class=\"line\">(DEV)[root@master03 etc]<span class=\"comment\"># mv /etc/kubernetes /etc/kubernetes-bak-12-28</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 将新生成的证书传到master02和master03</span></span><br><span class=\"line\">(DEV)[root@master01 etc]<span class=\"comment\"># scp -r kubernetes root@master02:/etc/</span></span><br><span class=\"line\">(DEV)[root@master01 etc]<span class=\"comment\"># scp -r kubernetes root@master03:/etc/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.重启ETCD</span></span><br><span class=\"line\"><span class=\"comment\"># 登录master01和master02以及master03</span></span><br><span class=\"line\">(DEV)[root@master01 etc]<span class=\"comment\"># docker ps|grep etcd</span></span><br><span class=\"line\">f306a918736b   <span class=\"number\">28</span>c771d7cfbf                           <span class=\"string\">&quot;/usr/local/bin/etcd&quot;</span>    <span class=\"number\">8</span> months ago   Up <span class=\"number\">8</span> months             etcd1</span><br><span class=\"line\">(DEV)[root@master01 etc]<span class=\"comment\"># docker restart f306a918736b</span></span><br><span class=\"line\">f306a918736b</span><br><span class=\"line\"></span><br><span class=\"line\">(DEV)[root@master02 etc]<span class=\"comment\"># docker ps |grep etcd</span></span><br><span class=\"line\"><span class=\"number\">11876</span>daa3de5   <span class=\"number\">30.23</span>.<span class=\"number\">8.56</span>:<span class=\"number\">5000</span>/kubesphere/etcd:v3.<span class=\"number\">3.12</span>                            <span class=\"string\">&quot;/usr/local/bin/etcd&quot;</span>    <span class=\"number\">8</span> months ago         Up <span class=\"number\">8</span> months                   etcd2</span><br><span class=\"line\">(DEV)[root@master02 etc]<span class=\"comment\"># docker restart 11876daa3de5</span></span><br><span class=\"line\"><span class=\"number\">11876</span>daa3de5</span><br><span class=\"line\"></span><br><span class=\"line\">(DEV)[root@master03 etc]<span class=\"comment\"># docker ps|grep etcd</span></span><br><span class=\"line\"><span class=\"number\">3</span>a9ad934353b   <span class=\"number\">30.23</span>.<span class=\"number\">8.56</span>:<span class=\"number\">5000</span>/kubesphere/etcd:v3.<span class=\"number\">3.12</span>                 <span class=\"string\">&quot;/usr/local/bin/etcd&quot;</span>    <span class=\"number\">7</span> seconds ago        Restarting (<span class=\"number\">2</span>) Less than a second ago             etcd3</span><br><span class=\"line\">(DEV)[root@master03 etc]<span class=\"comment\"># docker restart 3a9ad934353b</span></span><br><span class=\"line\"><span class=\"number\">3</span>a9ad934353b</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.生成新的config文件</span></span><br><span class=\"line\"><span class=\"comment\"># 不进行替换的话，kubectl的命令还是使用不了会提示如下错误。</span></span><br><span class=\"line\">(DEV)[root@master01 ~]<span class=\"comment\"># kubectl get pods -n hbp</span></span><br><span class=\"line\">Unable to <span class=\"keyword\">connect</span> to the server: x509: certificate has expired <span class=\"keyword\">or</span> is <span class=\"keyword\">not</span> yet valid</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 登录master01和master02以及master03</span></span><br><span class=\"line\">(DEV)[root@master01 .kube]<span class=\"comment\"># mv ~/.kube/config ~/.kube/config-bak-2021-12-28</span></span><br><span class=\"line\">(DEV)[root@master01 .kube]<span class=\"comment\"># cp /etc/kubernetes/admin.conf ~/.kube/config</span></span><br><span class=\"line\"></span><br><span class=\"line\">(DEV)[root@master02 .kube]<span class=\"comment\"># mv ~/.kube/config ~/.kube/config-bak-2021-12-28</span></span><br><span class=\"line\">(DEV)[root@master02 .kube]<span class=\"comment\"># cp /etc/kubernetes/admin.conf ~/.kube/config</span></span><br><span class=\"line\"></span><br><span class=\"line\">(DEV)[root@master03 etc]<span class=\"comment\"># mv ~/.kube/config ~/.kube/config-bak-2021-12-28</span></span><br><span class=\"line\">(DEV)[root@master03 etc]<span class=\"comment\"># cp /etc/kubernetes/admin.conf ~/.kube/config</span></span><br></pre></td></tr></table></figure>"},{"title":"Zookeeper集群部署","date":"2022-12-29T02:17:48.000Z","_content":"\n# Zookeeper集群部署\n\n## 1 云硬盘挂载\n\n<!--more-->\n\n```\n# 查看挂盘名称\nfdisk -l\n\n# 创建物理卷\npvcreate /dev/vdb\n\n# 创建卷组\nvgcreate data_vg /dev/vdb\n\n# 创建逻辑卷\nlvcreate -l +100%free -n data data_vg\n\n# 格式化磁盘\nmkfs.xfs /dev/data_vg/data\n\n# 创建挂载目录\nmkdir -p /data1\n\n# 挂载\nmount /dev/data_vg/data /data1\n\n# 添加挂载信息\necho \"/dev/mapper/data_vg-data /data1 xfs     defaults        0 0\" >> /etc/fstab\n\n```\n\n\n\n## 2 安装Java\n\n### 2.1 检查系统是否安装了JAVA\n\n如果有以下输出，则表示已安装\n\n```\nrpm -qa | grep java\n\njava-1.8.0-openjdk-headless-1.8.0.272.b10-1.el7_9.x86_64\ntzdata-java-2020d-2.el7.noarch\npython-javapackages-3.4.1-11.el7.noarch\njava-1.8.0-openjdk-1.8.0.272.b10-1.el7_9.x86_64\njavapackages-tools-3.4.1-11.el7.noarch\n```\n\n需要进行卸载操作\n\n```\nrpm -e java-1.8.0-openjdk-1.8.0.272.b10-1.el7_9.x86_64\nrpm -e java-1.8.0-openjdk-headless-1.8.0.272.b10-1.el7_9.x86_64\nrpm -e javapackages-tools-3.4.1-11.el7.noarch\n```\n\n### 2.2 解压JAVA安装包\n\n```\ntar -zxf /usr/local/java-1.8.0.tar.gz -C /usr/local\n```\n\n### 2.3 配置JAVA环境变量\n\n```\n# 在/etc/profile，追加JAVA_HOME和PATH两个变量。\n\nvi /etc/profile\nexport JAVA_HOME=/usr/local/java-1.8.0\nexport PATH=$JAVA_HOME/bin:$PATH\n```\n\n### 2.4 检查JAVA安装\n\n```\n# 使环境变量生效，然后检查Java版本\n\nsource /etc/profile\njava -version\n```\n\n## 3 安装zookeeper\n\n```\n# 解压安装好的包\ntar -zxf /usr/local/apache-zookeeper-3.5.8-bin.tar.gz -C /usr/local/\nmv /usr/local/apache-zookeeper-3.5.8-bin /usr/local/apache-zookeeper-3.5.8\n\n# 新建数据目录\nmkdir -p /data1/zookeeper/{data,logs}\n\n# 修改配置文件\n# 10.8.132.22配置为1\n# 10.8.132.23配置为2\n# 10.8.132.24配置为3\necho \"1\">/data1/zookeeper/data/myid\n\nvi /usr/local/apache-zookeeper-3.5.8/conf/zoo.cfg\n\nclientPort=2181\ndataDir=/data1/zookeeper/data\ndataLogDir=/data1/zookeeper/logs\ntickTime=2000\ninitLimit=10\nsyncLimit=5\nmaxClientCnxns=10000\nminSessionTimeout=4000\nmaxSessionTimeout=40000\nautopurge.snapRetainCount=3\nautopurge.purgeInterval=12\nserver.1=10.8.132.22:2888:3888\nserver.2=10.8.132.23:2888:3888\nserver.3=10.8.132.24:2888:3888\n\n# 编辑启动脚本\nvi /usr/local/apache-zookeeper-3.5.8/monitor.sh\n\n#!/bin/bash\n\nsource /etc/profile\n\ncur_path=$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\n\nfunction log_info(){\n\techo \"[INFO] [$(date \"+%Y-%m-%d %T\")] $1\"\n}\n\nfunction log_error(){\n\techo \"[ERROR] [$(date \"+%Y-%m-%d %T\")] $1\"\n\texit 1\n}\n\nfunction check_status(){\n\tpids=$(ps -ef|grep java|grep apache-zookeeper-3.5.8|awk '{print $2}')\n\n\tif [[ -n ${pids} ]];then\n\t\techo \"True\"\n\telse \n\t\techo \"False\"\n\tfi\n}\n\nfunction stop(){\n\tlog_info \"${FUNCNAME[0]} begin.\"\n\n\tpids=$(ps -ef|grep java|grep apache-zookeeper-3.5.8|awk '{print $2}')\n\t\n\tlog_info \"kill pid ${pids} begin.\"\n\tif [[ -n ${pids} ]];then\n\t\tlog_info \"process exist,kill it ${pids}!\"\n\t\tfor i in ${pids}\n\t\tdo\n\t\t\tlog_info \"kill process $i!\"\n\t\t\tkill -9 $i\n\t\tdone\n\telse\n\t\tlog_info \"process not exist!\"\n\n\tfi\n\tlog_info \"kill pid ${pids} end.\"\n\n\tlog_info \"${FUNCNAME[0]} end.\"\n}\n\nfunction start(){\n\tlog_info \"${FUNCTION[0]} begin.\"\n\n\tif [[ $(check_status $node) == \"True\" ]];then\n\t\tlog_info \"process is exist, not need to start!\"\n\telse\n\t\tlog_info \"start zookeeper begin.\"\n\n\t\t/usr/local/apache-zookeeper-3.5.8/bin/zkServer.sh start\n\n\t\tlog_info \"start zookeeper success.\"\n\tfi\n\n\tlog_info \"${FUNCTION[0]} complete.\"\n}\n\nfunction restart(){\n\tlog_info \"${FUNCTION[0]} begin.\"\n\n\tstop\n\n\tsleep 5\n\n\tstart\n\n\tlog_info \"${FUNCTION[0]} end.\"\n}\n\nfunction main(){\n\tlog_info \"${FUNCTION[0]} begin.\"\n\n\tACTION=\"$1\"\n\n\tcase \"${ACTION}\" in\n\t    start)\n            start\n\t    ;;\n            stop)\n            stop\n            ;;\n\t    restart)\n            restart\n            ;;\n\t    *)\n            usage\n            ;;\n            esac\n\n\tlog_info \"${FUNCTION[0]} complete.\"\n}\n\nmain \"$@\"\n\n# 修改权限\nchmod a+x /usr/local/apache-zookeeper-3.5.8/monitor.sh\n\n# 启动\nsh /usr/local/apache-zookeeper-3.5.8/monitor.sh start\n\n# 查看进程\njps\n\n# 将健康检查加入crontab\nvi /etc/crontab\n\n*/1 * * * * root /usr/local/apache-zookeeper-3.5.8/monitor.sh start >/dev/null 2>&1\n\n# 重启crontab\nsystemctl restart crond\n```\n\n","source":"_posts/Zookeeper集群部署.md","raw":"---\ntitle: Zookeeper集群部署\ndate: 2022-12-29 10:17:48\ntags: Zookeeper\n---\n\n# Zookeeper集群部署\n\n## 1 云硬盘挂载\n\n<!--more-->\n\n```\n# 查看挂盘名称\nfdisk -l\n\n# 创建物理卷\npvcreate /dev/vdb\n\n# 创建卷组\nvgcreate data_vg /dev/vdb\n\n# 创建逻辑卷\nlvcreate -l +100%free -n data data_vg\n\n# 格式化磁盘\nmkfs.xfs /dev/data_vg/data\n\n# 创建挂载目录\nmkdir -p /data1\n\n# 挂载\nmount /dev/data_vg/data /data1\n\n# 添加挂载信息\necho \"/dev/mapper/data_vg-data /data1 xfs     defaults        0 0\" >> /etc/fstab\n\n```\n\n\n\n## 2 安装Java\n\n### 2.1 检查系统是否安装了JAVA\n\n如果有以下输出，则表示已安装\n\n```\nrpm -qa | grep java\n\njava-1.8.0-openjdk-headless-1.8.0.272.b10-1.el7_9.x86_64\ntzdata-java-2020d-2.el7.noarch\npython-javapackages-3.4.1-11.el7.noarch\njava-1.8.0-openjdk-1.8.0.272.b10-1.el7_9.x86_64\njavapackages-tools-3.4.1-11.el7.noarch\n```\n\n需要进行卸载操作\n\n```\nrpm -e java-1.8.0-openjdk-1.8.0.272.b10-1.el7_9.x86_64\nrpm -e java-1.8.0-openjdk-headless-1.8.0.272.b10-1.el7_9.x86_64\nrpm -e javapackages-tools-3.4.1-11.el7.noarch\n```\n\n### 2.2 解压JAVA安装包\n\n```\ntar -zxf /usr/local/java-1.8.0.tar.gz -C /usr/local\n```\n\n### 2.3 配置JAVA环境变量\n\n```\n# 在/etc/profile，追加JAVA_HOME和PATH两个变量。\n\nvi /etc/profile\nexport JAVA_HOME=/usr/local/java-1.8.0\nexport PATH=$JAVA_HOME/bin:$PATH\n```\n\n### 2.4 检查JAVA安装\n\n```\n# 使环境变量生效，然后检查Java版本\n\nsource /etc/profile\njava -version\n```\n\n## 3 安装zookeeper\n\n```\n# 解压安装好的包\ntar -zxf /usr/local/apache-zookeeper-3.5.8-bin.tar.gz -C /usr/local/\nmv /usr/local/apache-zookeeper-3.5.8-bin /usr/local/apache-zookeeper-3.5.8\n\n# 新建数据目录\nmkdir -p /data1/zookeeper/{data,logs}\n\n# 修改配置文件\n# 10.8.132.22配置为1\n# 10.8.132.23配置为2\n# 10.8.132.24配置为3\necho \"1\">/data1/zookeeper/data/myid\n\nvi /usr/local/apache-zookeeper-3.5.8/conf/zoo.cfg\n\nclientPort=2181\ndataDir=/data1/zookeeper/data\ndataLogDir=/data1/zookeeper/logs\ntickTime=2000\ninitLimit=10\nsyncLimit=5\nmaxClientCnxns=10000\nminSessionTimeout=4000\nmaxSessionTimeout=40000\nautopurge.snapRetainCount=3\nautopurge.purgeInterval=12\nserver.1=10.8.132.22:2888:3888\nserver.2=10.8.132.23:2888:3888\nserver.3=10.8.132.24:2888:3888\n\n# 编辑启动脚本\nvi /usr/local/apache-zookeeper-3.5.8/monitor.sh\n\n#!/bin/bash\n\nsource /etc/profile\n\ncur_path=$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\n\nfunction log_info(){\n\techo \"[INFO] [$(date \"+%Y-%m-%d %T\")] $1\"\n}\n\nfunction log_error(){\n\techo \"[ERROR] [$(date \"+%Y-%m-%d %T\")] $1\"\n\texit 1\n}\n\nfunction check_status(){\n\tpids=$(ps -ef|grep java|grep apache-zookeeper-3.5.8|awk '{print $2}')\n\n\tif [[ -n ${pids} ]];then\n\t\techo \"True\"\n\telse \n\t\techo \"False\"\n\tfi\n}\n\nfunction stop(){\n\tlog_info \"${FUNCNAME[0]} begin.\"\n\n\tpids=$(ps -ef|grep java|grep apache-zookeeper-3.5.8|awk '{print $2}')\n\t\n\tlog_info \"kill pid ${pids} begin.\"\n\tif [[ -n ${pids} ]];then\n\t\tlog_info \"process exist,kill it ${pids}!\"\n\t\tfor i in ${pids}\n\t\tdo\n\t\t\tlog_info \"kill process $i!\"\n\t\t\tkill -9 $i\n\t\tdone\n\telse\n\t\tlog_info \"process not exist!\"\n\n\tfi\n\tlog_info \"kill pid ${pids} end.\"\n\n\tlog_info \"${FUNCNAME[0]} end.\"\n}\n\nfunction start(){\n\tlog_info \"${FUNCTION[0]} begin.\"\n\n\tif [[ $(check_status $node) == \"True\" ]];then\n\t\tlog_info \"process is exist, not need to start!\"\n\telse\n\t\tlog_info \"start zookeeper begin.\"\n\n\t\t/usr/local/apache-zookeeper-3.5.8/bin/zkServer.sh start\n\n\t\tlog_info \"start zookeeper success.\"\n\tfi\n\n\tlog_info \"${FUNCTION[0]} complete.\"\n}\n\nfunction restart(){\n\tlog_info \"${FUNCTION[0]} begin.\"\n\n\tstop\n\n\tsleep 5\n\n\tstart\n\n\tlog_info \"${FUNCTION[0]} end.\"\n}\n\nfunction main(){\n\tlog_info \"${FUNCTION[0]} begin.\"\n\n\tACTION=\"$1\"\n\n\tcase \"${ACTION}\" in\n\t    start)\n            start\n\t    ;;\n            stop)\n            stop\n            ;;\n\t    restart)\n            restart\n            ;;\n\t    *)\n            usage\n            ;;\n            esac\n\n\tlog_info \"${FUNCTION[0]} complete.\"\n}\n\nmain \"$@\"\n\n# 修改权限\nchmod a+x /usr/local/apache-zookeeper-3.5.8/monitor.sh\n\n# 启动\nsh /usr/local/apache-zookeeper-3.5.8/monitor.sh start\n\n# 查看进程\njps\n\n# 将健康检查加入crontab\nvi /etc/crontab\n\n*/1 * * * * root /usr/local/apache-zookeeper-3.5.8/monitor.sh start >/dev/null 2>&1\n\n# 重启crontab\nsystemctl restart crond\n```\n\n","slug":"Zookeeper集群部署","published":1,"updated":"2023-01-03T06:17:51.244Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clcfuykym00033wrsbuf6de01","content":"<h1 id=\"Zookeeper集群部署\"><a href=\"#Zookeeper集群部署\" class=\"headerlink\" title=\"Zookeeper集群部署\"></a>Zookeeper集群部署</h1><h2 id=\"1-云硬盘挂载\"><a href=\"#1-云硬盘挂载\" class=\"headerlink\" title=\"1 云硬盘挂载\"></a>1 云硬盘挂载</h2><span id=\"more\"></span>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 查看挂盘名称</span><br><span class=\"line\">fdisk -l</span><br><span class=\"line\"></span><br><span class=\"line\"># 创建物理卷</span><br><span class=\"line\">pvcreate /dev/vdb</span><br><span class=\"line\"></span><br><span class=\"line\"># 创建卷组</span><br><span class=\"line\">vgcreate data_vg /dev/vdb</span><br><span class=\"line\"></span><br><span class=\"line\"># 创建逻辑卷</span><br><span class=\"line\">lvcreate -l +100%free -n data data_vg</span><br><span class=\"line\"></span><br><span class=\"line\"># 格式化磁盘</span><br><span class=\"line\">mkfs.xfs /dev/data_vg/data</span><br><span class=\"line\"></span><br><span class=\"line\"># 创建挂载目录</span><br><span class=\"line\">mkdir -p /data1</span><br><span class=\"line\"></span><br><span class=\"line\"># 挂载</span><br><span class=\"line\">mount /dev/data_vg/data /data1</span><br><span class=\"line\"></span><br><span class=\"line\"># 添加挂载信息</span><br><span class=\"line\">echo &quot;/dev/mapper/data_vg-data /data1 xfs     defaults        0 0&quot; &gt;&gt; /etc/fstab</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"2-安装Java\"><a href=\"#2-安装Java\" class=\"headerlink\" title=\"2 安装Java\"></a>2 安装Java</h2><h3 id=\"2-1-检查系统是否安装了JAVA\"><a href=\"#2-1-检查系统是否安装了JAVA\" class=\"headerlink\" title=\"2.1 检查系统是否安装了JAVA\"></a>2.1 检查系统是否安装了JAVA</h3><p>如果有以下输出，则表示已安装</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rpm -qa | grep java</span><br><span class=\"line\"></span><br><span class=\"line\">java-1.8.0-openjdk-headless-1.8.0.272.b10-1.el7_9.x86_64</span><br><span class=\"line\">tzdata-java-2020d-2.el7.noarch</span><br><span class=\"line\">python-javapackages-3.4.1-11.el7.noarch</span><br><span class=\"line\">java-1.8.0-openjdk-1.8.0.272.b10-1.el7_9.x86_64</span><br><span class=\"line\">javapackages-tools-3.4.1-11.el7.noarch</span><br></pre></td></tr></table></figure>\n\n<p>需要进行卸载操作</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rpm -e java-1.8.0-openjdk-1.8.0.272.b10-1.el7_9.x86_64</span><br><span class=\"line\">rpm -e java-1.8.0-openjdk-headless-1.8.0.272.b10-1.el7_9.x86_64</span><br><span class=\"line\">rpm -e javapackages-tools-3.4.1-11.el7.noarch</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-2-解压JAVA安装包\"><a href=\"#2-2-解压JAVA安装包\" class=\"headerlink\" title=\"2.2 解压JAVA安装包\"></a>2.2 解压JAVA安装包</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tar -zxf /usr/local/java-1.8.0.tar.gz -C /usr/local</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-3-配置JAVA环境变量\"><a href=\"#2-3-配置JAVA环境变量\" class=\"headerlink\" title=\"2.3 配置JAVA环境变量\"></a>2.3 配置JAVA环境变量</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 在/etc/profile，追加JAVA_HOME和PATH两个变量。</span><br><span class=\"line\"></span><br><span class=\"line\">vi /etc/profile</span><br><span class=\"line\">export JAVA_HOME=/usr/local/java-1.8.0</span><br><span class=\"line\">export PATH=$JAVA_HOME/bin:$PATH</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-4-检查JAVA安装\"><a href=\"#2-4-检查JAVA安装\" class=\"headerlink\" title=\"2.4 检查JAVA安装\"></a>2.4 检查JAVA安装</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 使环境变量生效，然后检查Java版本</span><br><span class=\"line\"></span><br><span class=\"line\">source /etc/profile</span><br><span class=\"line\">java -version</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-安装zookeeper\"><a href=\"#3-安装zookeeper\" class=\"headerlink\" title=\"3 安装zookeeper\"></a>3 安装zookeeper</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 解压安装好的包</span><br><span class=\"line\">tar -zxf /usr/local/apache-zookeeper-3.5.8-bin.tar.gz -C /usr/local/</span><br><span class=\"line\">mv /usr/local/apache-zookeeper-3.5.8-bin /usr/local/apache-zookeeper-3.5.8</span><br><span class=\"line\"></span><br><span class=\"line\"># 新建数据目录</span><br><span class=\"line\">mkdir -p /data1/zookeeper/&#123;data,logs&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 修改配置文件</span><br><span class=\"line\"># 10.8.132.22配置为1</span><br><span class=\"line\"># 10.8.132.23配置为2</span><br><span class=\"line\"># 10.8.132.24配置为3</span><br><span class=\"line\">echo &quot;1&quot;&gt;/data1/zookeeper/data/myid</span><br><span class=\"line\"></span><br><span class=\"line\">vi /usr/local/apache-zookeeper-3.5.8/conf/zoo.cfg</span><br><span class=\"line\"></span><br><span class=\"line\">clientPort=2181</span><br><span class=\"line\">dataDir=/data1/zookeeper/data</span><br><span class=\"line\">dataLogDir=/data1/zookeeper/logs</span><br><span class=\"line\">tickTime=2000</span><br><span class=\"line\">initLimit=10</span><br><span class=\"line\">syncLimit=5</span><br><span class=\"line\">maxClientCnxns=10000</span><br><span class=\"line\">minSessionTimeout=4000</span><br><span class=\"line\">maxSessionTimeout=40000</span><br><span class=\"line\">autopurge.snapRetainCount=3</span><br><span class=\"line\">autopurge.purgeInterval=12</span><br><span class=\"line\">server.1=10.8.132.22:2888:3888</span><br><span class=\"line\">server.2=10.8.132.23:2888:3888</span><br><span class=\"line\">server.3=10.8.132.24:2888:3888</span><br><span class=\"line\"></span><br><span class=\"line\"># 编辑启动脚本</span><br><span class=\"line\">vi /usr/local/apache-zookeeper-3.5.8/monitor.sh</span><br><span class=\"line\"></span><br><span class=\"line\">#!/bin/bash</span><br><span class=\"line\"></span><br><span class=\"line\">source /etc/profile</span><br><span class=\"line\"></span><br><span class=\"line\">cur_path=$(cd &quot;$(dirname &quot;$&#123;BASH_SOURCE[0]&#125;&quot;)&quot; &amp;&amp; pwd)</span><br><span class=\"line\"></span><br><span class=\"line\">function log_info()&#123;</span><br><span class=\"line\">\techo &quot;[INFO] [$(date &quot;+%Y-%m-%d %T&quot;)] $1&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function log_error()&#123;</span><br><span class=\"line\">\techo &quot;[ERROR] [$(date &quot;+%Y-%m-%d %T&quot;)] $1&quot;</span><br><span class=\"line\">\texit 1</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function check_status()&#123;</span><br><span class=\"line\">\tpids=$(ps -ef|grep java|grep apache-zookeeper-3.5.8|awk &#x27;&#123;print $2&#125;&#x27;)</span><br><span class=\"line\"></span><br><span class=\"line\">\tif [[ -n $&#123;pids&#125; ]];then</span><br><span class=\"line\">\t\techo &quot;True&quot;</span><br><span class=\"line\">\telse </span><br><span class=\"line\">\t\techo &quot;False&quot;</span><br><span class=\"line\">\tfi</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function stop()&#123;</span><br><span class=\"line\">\tlog_info &quot;$&#123;FUNCNAME[0]&#125; begin.&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpids=$(ps -ef|grep java|grep apache-zookeeper-3.5.8|awk &#x27;&#123;print $2&#125;&#x27;)</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tlog_info &quot;kill pid $&#123;pids&#125; begin.&quot;</span><br><span class=\"line\">\tif [[ -n $&#123;pids&#125; ]];then</span><br><span class=\"line\">\t\tlog_info &quot;process exist,kill it $&#123;pids&#125;!&quot;</span><br><span class=\"line\">\t\tfor i in $&#123;pids&#125;</span><br><span class=\"line\">\t\tdo</span><br><span class=\"line\">\t\t\tlog_info &quot;kill process $i!&quot;</span><br><span class=\"line\">\t\t\tkill -9 $i</span><br><span class=\"line\">\t\tdone</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t\tlog_info &quot;process not exist!&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\tfi</span><br><span class=\"line\">\tlog_info &quot;kill pid $&#123;pids&#125; end.&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\tlog_info &quot;$&#123;FUNCNAME[0]&#125; end.&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function start()&#123;</span><br><span class=\"line\">\tlog_info &quot;$&#123;FUNCTION[0]&#125; begin.&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\tif [[ $(check_status $node) == &quot;True&quot; ]];then</span><br><span class=\"line\">\t\tlog_info &quot;process is exist, not need to start!&quot;</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t\tlog_info &quot;start zookeeper begin.&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t/usr/local/apache-zookeeper-3.5.8/bin/zkServer.sh start</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tlog_info &quot;start zookeeper success.&quot;</span><br><span class=\"line\">\tfi</span><br><span class=\"line\"></span><br><span class=\"line\">\tlog_info &quot;$&#123;FUNCTION[0]&#125; complete.&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function restart()&#123;</span><br><span class=\"line\">\tlog_info &quot;$&#123;FUNCTION[0]&#125; begin.&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\tstop</span><br><span class=\"line\"></span><br><span class=\"line\">\tsleep 5</span><br><span class=\"line\"></span><br><span class=\"line\">\tstart</span><br><span class=\"line\"></span><br><span class=\"line\">\tlog_info &quot;$&#123;FUNCTION[0]&#125; end.&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function main()&#123;</span><br><span class=\"line\">\tlog_info &quot;$&#123;FUNCTION[0]&#125; begin.&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\tACTION=&quot;$1&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\tcase &quot;$&#123;ACTION&#125;&quot; in</span><br><span class=\"line\">\t    start)</span><br><span class=\"line\">            start</span><br><span class=\"line\">\t    ;;</span><br><span class=\"line\">            stop)</span><br><span class=\"line\">            stop</span><br><span class=\"line\">            ;;</span><br><span class=\"line\">\t    restart)</span><br><span class=\"line\">            restart</span><br><span class=\"line\">            ;;</span><br><span class=\"line\">\t    *)</span><br><span class=\"line\">            usage</span><br><span class=\"line\">            ;;</span><br><span class=\"line\">            esac</span><br><span class=\"line\"></span><br><span class=\"line\">\tlog_info &quot;$&#123;FUNCTION[0]&#125; complete.&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">main &quot;$@&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"># 修改权限</span><br><span class=\"line\">chmod a+x /usr/local/apache-zookeeper-3.5.8/monitor.sh</span><br><span class=\"line\"></span><br><span class=\"line\"># 启动</span><br><span class=\"line\">sh /usr/local/apache-zookeeper-3.5.8/monitor.sh start</span><br><span class=\"line\"></span><br><span class=\"line\"># 查看进程</span><br><span class=\"line\">jps</span><br><span class=\"line\"></span><br><span class=\"line\"># 将健康检查加入crontab</span><br><span class=\"line\">vi /etc/crontab</span><br><span class=\"line\"></span><br><span class=\"line\">*/1 * * * * root /usr/local/apache-zookeeper-3.5.8/monitor.sh start &gt;/dev/null 2&gt;&amp;1</span><br><span class=\"line\"></span><br><span class=\"line\"># 重启crontab</span><br><span class=\"line\">systemctl restart crond</span><br></pre></td></tr></table></figure>\n\n","site":{"data":{}},"excerpt":"<h1 id=\"Zookeeper集群部署\"><a href=\"#Zookeeper集群部署\" class=\"headerlink\" title=\"Zookeeper集群部署\"></a>Zookeeper集群部署</h1><h2 id=\"1-云硬盘挂载\"><a href=\"#1-云硬盘挂载\" class=\"headerlink\" title=\"1 云硬盘挂载\"></a>1 云硬盘挂载</h2>","more":"<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 查看挂盘名称</span><br><span class=\"line\">fdisk -l</span><br><span class=\"line\"></span><br><span class=\"line\"># 创建物理卷</span><br><span class=\"line\">pvcreate /dev/vdb</span><br><span class=\"line\"></span><br><span class=\"line\"># 创建卷组</span><br><span class=\"line\">vgcreate data_vg /dev/vdb</span><br><span class=\"line\"></span><br><span class=\"line\"># 创建逻辑卷</span><br><span class=\"line\">lvcreate -l +100%free -n data data_vg</span><br><span class=\"line\"></span><br><span class=\"line\"># 格式化磁盘</span><br><span class=\"line\">mkfs.xfs /dev/data_vg/data</span><br><span class=\"line\"></span><br><span class=\"line\"># 创建挂载目录</span><br><span class=\"line\">mkdir -p /data1</span><br><span class=\"line\"></span><br><span class=\"line\"># 挂载</span><br><span class=\"line\">mount /dev/data_vg/data /data1</span><br><span class=\"line\"></span><br><span class=\"line\"># 添加挂载信息</span><br><span class=\"line\">echo &quot;/dev/mapper/data_vg-data /data1 xfs     defaults        0 0&quot; &gt;&gt; /etc/fstab</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"2-安装Java\"><a href=\"#2-安装Java\" class=\"headerlink\" title=\"2 安装Java\"></a>2 安装Java</h2><h3 id=\"2-1-检查系统是否安装了JAVA\"><a href=\"#2-1-检查系统是否安装了JAVA\" class=\"headerlink\" title=\"2.1 检查系统是否安装了JAVA\"></a>2.1 检查系统是否安装了JAVA</h3><p>如果有以下输出，则表示已安装</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rpm -qa | grep java</span><br><span class=\"line\"></span><br><span class=\"line\">java-1.8.0-openjdk-headless-1.8.0.272.b10-1.el7_9.x86_64</span><br><span class=\"line\">tzdata-java-2020d-2.el7.noarch</span><br><span class=\"line\">python-javapackages-3.4.1-11.el7.noarch</span><br><span class=\"line\">java-1.8.0-openjdk-1.8.0.272.b10-1.el7_9.x86_64</span><br><span class=\"line\">javapackages-tools-3.4.1-11.el7.noarch</span><br></pre></td></tr></table></figure>\n\n<p>需要进行卸载操作</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rpm -e java-1.8.0-openjdk-1.8.0.272.b10-1.el7_9.x86_64</span><br><span class=\"line\">rpm -e java-1.8.0-openjdk-headless-1.8.0.272.b10-1.el7_9.x86_64</span><br><span class=\"line\">rpm -e javapackages-tools-3.4.1-11.el7.noarch</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-2-解压JAVA安装包\"><a href=\"#2-2-解压JAVA安装包\" class=\"headerlink\" title=\"2.2 解压JAVA安装包\"></a>2.2 解压JAVA安装包</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tar -zxf /usr/local/java-1.8.0.tar.gz -C /usr/local</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-3-配置JAVA环境变量\"><a href=\"#2-3-配置JAVA环境变量\" class=\"headerlink\" title=\"2.3 配置JAVA环境变量\"></a>2.3 配置JAVA环境变量</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 在/etc/profile，追加JAVA_HOME和PATH两个变量。</span><br><span class=\"line\"></span><br><span class=\"line\">vi /etc/profile</span><br><span class=\"line\">export JAVA_HOME=/usr/local/java-1.8.0</span><br><span class=\"line\">export PATH=$JAVA_HOME/bin:$PATH</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-4-检查JAVA安装\"><a href=\"#2-4-检查JAVA安装\" class=\"headerlink\" title=\"2.4 检查JAVA安装\"></a>2.4 检查JAVA安装</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 使环境变量生效，然后检查Java版本</span><br><span class=\"line\"></span><br><span class=\"line\">source /etc/profile</span><br><span class=\"line\">java -version</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-安装zookeeper\"><a href=\"#3-安装zookeeper\" class=\"headerlink\" title=\"3 安装zookeeper\"></a>3 安装zookeeper</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 解压安装好的包</span><br><span class=\"line\">tar -zxf /usr/local/apache-zookeeper-3.5.8-bin.tar.gz -C /usr/local/</span><br><span class=\"line\">mv /usr/local/apache-zookeeper-3.5.8-bin /usr/local/apache-zookeeper-3.5.8</span><br><span class=\"line\"></span><br><span class=\"line\"># 新建数据目录</span><br><span class=\"line\">mkdir -p /data1/zookeeper/&#123;data,logs&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 修改配置文件</span><br><span class=\"line\"># 10.8.132.22配置为1</span><br><span class=\"line\"># 10.8.132.23配置为2</span><br><span class=\"line\"># 10.8.132.24配置为3</span><br><span class=\"line\">echo &quot;1&quot;&gt;/data1/zookeeper/data/myid</span><br><span class=\"line\"></span><br><span class=\"line\">vi /usr/local/apache-zookeeper-3.5.8/conf/zoo.cfg</span><br><span class=\"line\"></span><br><span class=\"line\">clientPort=2181</span><br><span class=\"line\">dataDir=/data1/zookeeper/data</span><br><span class=\"line\">dataLogDir=/data1/zookeeper/logs</span><br><span class=\"line\">tickTime=2000</span><br><span class=\"line\">initLimit=10</span><br><span class=\"line\">syncLimit=5</span><br><span class=\"line\">maxClientCnxns=10000</span><br><span class=\"line\">minSessionTimeout=4000</span><br><span class=\"line\">maxSessionTimeout=40000</span><br><span class=\"line\">autopurge.snapRetainCount=3</span><br><span class=\"line\">autopurge.purgeInterval=12</span><br><span class=\"line\">server.1=10.8.132.22:2888:3888</span><br><span class=\"line\">server.2=10.8.132.23:2888:3888</span><br><span class=\"line\">server.3=10.8.132.24:2888:3888</span><br><span class=\"line\"></span><br><span class=\"line\"># 编辑启动脚本</span><br><span class=\"line\">vi /usr/local/apache-zookeeper-3.5.8/monitor.sh</span><br><span class=\"line\"></span><br><span class=\"line\">#!/bin/bash</span><br><span class=\"line\"></span><br><span class=\"line\">source /etc/profile</span><br><span class=\"line\"></span><br><span class=\"line\">cur_path=$(cd &quot;$(dirname &quot;$&#123;BASH_SOURCE[0]&#125;&quot;)&quot; &amp;&amp; pwd)</span><br><span class=\"line\"></span><br><span class=\"line\">function log_info()&#123;</span><br><span class=\"line\">\techo &quot;[INFO] [$(date &quot;+%Y-%m-%d %T&quot;)] $1&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function log_error()&#123;</span><br><span class=\"line\">\techo &quot;[ERROR] [$(date &quot;+%Y-%m-%d %T&quot;)] $1&quot;</span><br><span class=\"line\">\texit 1</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function check_status()&#123;</span><br><span class=\"line\">\tpids=$(ps -ef|grep java|grep apache-zookeeper-3.5.8|awk &#x27;&#123;print $2&#125;&#x27;)</span><br><span class=\"line\"></span><br><span class=\"line\">\tif [[ -n $&#123;pids&#125; ]];then</span><br><span class=\"line\">\t\techo &quot;True&quot;</span><br><span class=\"line\">\telse </span><br><span class=\"line\">\t\techo &quot;False&quot;</span><br><span class=\"line\">\tfi</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function stop()&#123;</span><br><span class=\"line\">\tlog_info &quot;$&#123;FUNCNAME[0]&#125; begin.&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\tpids=$(ps -ef|grep java|grep apache-zookeeper-3.5.8|awk &#x27;&#123;print $2&#125;&#x27;)</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tlog_info &quot;kill pid $&#123;pids&#125; begin.&quot;</span><br><span class=\"line\">\tif [[ -n $&#123;pids&#125; ]];then</span><br><span class=\"line\">\t\tlog_info &quot;process exist,kill it $&#123;pids&#125;!&quot;</span><br><span class=\"line\">\t\tfor i in $&#123;pids&#125;</span><br><span class=\"line\">\t\tdo</span><br><span class=\"line\">\t\t\tlog_info &quot;kill process $i!&quot;</span><br><span class=\"line\">\t\t\tkill -9 $i</span><br><span class=\"line\">\t\tdone</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t\tlog_info &quot;process not exist!&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\tfi</span><br><span class=\"line\">\tlog_info &quot;kill pid $&#123;pids&#125; end.&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\tlog_info &quot;$&#123;FUNCNAME[0]&#125; end.&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function start()&#123;</span><br><span class=\"line\">\tlog_info &quot;$&#123;FUNCTION[0]&#125; begin.&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\tif [[ $(check_status $node) == &quot;True&quot; ]];then</span><br><span class=\"line\">\t\tlog_info &quot;process is exist, not need to start!&quot;</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t\tlog_info &quot;start zookeeper begin.&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t/usr/local/apache-zookeeper-3.5.8/bin/zkServer.sh start</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tlog_info &quot;start zookeeper success.&quot;</span><br><span class=\"line\">\tfi</span><br><span class=\"line\"></span><br><span class=\"line\">\tlog_info &quot;$&#123;FUNCTION[0]&#125; complete.&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function restart()&#123;</span><br><span class=\"line\">\tlog_info &quot;$&#123;FUNCTION[0]&#125; begin.&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\tstop</span><br><span class=\"line\"></span><br><span class=\"line\">\tsleep 5</span><br><span class=\"line\"></span><br><span class=\"line\">\tstart</span><br><span class=\"line\"></span><br><span class=\"line\">\tlog_info &quot;$&#123;FUNCTION[0]&#125; end.&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function main()&#123;</span><br><span class=\"line\">\tlog_info &quot;$&#123;FUNCTION[0]&#125; begin.&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\tACTION=&quot;$1&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">\tcase &quot;$&#123;ACTION&#125;&quot; in</span><br><span class=\"line\">\t    start)</span><br><span class=\"line\">            start</span><br><span class=\"line\">\t    ;;</span><br><span class=\"line\">            stop)</span><br><span class=\"line\">            stop</span><br><span class=\"line\">            ;;</span><br><span class=\"line\">\t    restart)</span><br><span class=\"line\">            restart</span><br><span class=\"line\">            ;;</span><br><span class=\"line\">\t    *)</span><br><span class=\"line\">            usage</span><br><span class=\"line\">            ;;</span><br><span class=\"line\">            esac</span><br><span class=\"line\"></span><br><span class=\"line\">\tlog_info &quot;$&#123;FUNCTION[0]&#125; complete.&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">main &quot;$@&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"># 修改权限</span><br><span class=\"line\">chmod a+x /usr/local/apache-zookeeper-3.5.8/monitor.sh</span><br><span class=\"line\"></span><br><span class=\"line\"># 启动</span><br><span class=\"line\">sh /usr/local/apache-zookeeper-3.5.8/monitor.sh start</span><br><span class=\"line\"></span><br><span class=\"line\"># 查看进程</span><br><span class=\"line\">jps</span><br><span class=\"line\"></span><br><span class=\"line\"># 将健康检查加入crontab</span><br><span class=\"line\">vi /etc/crontab</span><br><span class=\"line\"></span><br><span class=\"line\">*/1 * * * * root /usr/local/apache-zookeeper-3.5.8/monitor.sh start &gt;/dev/null 2&gt;&amp;1</span><br><span class=\"line\"></span><br><span class=\"line\"># 重启crontab</span><br><span class=\"line\">systemctl restart crond</span><br></pre></td></tr></table></figure>"},{"title":"harbor部署","date":"2022-11-25T02:04:56.000Z","_content":"\n# harbor部署\n\n<!--more-->\n\n```\n\nharbor部署\n\n# 安装docker\n# yum install -y vim wget net-tools gcc gcc-c++ socat conntrack nfs-utils rpcbind yum-utils device-mapper-persistent-data lvm2 docker-ce\n\n# 配置私有仓库地址\n# mkdir -p /etc/docker/\n# vi /etc/docker/daemon.json\n{\n        \"exec-opts\": [\"native.cgroupdriver=systemd\"],\n        \"log-driver\": \"json-file\",\n        \"log-opts\": {\n                \"max-size\": \"100m\"\n        },\n        \"storage-driver\": \"overlay2\",\n        \"storage-opts\": [\n                \"overlay2.override_kernel_check=true\"\n        ],\n        \"insecure-registries\": [\"192.168.0.183:8080\",\"192.168.0.183:5000\"]\n}\n\n# 启动docker\n# systemctl daemon-reload\n# systemctl restart docker\n# systemctl status docker\n# systemctl enable docker\n\n# 下载docker-compose\n# wget -O /usr/local/bin/docker-compose https://github.com/docker/compose/releases/download/1.29.0/docker-compose-Linux-x86_64 \n# mv /usr/local/bin/docker-compose-Linux-x86_64 /usr/local/bin/docker-compose\n# chmod a+x /usr/local/bin/docker-compose\n# docker-compose --version\n\n# 上传harbor-offline-installer-v2.6.2.tgz registry.tar\n# tar -xf /usr/local/harbor-offline-installer-v2.6.2.tgz -C /usr/local/  \n\n# 新建数据与日志目录\n# mkdir -p /data1/harbor/{logs,data}\n\n# 修改配置文件\n# cd /usr/local/harbor\n# vi harbor.yml\nhostname: 192.168.0.183\n\nhttp:\n  port: 8080\n\nharbor_admin_password: password\n\ndatabase:\n  password: password\n  max_idle_conns: 500\n  max_open_conns: 10000\n\ndata_volume: /data1/harbor/data\n\ntrivy:\n  ignore_unfixed: false\n  skip_update: false\n  insecure: false\n\njobservice:\n  max_job_workers: 100\n\nnotification:\n  webhook_job_max_retry: 100\n\nchart:\n  absolute_url: disabled\n\nlog:\n  level: info\n  local:\n    rotate_count: 50\n    rotate_size: 200M\n    location: /data1/harbor/logs\n_version: 2.2.0\nproxy:\n  http_proxy:\n  https_proxy:\n  no_proxy:\n  components:\n    - core\n    - jobservice\n    - trivy\n\n\n# docker load -i harbor.v2.6.2.tar.gz\n# ./prepare\n# ./install.sh --with-chartmuseum\n# netstat -tunlp|grep 8080\n\n# 登录harbor\n# docker login 192.168.0.183:8080 -u admin -p password\n\n# 浏览器登录，然后创建项目\n# http://192.168.0.183:8080/  admin password\n\n\n```\n\n","source":"_posts/harbor部署.md","raw":"---\ntitle: harbor部署\ndate: 2022-11-25 10:04:56\ntags: harbor部署\n---\n\n# harbor部署\n\n<!--more-->\n\n```\n\nharbor部署\n\n# 安装docker\n# yum install -y vim wget net-tools gcc gcc-c++ socat conntrack nfs-utils rpcbind yum-utils device-mapper-persistent-data lvm2 docker-ce\n\n# 配置私有仓库地址\n# mkdir -p /etc/docker/\n# vi /etc/docker/daemon.json\n{\n        \"exec-opts\": [\"native.cgroupdriver=systemd\"],\n        \"log-driver\": \"json-file\",\n        \"log-opts\": {\n                \"max-size\": \"100m\"\n        },\n        \"storage-driver\": \"overlay2\",\n        \"storage-opts\": [\n                \"overlay2.override_kernel_check=true\"\n        ],\n        \"insecure-registries\": [\"192.168.0.183:8080\",\"192.168.0.183:5000\"]\n}\n\n# 启动docker\n# systemctl daemon-reload\n# systemctl restart docker\n# systemctl status docker\n# systemctl enable docker\n\n# 下载docker-compose\n# wget -O /usr/local/bin/docker-compose https://github.com/docker/compose/releases/download/1.29.0/docker-compose-Linux-x86_64 \n# mv /usr/local/bin/docker-compose-Linux-x86_64 /usr/local/bin/docker-compose\n# chmod a+x /usr/local/bin/docker-compose\n# docker-compose --version\n\n# 上传harbor-offline-installer-v2.6.2.tgz registry.tar\n# tar -xf /usr/local/harbor-offline-installer-v2.6.2.tgz -C /usr/local/  \n\n# 新建数据与日志目录\n# mkdir -p /data1/harbor/{logs,data}\n\n# 修改配置文件\n# cd /usr/local/harbor\n# vi harbor.yml\nhostname: 192.168.0.183\n\nhttp:\n  port: 8080\n\nharbor_admin_password: password\n\ndatabase:\n  password: password\n  max_idle_conns: 500\n  max_open_conns: 10000\n\ndata_volume: /data1/harbor/data\n\ntrivy:\n  ignore_unfixed: false\n  skip_update: false\n  insecure: false\n\njobservice:\n  max_job_workers: 100\n\nnotification:\n  webhook_job_max_retry: 100\n\nchart:\n  absolute_url: disabled\n\nlog:\n  level: info\n  local:\n    rotate_count: 50\n    rotate_size: 200M\n    location: /data1/harbor/logs\n_version: 2.2.0\nproxy:\n  http_proxy:\n  https_proxy:\n  no_proxy:\n  components:\n    - core\n    - jobservice\n    - trivy\n\n\n# docker load -i harbor.v2.6.2.tar.gz\n# ./prepare\n# ./install.sh --with-chartmuseum\n# netstat -tunlp|grep 8080\n\n# 登录harbor\n# docker login 192.168.0.183:8080 -u admin -p password\n\n# 浏览器登录，然后创建项目\n# http://192.168.0.183:8080/  admin password\n\n\n```\n\n","slug":"harbor部署","published":1,"updated":"2023-01-03T06:17:51.244Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clcfuykyn00043wrs3vxsfox8","content":"<h1 id=\"harbor部署\"><a href=\"#harbor部署\" class=\"headerlink\" title=\"harbor部署\"></a>harbor部署</h1><span id=\"more\"></span>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">harbor部署</span><br><span class=\"line\"></span><br><span class=\"line\"># 安装docker</span><br><span class=\"line\"># yum install -y vim wget net-tools gcc gcc-c++ socat conntrack nfs-utils rpcbind yum-utils device-mapper-persistent-data lvm2 docker-ce</span><br><span class=\"line\"></span><br><span class=\"line\"># 配置私有仓库地址</span><br><span class=\"line\"># mkdir -p /etc/docker/</span><br><span class=\"line\"># vi /etc/docker/daemon.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class=\"line\">        &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class=\"line\">        &quot;log-opts&quot;: &#123;</span><br><span class=\"line\">                &quot;max-size&quot;: &quot;100m&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;storage-driver&quot;: &quot;overlay2&quot;,</span><br><span class=\"line\">        &quot;storage-opts&quot;: [</span><br><span class=\"line\">                &quot;overlay2.override_kernel_check=true&quot;</span><br><span class=\"line\">        ],</span><br><span class=\"line\">        &quot;insecure-registries&quot;: [&quot;192.168.0.183:8080&quot;,&quot;192.168.0.183:5000&quot;]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 启动docker</span><br><span class=\"line\"># systemctl daemon-reload</span><br><span class=\"line\"># systemctl restart docker</span><br><span class=\"line\"># systemctl status docker</span><br><span class=\"line\"># systemctl enable docker</span><br><span class=\"line\"></span><br><span class=\"line\"># 下载docker-compose</span><br><span class=\"line\"># wget -O /usr/local/bin/docker-compose https://github.com/docker/compose/releases/download/1.29.0/docker-compose-Linux-x86_64 </span><br><span class=\"line\"># mv /usr/local/bin/docker-compose-Linux-x86_64 /usr/local/bin/docker-compose</span><br><span class=\"line\"># chmod a+x /usr/local/bin/docker-compose</span><br><span class=\"line\"># docker-compose --version</span><br><span class=\"line\"></span><br><span class=\"line\"># 上传harbor-offline-installer-v2.6.2.tgz registry.tar</span><br><span class=\"line\"># tar -xf /usr/local/harbor-offline-installer-v2.6.2.tgz -C /usr/local/  </span><br><span class=\"line\"></span><br><span class=\"line\"># 新建数据与日志目录</span><br><span class=\"line\"># mkdir -p /data1/harbor/&#123;logs,data&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 修改配置文件</span><br><span class=\"line\"># cd /usr/local/harbor</span><br><span class=\"line\"># vi harbor.yml</span><br><span class=\"line\">hostname: 192.168.0.183</span><br><span class=\"line\"></span><br><span class=\"line\">http:</span><br><span class=\"line\">  port: 8080</span><br><span class=\"line\"></span><br><span class=\"line\">harbor_admin_password: password</span><br><span class=\"line\"></span><br><span class=\"line\">database:</span><br><span class=\"line\">  password: password</span><br><span class=\"line\">  max_idle_conns: 500</span><br><span class=\"line\">  max_open_conns: 10000</span><br><span class=\"line\"></span><br><span class=\"line\">data_volume: /data1/harbor/data</span><br><span class=\"line\"></span><br><span class=\"line\">trivy:</span><br><span class=\"line\">  ignore_unfixed: false</span><br><span class=\"line\">  skip_update: false</span><br><span class=\"line\">  insecure: false</span><br><span class=\"line\"></span><br><span class=\"line\">jobservice:</span><br><span class=\"line\">  max_job_workers: 100</span><br><span class=\"line\"></span><br><span class=\"line\">notification:</span><br><span class=\"line\">  webhook_job_max_retry: 100</span><br><span class=\"line\"></span><br><span class=\"line\">chart:</span><br><span class=\"line\">  absolute_url: disabled</span><br><span class=\"line\"></span><br><span class=\"line\">log:</span><br><span class=\"line\">  level: info</span><br><span class=\"line\">  local:</span><br><span class=\"line\">    rotate_count: 50</span><br><span class=\"line\">    rotate_size: 200M</span><br><span class=\"line\">    location: /data1/harbor/logs</span><br><span class=\"line\">_version: 2.2.0</span><br><span class=\"line\">proxy:</span><br><span class=\"line\">  http_proxy:</span><br><span class=\"line\">  https_proxy:</span><br><span class=\"line\">  no_proxy:</span><br><span class=\"line\">  components:</span><br><span class=\"line\">    - core</span><br><span class=\"line\">    - jobservice</span><br><span class=\"line\">    - trivy</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># docker load -i harbor.v2.6.2.tar.gz</span><br><span class=\"line\"># ./prepare</span><br><span class=\"line\"># ./install.sh --with-chartmuseum</span><br><span class=\"line\"># netstat -tunlp|grep 8080</span><br><span class=\"line\"></span><br><span class=\"line\"># 登录harbor</span><br><span class=\"line\"># docker login 192.168.0.183:8080 -u admin -p password</span><br><span class=\"line\"></span><br><span class=\"line\"># 浏览器登录，然后创建项目</span><br><span class=\"line\"># http://192.168.0.183:8080/  admin password</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n","site":{"data":{}},"excerpt":"<h1 id=\"harbor部署\"><a href=\"#harbor部署\" class=\"headerlink\" title=\"harbor部署\"></a>harbor部署</h1>","more":"<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">harbor部署</span><br><span class=\"line\"></span><br><span class=\"line\"># 安装docker</span><br><span class=\"line\"># yum install -y vim wget net-tools gcc gcc-c++ socat conntrack nfs-utils rpcbind yum-utils device-mapper-persistent-data lvm2 docker-ce</span><br><span class=\"line\"></span><br><span class=\"line\"># 配置私有仓库地址</span><br><span class=\"line\"># mkdir -p /etc/docker/</span><br><span class=\"line\"># vi /etc/docker/daemon.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class=\"line\">        &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class=\"line\">        &quot;log-opts&quot;: &#123;</span><br><span class=\"line\">                &quot;max-size&quot;: &quot;100m&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;storage-driver&quot;: &quot;overlay2&quot;,</span><br><span class=\"line\">        &quot;storage-opts&quot;: [</span><br><span class=\"line\">                &quot;overlay2.override_kernel_check=true&quot;</span><br><span class=\"line\">        ],</span><br><span class=\"line\">        &quot;insecure-registries&quot;: [&quot;192.168.0.183:8080&quot;,&quot;192.168.0.183:5000&quot;]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 启动docker</span><br><span class=\"line\"># systemctl daemon-reload</span><br><span class=\"line\"># systemctl restart docker</span><br><span class=\"line\"># systemctl status docker</span><br><span class=\"line\"># systemctl enable docker</span><br><span class=\"line\"></span><br><span class=\"line\"># 下载docker-compose</span><br><span class=\"line\"># wget -O /usr/local/bin/docker-compose https://github.com/docker/compose/releases/download/1.29.0/docker-compose-Linux-x86_64 </span><br><span class=\"line\"># mv /usr/local/bin/docker-compose-Linux-x86_64 /usr/local/bin/docker-compose</span><br><span class=\"line\"># chmod a+x /usr/local/bin/docker-compose</span><br><span class=\"line\"># docker-compose --version</span><br><span class=\"line\"></span><br><span class=\"line\"># 上传harbor-offline-installer-v2.6.2.tgz registry.tar</span><br><span class=\"line\"># tar -xf /usr/local/harbor-offline-installer-v2.6.2.tgz -C /usr/local/  </span><br><span class=\"line\"></span><br><span class=\"line\"># 新建数据与日志目录</span><br><span class=\"line\"># mkdir -p /data1/harbor/&#123;logs,data&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 修改配置文件</span><br><span class=\"line\"># cd /usr/local/harbor</span><br><span class=\"line\"># vi harbor.yml</span><br><span class=\"line\">hostname: 192.168.0.183</span><br><span class=\"line\"></span><br><span class=\"line\">http:</span><br><span class=\"line\">  port: 8080</span><br><span class=\"line\"></span><br><span class=\"line\">harbor_admin_password: password</span><br><span class=\"line\"></span><br><span class=\"line\">database:</span><br><span class=\"line\">  password: password</span><br><span class=\"line\">  max_idle_conns: 500</span><br><span class=\"line\">  max_open_conns: 10000</span><br><span class=\"line\"></span><br><span class=\"line\">data_volume: /data1/harbor/data</span><br><span class=\"line\"></span><br><span class=\"line\">trivy:</span><br><span class=\"line\">  ignore_unfixed: false</span><br><span class=\"line\">  skip_update: false</span><br><span class=\"line\">  insecure: false</span><br><span class=\"line\"></span><br><span class=\"line\">jobservice:</span><br><span class=\"line\">  max_job_workers: 100</span><br><span class=\"line\"></span><br><span class=\"line\">notification:</span><br><span class=\"line\">  webhook_job_max_retry: 100</span><br><span class=\"line\"></span><br><span class=\"line\">chart:</span><br><span class=\"line\">  absolute_url: disabled</span><br><span class=\"line\"></span><br><span class=\"line\">log:</span><br><span class=\"line\">  level: info</span><br><span class=\"line\">  local:</span><br><span class=\"line\">    rotate_count: 50</span><br><span class=\"line\">    rotate_size: 200M</span><br><span class=\"line\">    location: /data1/harbor/logs</span><br><span class=\"line\">_version: 2.2.0</span><br><span class=\"line\">proxy:</span><br><span class=\"line\">  http_proxy:</span><br><span class=\"line\">  https_proxy:</span><br><span class=\"line\">  no_proxy:</span><br><span class=\"line\">  components:</span><br><span class=\"line\">    - core</span><br><span class=\"line\">    - jobservice</span><br><span class=\"line\">    - trivy</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># docker load -i harbor.v2.6.2.tar.gz</span><br><span class=\"line\"># ./prepare</span><br><span class=\"line\"># ./install.sh --with-chartmuseum</span><br><span class=\"line\"># netstat -tunlp|grep 8080</span><br><span class=\"line\"></span><br><span class=\"line\"># 登录harbor</span><br><span class=\"line\"># docker login 192.168.0.183:8080 -u admin -p password</span><br><span class=\"line\"></span><br><span class=\"line\"># 浏览器登录，然后创建项目</span><br><span class=\"line\"># http://192.168.0.183:8080/  admin password</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>"},{"title":"ingress-nginx部署","date":"2022-11-25T02:59:08.000Z","_content":"\n# ingress-nginx部署\n\n在 Kubernetes 集群内部使用 kube-dns 实现服务发现的功能，那么我们部署在 Kubernetes 集群中的应用如何暴露给外部的用户使用呢？我们知道可以使用 `NodePort` 和 `LoadBlancer` 类型的 Service 可以把应用暴露给外部用户使用，除此之外，Kubernetes 还为我们提供了一个非常重要的资源对象可以用来暴露服务给外部用户，那就是 `Ingress`。对于小规模的应用我们使用 NodePort 或许能够满足我们的需求，但是当你的应用越来越多的时候，你就会发现对于 NodePort 的管理就非常麻烦了，这个时候使用 Ingress 就非常方便了，可以避免管理大量的端口。\n\n<!--more-->\n\nIngress 其实就是从 Kuberenets 集群外部访问集群的一个入口，将外部的请求转发到集群内不同的 Service 上，其实就相当于 nginx、haproxy 等[负载均衡](https://cloud.tencent.com/product/clb?from=10680)代理服务器，可能你会觉得我们直接使用 nginx 就实现了，但是只使用 nginx 这种方式有很大缺陷，每次有新服务加入的时候怎么改 Nginx 配置？不可能让我们去手动更改或者滚动更新前端的 Nginx Pod 吧？那我们再加上一个服务发现的工具比如 consul 如何？貌似是可以，对吧？Ingress 实际上就是这样实现的，只是服务发现的功能自己实现了，不需要使用第三方的服务了，然后再加上一个域名规则定义，路由信息的刷新依靠 Ingress Controller 来提供。\n\nIngress Controller 可以理解为一个监听器，通过不断地监听 kube-apiserver，实时的感知后端 Service、Pod 的变化，当得到这些信息变化后，Ingress Controller 再结合 Ingress 的配置，更新反向代理负载均衡器，达到服务发现的作用。其实这点和服务发现工具 consul、 consul-template 非常类似。\n\n## 创建ingress控制器\n\n```\n# 导入镜像\ndocker load -i nginx-ingress-controller.tar\n\n# 镜像打标签\ndocker tag 89ccad40ce8e 192.168.0.183:5000/kubernetes-ingress-controller/nginx-ingress-controller:0.24.0\n\n# 推送到私有仓库\ndocker push 192.168.0.183:5000/kubernetes-ingress-controller/nginx-ingress-controller:0.24.0\n```\n\n## 编写INGRESS文件\n\nvi ingress.yaml\n\n```\napiVersion: v1\nkind: Namespace\nmetadata:\n  name: ingress-nginx\n  labels:\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\n\n---\n\nkind: ConfigMap\napiVersion: v1\nmetadata:\n  name: nginx-configuration\n  namespace: ingress-nginx\n  labels:\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\n\n---\nkind: ConfigMap\napiVersion: v1\nmetadata:\n  name: tcp-services\n  namespace: ingress-nginx\n  labels:\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\n\n---\nkind: ConfigMap\napiVersion: v1\nmetadata:\n  name: udp-services\n  namespace: ingress-nginx\n  labels:\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\n\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: nginx-ingress-serviceaccount\n  namespace: ingress-nginx\n  labels:\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\n\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRole\nmetadata:\n  name: nginx-ingress-clusterrole\n  labels:\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\nrules:\n  - apiGroups:\n      - \"\"\n    resources:\n      - configmaps\n      - endpoints\n      - nodes\n      - pods\n      - secrets\n    verbs:\n      - list\n      - watch\n  - apiGroups:\n      - \"\"\n    resources:\n      - nodes\n    verbs:\n      - get\n  - apiGroups:\n      - \"\"\n    resources:\n      - services\n    verbs:\n      - get\n      - list\n      - watch\n  - apiGroups:\n      - \"\"\n    resources:\n      - events\n    verbs:\n      - create\n      - patch\n  - apiGroups:\n      - \"extensions\"\n      - \"networking.k8s.io\"\n    resources:\n      - ingresses\n    verbs:\n      - get\n      - list\n      - watch\n  - apiGroups:\n      - \"extensions\"\n      - \"networking.k8s.io\"\n    resources:\n      - ingresses/status\n    verbs:\n      - update\n\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: Role\nmetadata:\n  name: nginx-ingress-role\n  namespace: ingress-nginx\n  labels:\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\nrules:\n  - apiGroups:\n      - \"\"\n    resources:\n      - configmaps\n      - pods\n      - secrets\n      - namespaces\n    verbs:\n      - get\n  - apiGroups:\n      - \"\"\n    resources:\n      - configmaps\n    resourceNames:\n      # Defaults to \"<election-id>-<ingress-class>\"\n      # Here: \"<ingress-controller-leader>-<nginx>\"\n      # This has to be adapted if you change either parameter\n      # when launching the nginx-ingress-controller.\n      - \"ingress-controller-leader-nginx\"\n    verbs:\n      - get\n      - update\n  - apiGroups:\n      - \"\"\n    resources:\n      - configmaps\n    verbs:\n      - create\n  - apiGroups:\n      - \"\"\n    resources:\n      - endpoints\n    verbs:\n      - get\n\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: RoleBinding\nmetadata:\n  name: nginx-ingress-role-nisa-binding\n  namespace: ingress-nginx\n  labels:\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: Role\n  name: nginx-ingress-role\nsubjects:\n  - kind: ServiceAccount\n    name: nginx-ingress-serviceaccount\n    namespace: ingress-nginx\n\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRoleBinding\nmetadata:\n  name: nginx-ingress-clusterrole-nisa-binding\n  labels:\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: nginx-ingress-clusterrole\nsubjects:\n  - kind: ServiceAccount\n    name: nginx-ingress-serviceaccount\n    namespace: ingress-nginx\n\n---\n\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: nginx-ingress-controller\n  namespace: ingress-nginx\n  labels:\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: ingress-nginx\n      app.kubernetes.io/part-of: ingress-nginx\n  template:\n    metadata:\n      labels:\n        app.kubernetes.io/name: ingress-nginx\n        app.kubernetes.io/part-of: ingress-nginx\n      annotations:\n        prometheus.io/port: \"10254\"\n        prometheus.io/scrape: \"true\"\n    spec:\n      # wait up to five minutes for the drain of connections\n      terminationGracePeriodSeconds: 300\n      serviceAccountName: nginx-ingress-serviceaccount\n      nodeSelector:\n        kubernetes.io/os: linux\n      containers:\n        - name: nginx-ingress-controller\n          #image: quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.24.0\n          image: 192.168.0.183:5000/kubernetes-ingress-controller/nginx-ingress-controller:0.24.0\n          args:\n            - /nginx-ingress-controller\n            - --configmap=$(POD_NAMESPACE)/nginx-configuration\n            - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services\n            - --udp-services-configmap=$(POD_NAMESPACE)/udp-services\n            - --publish-service=$(POD_NAMESPACE)/ingress-nginx\n            - --annotations-prefix=nginx.ingress.kubernetes.io\n          securityContext:\n            allowPrivilegeEscalation: true\n            capabilities:\n              drop:\n                - ALL\n              add:\n                - NET_BIND_SERVICE\n            # www-data -> 101\n            runAsUser: 101\n          env:\n            - name: POD_NAME\n              valueFrom:\n                fieldRef:\n                  fieldPath: metadata.name\n            - name: POD_NAMESPACE\n              valueFrom:\n                fieldRef:\n                  fieldPath: metadata.namespace\n          ports:\n            - name: http\n              containerPort: 80\n              protocol: TCP\n            - name: https\n              containerPort: 443\n              protocol: TCP\n          livenessProbe:\n            failureThreshold: 3\n            httpGet:\n              path: /healthz\n              port: 10254\n              scheme: HTTP\n            initialDelaySeconds: 10\n            periodSeconds: 10\n            successThreshold: 1\n            timeoutSeconds: 10\n          readinessProbe:\n            failureThreshold: 3\n            httpGet:\n              path: /healthz\n              port: 10254\n              scheme: HTTP\n            periodSeconds: 10\n            successThreshold: 1\n            timeoutSeconds: 10\n          lifecycle:\n            preStop:\n              exec:\n                command:\n                  - /wait-shutdown\n\n---\n\napiVersion: v1\nkind: LimitRange\nmetadata:\n  name: ingress-nginx\n  namespace: ingress-nginx\n  labels:\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\nspec:\n  limits:\n  - min:\n      memory: 90Mi\n      cpu: 100m\n    type: Container\n\n\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: ingress-nginx\n  namespace: ingress-nginx\n  labels:\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\nspec:\n  type: NodePort\n  ports:\n    - name: http\n      port: 80\n      targetPort: 80\n      protocol: TCP\n      nodePort: 32080\n    - name: https\n      port: 443\n      targetPort: 443\n      protocol: TCP\n      nodePort: 32443\n  selector:\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\n```\n\n### 创建控制器\n\n```\nkubectl create -f mandatory.yml\n```\n\n\n\n## 创建ingress资源\n\n新建业务ingress资源文件，这里需要添加nginx.ingress.kubernetes.io/proxy-body-size指定大小，不然默认是1M。\n\n```\nkind: Ingress\napiVersion: extensions/v1beta1\nmetadata:\n  name: ingress\n  namespace: portal\n  annotations:\n    nginx.ingress.kubernetes.io/proxy-body-size: 500M\n    nginx.ingress.kubernetes.io/service-weight: ''\nspec:\n  rules:\n    - host: xxx.com\n      http:\n        paths:\n          - path: /\n            pathType: ImplementationSpecific\n            backend:\n              serviceName: global-nginx\n              servicePort: 80\n```\n\n","source":"_posts/ingress-nginx部署.md","raw":"---\ntitle: ingress-nginx部署\ndate: 2022-11-25 10:59:08\ntags: ingress-nginx\n---\n\n# ingress-nginx部署\n\n在 Kubernetes 集群内部使用 kube-dns 实现服务发现的功能，那么我们部署在 Kubernetes 集群中的应用如何暴露给外部的用户使用呢？我们知道可以使用 `NodePort` 和 `LoadBlancer` 类型的 Service 可以把应用暴露给外部用户使用，除此之外，Kubernetes 还为我们提供了一个非常重要的资源对象可以用来暴露服务给外部用户，那就是 `Ingress`。对于小规模的应用我们使用 NodePort 或许能够满足我们的需求，但是当你的应用越来越多的时候，你就会发现对于 NodePort 的管理就非常麻烦了，这个时候使用 Ingress 就非常方便了，可以避免管理大量的端口。\n\n<!--more-->\n\nIngress 其实就是从 Kuberenets 集群外部访问集群的一个入口，将外部的请求转发到集群内不同的 Service 上，其实就相当于 nginx、haproxy 等[负载均衡](https://cloud.tencent.com/product/clb?from=10680)代理服务器，可能你会觉得我们直接使用 nginx 就实现了，但是只使用 nginx 这种方式有很大缺陷，每次有新服务加入的时候怎么改 Nginx 配置？不可能让我们去手动更改或者滚动更新前端的 Nginx Pod 吧？那我们再加上一个服务发现的工具比如 consul 如何？貌似是可以，对吧？Ingress 实际上就是这样实现的，只是服务发现的功能自己实现了，不需要使用第三方的服务了，然后再加上一个域名规则定义，路由信息的刷新依靠 Ingress Controller 来提供。\n\nIngress Controller 可以理解为一个监听器，通过不断地监听 kube-apiserver，实时的感知后端 Service、Pod 的变化，当得到这些信息变化后，Ingress Controller 再结合 Ingress 的配置，更新反向代理负载均衡器，达到服务发现的作用。其实这点和服务发现工具 consul、 consul-template 非常类似。\n\n## 创建ingress控制器\n\n```\n# 导入镜像\ndocker load -i nginx-ingress-controller.tar\n\n# 镜像打标签\ndocker tag 89ccad40ce8e 192.168.0.183:5000/kubernetes-ingress-controller/nginx-ingress-controller:0.24.0\n\n# 推送到私有仓库\ndocker push 192.168.0.183:5000/kubernetes-ingress-controller/nginx-ingress-controller:0.24.0\n```\n\n## 编写INGRESS文件\n\nvi ingress.yaml\n\n```\napiVersion: v1\nkind: Namespace\nmetadata:\n  name: ingress-nginx\n  labels:\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\n\n---\n\nkind: ConfigMap\napiVersion: v1\nmetadata:\n  name: nginx-configuration\n  namespace: ingress-nginx\n  labels:\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\n\n---\nkind: ConfigMap\napiVersion: v1\nmetadata:\n  name: tcp-services\n  namespace: ingress-nginx\n  labels:\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\n\n---\nkind: ConfigMap\napiVersion: v1\nmetadata:\n  name: udp-services\n  namespace: ingress-nginx\n  labels:\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\n\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: nginx-ingress-serviceaccount\n  namespace: ingress-nginx\n  labels:\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\n\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRole\nmetadata:\n  name: nginx-ingress-clusterrole\n  labels:\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\nrules:\n  - apiGroups:\n      - \"\"\n    resources:\n      - configmaps\n      - endpoints\n      - nodes\n      - pods\n      - secrets\n    verbs:\n      - list\n      - watch\n  - apiGroups:\n      - \"\"\n    resources:\n      - nodes\n    verbs:\n      - get\n  - apiGroups:\n      - \"\"\n    resources:\n      - services\n    verbs:\n      - get\n      - list\n      - watch\n  - apiGroups:\n      - \"\"\n    resources:\n      - events\n    verbs:\n      - create\n      - patch\n  - apiGroups:\n      - \"extensions\"\n      - \"networking.k8s.io\"\n    resources:\n      - ingresses\n    verbs:\n      - get\n      - list\n      - watch\n  - apiGroups:\n      - \"extensions\"\n      - \"networking.k8s.io\"\n    resources:\n      - ingresses/status\n    verbs:\n      - update\n\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: Role\nmetadata:\n  name: nginx-ingress-role\n  namespace: ingress-nginx\n  labels:\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\nrules:\n  - apiGroups:\n      - \"\"\n    resources:\n      - configmaps\n      - pods\n      - secrets\n      - namespaces\n    verbs:\n      - get\n  - apiGroups:\n      - \"\"\n    resources:\n      - configmaps\n    resourceNames:\n      # Defaults to \"<election-id>-<ingress-class>\"\n      # Here: \"<ingress-controller-leader>-<nginx>\"\n      # This has to be adapted if you change either parameter\n      # when launching the nginx-ingress-controller.\n      - \"ingress-controller-leader-nginx\"\n    verbs:\n      - get\n      - update\n  - apiGroups:\n      - \"\"\n    resources:\n      - configmaps\n    verbs:\n      - create\n  - apiGroups:\n      - \"\"\n    resources:\n      - endpoints\n    verbs:\n      - get\n\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: RoleBinding\nmetadata:\n  name: nginx-ingress-role-nisa-binding\n  namespace: ingress-nginx\n  labels:\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: Role\n  name: nginx-ingress-role\nsubjects:\n  - kind: ServiceAccount\n    name: nginx-ingress-serviceaccount\n    namespace: ingress-nginx\n\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRoleBinding\nmetadata:\n  name: nginx-ingress-clusterrole-nisa-binding\n  labels:\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: nginx-ingress-clusterrole\nsubjects:\n  - kind: ServiceAccount\n    name: nginx-ingress-serviceaccount\n    namespace: ingress-nginx\n\n---\n\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: nginx-ingress-controller\n  namespace: ingress-nginx\n  labels:\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: ingress-nginx\n      app.kubernetes.io/part-of: ingress-nginx\n  template:\n    metadata:\n      labels:\n        app.kubernetes.io/name: ingress-nginx\n        app.kubernetes.io/part-of: ingress-nginx\n      annotations:\n        prometheus.io/port: \"10254\"\n        prometheus.io/scrape: \"true\"\n    spec:\n      # wait up to five minutes for the drain of connections\n      terminationGracePeriodSeconds: 300\n      serviceAccountName: nginx-ingress-serviceaccount\n      nodeSelector:\n        kubernetes.io/os: linux\n      containers:\n        - name: nginx-ingress-controller\n          #image: quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.24.0\n          image: 192.168.0.183:5000/kubernetes-ingress-controller/nginx-ingress-controller:0.24.0\n          args:\n            - /nginx-ingress-controller\n            - --configmap=$(POD_NAMESPACE)/nginx-configuration\n            - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services\n            - --udp-services-configmap=$(POD_NAMESPACE)/udp-services\n            - --publish-service=$(POD_NAMESPACE)/ingress-nginx\n            - --annotations-prefix=nginx.ingress.kubernetes.io\n          securityContext:\n            allowPrivilegeEscalation: true\n            capabilities:\n              drop:\n                - ALL\n              add:\n                - NET_BIND_SERVICE\n            # www-data -> 101\n            runAsUser: 101\n          env:\n            - name: POD_NAME\n              valueFrom:\n                fieldRef:\n                  fieldPath: metadata.name\n            - name: POD_NAMESPACE\n              valueFrom:\n                fieldRef:\n                  fieldPath: metadata.namespace\n          ports:\n            - name: http\n              containerPort: 80\n              protocol: TCP\n            - name: https\n              containerPort: 443\n              protocol: TCP\n          livenessProbe:\n            failureThreshold: 3\n            httpGet:\n              path: /healthz\n              port: 10254\n              scheme: HTTP\n            initialDelaySeconds: 10\n            periodSeconds: 10\n            successThreshold: 1\n            timeoutSeconds: 10\n          readinessProbe:\n            failureThreshold: 3\n            httpGet:\n              path: /healthz\n              port: 10254\n              scheme: HTTP\n            periodSeconds: 10\n            successThreshold: 1\n            timeoutSeconds: 10\n          lifecycle:\n            preStop:\n              exec:\n                command:\n                  - /wait-shutdown\n\n---\n\napiVersion: v1\nkind: LimitRange\nmetadata:\n  name: ingress-nginx\n  namespace: ingress-nginx\n  labels:\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\nspec:\n  limits:\n  - min:\n      memory: 90Mi\n      cpu: 100m\n    type: Container\n\n\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: ingress-nginx\n  namespace: ingress-nginx\n  labels:\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\nspec:\n  type: NodePort\n  ports:\n    - name: http\n      port: 80\n      targetPort: 80\n      protocol: TCP\n      nodePort: 32080\n    - name: https\n      port: 443\n      targetPort: 443\n      protocol: TCP\n      nodePort: 32443\n  selector:\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/part-of: ingress-nginx\n```\n\n### 创建控制器\n\n```\nkubectl create -f mandatory.yml\n```\n\n\n\n## 创建ingress资源\n\n新建业务ingress资源文件，这里需要添加nginx.ingress.kubernetes.io/proxy-body-size指定大小，不然默认是1M。\n\n```\nkind: Ingress\napiVersion: extensions/v1beta1\nmetadata:\n  name: ingress\n  namespace: portal\n  annotations:\n    nginx.ingress.kubernetes.io/proxy-body-size: 500M\n    nginx.ingress.kubernetes.io/service-weight: ''\nspec:\n  rules:\n    - host: xxx.com\n      http:\n        paths:\n          - path: /\n            pathType: ImplementationSpecific\n            backend:\n              serviceName: global-nginx\n              servicePort: 80\n```\n\n","slug":"ingress-nginx部署","published":1,"updated":"2023-01-03T06:17:51.245Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clcfuykyn00053wrsd1uzhrtr","content":"<h1 id=\"ingress-nginx部署\"><a href=\"#ingress-nginx部署\" class=\"headerlink\" title=\"ingress-nginx部署\"></a>ingress-nginx部署</h1><p>在 Kubernetes 集群内部使用 kube-dns 实现服务发现的功能，那么我们部署在 Kubernetes 集群中的应用如何暴露给外部的用户使用呢？我们知道可以使用 <code>NodePort</code> 和 <code>LoadBlancer</code> 类型的 Service 可以把应用暴露给外部用户使用，除此之外，Kubernetes 还为我们提供了一个非常重要的资源对象可以用来暴露服务给外部用户，那就是 <code>Ingress</code>。对于小规模的应用我们使用 NodePort 或许能够满足我们的需求，但是当你的应用越来越多的时候，你就会发现对于 NodePort 的管理就非常麻烦了，这个时候使用 Ingress 就非常方便了，可以避免管理大量的端口。</p>\n<span id=\"more\"></span>\n\n<p>Ingress 其实就是从 Kuberenets 集群外部访问集群的一个入口，将外部的请求转发到集群内不同的 Service 上，其实就相当于 nginx、haproxy 等<a href=\"https://cloud.tencent.com/product/clb?from=10680\">负载均衡</a>代理服务器，可能你会觉得我们直接使用 nginx 就实现了，但是只使用 nginx 这种方式有很大缺陷，每次有新服务加入的时候怎么改 Nginx 配置？不可能让我们去手动更改或者滚动更新前端的 Nginx Pod 吧？那我们再加上一个服务发现的工具比如 consul 如何？貌似是可以，对吧？Ingress 实际上就是这样实现的，只是服务发现的功能自己实现了，不需要使用第三方的服务了，然后再加上一个域名规则定义，路由信息的刷新依靠 Ingress Controller 来提供。</p>\n<p>Ingress Controller 可以理解为一个监听器，通过不断地监听 kube-apiserver，实时的感知后端 Service、Pod 的变化，当得到这些信息变化后，Ingress Controller 再结合 Ingress 的配置，更新反向代理负载均衡器，达到服务发现的作用。其实这点和服务发现工具 consul、 consul-template 非常类似。</p>\n<h2 id=\"创建ingress控制器\"><a href=\"#创建ingress控制器\" class=\"headerlink\" title=\"创建ingress控制器\"></a>创建ingress控制器</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 导入镜像</span><br><span class=\"line\">docker load -i nginx-ingress-controller.tar</span><br><span class=\"line\"></span><br><span class=\"line\"># 镜像打标签</span><br><span class=\"line\">docker tag 89ccad40ce8e 192.168.0.183:5000/kubernetes-ingress-controller/nginx-ingress-controller:0.24.0</span><br><span class=\"line\"></span><br><span class=\"line\"># 推送到私有仓库</span><br><span class=\"line\">docker push 192.168.0.183:5000/kubernetes-ingress-controller/nginx-ingress-controller:0.24.0</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"编写INGRESS文件\"><a href=\"#编写INGRESS文件\" class=\"headerlink\" title=\"编写INGRESS文件\"></a>编写INGRESS文件</h2><p>vi ingress.yaml</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Namespace</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: ingress-nginx</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/name: ingress-nginx</span><br><span class=\"line\">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\"></span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nginx-configuration</span><br><span class=\"line\">  namespace: ingress-nginx</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/name: ingress-nginx</span><br><span class=\"line\">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: tcp-services</span><br><span class=\"line\">  namespace: ingress-nginx</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/name: ingress-nginx</span><br><span class=\"line\">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: udp-services</span><br><span class=\"line\">  namespace: ingress-nginx</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/name: ingress-nginx</span><br><span class=\"line\">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ServiceAccount</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nginx-ingress-serviceaccount</span><br><span class=\"line\">  namespace: ingress-nginx</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/name: ingress-nginx</span><br><span class=\"line\">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class=\"line\">kind: ClusterRole</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nginx-ingress-clusterrole</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/name: ingress-nginx</span><br><span class=\"line\">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class=\"line\">rules:</span><br><span class=\"line\">  - apiGroups:</span><br><span class=\"line\">      - &quot;&quot;</span><br><span class=\"line\">    resources:</span><br><span class=\"line\">      - configmaps</span><br><span class=\"line\">      - endpoints</span><br><span class=\"line\">      - nodes</span><br><span class=\"line\">      - pods</span><br><span class=\"line\">      - secrets</span><br><span class=\"line\">    verbs:</span><br><span class=\"line\">      - list</span><br><span class=\"line\">      - watch</span><br><span class=\"line\">  - apiGroups:</span><br><span class=\"line\">      - &quot;&quot;</span><br><span class=\"line\">    resources:</span><br><span class=\"line\">      - nodes</span><br><span class=\"line\">    verbs:</span><br><span class=\"line\">      - get</span><br><span class=\"line\">  - apiGroups:</span><br><span class=\"line\">      - &quot;&quot;</span><br><span class=\"line\">    resources:</span><br><span class=\"line\">      - services</span><br><span class=\"line\">    verbs:</span><br><span class=\"line\">      - get</span><br><span class=\"line\">      - list</span><br><span class=\"line\">      - watch</span><br><span class=\"line\">  - apiGroups:</span><br><span class=\"line\">      - &quot;&quot;</span><br><span class=\"line\">    resources:</span><br><span class=\"line\">      - events</span><br><span class=\"line\">    verbs:</span><br><span class=\"line\">      - create</span><br><span class=\"line\">      - patch</span><br><span class=\"line\">  - apiGroups:</span><br><span class=\"line\">      - &quot;extensions&quot;</span><br><span class=\"line\">      - &quot;networking.k8s.io&quot;</span><br><span class=\"line\">    resources:</span><br><span class=\"line\">      - ingresses</span><br><span class=\"line\">    verbs:</span><br><span class=\"line\">      - get</span><br><span class=\"line\">      - list</span><br><span class=\"line\">      - watch</span><br><span class=\"line\">  - apiGroups:</span><br><span class=\"line\">      - &quot;extensions&quot;</span><br><span class=\"line\">      - &quot;networking.k8s.io&quot;</span><br><span class=\"line\">    resources:</span><br><span class=\"line\">      - ingresses/status</span><br><span class=\"line\">    verbs:</span><br><span class=\"line\">      - update</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class=\"line\">kind: Role</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nginx-ingress-role</span><br><span class=\"line\">  namespace: ingress-nginx</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/name: ingress-nginx</span><br><span class=\"line\">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class=\"line\">rules:</span><br><span class=\"line\">  - apiGroups:</span><br><span class=\"line\">      - &quot;&quot;</span><br><span class=\"line\">    resources:</span><br><span class=\"line\">      - configmaps</span><br><span class=\"line\">      - pods</span><br><span class=\"line\">      - secrets</span><br><span class=\"line\">      - namespaces</span><br><span class=\"line\">    verbs:</span><br><span class=\"line\">      - get</span><br><span class=\"line\">  - apiGroups:</span><br><span class=\"line\">      - &quot;&quot;</span><br><span class=\"line\">    resources:</span><br><span class=\"line\">      - configmaps</span><br><span class=\"line\">    resourceNames:</span><br><span class=\"line\">      # Defaults to &quot;&lt;election-id&gt;-&lt;ingress-class&gt;&quot;</span><br><span class=\"line\">      # Here: &quot;&lt;ingress-controller-leader&gt;-&lt;nginx&gt;&quot;</span><br><span class=\"line\">      # This has to be adapted if you change either parameter</span><br><span class=\"line\">      # when launching the nginx-ingress-controller.</span><br><span class=\"line\">      - &quot;ingress-controller-leader-nginx&quot;</span><br><span class=\"line\">    verbs:</span><br><span class=\"line\">      - get</span><br><span class=\"line\">      - update</span><br><span class=\"line\">  - apiGroups:</span><br><span class=\"line\">      - &quot;&quot;</span><br><span class=\"line\">    resources:</span><br><span class=\"line\">      - configmaps</span><br><span class=\"line\">    verbs:</span><br><span class=\"line\">      - create</span><br><span class=\"line\">  - apiGroups:</span><br><span class=\"line\">      - &quot;&quot;</span><br><span class=\"line\">    resources:</span><br><span class=\"line\">      - endpoints</span><br><span class=\"line\">    verbs:</span><br><span class=\"line\">      - get</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class=\"line\">kind: RoleBinding</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nginx-ingress-role-nisa-binding</span><br><span class=\"line\">  namespace: ingress-nginx</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/name: ingress-nginx</span><br><span class=\"line\">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class=\"line\">roleRef:</span><br><span class=\"line\">  apiGroup: rbac.authorization.k8s.io</span><br><span class=\"line\">  kind: Role</span><br><span class=\"line\">  name: nginx-ingress-role</span><br><span class=\"line\">subjects:</span><br><span class=\"line\">  - kind: ServiceAccount</span><br><span class=\"line\">    name: nginx-ingress-serviceaccount</span><br><span class=\"line\">    namespace: ingress-nginx</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class=\"line\">kind: ClusterRoleBinding</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nginx-ingress-clusterrole-nisa-binding</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/name: ingress-nginx</span><br><span class=\"line\">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class=\"line\">roleRef:</span><br><span class=\"line\">  apiGroup: rbac.authorization.k8s.io</span><br><span class=\"line\">  kind: ClusterRole</span><br><span class=\"line\">  name: nginx-ingress-clusterrole</span><br><span class=\"line\">subjects:</span><br><span class=\"line\">  - kind: ServiceAccount</span><br><span class=\"line\">    name: nginx-ingress-serviceaccount</span><br><span class=\"line\">    namespace: ingress-nginx</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\"></span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nginx-ingress-controller</span><br><span class=\"line\">  namespace: ingress-nginx</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/name: ingress-nginx</span><br><span class=\"line\">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 2</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app.kubernetes.io/name: ingress-nginx</span><br><span class=\"line\">      app.kubernetes.io/part-of: ingress-nginx</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app.kubernetes.io/name: ingress-nginx</span><br><span class=\"line\">        app.kubernetes.io/part-of: ingress-nginx</span><br><span class=\"line\">      annotations:</span><br><span class=\"line\">        prometheus.io/port: &quot;10254&quot;</span><br><span class=\"line\">        prometheus.io/scrape: &quot;true&quot;</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      # wait up to five minutes for the drain of connections</span><br><span class=\"line\">      terminationGracePeriodSeconds: 300</span><br><span class=\"line\">      serviceAccountName: nginx-ingress-serviceaccount</span><br><span class=\"line\">      nodeSelector:</span><br><span class=\"line\">        kubernetes.io/os: linux</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">        - name: nginx-ingress-controller</span><br><span class=\"line\">          #image: quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.24.0</span><br><span class=\"line\">          image: 192.168.0.183:5000/kubernetes-ingress-controller/nginx-ingress-controller:0.24.0</span><br><span class=\"line\">          args:</span><br><span class=\"line\">            - /nginx-ingress-controller</span><br><span class=\"line\">            - --configmap=$(POD_NAMESPACE)/nginx-configuration</span><br><span class=\"line\">            - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services</span><br><span class=\"line\">            - --udp-services-configmap=$(POD_NAMESPACE)/udp-services</span><br><span class=\"line\">            - --publish-service=$(POD_NAMESPACE)/ingress-nginx</span><br><span class=\"line\">            - --annotations-prefix=nginx.ingress.kubernetes.io</span><br><span class=\"line\">          securityContext:</span><br><span class=\"line\">            allowPrivilegeEscalation: true</span><br><span class=\"line\">            capabilities:</span><br><span class=\"line\">              drop:</span><br><span class=\"line\">                - ALL</span><br><span class=\"line\">              add:</span><br><span class=\"line\">                - NET_BIND_SERVICE</span><br><span class=\"line\">            # www-data -&gt; 101</span><br><span class=\"line\">            runAsUser: 101</span><br><span class=\"line\">          env:</span><br><span class=\"line\">            - name: POD_NAME</span><br><span class=\"line\">              valueFrom:</span><br><span class=\"line\">                fieldRef:</span><br><span class=\"line\">                  fieldPath: metadata.name</span><br><span class=\"line\">            - name: POD_NAMESPACE</span><br><span class=\"line\">              valueFrom:</span><br><span class=\"line\">                fieldRef:</span><br><span class=\"line\">                  fieldPath: metadata.namespace</span><br><span class=\"line\">          ports:</span><br><span class=\"line\">            - name: http</span><br><span class=\"line\">              containerPort: 80</span><br><span class=\"line\">              protocol: TCP</span><br><span class=\"line\">            - name: https</span><br><span class=\"line\">              containerPort: 443</span><br><span class=\"line\">              protocol: TCP</span><br><span class=\"line\">          livenessProbe:</span><br><span class=\"line\">            failureThreshold: 3</span><br><span class=\"line\">            httpGet:</span><br><span class=\"line\">              path: /healthz</span><br><span class=\"line\">              port: 10254</span><br><span class=\"line\">              scheme: HTTP</span><br><span class=\"line\">            initialDelaySeconds: 10</span><br><span class=\"line\">            periodSeconds: 10</span><br><span class=\"line\">            successThreshold: 1</span><br><span class=\"line\">            timeoutSeconds: 10</span><br><span class=\"line\">          readinessProbe:</span><br><span class=\"line\">            failureThreshold: 3</span><br><span class=\"line\">            httpGet:</span><br><span class=\"line\">              path: /healthz</span><br><span class=\"line\">              port: 10254</span><br><span class=\"line\">              scheme: HTTP</span><br><span class=\"line\">            periodSeconds: 10</span><br><span class=\"line\">            successThreshold: 1</span><br><span class=\"line\">            timeoutSeconds: 10</span><br><span class=\"line\">          lifecycle:</span><br><span class=\"line\">            preStop:</span><br><span class=\"line\">              exec:</span><br><span class=\"line\">                command:</span><br><span class=\"line\">                  - /wait-shutdown</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\"></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: LimitRange</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: ingress-nginx</span><br><span class=\"line\">  namespace: ingress-nginx</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/name: ingress-nginx</span><br><span class=\"line\">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  limits:</span><br><span class=\"line\">  - min:</span><br><span class=\"line\">      memory: 90Mi</span><br><span class=\"line\">      cpu: 100m</span><br><span class=\"line\">    type: Container</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: ingress-nginx</span><br><span class=\"line\">  namespace: ingress-nginx</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/name: ingress-nginx</span><br><span class=\"line\">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  type: NodePort</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">    - name: http</span><br><span class=\"line\">      port: 80</span><br><span class=\"line\">      targetPort: 80</span><br><span class=\"line\">      protocol: TCP</span><br><span class=\"line\">      nodePort: 32080</span><br><span class=\"line\">    - name: https</span><br><span class=\"line\">      port: 443</span><br><span class=\"line\">      targetPort: 443</span><br><span class=\"line\">      protocol: TCP</span><br><span class=\"line\">      nodePort: 32443</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app.kubernetes.io/name: ingress-nginx</span><br><span class=\"line\">    app.kubernetes.io/part-of: ingress-nginx</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"创建控制器\"><a href=\"#创建控制器\" class=\"headerlink\" title=\"创建控制器\"></a>创建控制器</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create -f mandatory.yml</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"创建ingress资源\"><a href=\"#创建ingress资源\" class=\"headerlink\" title=\"创建ingress资源\"></a>创建ingress资源</h2><p>新建业务ingress资源文件，这里需要添加nginx.ingress.kubernetes.io/proxy-body-size指定大小，不然默认是1M。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kind: Ingress</span><br><span class=\"line\">apiVersion: extensions/v1beta1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: ingress</span><br><span class=\"line\">  namespace: portal</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    nginx.ingress.kubernetes.io/proxy-body-size: 500M</span><br><span class=\"line\">    nginx.ingress.kubernetes.io/service-weight: &#x27;&#x27;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  rules:</span><br><span class=\"line\">    - host: xxx.com</span><br><span class=\"line\">      http:</span><br><span class=\"line\">        paths:</span><br><span class=\"line\">          - path: /</span><br><span class=\"line\">            pathType: ImplementationSpecific</span><br><span class=\"line\">            backend:</span><br><span class=\"line\">              serviceName: global-nginx</span><br><span class=\"line\">              servicePort: 80</span><br></pre></td></tr></table></figure>\n\n","site":{"data":{}},"excerpt":"<h1 id=\"ingress-nginx部署\"><a href=\"#ingress-nginx部署\" class=\"headerlink\" title=\"ingress-nginx部署\"></a>ingress-nginx部署</h1><p>在 Kubernetes 集群内部使用 kube-dns 实现服务发现的功能，那么我们部署在 Kubernetes 集群中的应用如何暴露给外部的用户使用呢？我们知道可以使用 <code>NodePort</code> 和 <code>LoadBlancer</code> 类型的 Service 可以把应用暴露给外部用户使用，除此之外，Kubernetes 还为我们提供了一个非常重要的资源对象可以用来暴露服务给外部用户，那就是 <code>Ingress</code>。对于小规模的应用我们使用 NodePort 或许能够满足我们的需求，但是当你的应用越来越多的时候，你就会发现对于 NodePort 的管理就非常麻烦了，这个时候使用 Ingress 就非常方便了，可以避免管理大量的端口。</p>","more":"<p>Ingress 其实就是从 Kuberenets 集群外部访问集群的一个入口，将外部的请求转发到集群内不同的 Service 上，其实就相当于 nginx、haproxy 等<a href=\"https://cloud.tencent.com/product/clb?from=10680\">负载均衡</a>代理服务器，可能你会觉得我们直接使用 nginx 就实现了，但是只使用 nginx 这种方式有很大缺陷，每次有新服务加入的时候怎么改 Nginx 配置？不可能让我们去手动更改或者滚动更新前端的 Nginx Pod 吧？那我们再加上一个服务发现的工具比如 consul 如何？貌似是可以，对吧？Ingress 实际上就是这样实现的，只是服务发现的功能自己实现了，不需要使用第三方的服务了，然后再加上一个域名规则定义，路由信息的刷新依靠 Ingress Controller 来提供。</p>\n<p>Ingress Controller 可以理解为一个监听器，通过不断地监听 kube-apiserver，实时的感知后端 Service、Pod 的变化，当得到这些信息变化后，Ingress Controller 再结合 Ingress 的配置，更新反向代理负载均衡器，达到服务发现的作用。其实这点和服务发现工具 consul、 consul-template 非常类似。</p>\n<h2 id=\"创建ingress控制器\"><a href=\"#创建ingress控制器\" class=\"headerlink\" title=\"创建ingress控制器\"></a>创建ingress控制器</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 导入镜像</span><br><span class=\"line\">docker load -i nginx-ingress-controller.tar</span><br><span class=\"line\"></span><br><span class=\"line\"># 镜像打标签</span><br><span class=\"line\">docker tag 89ccad40ce8e 192.168.0.183:5000/kubernetes-ingress-controller/nginx-ingress-controller:0.24.0</span><br><span class=\"line\"></span><br><span class=\"line\"># 推送到私有仓库</span><br><span class=\"line\">docker push 192.168.0.183:5000/kubernetes-ingress-controller/nginx-ingress-controller:0.24.0</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"编写INGRESS文件\"><a href=\"#编写INGRESS文件\" class=\"headerlink\" title=\"编写INGRESS文件\"></a>编写INGRESS文件</h2><p>vi ingress.yaml</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Namespace</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: ingress-nginx</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/name: ingress-nginx</span><br><span class=\"line\">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\"></span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nginx-configuration</span><br><span class=\"line\">  namespace: ingress-nginx</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/name: ingress-nginx</span><br><span class=\"line\">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: tcp-services</span><br><span class=\"line\">  namespace: ingress-nginx</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/name: ingress-nginx</span><br><span class=\"line\">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: udp-services</span><br><span class=\"line\">  namespace: ingress-nginx</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/name: ingress-nginx</span><br><span class=\"line\">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ServiceAccount</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nginx-ingress-serviceaccount</span><br><span class=\"line\">  namespace: ingress-nginx</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/name: ingress-nginx</span><br><span class=\"line\">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class=\"line\">kind: ClusterRole</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nginx-ingress-clusterrole</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/name: ingress-nginx</span><br><span class=\"line\">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class=\"line\">rules:</span><br><span class=\"line\">  - apiGroups:</span><br><span class=\"line\">      - &quot;&quot;</span><br><span class=\"line\">    resources:</span><br><span class=\"line\">      - configmaps</span><br><span class=\"line\">      - endpoints</span><br><span class=\"line\">      - nodes</span><br><span class=\"line\">      - pods</span><br><span class=\"line\">      - secrets</span><br><span class=\"line\">    verbs:</span><br><span class=\"line\">      - list</span><br><span class=\"line\">      - watch</span><br><span class=\"line\">  - apiGroups:</span><br><span class=\"line\">      - &quot;&quot;</span><br><span class=\"line\">    resources:</span><br><span class=\"line\">      - nodes</span><br><span class=\"line\">    verbs:</span><br><span class=\"line\">      - get</span><br><span class=\"line\">  - apiGroups:</span><br><span class=\"line\">      - &quot;&quot;</span><br><span class=\"line\">    resources:</span><br><span class=\"line\">      - services</span><br><span class=\"line\">    verbs:</span><br><span class=\"line\">      - get</span><br><span class=\"line\">      - list</span><br><span class=\"line\">      - watch</span><br><span class=\"line\">  - apiGroups:</span><br><span class=\"line\">      - &quot;&quot;</span><br><span class=\"line\">    resources:</span><br><span class=\"line\">      - events</span><br><span class=\"line\">    verbs:</span><br><span class=\"line\">      - create</span><br><span class=\"line\">      - patch</span><br><span class=\"line\">  - apiGroups:</span><br><span class=\"line\">      - &quot;extensions&quot;</span><br><span class=\"line\">      - &quot;networking.k8s.io&quot;</span><br><span class=\"line\">    resources:</span><br><span class=\"line\">      - ingresses</span><br><span class=\"line\">    verbs:</span><br><span class=\"line\">      - get</span><br><span class=\"line\">      - list</span><br><span class=\"line\">      - watch</span><br><span class=\"line\">  - apiGroups:</span><br><span class=\"line\">      - &quot;extensions&quot;</span><br><span class=\"line\">      - &quot;networking.k8s.io&quot;</span><br><span class=\"line\">    resources:</span><br><span class=\"line\">      - ingresses/status</span><br><span class=\"line\">    verbs:</span><br><span class=\"line\">      - update</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class=\"line\">kind: Role</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nginx-ingress-role</span><br><span class=\"line\">  namespace: ingress-nginx</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/name: ingress-nginx</span><br><span class=\"line\">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class=\"line\">rules:</span><br><span class=\"line\">  - apiGroups:</span><br><span class=\"line\">      - &quot;&quot;</span><br><span class=\"line\">    resources:</span><br><span class=\"line\">      - configmaps</span><br><span class=\"line\">      - pods</span><br><span class=\"line\">      - secrets</span><br><span class=\"line\">      - namespaces</span><br><span class=\"line\">    verbs:</span><br><span class=\"line\">      - get</span><br><span class=\"line\">  - apiGroups:</span><br><span class=\"line\">      - &quot;&quot;</span><br><span class=\"line\">    resources:</span><br><span class=\"line\">      - configmaps</span><br><span class=\"line\">    resourceNames:</span><br><span class=\"line\">      # Defaults to &quot;&lt;election-id&gt;-&lt;ingress-class&gt;&quot;</span><br><span class=\"line\">      # Here: &quot;&lt;ingress-controller-leader&gt;-&lt;nginx&gt;&quot;</span><br><span class=\"line\">      # This has to be adapted if you change either parameter</span><br><span class=\"line\">      # when launching the nginx-ingress-controller.</span><br><span class=\"line\">      - &quot;ingress-controller-leader-nginx&quot;</span><br><span class=\"line\">    verbs:</span><br><span class=\"line\">      - get</span><br><span class=\"line\">      - update</span><br><span class=\"line\">  - apiGroups:</span><br><span class=\"line\">      - &quot;&quot;</span><br><span class=\"line\">    resources:</span><br><span class=\"line\">      - configmaps</span><br><span class=\"line\">    verbs:</span><br><span class=\"line\">      - create</span><br><span class=\"line\">  - apiGroups:</span><br><span class=\"line\">      - &quot;&quot;</span><br><span class=\"line\">    resources:</span><br><span class=\"line\">      - endpoints</span><br><span class=\"line\">    verbs:</span><br><span class=\"line\">      - get</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class=\"line\">kind: RoleBinding</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nginx-ingress-role-nisa-binding</span><br><span class=\"line\">  namespace: ingress-nginx</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/name: ingress-nginx</span><br><span class=\"line\">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class=\"line\">roleRef:</span><br><span class=\"line\">  apiGroup: rbac.authorization.k8s.io</span><br><span class=\"line\">  kind: Role</span><br><span class=\"line\">  name: nginx-ingress-role</span><br><span class=\"line\">subjects:</span><br><span class=\"line\">  - kind: ServiceAccount</span><br><span class=\"line\">    name: nginx-ingress-serviceaccount</span><br><span class=\"line\">    namespace: ingress-nginx</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class=\"line\">kind: ClusterRoleBinding</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nginx-ingress-clusterrole-nisa-binding</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/name: ingress-nginx</span><br><span class=\"line\">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class=\"line\">roleRef:</span><br><span class=\"line\">  apiGroup: rbac.authorization.k8s.io</span><br><span class=\"line\">  kind: ClusterRole</span><br><span class=\"line\">  name: nginx-ingress-clusterrole</span><br><span class=\"line\">subjects:</span><br><span class=\"line\">  - kind: ServiceAccount</span><br><span class=\"line\">    name: nginx-ingress-serviceaccount</span><br><span class=\"line\">    namespace: ingress-nginx</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\"></span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nginx-ingress-controller</span><br><span class=\"line\">  namespace: ingress-nginx</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/name: ingress-nginx</span><br><span class=\"line\">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 2</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app.kubernetes.io/name: ingress-nginx</span><br><span class=\"line\">      app.kubernetes.io/part-of: ingress-nginx</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app.kubernetes.io/name: ingress-nginx</span><br><span class=\"line\">        app.kubernetes.io/part-of: ingress-nginx</span><br><span class=\"line\">      annotations:</span><br><span class=\"line\">        prometheus.io/port: &quot;10254&quot;</span><br><span class=\"line\">        prometheus.io/scrape: &quot;true&quot;</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      # wait up to five minutes for the drain of connections</span><br><span class=\"line\">      terminationGracePeriodSeconds: 300</span><br><span class=\"line\">      serviceAccountName: nginx-ingress-serviceaccount</span><br><span class=\"line\">      nodeSelector:</span><br><span class=\"line\">        kubernetes.io/os: linux</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">        - name: nginx-ingress-controller</span><br><span class=\"line\">          #image: quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.24.0</span><br><span class=\"line\">          image: 192.168.0.183:5000/kubernetes-ingress-controller/nginx-ingress-controller:0.24.0</span><br><span class=\"line\">          args:</span><br><span class=\"line\">            - /nginx-ingress-controller</span><br><span class=\"line\">            - --configmap=$(POD_NAMESPACE)/nginx-configuration</span><br><span class=\"line\">            - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services</span><br><span class=\"line\">            - --udp-services-configmap=$(POD_NAMESPACE)/udp-services</span><br><span class=\"line\">            - --publish-service=$(POD_NAMESPACE)/ingress-nginx</span><br><span class=\"line\">            - --annotations-prefix=nginx.ingress.kubernetes.io</span><br><span class=\"line\">          securityContext:</span><br><span class=\"line\">            allowPrivilegeEscalation: true</span><br><span class=\"line\">            capabilities:</span><br><span class=\"line\">              drop:</span><br><span class=\"line\">                - ALL</span><br><span class=\"line\">              add:</span><br><span class=\"line\">                - NET_BIND_SERVICE</span><br><span class=\"line\">            # www-data -&gt; 101</span><br><span class=\"line\">            runAsUser: 101</span><br><span class=\"line\">          env:</span><br><span class=\"line\">            - name: POD_NAME</span><br><span class=\"line\">              valueFrom:</span><br><span class=\"line\">                fieldRef:</span><br><span class=\"line\">                  fieldPath: metadata.name</span><br><span class=\"line\">            - name: POD_NAMESPACE</span><br><span class=\"line\">              valueFrom:</span><br><span class=\"line\">                fieldRef:</span><br><span class=\"line\">                  fieldPath: metadata.namespace</span><br><span class=\"line\">          ports:</span><br><span class=\"line\">            - name: http</span><br><span class=\"line\">              containerPort: 80</span><br><span class=\"line\">              protocol: TCP</span><br><span class=\"line\">            - name: https</span><br><span class=\"line\">              containerPort: 443</span><br><span class=\"line\">              protocol: TCP</span><br><span class=\"line\">          livenessProbe:</span><br><span class=\"line\">            failureThreshold: 3</span><br><span class=\"line\">            httpGet:</span><br><span class=\"line\">              path: /healthz</span><br><span class=\"line\">              port: 10254</span><br><span class=\"line\">              scheme: HTTP</span><br><span class=\"line\">            initialDelaySeconds: 10</span><br><span class=\"line\">            periodSeconds: 10</span><br><span class=\"line\">            successThreshold: 1</span><br><span class=\"line\">            timeoutSeconds: 10</span><br><span class=\"line\">          readinessProbe:</span><br><span class=\"line\">            failureThreshold: 3</span><br><span class=\"line\">            httpGet:</span><br><span class=\"line\">              path: /healthz</span><br><span class=\"line\">              port: 10254</span><br><span class=\"line\">              scheme: HTTP</span><br><span class=\"line\">            periodSeconds: 10</span><br><span class=\"line\">            successThreshold: 1</span><br><span class=\"line\">            timeoutSeconds: 10</span><br><span class=\"line\">          lifecycle:</span><br><span class=\"line\">            preStop:</span><br><span class=\"line\">              exec:</span><br><span class=\"line\">                command:</span><br><span class=\"line\">                  - /wait-shutdown</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\"></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: LimitRange</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: ingress-nginx</span><br><span class=\"line\">  namespace: ingress-nginx</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/name: ingress-nginx</span><br><span class=\"line\">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  limits:</span><br><span class=\"line\">  - min:</span><br><span class=\"line\">      memory: 90Mi</span><br><span class=\"line\">      cpu: 100m</span><br><span class=\"line\">    type: Container</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: ingress-nginx</span><br><span class=\"line\">  namespace: ingress-nginx</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/name: ingress-nginx</span><br><span class=\"line\">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  type: NodePort</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">    - name: http</span><br><span class=\"line\">      port: 80</span><br><span class=\"line\">      targetPort: 80</span><br><span class=\"line\">      protocol: TCP</span><br><span class=\"line\">      nodePort: 32080</span><br><span class=\"line\">    - name: https</span><br><span class=\"line\">      port: 443</span><br><span class=\"line\">      targetPort: 443</span><br><span class=\"line\">      protocol: TCP</span><br><span class=\"line\">      nodePort: 32443</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app.kubernetes.io/name: ingress-nginx</span><br><span class=\"line\">    app.kubernetes.io/part-of: ingress-nginx</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"创建控制器\"><a href=\"#创建控制器\" class=\"headerlink\" title=\"创建控制器\"></a>创建控制器</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create -f mandatory.yml</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"创建ingress资源\"><a href=\"#创建ingress资源\" class=\"headerlink\" title=\"创建ingress资源\"></a>创建ingress资源</h2><p>新建业务ingress资源文件，这里需要添加nginx.ingress.kubernetes.io/proxy-body-size指定大小，不然默认是1M。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kind: Ingress</span><br><span class=\"line\">apiVersion: extensions/v1beta1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: ingress</span><br><span class=\"line\">  namespace: portal</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    nginx.ingress.kubernetes.io/proxy-body-size: 500M</span><br><span class=\"line\">    nginx.ingress.kubernetes.io/service-weight: &#x27;&#x27;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  rules:</span><br><span class=\"line\">    - host: xxx.com</span><br><span class=\"line\">      http:</span><br><span class=\"line\">        paths:</span><br><span class=\"line\">          - path: /</span><br><span class=\"line\">            pathType: ImplementationSpecific</span><br><span class=\"line\">            backend:</span><br><span class=\"line\">              serviceName: global-nginx</span><br><span class=\"line\">              servicePort: 80</span><br></pre></td></tr></table></figure>"},{"title":"kubesphere部署","date":"2022-11-25T02:39:06.000Z","_content":"\n# 青云部署k8s\n\n获取离线安装包\n\n<!--more-->\n\n```\n青云部署k8s\n获取离线安装包\n\ncurl -Ok https://kubesphere-installer.pek3b.qingstor.com/offline/v3.0.0/kubesphere-all-v3.0.0-offline-linux-amd64.tar.gz\n\n\n解压离线安装包\ntar-xvf kubesphere-all-v3.0.0-offline-linux-amd64.tar.gz -C /usr/local/\n\n集群安装\n\n1.创建集群配置文件\n\n./kk create config --with-kubesphere v3.0.0\n\n2.修改集群配置文件\nvi config-sample.yaml\napiVersion: kubekey.kubesphere.io/v1alpha1\nkind: Cluster\nmetadata:\n  name: laopai-uat\nspec:\n  hosts:\n  - {name: master01, address: 192.168.0.183, internalAddress: 192.168.0.183, user: root, password: password}\n  - {name: master02, address: 192.168.0.184, internalAddress: 192.168.0.184, user: root, password: password}\n  - {name: master03, address: 192.168.0.185, internalAddress: 192.168.0.185, user: root, password: password}\n  - {name: node01, address: 192.168.0.186, internalAddress: 192.168.0.186, user: root, password: password}\n  - {name: node02, address: 192.168.0.187, internalAddress: 192.168.0.187, user: root, password: password}\n  - {name: node03, address: 192.168.0.188, internalAddress: 192.168.0.188, user: root, password: password}\n  - {name: node04, address: 192.168.0.189, internalAddress: 192.168.0.189, user: root, password: password}\n  - {name: node05, address: 192.168.0.190, internalAddress: 192.168.0.190, user: root, password: password}\n  roleGroups:\n    etcd:\n    - master01\n    - master02\n    - master03\n    master: \n    - master01\n    - master02\n    - master03\n    worker:\n    - node01\n    - node02\n    - node03\n    - node04\n    - node05\n  controlPlaneEndpoint:\n    domain: kubesphere.com\n    address: \"192.168.0.183\"\n    port: \"6443\"\n  kubernetes:\n    version: v1.18.6\n    imageRepo: kubesphere\n    clusterName: cluster.local\n  network:\n    plugin: calico\n    kubePodsCIDR: 10.233.64.0/18\n    kubeServiceCIDR: 10.233.0.0/18\n  registry:\n    registryMirrors: []\n    insecureRegistries: [\"192.168.0.183.2:5000\"]\n    privateRegistry: 192.168.0.183.2:5000\n  addons: \n  - name: nfs-client\n    namespace: kube-system\n    sources: \n      chart:\n        name: nfs-client-provisioner\n        #repo: https://charts.kubesphere.io/main\n        path: /data1/kubesphere-all-v3.0.0-offline-linux-amd64/charts\n        values:\n        - image.repository=192.168.0.183.2:5000/kubesphere/nfs-client-provisioner\n        - nfs.server=100.68.212.1\n        - nfs.path=/data\n        - storageClass.defaultClass=true\n\n\n---\napiVersion: installer.kubesphere.io/v1alpha1\nkind: ClusterConfiguration\nmetadata:\n  name: ks-installer\n  namespace: kubesphere-system\n  labels:\n    version: v3.0.0\nspec:\n  local_registry: \"\"\n  persistence:\n    storageClass: \"\"\n  authentication:\n    jwtSecret: \"\"\n  etcd:\n    monitoring: true\n    endpointIps: localhost\n    port: 2379\n    tlsEnable: true\n  common:\n    es:\n      elasticsearchDataVolumeSize: 20Gi\n      elasticsearchMasterVolumeSize: 4Gi\n      elkPrefix: logstash\n      logMaxAge: 7\n    mysqlVolumeSize: 20Gi\n    minioVolumeSize: 20Gi\n    etcdVolumeSize: 20Gi\n    openldapVolumeSize: 2Gi\n    redisVolumSize: 2Gi\n  console:\n    enableMultiLogin: false  # enable/disable multi login\n    port: 30880\n  alerting:\n    enabled: true\n  auditing:\n    enabled: true\n  devops:\n    enabled: true\n    jenkinsMemoryLim: 2Gi\n    jenkinsMemoryReq: 1500Mi\n    jenkinsVolumeSize: 8Gi\n    jenkinsJavaOpts_Xms: 512m\n    jenkinsJavaOpts_Xmx: 512m\n    jenkinsJavaOpts_MaxRAM: 2g\n  events:\n    enabled: true\n    ruler:\n      enabled: true\n      replicas: 2\n  logging:\n    enabled: true\n    logsidecarReplicas: 2\n  metrics_server:\n    enabled: true\n  monitoring:\n    prometheusMemoryRequest: 400Mi\n    prometheusVolumeSize: 20Gi\n  multicluster:\n    clusterRole: none  # host | member | none\n  networkpolicy:\n    enabled: true\n  notification:\n    enabled: true\n  openpitrix:\n    enabled: true\n  servicemesh:\n    enabled: true\n\n3.在镜像机器搭建registry私服\n\ndocker run -d --name registry2 --restart=always -v /data/registry:/var/lib/registry -p5000:5000registry:2\n\n\n\nregistry2安装后，集群所有节点需设置docker daemon.json文件insecure后重启docker\n\n4.导入镜像\n\n推送语句\n\n./push-images.sh 192.168.0.183:5000\n\n镜像清单\n\nk8s：\n\nkubesphere/kube-apiserver:v1.17.9\n\nkubesphere/kube-scheduler:v1.17.9\n\nkubesphere/kube-proxy:v1.17.9\n\nkubesphere/kube-controller-manager:v1.17.9\n\nkubesphere/pause:3.1\n\nkubesphere/pause:3.2 (k8s版本大于v1.18)\n\nkubesphere/etcd:v3.3.12\n\ncalico/kube-controllers:v3.15.1\n\ncalico/node:v3.15.1\n\ncalico/cni:v3.15.1\n\ncalico/pod2daemon-flexvol:v3.15.1\n\ncoredns/coredns:1.6.9\n\nkubesphere/k8s-dns-node-cache:1.15.12\n\n\n\nlocalVolume：\n\nkubesphere/node-disk-manager:0.5.0\n\nkubesphere/node-disk-operator:0.5.0\n\nkubesphere/provisioner-localpv:1.10.0\n\nkubesphere/linux-utils:1.10.0\n\n\n\nkubesphere：\n\nkubesphere/ks-apiserver:v3.0.0\n\nkubesphere/ks-console:v3.0.0\n\nkubesphere/ks-controller-manager:v3.0.0\n\nkubesphere/ks-installer:v3.0.0\n\nkubesphere/etcd:v3.2.18\n\nkubesphere/kubectl:v1.0.0\n\nkubesphere/ks-upgrade:v3.0.0\n\nkubesphere/ks-devops:flyway-v3.0.0\n\nredis:5.0.5-alpine\n\nalpine:3.10.4\n\nhaproxy:2.0.4\n\nmysql:8.0.11\n\nnginx:1.14-alpine\n\nminio/minio:RELEASE.2019-08-07T01-59-21Z\n\nminio/mc:RELEASE.2019-08-07T23-14-43Z\n\nmirrorgooglecontainers/defaultbackend-amd64:1.4\n\nkubesphere/nginx-ingress-controller:0.24.1\n\nosixia/openldap:1.3.0\n\ncsiplugin/snapshot-controller:v2.0.1\n\nkubesphere/ks-upgrade:v3.0.0\n\nkubesphere/ks-devops:flyway-v3.0.0\n\n\n\nmonitoring：\n\nkubesphere/prometheus-config-reloader:v0.38.3\n\nkubesphere/prometheus-operator:v0.38.3\n\nprom/alertmanager:v0.21.0\n\nprom/prometheus:v2.20.1\n\nkubesphere/node-exporter:ks-v0.18.1\n\njimmidyson/configmap-reload:v0.3.0\n\nkubesphere/notification-manager-operator:v0.1.0\n\nkubesphere/notification-manager:v0.1.0\n\nkubesphere/metrics-server:v0.3.7\n\nkubesphere/kube-rbac-proxy:v0.4.1\n\nkubesphere/kube-state-metrics:v1.9.6\n\n\n\nlogging:\n\nkubesphere/elasticsearch-oss:6.7.0-1\n\nkubesphere/fluentbit-operator:v0.2.0\n\nkubesphere/fluentbit-operator:migrator\n\nkubesphere/fluent-bit:v1.4.6\n\nkubesphere/kube-auditing-operator:v0.1.0\n\nkubesphere/kube-auditing-webhook:v0.1.0\n\nkubesphere/kube-events-exporter:v0.1.0\n\nkubesphere/kube-events-operator:v0.1.0\n\nkubesphere/kube-events-ruler:v0.1.0\n\nkubesphere/log-sidecar-injector:1.1\n\ndocker:19.03\n\nservice-mesh：\n\nistio/citadel:1.4.8\n\nistio/galley:1.4.8\n\nistio/kubectl:1.4.8\n\nistio/mixer:1.4.8\n\nistio/pilot:1.4.8\n\nistio/proxyv2:1.4.8\n\nistio/sidecar_injector:1.4.8\n\njaegertracing/jaeger-agent:1.17\n\njaegertracing/jaeger-collector:1.17\n\njaegertracing/jaeger-operator:1.17.1\n\njaegertracing/jaeger-query:1.17\n\njaegertracing/jaeger-es-index-cleaner:1.17.1\n\n\n\ndevops：\n\njenkins/jenkins:2.176.2\n\njenkins/jnlp-slave:3.27-1\n\nkubesphere/jenkins-uc:v3.0.0\n\nkubesphere/s2ioperator:v2.1.1\n\nkubesphere/s2irun:v2.1.1\n\nkubesphere/builder-base:v2.1.0\n\nkubesphere/builder-nodejs:v2.1.0\n\nkubesphere/builder-maven:v2.1.0\n\nkubesphere/builder-go:v2.1.0\n\nkubesphere/s2i-binary:v2.1.0\n\nkubesphere/tomcat85-java11-centos7:v2.1.0\n\nkubesphere/tomcat85-java11-runtime:v2.1.0\n\nkubesphere/tomcat85-java8-centos7:v2.1.0\n\nkubesphere/tomcat85-java8-runtime:v2.1.0\n\nkubesphere/java-11-centos7:v2.1.0\n\nkubesphere/java-8-centos7:v2.1.0\n\nkubesphere/java-8-runtime:v2.1.0\n\nkubesphere/java-11-runtime:v2.1.0\n\nkubesphere/nodejs-8-centos7:v2.1.0\n\nkubesphere/nodejs-6-centos7:v2.1.0\n\nkubesphere/nodejs-4-centos7:v2.1.0\n\nkubesphere/python-36-centos7:v2.1.0\n\nkubesphere/python-35-centos7:v2.1.0\n\nkubesphere/python-34-centos7:v2.1.0\n\nkubesphere/python-27-centos7:v2.1.0\n\n\n\nnotification&&alerting:\n\nkubesphere/notification:flyway_v2.1.2\n\nkubesphere/notification:v2.1.2\n\nkubesphere/alert-adapter:v3.0.0\n\nkubesphere/alerting-dbinit:v3.0.0\n\nkubesphere/alerting:v2.1.2\n\n\n\nmulticluster:\n\nkubesphere/kubefed:v0.3.0\n\nkubesphere/tower:v0.1.0\n\n\n\nopenpitrix(app store)：\n\nopenpitrix/generate-kubeconfig:v0.5.0\n\nopenpitrix/openpitrix:flyway-v0.5.0\n\nopenpitrix/openpitrix:v0.5.0\n\nopenpitrix/release-app:v0.5.0\n\n5.节点初始化\n\nyum install -y socat conntrack ebtables ipset\n\n./kk init os -f config-sample.yaml -s ./dependencies/\n\n6.执行集群安装\n\n集群安装语句\n\n./kk create cluster -f config-sample.yaml\n\n显示安装结果\n\n#####################################################\n\n###Welcome to KubeSphere!###\n\n#####################################################\n\n\n\nConsole: http://192.168.0.8:30880\n\nAccount: admin\n\nPassword: P@88w0rd\n\n\n\nNOTES：\n\n1.After logging into theconsole, please check the\n\nmonitoring statusofservice componentsin\n\nthe\"Cluster Management\". If any serviceisnot\n\nready, please wait patientlyuntilall components\n\nare ready.\n\n2.Please modify thedefaultpassword after login.\n\n\n\n#####################################################\n\nhttps://kubesphere.io\n\n20xx-xx-xx xx:xx:xx\n\n#####################################################\n\n检查安装\n\nkubectl logs -n kubesphere-system$(kubectl get pod -n kubesphere-system-l app=ks-install -o jsonpath='{.items[0].metadata.name}') -f\n\n7.集群清理/卸载\n\n./kk delete cluster –f config-sample.yaml\n\n8.集群增加节点\n\n编辑追加config-sample,host行\n\n./kk add nodes -f config-sample.yaml\n\n9.集群删除节点\n\n./kk delete node nodeName -f config-sample.yaml\n```\n\n","source":"_posts/kubesphere部署.md","raw":"---\ntitle: kubesphere部署\ndate: 2022-11-25 10:39:06\ntags: kubesphere\n---\n\n# 青云部署k8s\n\n获取离线安装包\n\n<!--more-->\n\n```\n青云部署k8s\n获取离线安装包\n\ncurl -Ok https://kubesphere-installer.pek3b.qingstor.com/offline/v3.0.0/kubesphere-all-v3.0.0-offline-linux-amd64.tar.gz\n\n\n解压离线安装包\ntar-xvf kubesphere-all-v3.0.0-offline-linux-amd64.tar.gz -C /usr/local/\n\n集群安装\n\n1.创建集群配置文件\n\n./kk create config --with-kubesphere v3.0.0\n\n2.修改集群配置文件\nvi config-sample.yaml\napiVersion: kubekey.kubesphere.io/v1alpha1\nkind: Cluster\nmetadata:\n  name: laopai-uat\nspec:\n  hosts:\n  - {name: master01, address: 192.168.0.183, internalAddress: 192.168.0.183, user: root, password: password}\n  - {name: master02, address: 192.168.0.184, internalAddress: 192.168.0.184, user: root, password: password}\n  - {name: master03, address: 192.168.0.185, internalAddress: 192.168.0.185, user: root, password: password}\n  - {name: node01, address: 192.168.0.186, internalAddress: 192.168.0.186, user: root, password: password}\n  - {name: node02, address: 192.168.0.187, internalAddress: 192.168.0.187, user: root, password: password}\n  - {name: node03, address: 192.168.0.188, internalAddress: 192.168.0.188, user: root, password: password}\n  - {name: node04, address: 192.168.0.189, internalAddress: 192.168.0.189, user: root, password: password}\n  - {name: node05, address: 192.168.0.190, internalAddress: 192.168.0.190, user: root, password: password}\n  roleGroups:\n    etcd:\n    - master01\n    - master02\n    - master03\n    master: \n    - master01\n    - master02\n    - master03\n    worker:\n    - node01\n    - node02\n    - node03\n    - node04\n    - node05\n  controlPlaneEndpoint:\n    domain: kubesphere.com\n    address: \"192.168.0.183\"\n    port: \"6443\"\n  kubernetes:\n    version: v1.18.6\n    imageRepo: kubesphere\n    clusterName: cluster.local\n  network:\n    plugin: calico\n    kubePodsCIDR: 10.233.64.0/18\n    kubeServiceCIDR: 10.233.0.0/18\n  registry:\n    registryMirrors: []\n    insecureRegistries: [\"192.168.0.183.2:5000\"]\n    privateRegistry: 192.168.0.183.2:5000\n  addons: \n  - name: nfs-client\n    namespace: kube-system\n    sources: \n      chart:\n        name: nfs-client-provisioner\n        #repo: https://charts.kubesphere.io/main\n        path: /data1/kubesphere-all-v3.0.0-offline-linux-amd64/charts\n        values:\n        - image.repository=192.168.0.183.2:5000/kubesphere/nfs-client-provisioner\n        - nfs.server=100.68.212.1\n        - nfs.path=/data\n        - storageClass.defaultClass=true\n\n\n---\napiVersion: installer.kubesphere.io/v1alpha1\nkind: ClusterConfiguration\nmetadata:\n  name: ks-installer\n  namespace: kubesphere-system\n  labels:\n    version: v3.0.0\nspec:\n  local_registry: \"\"\n  persistence:\n    storageClass: \"\"\n  authentication:\n    jwtSecret: \"\"\n  etcd:\n    monitoring: true\n    endpointIps: localhost\n    port: 2379\n    tlsEnable: true\n  common:\n    es:\n      elasticsearchDataVolumeSize: 20Gi\n      elasticsearchMasterVolumeSize: 4Gi\n      elkPrefix: logstash\n      logMaxAge: 7\n    mysqlVolumeSize: 20Gi\n    minioVolumeSize: 20Gi\n    etcdVolumeSize: 20Gi\n    openldapVolumeSize: 2Gi\n    redisVolumSize: 2Gi\n  console:\n    enableMultiLogin: false  # enable/disable multi login\n    port: 30880\n  alerting:\n    enabled: true\n  auditing:\n    enabled: true\n  devops:\n    enabled: true\n    jenkinsMemoryLim: 2Gi\n    jenkinsMemoryReq: 1500Mi\n    jenkinsVolumeSize: 8Gi\n    jenkinsJavaOpts_Xms: 512m\n    jenkinsJavaOpts_Xmx: 512m\n    jenkinsJavaOpts_MaxRAM: 2g\n  events:\n    enabled: true\n    ruler:\n      enabled: true\n      replicas: 2\n  logging:\n    enabled: true\n    logsidecarReplicas: 2\n  metrics_server:\n    enabled: true\n  monitoring:\n    prometheusMemoryRequest: 400Mi\n    prometheusVolumeSize: 20Gi\n  multicluster:\n    clusterRole: none  # host | member | none\n  networkpolicy:\n    enabled: true\n  notification:\n    enabled: true\n  openpitrix:\n    enabled: true\n  servicemesh:\n    enabled: true\n\n3.在镜像机器搭建registry私服\n\ndocker run -d --name registry2 --restart=always -v /data/registry:/var/lib/registry -p5000:5000registry:2\n\n\n\nregistry2安装后，集群所有节点需设置docker daemon.json文件insecure后重启docker\n\n4.导入镜像\n\n推送语句\n\n./push-images.sh 192.168.0.183:5000\n\n镜像清单\n\nk8s：\n\nkubesphere/kube-apiserver:v1.17.9\n\nkubesphere/kube-scheduler:v1.17.9\n\nkubesphere/kube-proxy:v1.17.9\n\nkubesphere/kube-controller-manager:v1.17.9\n\nkubesphere/pause:3.1\n\nkubesphere/pause:3.2 (k8s版本大于v1.18)\n\nkubesphere/etcd:v3.3.12\n\ncalico/kube-controllers:v3.15.1\n\ncalico/node:v3.15.1\n\ncalico/cni:v3.15.1\n\ncalico/pod2daemon-flexvol:v3.15.1\n\ncoredns/coredns:1.6.9\n\nkubesphere/k8s-dns-node-cache:1.15.12\n\n\n\nlocalVolume：\n\nkubesphere/node-disk-manager:0.5.0\n\nkubesphere/node-disk-operator:0.5.0\n\nkubesphere/provisioner-localpv:1.10.0\n\nkubesphere/linux-utils:1.10.0\n\n\n\nkubesphere：\n\nkubesphere/ks-apiserver:v3.0.0\n\nkubesphere/ks-console:v3.0.0\n\nkubesphere/ks-controller-manager:v3.0.0\n\nkubesphere/ks-installer:v3.0.0\n\nkubesphere/etcd:v3.2.18\n\nkubesphere/kubectl:v1.0.0\n\nkubesphere/ks-upgrade:v3.0.0\n\nkubesphere/ks-devops:flyway-v3.0.0\n\nredis:5.0.5-alpine\n\nalpine:3.10.4\n\nhaproxy:2.0.4\n\nmysql:8.0.11\n\nnginx:1.14-alpine\n\nminio/minio:RELEASE.2019-08-07T01-59-21Z\n\nminio/mc:RELEASE.2019-08-07T23-14-43Z\n\nmirrorgooglecontainers/defaultbackend-amd64:1.4\n\nkubesphere/nginx-ingress-controller:0.24.1\n\nosixia/openldap:1.3.0\n\ncsiplugin/snapshot-controller:v2.0.1\n\nkubesphere/ks-upgrade:v3.0.0\n\nkubesphere/ks-devops:flyway-v3.0.0\n\n\n\nmonitoring：\n\nkubesphere/prometheus-config-reloader:v0.38.3\n\nkubesphere/prometheus-operator:v0.38.3\n\nprom/alertmanager:v0.21.0\n\nprom/prometheus:v2.20.1\n\nkubesphere/node-exporter:ks-v0.18.1\n\njimmidyson/configmap-reload:v0.3.0\n\nkubesphere/notification-manager-operator:v0.1.0\n\nkubesphere/notification-manager:v0.1.0\n\nkubesphere/metrics-server:v0.3.7\n\nkubesphere/kube-rbac-proxy:v0.4.1\n\nkubesphere/kube-state-metrics:v1.9.6\n\n\n\nlogging:\n\nkubesphere/elasticsearch-oss:6.7.0-1\n\nkubesphere/fluentbit-operator:v0.2.0\n\nkubesphere/fluentbit-operator:migrator\n\nkubesphere/fluent-bit:v1.4.6\n\nkubesphere/kube-auditing-operator:v0.1.0\n\nkubesphere/kube-auditing-webhook:v0.1.0\n\nkubesphere/kube-events-exporter:v0.1.0\n\nkubesphere/kube-events-operator:v0.1.0\n\nkubesphere/kube-events-ruler:v0.1.0\n\nkubesphere/log-sidecar-injector:1.1\n\ndocker:19.03\n\nservice-mesh：\n\nistio/citadel:1.4.8\n\nistio/galley:1.4.8\n\nistio/kubectl:1.4.8\n\nistio/mixer:1.4.8\n\nistio/pilot:1.4.8\n\nistio/proxyv2:1.4.8\n\nistio/sidecar_injector:1.4.8\n\njaegertracing/jaeger-agent:1.17\n\njaegertracing/jaeger-collector:1.17\n\njaegertracing/jaeger-operator:1.17.1\n\njaegertracing/jaeger-query:1.17\n\njaegertracing/jaeger-es-index-cleaner:1.17.1\n\n\n\ndevops：\n\njenkins/jenkins:2.176.2\n\njenkins/jnlp-slave:3.27-1\n\nkubesphere/jenkins-uc:v3.0.0\n\nkubesphere/s2ioperator:v2.1.1\n\nkubesphere/s2irun:v2.1.1\n\nkubesphere/builder-base:v2.1.0\n\nkubesphere/builder-nodejs:v2.1.0\n\nkubesphere/builder-maven:v2.1.0\n\nkubesphere/builder-go:v2.1.0\n\nkubesphere/s2i-binary:v2.1.0\n\nkubesphere/tomcat85-java11-centos7:v2.1.0\n\nkubesphere/tomcat85-java11-runtime:v2.1.0\n\nkubesphere/tomcat85-java8-centos7:v2.1.0\n\nkubesphere/tomcat85-java8-runtime:v2.1.0\n\nkubesphere/java-11-centos7:v2.1.0\n\nkubesphere/java-8-centos7:v2.1.0\n\nkubesphere/java-8-runtime:v2.1.0\n\nkubesphere/java-11-runtime:v2.1.0\n\nkubesphere/nodejs-8-centos7:v2.1.0\n\nkubesphere/nodejs-6-centos7:v2.1.0\n\nkubesphere/nodejs-4-centos7:v2.1.0\n\nkubesphere/python-36-centos7:v2.1.0\n\nkubesphere/python-35-centos7:v2.1.0\n\nkubesphere/python-34-centos7:v2.1.0\n\nkubesphere/python-27-centos7:v2.1.0\n\n\n\nnotification&&alerting:\n\nkubesphere/notification:flyway_v2.1.2\n\nkubesphere/notification:v2.1.2\n\nkubesphere/alert-adapter:v3.0.0\n\nkubesphere/alerting-dbinit:v3.0.0\n\nkubesphere/alerting:v2.1.2\n\n\n\nmulticluster:\n\nkubesphere/kubefed:v0.3.0\n\nkubesphere/tower:v0.1.0\n\n\n\nopenpitrix(app store)：\n\nopenpitrix/generate-kubeconfig:v0.5.0\n\nopenpitrix/openpitrix:flyway-v0.5.0\n\nopenpitrix/openpitrix:v0.5.0\n\nopenpitrix/release-app:v0.5.0\n\n5.节点初始化\n\nyum install -y socat conntrack ebtables ipset\n\n./kk init os -f config-sample.yaml -s ./dependencies/\n\n6.执行集群安装\n\n集群安装语句\n\n./kk create cluster -f config-sample.yaml\n\n显示安装结果\n\n#####################################################\n\n###Welcome to KubeSphere!###\n\n#####################################################\n\n\n\nConsole: http://192.168.0.8:30880\n\nAccount: admin\n\nPassword: P@88w0rd\n\n\n\nNOTES：\n\n1.After logging into theconsole, please check the\n\nmonitoring statusofservice componentsin\n\nthe\"Cluster Management\". If any serviceisnot\n\nready, please wait patientlyuntilall components\n\nare ready.\n\n2.Please modify thedefaultpassword after login.\n\n\n\n#####################################################\n\nhttps://kubesphere.io\n\n20xx-xx-xx xx:xx:xx\n\n#####################################################\n\n检查安装\n\nkubectl logs -n kubesphere-system$(kubectl get pod -n kubesphere-system-l app=ks-install -o jsonpath='{.items[0].metadata.name}') -f\n\n7.集群清理/卸载\n\n./kk delete cluster –f config-sample.yaml\n\n8.集群增加节点\n\n编辑追加config-sample,host行\n\n./kk add nodes -f config-sample.yaml\n\n9.集群删除节点\n\n./kk delete node nodeName -f config-sample.yaml\n```\n\n","slug":"kubesphere部署","published":1,"updated":"2023-01-03T06:17:51.245Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clcfuykyp00083wrs5ra94g2h","content":"<h1 id=\"青云部署k8s\"><a href=\"#青云部署k8s\" class=\"headerlink\" title=\"青云部署k8s\"></a>青云部署k8s</h1><p>获取离线安装包</p>\n<span id=\"more\"></span>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br><span class=\"line\">325</span><br><span class=\"line\">326</span><br><span class=\"line\">327</span><br><span class=\"line\">328</span><br><span class=\"line\">329</span><br><span class=\"line\">330</span><br><span class=\"line\">331</span><br><span class=\"line\">332</span><br><span class=\"line\">333</span><br><span class=\"line\">334</span><br><span class=\"line\">335</span><br><span class=\"line\">336</span><br><span class=\"line\">337</span><br><span class=\"line\">338</span><br><span class=\"line\">339</span><br><span class=\"line\">340</span><br><span class=\"line\">341</span><br><span class=\"line\">342</span><br><span class=\"line\">343</span><br><span class=\"line\">344</span><br><span class=\"line\">345</span><br><span class=\"line\">346</span><br><span class=\"line\">347</span><br><span class=\"line\">348</span><br><span class=\"line\">349</span><br><span class=\"line\">350</span><br><span class=\"line\">351</span><br><span class=\"line\">352</span><br><span class=\"line\">353</span><br><span class=\"line\">354</span><br><span class=\"line\">355</span><br><span class=\"line\">356</span><br><span class=\"line\">357</span><br><span class=\"line\">358</span><br><span class=\"line\">359</span><br><span class=\"line\">360</span><br><span class=\"line\">361</span><br><span class=\"line\">362</span><br><span class=\"line\">363</span><br><span class=\"line\">364</span><br><span class=\"line\">365</span><br><span class=\"line\">366</span><br><span class=\"line\">367</span><br><span class=\"line\">368</span><br><span class=\"line\">369</span><br><span class=\"line\">370</span><br><span class=\"line\">371</span><br><span class=\"line\">372</span><br><span class=\"line\">373</span><br><span class=\"line\">374</span><br><span class=\"line\">375</span><br><span class=\"line\">376</span><br><span class=\"line\">377</span><br><span class=\"line\">378</span><br><span class=\"line\">379</span><br><span class=\"line\">380</span><br><span class=\"line\">381</span><br><span class=\"line\">382</span><br><span class=\"line\">383</span><br><span class=\"line\">384</span><br><span class=\"line\">385</span><br><span class=\"line\">386</span><br><span class=\"line\">387</span><br><span class=\"line\">388</span><br><span class=\"line\">389</span><br><span class=\"line\">390</span><br><span class=\"line\">391</span><br><span class=\"line\">392</span><br><span class=\"line\">393</span><br><span class=\"line\">394</span><br><span class=\"line\">395</span><br><span class=\"line\">396</span><br><span class=\"line\">397</span><br><span class=\"line\">398</span><br><span class=\"line\">399</span><br><span class=\"line\">400</span><br><span class=\"line\">401</span><br><span class=\"line\">402</span><br><span class=\"line\">403</span><br><span class=\"line\">404</span><br><span class=\"line\">405</span><br><span class=\"line\">406</span><br><span class=\"line\">407</span><br><span class=\"line\">408</span><br><span class=\"line\">409</span><br><span class=\"line\">410</span><br><span class=\"line\">411</span><br><span class=\"line\">412</span><br><span class=\"line\">413</span><br><span class=\"line\">414</span><br><span class=\"line\">415</span><br><span class=\"line\">416</span><br><span class=\"line\">417</span><br><span class=\"line\">418</span><br><span class=\"line\">419</span><br><span class=\"line\">420</span><br><span class=\"line\">421</span><br><span class=\"line\">422</span><br><span class=\"line\">423</span><br><span class=\"line\">424</span><br><span class=\"line\">425</span><br><span class=\"line\">426</span><br><span class=\"line\">427</span><br><span class=\"line\">428</span><br><span class=\"line\">429</span><br><span class=\"line\">430</span><br><span class=\"line\">431</span><br><span class=\"line\">432</span><br><span class=\"line\">433</span><br><span class=\"line\">434</span><br><span class=\"line\">435</span><br><span class=\"line\">436</span><br><span class=\"line\">437</span><br><span class=\"line\">438</span><br><span class=\"line\">439</span><br><span class=\"line\">440</span><br><span class=\"line\">441</span><br><span class=\"line\">442</span><br><span class=\"line\">443</span><br><span class=\"line\">444</span><br><span class=\"line\">445</span><br><span class=\"line\">446</span><br><span class=\"line\">447</span><br><span class=\"line\">448</span><br><span class=\"line\">449</span><br><span class=\"line\">450</span><br><span class=\"line\">451</span><br><span class=\"line\">452</span><br><span class=\"line\">453</span><br><span class=\"line\">454</span><br><span class=\"line\">455</span><br><span class=\"line\">456</span><br><span class=\"line\">457</span><br><span class=\"line\">458</span><br><span class=\"line\">459</span><br><span class=\"line\">460</span><br><span class=\"line\">461</span><br><span class=\"line\">462</span><br><span class=\"line\">463</span><br><span class=\"line\">464</span><br><span class=\"line\">465</span><br><span class=\"line\">466</span><br><span class=\"line\">467</span><br><span class=\"line\">468</span><br><span class=\"line\">469</span><br><span class=\"line\">470</span><br><span class=\"line\">471</span><br><span class=\"line\">472</span><br><span class=\"line\">473</span><br><span class=\"line\">474</span><br><span class=\"line\">475</span><br><span class=\"line\">476</span><br><span class=\"line\">477</span><br><span class=\"line\">478</span><br><span class=\"line\">479</span><br><span class=\"line\">480</span><br><span class=\"line\">481</span><br><span class=\"line\">482</span><br><span class=\"line\">483</span><br><span class=\"line\">484</span><br><span class=\"line\">485</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">青云部署k8s</span><br><span class=\"line\">获取离线安装包</span><br><span class=\"line\"></span><br><span class=\"line\">curl -Ok https://kubesphere-installer.pek3b.qingstor.com/offline/v3.0.0/kubesphere-all-v3.0.0-offline-linux-amd64.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">解压离线安装包</span><br><span class=\"line\">tar-xvf kubesphere-all-v3.0.0-offline-linux-amd64.tar.gz -C /usr/local/</span><br><span class=\"line\"></span><br><span class=\"line\">集群安装</span><br><span class=\"line\"></span><br><span class=\"line\">1.创建集群配置文件</span><br><span class=\"line\"></span><br><span class=\"line\">./kk create config --with-kubesphere v3.0.0</span><br><span class=\"line\"></span><br><span class=\"line\">2.修改集群配置文件</span><br><span class=\"line\">vi config-sample.yaml</span><br><span class=\"line\">apiVersion: kubekey.kubesphere.io/v1alpha1</span><br><span class=\"line\">kind: Cluster</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: laopai-uat</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  hosts:</span><br><span class=\"line\">  - &#123;name: master01, address: 192.168.0.183, internalAddress: 192.168.0.183, user: root, password: password&#125;</span><br><span class=\"line\">  - &#123;name: master02, address: 192.168.0.184, internalAddress: 192.168.0.184, user: root, password: password&#125;</span><br><span class=\"line\">  - &#123;name: master03, address: 192.168.0.185, internalAddress: 192.168.0.185, user: root, password: password&#125;</span><br><span class=\"line\">  - &#123;name: node01, address: 192.168.0.186, internalAddress: 192.168.0.186, user: root, password: password&#125;</span><br><span class=\"line\">  - &#123;name: node02, address: 192.168.0.187, internalAddress: 192.168.0.187, user: root, password: password&#125;</span><br><span class=\"line\">  - &#123;name: node03, address: 192.168.0.188, internalAddress: 192.168.0.188, user: root, password: password&#125;</span><br><span class=\"line\">  - &#123;name: node04, address: 192.168.0.189, internalAddress: 192.168.0.189, user: root, password: password&#125;</span><br><span class=\"line\">  - &#123;name: node05, address: 192.168.0.190, internalAddress: 192.168.0.190, user: root, password: password&#125;</span><br><span class=\"line\">  roleGroups:</span><br><span class=\"line\">    etcd:</span><br><span class=\"line\">    - master01</span><br><span class=\"line\">    - master02</span><br><span class=\"line\">    - master03</span><br><span class=\"line\">    master: </span><br><span class=\"line\">    - master01</span><br><span class=\"line\">    - master02</span><br><span class=\"line\">    - master03</span><br><span class=\"line\">    worker:</span><br><span class=\"line\">    - node01</span><br><span class=\"line\">    - node02</span><br><span class=\"line\">    - node03</span><br><span class=\"line\">    - node04</span><br><span class=\"line\">    - node05</span><br><span class=\"line\">  controlPlaneEndpoint:</span><br><span class=\"line\">    domain: kubesphere.com</span><br><span class=\"line\">    address: &quot;192.168.0.183&quot;</span><br><span class=\"line\">    port: &quot;6443&quot;</span><br><span class=\"line\">  kubernetes:</span><br><span class=\"line\">    version: v1.18.6</span><br><span class=\"line\">    imageRepo: kubesphere</span><br><span class=\"line\">    clusterName: cluster.local</span><br><span class=\"line\">  network:</span><br><span class=\"line\">    plugin: calico</span><br><span class=\"line\">    kubePodsCIDR: 10.233.64.0/18</span><br><span class=\"line\">    kubeServiceCIDR: 10.233.0.0/18</span><br><span class=\"line\">  registry:</span><br><span class=\"line\">    registryMirrors: []</span><br><span class=\"line\">    insecureRegistries: [&quot;192.168.0.183.2:5000&quot;]</span><br><span class=\"line\">    privateRegistry: 192.168.0.183.2:5000</span><br><span class=\"line\">  addons: </span><br><span class=\"line\">  - name: nfs-client</span><br><span class=\"line\">    namespace: kube-system</span><br><span class=\"line\">    sources: </span><br><span class=\"line\">      chart:</span><br><span class=\"line\">        name: nfs-client-provisioner</span><br><span class=\"line\">        #repo: https://charts.kubesphere.io/main</span><br><span class=\"line\">        path: /data1/kubesphere-all-v3.0.0-offline-linux-amd64/charts</span><br><span class=\"line\">        values:</span><br><span class=\"line\">        - image.repository=192.168.0.183.2:5000/kubesphere/nfs-client-provisioner</span><br><span class=\"line\">        - nfs.server=100.68.212.1</span><br><span class=\"line\">        - nfs.path=/data</span><br><span class=\"line\">        - storageClass.defaultClass=true</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: installer.kubesphere.io/v1alpha1</span><br><span class=\"line\">kind: ClusterConfiguration</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: ks-installer</span><br><span class=\"line\">  namespace: kubesphere-system</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    version: v3.0.0</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  local_registry: &quot;&quot;</span><br><span class=\"line\">  persistence:</span><br><span class=\"line\">    storageClass: &quot;&quot;</span><br><span class=\"line\">  authentication:</span><br><span class=\"line\">    jwtSecret: &quot;&quot;</span><br><span class=\"line\">  etcd:</span><br><span class=\"line\">    monitoring: true</span><br><span class=\"line\">    endpointIps: localhost</span><br><span class=\"line\">    port: 2379</span><br><span class=\"line\">    tlsEnable: true</span><br><span class=\"line\">  common:</span><br><span class=\"line\">    es:</span><br><span class=\"line\">      elasticsearchDataVolumeSize: 20Gi</span><br><span class=\"line\">      elasticsearchMasterVolumeSize: 4Gi</span><br><span class=\"line\">      elkPrefix: logstash</span><br><span class=\"line\">      logMaxAge: 7</span><br><span class=\"line\">    mysqlVolumeSize: 20Gi</span><br><span class=\"line\">    minioVolumeSize: 20Gi</span><br><span class=\"line\">    etcdVolumeSize: 20Gi</span><br><span class=\"line\">    openldapVolumeSize: 2Gi</span><br><span class=\"line\">    redisVolumSize: 2Gi</span><br><span class=\"line\">  console:</span><br><span class=\"line\">    enableMultiLogin: false  # enable/disable multi login</span><br><span class=\"line\">    port: 30880</span><br><span class=\"line\">  alerting:</span><br><span class=\"line\">    enabled: true</span><br><span class=\"line\">  auditing:</span><br><span class=\"line\">    enabled: true</span><br><span class=\"line\">  devops:</span><br><span class=\"line\">    enabled: true</span><br><span class=\"line\">    jenkinsMemoryLim: 2Gi</span><br><span class=\"line\">    jenkinsMemoryReq: 1500Mi</span><br><span class=\"line\">    jenkinsVolumeSize: 8Gi</span><br><span class=\"line\">    jenkinsJavaOpts_Xms: 512m</span><br><span class=\"line\">    jenkinsJavaOpts_Xmx: 512m</span><br><span class=\"line\">    jenkinsJavaOpts_MaxRAM: 2g</span><br><span class=\"line\">  events:</span><br><span class=\"line\">    enabled: true</span><br><span class=\"line\">    ruler:</span><br><span class=\"line\">      enabled: true</span><br><span class=\"line\">      replicas: 2</span><br><span class=\"line\">  logging:</span><br><span class=\"line\">    enabled: true</span><br><span class=\"line\">    logsidecarReplicas: 2</span><br><span class=\"line\">  metrics_server:</span><br><span class=\"line\">    enabled: true</span><br><span class=\"line\">  monitoring:</span><br><span class=\"line\">    prometheusMemoryRequest: 400Mi</span><br><span class=\"line\">    prometheusVolumeSize: 20Gi</span><br><span class=\"line\">  multicluster:</span><br><span class=\"line\">    clusterRole: none  # host | member | none</span><br><span class=\"line\">  networkpolicy:</span><br><span class=\"line\">    enabled: true</span><br><span class=\"line\">  notification:</span><br><span class=\"line\">    enabled: true</span><br><span class=\"line\">  openpitrix:</span><br><span class=\"line\">    enabled: true</span><br><span class=\"line\">  servicemesh:</span><br><span class=\"line\">    enabled: true</span><br><span class=\"line\"></span><br><span class=\"line\">3.在镜像机器搭建registry私服</span><br><span class=\"line\"></span><br><span class=\"line\">docker run -d --name registry2 --restart=always -v /data/registry:/var/lib/registry -p5000:5000registry:2</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">registry2安装后，集群所有节点需设置docker daemon.json文件insecure后重启docker</span><br><span class=\"line\"></span><br><span class=\"line\">4.导入镜像</span><br><span class=\"line\"></span><br><span class=\"line\">推送语句</span><br><span class=\"line\"></span><br><span class=\"line\">./push-images.sh 192.168.0.183:5000</span><br><span class=\"line\"></span><br><span class=\"line\">镜像清单</span><br><span class=\"line\"></span><br><span class=\"line\">k8s：</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/kube-apiserver:v1.17.9</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/kube-scheduler:v1.17.9</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/kube-proxy:v1.17.9</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/kube-controller-manager:v1.17.9</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/pause:3.1</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/pause:3.2 (k8s版本大于v1.18)</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/etcd:v3.3.12</span><br><span class=\"line\"></span><br><span class=\"line\">calico/kube-controllers:v3.15.1</span><br><span class=\"line\"></span><br><span class=\"line\">calico/node:v3.15.1</span><br><span class=\"line\"></span><br><span class=\"line\">calico/cni:v3.15.1</span><br><span class=\"line\"></span><br><span class=\"line\">calico/pod2daemon-flexvol:v3.15.1</span><br><span class=\"line\"></span><br><span class=\"line\">coredns/coredns:1.6.9</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/k8s-dns-node-cache:1.15.12</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">localVolume：</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/node-disk-manager:0.5.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/node-disk-operator:0.5.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/provisioner-localpv:1.10.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/linux-utils:1.10.0</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere：</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/ks-apiserver:v3.0.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/ks-console:v3.0.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/ks-controller-manager:v3.0.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/ks-installer:v3.0.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/etcd:v3.2.18</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/kubectl:v1.0.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/ks-upgrade:v3.0.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/ks-devops:flyway-v3.0.0</span><br><span class=\"line\"></span><br><span class=\"line\">redis:5.0.5-alpine</span><br><span class=\"line\"></span><br><span class=\"line\">alpine:3.10.4</span><br><span class=\"line\"></span><br><span class=\"line\">haproxy:2.0.4</span><br><span class=\"line\"></span><br><span class=\"line\">mysql:8.0.11</span><br><span class=\"line\"></span><br><span class=\"line\">nginx:1.14-alpine</span><br><span class=\"line\"></span><br><span class=\"line\">minio/minio:RELEASE.2019-08-07T01-59-21Z</span><br><span class=\"line\"></span><br><span class=\"line\">minio/mc:RELEASE.2019-08-07T23-14-43Z</span><br><span class=\"line\"></span><br><span class=\"line\">mirrorgooglecontainers/defaultbackend-amd64:1.4</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/nginx-ingress-controller:0.24.1</span><br><span class=\"line\"></span><br><span class=\"line\">osixia/openldap:1.3.0</span><br><span class=\"line\"></span><br><span class=\"line\">csiplugin/snapshot-controller:v2.0.1</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/ks-upgrade:v3.0.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/ks-devops:flyway-v3.0.0</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">monitoring：</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/prometheus-config-reloader:v0.38.3</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/prometheus-operator:v0.38.3</span><br><span class=\"line\"></span><br><span class=\"line\">prom/alertmanager:v0.21.0</span><br><span class=\"line\"></span><br><span class=\"line\">prom/prometheus:v2.20.1</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/node-exporter:ks-v0.18.1</span><br><span class=\"line\"></span><br><span class=\"line\">jimmidyson/configmap-reload:v0.3.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/notification-manager-operator:v0.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/notification-manager:v0.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/metrics-server:v0.3.7</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/kube-rbac-proxy:v0.4.1</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/kube-state-metrics:v1.9.6</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">logging:</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/elasticsearch-oss:6.7.0-1</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/fluentbit-operator:v0.2.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/fluentbit-operator:migrator</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/fluent-bit:v1.4.6</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/kube-auditing-operator:v0.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/kube-auditing-webhook:v0.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/kube-events-exporter:v0.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/kube-events-operator:v0.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/kube-events-ruler:v0.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/log-sidecar-injector:1.1</span><br><span class=\"line\"></span><br><span class=\"line\">docker:19.03</span><br><span class=\"line\"></span><br><span class=\"line\">service-mesh：</span><br><span class=\"line\"></span><br><span class=\"line\">istio/citadel:1.4.8</span><br><span class=\"line\"></span><br><span class=\"line\">istio/galley:1.4.8</span><br><span class=\"line\"></span><br><span class=\"line\">istio/kubectl:1.4.8</span><br><span class=\"line\"></span><br><span class=\"line\">istio/mixer:1.4.8</span><br><span class=\"line\"></span><br><span class=\"line\">istio/pilot:1.4.8</span><br><span class=\"line\"></span><br><span class=\"line\">istio/proxyv2:1.4.8</span><br><span class=\"line\"></span><br><span class=\"line\">istio/sidecar_injector:1.4.8</span><br><span class=\"line\"></span><br><span class=\"line\">jaegertracing/jaeger-agent:1.17</span><br><span class=\"line\"></span><br><span class=\"line\">jaegertracing/jaeger-collector:1.17</span><br><span class=\"line\"></span><br><span class=\"line\">jaegertracing/jaeger-operator:1.17.1</span><br><span class=\"line\"></span><br><span class=\"line\">jaegertracing/jaeger-query:1.17</span><br><span class=\"line\"></span><br><span class=\"line\">jaegertracing/jaeger-es-index-cleaner:1.17.1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">devops：</span><br><span class=\"line\"></span><br><span class=\"line\">jenkins/jenkins:2.176.2</span><br><span class=\"line\"></span><br><span class=\"line\">jenkins/jnlp-slave:3.27-1</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/jenkins-uc:v3.0.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/s2ioperator:v2.1.1</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/s2irun:v2.1.1</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/builder-base:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/builder-nodejs:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/builder-maven:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/builder-go:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/s2i-binary:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/tomcat85-java11-centos7:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/tomcat85-java11-runtime:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/tomcat85-java8-centos7:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/tomcat85-java8-runtime:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/java-11-centos7:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/java-8-centos7:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/java-8-runtime:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/java-11-runtime:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/nodejs-8-centos7:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/nodejs-6-centos7:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/nodejs-4-centos7:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/python-36-centos7:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/python-35-centos7:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/python-34-centos7:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/python-27-centos7:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">notification&amp;&amp;alerting:</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/notification:flyway_v2.1.2</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/notification:v2.1.2</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/alert-adapter:v3.0.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/alerting-dbinit:v3.0.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/alerting:v2.1.2</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">multicluster:</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/kubefed:v0.3.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/tower:v0.1.0</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">openpitrix(app store)：</span><br><span class=\"line\"></span><br><span class=\"line\">openpitrix/generate-kubeconfig:v0.5.0</span><br><span class=\"line\"></span><br><span class=\"line\">openpitrix/openpitrix:flyway-v0.5.0</span><br><span class=\"line\"></span><br><span class=\"line\">openpitrix/openpitrix:v0.5.0</span><br><span class=\"line\"></span><br><span class=\"line\">openpitrix/release-app:v0.5.0</span><br><span class=\"line\"></span><br><span class=\"line\">5.节点初始化</span><br><span class=\"line\"></span><br><span class=\"line\">yum install -y socat conntrack ebtables ipset</span><br><span class=\"line\"></span><br><span class=\"line\">./kk init os -f config-sample.yaml -s ./dependencies/</span><br><span class=\"line\"></span><br><span class=\"line\">6.执行集群安装</span><br><span class=\"line\"></span><br><span class=\"line\">集群安装语句</span><br><span class=\"line\"></span><br><span class=\"line\">./kk create cluster -f config-sample.yaml</span><br><span class=\"line\"></span><br><span class=\"line\">显示安装结果</span><br><span class=\"line\"></span><br><span class=\"line\">#####################################################</span><br><span class=\"line\"></span><br><span class=\"line\">###Welcome to KubeSphere!###</span><br><span class=\"line\"></span><br><span class=\"line\">#####################################################</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Console: http://192.168.0.8:30880</span><br><span class=\"line\"></span><br><span class=\"line\">Account: admin</span><br><span class=\"line\"></span><br><span class=\"line\">Password: P@88w0rd</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">NOTES：</span><br><span class=\"line\"></span><br><span class=\"line\">1.After logging into theconsole, please check the</span><br><span class=\"line\"></span><br><span class=\"line\">monitoring statusofservice componentsin</span><br><span class=\"line\"></span><br><span class=\"line\">the&quot;Cluster Management&quot;. If any serviceisnot</span><br><span class=\"line\"></span><br><span class=\"line\">ready, please wait patientlyuntilall components</span><br><span class=\"line\"></span><br><span class=\"line\">are ready.</span><br><span class=\"line\"></span><br><span class=\"line\">2.Please modify thedefaultpassword after login.</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#####################################################</span><br><span class=\"line\"></span><br><span class=\"line\">https://kubesphere.io</span><br><span class=\"line\"></span><br><span class=\"line\">20xx-xx-xx xx:xx:xx</span><br><span class=\"line\"></span><br><span class=\"line\">#####################################################</span><br><span class=\"line\"></span><br><span class=\"line\">检查安装</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl logs -n kubesphere-system$(kubectl get pod -n kubesphere-system-l app=ks-install -o jsonpath=&#x27;&#123;.items[0].metadata.name&#125;&#x27;) -f</span><br><span class=\"line\"></span><br><span class=\"line\">7.集群清理/卸载</span><br><span class=\"line\"></span><br><span class=\"line\">./kk delete cluster –f config-sample.yaml</span><br><span class=\"line\"></span><br><span class=\"line\">8.集群增加节点</span><br><span class=\"line\"></span><br><span class=\"line\">编辑追加config-sample,host行</span><br><span class=\"line\"></span><br><span class=\"line\">./kk add nodes -f config-sample.yaml</span><br><span class=\"line\"></span><br><span class=\"line\">9.集群删除节点</span><br><span class=\"line\"></span><br><span class=\"line\">./kk delete node nodeName -f config-sample.yaml</span><br></pre></td></tr></table></figure>\n\n","site":{"data":{}},"excerpt":"<h1 id=\"青云部署k8s\"><a href=\"#青云部署k8s\" class=\"headerlink\" title=\"青云部署k8s\"></a>青云部署k8s</h1><p>获取离线安装包</p>","more":"<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br><span class=\"line\">325</span><br><span class=\"line\">326</span><br><span class=\"line\">327</span><br><span class=\"line\">328</span><br><span class=\"line\">329</span><br><span class=\"line\">330</span><br><span class=\"line\">331</span><br><span class=\"line\">332</span><br><span class=\"line\">333</span><br><span class=\"line\">334</span><br><span class=\"line\">335</span><br><span class=\"line\">336</span><br><span class=\"line\">337</span><br><span class=\"line\">338</span><br><span class=\"line\">339</span><br><span class=\"line\">340</span><br><span class=\"line\">341</span><br><span class=\"line\">342</span><br><span class=\"line\">343</span><br><span class=\"line\">344</span><br><span class=\"line\">345</span><br><span class=\"line\">346</span><br><span class=\"line\">347</span><br><span class=\"line\">348</span><br><span class=\"line\">349</span><br><span class=\"line\">350</span><br><span class=\"line\">351</span><br><span class=\"line\">352</span><br><span class=\"line\">353</span><br><span class=\"line\">354</span><br><span class=\"line\">355</span><br><span class=\"line\">356</span><br><span class=\"line\">357</span><br><span class=\"line\">358</span><br><span class=\"line\">359</span><br><span class=\"line\">360</span><br><span class=\"line\">361</span><br><span class=\"line\">362</span><br><span class=\"line\">363</span><br><span class=\"line\">364</span><br><span class=\"line\">365</span><br><span class=\"line\">366</span><br><span class=\"line\">367</span><br><span class=\"line\">368</span><br><span class=\"line\">369</span><br><span class=\"line\">370</span><br><span class=\"line\">371</span><br><span class=\"line\">372</span><br><span class=\"line\">373</span><br><span class=\"line\">374</span><br><span class=\"line\">375</span><br><span class=\"line\">376</span><br><span class=\"line\">377</span><br><span class=\"line\">378</span><br><span class=\"line\">379</span><br><span class=\"line\">380</span><br><span class=\"line\">381</span><br><span class=\"line\">382</span><br><span class=\"line\">383</span><br><span class=\"line\">384</span><br><span class=\"line\">385</span><br><span class=\"line\">386</span><br><span class=\"line\">387</span><br><span class=\"line\">388</span><br><span class=\"line\">389</span><br><span class=\"line\">390</span><br><span class=\"line\">391</span><br><span class=\"line\">392</span><br><span class=\"line\">393</span><br><span class=\"line\">394</span><br><span class=\"line\">395</span><br><span class=\"line\">396</span><br><span class=\"line\">397</span><br><span class=\"line\">398</span><br><span class=\"line\">399</span><br><span class=\"line\">400</span><br><span class=\"line\">401</span><br><span class=\"line\">402</span><br><span class=\"line\">403</span><br><span class=\"line\">404</span><br><span class=\"line\">405</span><br><span class=\"line\">406</span><br><span class=\"line\">407</span><br><span class=\"line\">408</span><br><span class=\"line\">409</span><br><span class=\"line\">410</span><br><span class=\"line\">411</span><br><span class=\"line\">412</span><br><span class=\"line\">413</span><br><span class=\"line\">414</span><br><span class=\"line\">415</span><br><span class=\"line\">416</span><br><span class=\"line\">417</span><br><span class=\"line\">418</span><br><span class=\"line\">419</span><br><span class=\"line\">420</span><br><span class=\"line\">421</span><br><span class=\"line\">422</span><br><span class=\"line\">423</span><br><span class=\"line\">424</span><br><span class=\"line\">425</span><br><span class=\"line\">426</span><br><span class=\"line\">427</span><br><span class=\"line\">428</span><br><span class=\"line\">429</span><br><span class=\"line\">430</span><br><span class=\"line\">431</span><br><span class=\"line\">432</span><br><span class=\"line\">433</span><br><span class=\"line\">434</span><br><span class=\"line\">435</span><br><span class=\"line\">436</span><br><span class=\"line\">437</span><br><span class=\"line\">438</span><br><span class=\"line\">439</span><br><span class=\"line\">440</span><br><span class=\"line\">441</span><br><span class=\"line\">442</span><br><span class=\"line\">443</span><br><span class=\"line\">444</span><br><span class=\"line\">445</span><br><span class=\"line\">446</span><br><span class=\"line\">447</span><br><span class=\"line\">448</span><br><span class=\"line\">449</span><br><span class=\"line\">450</span><br><span class=\"line\">451</span><br><span class=\"line\">452</span><br><span class=\"line\">453</span><br><span class=\"line\">454</span><br><span class=\"line\">455</span><br><span class=\"line\">456</span><br><span class=\"line\">457</span><br><span class=\"line\">458</span><br><span class=\"line\">459</span><br><span class=\"line\">460</span><br><span class=\"line\">461</span><br><span class=\"line\">462</span><br><span class=\"line\">463</span><br><span class=\"line\">464</span><br><span class=\"line\">465</span><br><span class=\"line\">466</span><br><span class=\"line\">467</span><br><span class=\"line\">468</span><br><span class=\"line\">469</span><br><span class=\"line\">470</span><br><span class=\"line\">471</span><br><span class=\"line\">472</span><br><span class=\"line\">473</span><br><span class=\"line\">474</span><br><span class=\"line\">475</span><br><span class=\"line\">476</span><br><span class=\"line\">477</span><br><span class=\"line\">478</span><br><span class=\"line\">479</span><br><span class=\"line\">480</span><br><span class=\"line\">481</span><br><span class=\"line\">482</span><br><span class=\"line\">483</span><br><span class=\"line\">484</span><br><span class=\"line\">485</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">青云部署k8s</span><br><span class=\"line\">获取离线安装包</span><br><span class=\"line\"></span><br><span class=\"line\">curl -Ok https://kubesphere-installer.pek3b.qingstor.com/offline/v3.0.0/kubesphere-all-v3.0.0-offline-linux-amd64.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">解压离线安装包</span><br><span class=\"line\">tar-xvf kubesphere-all-v3.0.0-offline-linux-amd64.tar.gz -C /usr/local/</span><br><span class=\"line\"></span><br><span class=\"line\">集群安装</span><br><span class=\"line\"></span><br><span class=\"line\">1.创建集群配置文件</span><br><span class=\"line\"></span><br><span class=\"line\">./kk create config --with-kubesphere v3.0.0</span><br><span class=\"line\"></span><br><span class=\"line\">2.修改集群配置文件</span><br><span class=\"line\">vi config-sample.yaml</span><br><span class=\"line\">apiVersion: kubekey.kubesphere.io/v1alpha1</span><br><span class=\"line\">kind: Cluster</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: laopai-uat</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  hosts:</span><br><span class=\"line\">  - &#123;name: master01, address: 192.168.0.183, internalAddress: 192.168.0.183, user: root, password: password&#125;</span><br><span class=\"line\">  - &#123;name: master02, address: 192.168.0.184, internalAddress: 192.168.0.184, user: root, password: password&#125;</span><br><span class=\"line\">  - &#123;name: master03, address: 192.168.0.185, internalAddress: 192.168.0.185, user: root, password: password&#125;</span><br><span class=\"line\">  - &#123;name: node01, address: 192.168.0.186, internalAddress: 192.168.0.186, user: root, password: password&#125;</span><br><span class=\"line\">  - &#123;name: node02, address: 192.168.0.187, internalAddress: 192.168.0.187, user: root, password: password&#125;</span><br><span class=\"line\">  - &#123;name: node03, address: 192.168.0.188, internalAddress: 192.168.0.188, user: root, password: password&#125;</span><br><span class=\"line\">  - &#123;name: node04, address: 192.168.0.189, internalAddress: 192.168.0.189, user: root, password: password&#125;</span><br><span class=\"line\">  - &#123;name: node05, address: 192.168.0.190, internalAddress: 192.168.0.190, user: root, password: password&#125;</span><br><span class=\"line\">  roleGroups:</span><br><span class=\"line\">    etcd:</span><br><span class=\"line\">    - master01</span><br><span class=\"line\">    - master02</span><br><span class=\"line\">    - master03</span><br><span class=\"line\">    master: </span><br><span class=\"line\">    - master01</span><br><span class=\"line\">    - master02</span><br><span class=\"line\">    - master03</span><br><span class=\"line\">    worker:</span><br><span class=\"line\">    - node01</span><br><span class=\"line\">    - node02</span><br><span class=\"line\">    - node03</span><br><span class=\"line\">    - node04</span><br><span class=\"line\">    - node05</span><br><span class=\"line\">  controlPlaneEndpoint:</span><br><span class=\"line\">    domain: kubesphere.com</span><br><span class=\"line\">    address: &quot;192.168.0.183&quot;</span><br><span class=\"line\">    port: &quot;6443&quot;</span><br><span class=\"line\">  kubernetes:</span><br><span class=\"line\">    version: v1.18.6</span><br><span class=\"line\">    imageRepo: kubesphere</span><br><span class=\"line\">    clusterName: cluster.local</span><br><span class=\"line\">  network:</span><br><span class=\"line\">    plugin: calico</span><br><span class=\"line\">    kubePodsCIDR: 10.233.64.0/18</span><br><span class=\"line\">    kubeServiceCIDR: 10.233.0.0/18</span><br><span class=\"line\">  registry:</span><br><span class=\"line\">    registryMirrors: []</span><br><span class=\"line\">    insecureRegistries: [&quot;192.168.0.183.2:5000&quot;]</span><br><span class=\"line\">    privateRegistry: 192.168.0.183.2:5000</span><br><span class=\"line\">  addons: </span><br><span class=\"line\">  - name: nfs-client</span><br><span class=\"line\">    namespace: kube-system</span><br><span class=\"line\">    sources: </span><br><span class=\"line\">      chart:</span><br><span class=\"line\">        name: nfs-client-provisioner</span><br><span class=\"line\">        #repo: https://charts.kubesphere.io/main</span><br><span class=\"line\">        path: /data1/kubesphere-all-v3.0.0-offline-linux-amd64/charts</span><br><span class=\"line\">        values:</span><br><span class=\"line\">        - image.repository=192.168.0.183.2:5000/kubesphere/nfs-client-provisioner</span><br><span class=\"line\">        - nfs.server=100.68.212.1</span><br><span class=\"line\">        - nfs.path=/data</span><br><span class=\"line\">        - storageClass.defaultClass=true</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: installer.kubesphere.io/v1alpha1</span><br><span class=\"line\">kind: ClusterConfiguration</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: ks-installer</span><br><span class=\"line\">  namespace: kubesphere-system</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    version: v3.0.0</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  local_registry: &quot;&quot;</span><br><span class=\"line\">  persistence:</span><br><span class=\"line\">    storageClass: &quot;&quot;</span><br><span class=\"line\">  authentication:</span><br><span class=\"line\">    jwtSecret: &quot;&quot;</span><br><span class=\"line\">  etcd:</span><br><span class=\"line\">    monitoring: true</span><br><span class=\"line\">    endpointIps: localhost</span><br><span class=\"line\">    port: 2379</span><br><span class=\"line\">    tlsEnable: true</span><br><span class=\"line\">  common:</span><br><span class=\"line\">    es:</span><br><span class=\"line\">      elasticsearchDataVolumeSize: 20Gi</span><br><span class=\"line\">      elasticsearchMasterVolumeSize: 4Gi</span><br><span class=\"line\">      elkPrefix: logstash</span><br><span class=\"line\">      logMaxAge: 7</span><br><span class=\"line\">    mysqlVolumeSize: 20Gi</span><br><span class=\"line\">    minioVolumeSize: 20Gi</span><br><span class=\"line\">    etcdVolumeSize: 20Gi</span><br><span class=\"line\">    openldapVolumeSize: 2Gi</span><br><span class=\"line\">    redisVolumSize: 2Gi</span><br><span class=\"line\">  console:</span><br><span class=\"line\">    enableMultiLogin: false  # enable/disable multi login</span><br><span class=\"line\">    port: 30880</span><br><span class=\"line\">  alerting:</span><br><span class=\"line\">    enabled: true</span><br><span class=\"line\">  auditing:</span><br><span class=\"line\">    enabled: true</span><br><span class=\"line\">  devops:</span><br><span class=\"line\">    enabled: true</span><br><span class=\"line\">    jenkinsMemoryLim: 2Gi</span><br><span class=\"line\">    jenkinsMemoryReq: 1500Mi</span><br><span class=\"line\">    jenkinsVolumeSize: 8Gi</span><br><span class=\"line\">    jenkinsJavaOpts_Xms: 512m</span><br><span class=\"line\">    jenkinsJavaOpts_Xmx: 512m</span><br><span class=\"line\">    jenkinsJavaOpts_MaxRAM: 2g</span><br><span class=\"line\">  events:</span><br><span class=\"line\">    enabled: true</span><br><span class=\"line\">    ruler:</span><br><span class=\"line\">      enabled: true</span><br><span class=\"line\">      replicas: 2</span><br><span class=\"line\">  logging:</span><br><span class=\"line\">    enabled: true</span><br><span class=\"line\">    logsidecarReplicas: 2</span><br><span class=\"line\">  metrics_server:</span><br><span class=\"line\">    enabled: true</span><br><span class=\"line\">  monitoring:</span><br><span class=\"line\">    prometheusMemoryRequest: 400Mi</span><br><span class=\"line\">    prometheusVolumeSize: 20Gi</span><br><span class=\"line\">  multicluster:</span><br><span class=\"line\">    clusterRole: none  # host | member | none</span><br><span class=\"line\">  networkpolicy:</span><br><span class=\"line\">    enabled: true</span><br><span class=\"line\">  notification:</span><br><span class=\"line\">    enabled: true</span><br><span class=\"line\">  openpitrix:</span><br><span class=\"line\">    enabled: true</span><br><span class=\"line\">  servicemesh:</span><br><span class=\"line\">    enabled: true</span><br><span class=\"line\"></span><br><span class=\"line\">3.在镜像机器搭建registry私服</span><br><span class=\"line\"></span><br><span class=\"line\">docker run -d --name registry2 --restart=always -v /data/registry:/var/lib/registry -p5000:5000registry:2</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">registry2安装后，集群所有节点需设置docker daemon.json文件insecure后重启docker</span><br><span class=\"line\"></span><br><span class=\"line\">4.导入镜像</span><br><span class=\"line\"></span><br><span class=\"line\">推送语句</span><br><span class=\"line\"></span><br><span class=\"line\">./push-images.sh 192.168.0.183:5000</span><br><span class=\"line\"></span><br><span class=\"line\">镜像清单</span><br><span class=\"line\"></span><br><span class=\"line\">k8s：</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/kube-apiserver:v1.17.9</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/kube-scheduler:v1.17.9</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/kube-proxy:v1.17.9</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/kube-controller-manager:v1.17.9</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/pause:3.1</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/pause:3.2 (k8s版本大于v1.18)</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/etcd:v3.3.12</span><br><span class=\"line\"></span><br><span class=\"line\">calico/kube-controllers:v3.15.1</span><br><span class=\"line\"></span><br><span class=\"line\">calico/node:v3.15.1</span><br><span class=\"line\"></span><br><span class=\"line\">calico/cni:v3.15.1</span><br><span class=\"line\"></span><br><span class=\"line\">calico/pod2daemon-flexvol:v3.15.1</span><br><span class=\"line\"></span><br><span class=\"line\">coredns/coredns:1.6.9</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/k8s-dns-node-cache:1.15.12</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">localVolume：</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/node-disk-manager:0.5.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/node-disk-operator:0.5.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/provisioner-localpv:1.10.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/linux-utils:1.10.0</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere：</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/ks-apiserver:v3.0.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/ks-console:v3.0.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/ks-controller-manager:v3.0.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/ks-installer:v3.0.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/etcd:v3.2.18</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/kubectl:v1.0.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/ks-upgrade:v3.0.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/ks-devops:flyway-v3.0.0</span><br><span class=\"line\"></span><br><span class=\"line\">redis:5.0.5-alpine</span><br><span class=\"line\"></span><br><span class=\"line\">alpine:3.10.4</span><br><span class=\"line\"></span><br><span class=\"line\">haproxy:2.0.4</span><br><span class=\"line\"></span><br><span class=\"line\">mysql:8.0.11</span><br><span class=\"line\"></span><br><span class=\"line\">nginx:1.14-alpine</span><br><span class=\"line\"></span><br><span class=\"line\">minio/minio:RELEASE.2019-08-07T01-59-21Z</span><br><span class=\"line\"></span><br><span class=\"line\">minio/mc:RELEASE.2019-08-07T23-14-43Z</span><br><span class=\"line\"></span><br><span class=\"line\">mirrorgooglecontainers/defaultbackend-amd64:1.4</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/nginx-ingress-controller:0.24.1</span><br><span class=\"line\"></span><br><span class=\"line\">osixia/openldap:1.3.0</span><br><span class=\"line\"></span><br><span class=\"line\">csiplugin/snapshot-controller:v2.0.1</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/ks-upgrade:v3.0.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/ks-devops:flyway-v3.0.0</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">monitoring：</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/prometheus-config-reloader:v0.38.3</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/prometheus-operator:v0.38.3</span><br><span class=\"line\"></span><br><span class=\"line\">prom/alertmanager:v0.21.0</span><br><span class=\"line\"></span><br><span class=\"line\">prom/prometheus:v2.20.1</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/node-exporter:ks-v0.18.1</span><br><span class=\"line\"></span><br><span class=\"line\">jimmidyson/configmap-reload:v0.3.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/notification-manager-operator:v0.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/notification-manager:v0.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/metrics-server:v0.3.7</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/kube-rbac-proxy:v0.4.1</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/kube-state-metrics:v1.9.6</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">logging:</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/elasticsearch-oss:6.7.0-1</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/fluentbit-operator:v0.2.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/fluentbit-operator:migrator</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/fluent-bit:v1.4.6</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/kube-auditing-operator:v0.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/kube-auditing-webhook:v0.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/kube-events-exporter:v0.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/kube-events-operator:v0.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/kube-events-ruler:v0.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/log-sidecar-injector:1.1</span><br><span class=\"line\"></span><br><span class=\"line\">docker:19.03</span><br><span class=\"line\"></span><br><span class=\"line\">service-mesh：</span><br><span class=\"line\"></span><br><span class=\"line\">istio/citadel:1.4.8</span><br><span class=\"line\"></span><br><span class=\"line\">istio/galley:1.4.8</span><br><span class=\"line\"></span><br><span class=\"line\">istio/kubectl:1.4.8</span><br><span class=\"line\"></span><br><span class=\"line\">istio/mixer:1.4.8</span><br><span class=\"line\"></span><br><span class=\"line\">istio/pilot:1.4.8</span><br><span class=\"line\"></span><br><span class=\"line\">istio/proxyv2:1.4.8</span><br><span class=\"line\"></span><br><span class=\"line\">istio/sidecar_injector:1.4.8</span><br><span class=\"line\"></span><br><span class=\"line\">jaegertracing/jaeger-agent:1.17</span><br><span class=\"line\"></span><br><span class=\"line\">jaegertracing/jaeger-collector:1.17</span><br><span class=\"line\"></span><br><span class=\"line\">jaegertracing/jaeger-operator:1.17.1</span><br><span class=\"line\"></span><br><span class=\"line\">jaegertracing/jaeger-query:1.17</span><br><span class=\"line\"></span><br><span class=\"line\">jaegertracing/jaeger-es-index-cleaner:1.17.1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">devops：</span><br><span class=\"line\"></span><br><span class=\"line\">jenkins/jenkins:2.176.2</span><br><span class=\"line\"></span><br><span class=\"line\">jenkins/jnlp-slave:3.27-1</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/jenkins-uc:v3.0.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/s2ioperator:v2.1.1</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/s2irun:v2.1.1</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/builder-base:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/builder-nodejs:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/builder-maven:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/builder-go:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/s2i-binary:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/tomcat85-java11-centos7:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/tomcat85-java11-runtime:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/tomcat85-java8-centos7:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/tomcat85-java8-runtime:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/java-11-centos7:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/java-8-centos7:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/java-8-runtime:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/java-11-runtime:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/nodejs-8-centos7:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/nodejs-6-centos7:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/nodejs-4-centos7:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/python-36-centos7:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/python-35-centos7:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/python-34-centos7:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/python-27-centos7:v2.1.0</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">notification&amp;&amp;alerting:</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/notification:flyway_v2.1.2</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/notification:v2.1.2</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/alert-adapter:v3.0.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/alerting-dbinit:v3.0.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/alerting:v2.1.2</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">multicluster:</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/kubefed:v0.3.0</span><br><span class=\"line\"></span><br><span class=\"line\">kubesphere/tower:v0.1.0</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">openpitrix(app store)：</span><br><span class=\"line\"></span><br><span class=\"line\">openpitrix/generate-kubeconfig:v0.5.0</span><br><span class=\"line\"></span><br><span class=\"line\">openpitrix/openpitrix:flyway-v0.5.0</span><br><span class=\"line\"></span><br><span class=\"line\">openpitrix/openpitrix:v0.5.0</span><br><span class=\"line\"></span><br><span class=\"line\">openpitrix/release-app:v0.5.0</span><br><span class=\"line\"></span><br><span class=\"line\">5.节点初始化</span><br><span class=\"line\"></span><br><span class=\"line\">yum install -y socat conntrack ebtables ipset</span><br><span class=\"line\"></span><br><span class=\"line\">./kk init os -f config-sample.yaml -s ./dependencies/</span><br><span class=\"line\"></span><br><span class=\"line\">6.执行集群安装</span><br><span class=\"line\"></span><br><span class=\"line\">集群安装语句</span><br><span class=\"line\"></span><br><span class=\"line\">./kk create cluster -f config-sample.yaml</span><br><span class=\"line\"></span><br><span class=\"line\">显示安装结果</span><br><span class=\"line\"></span><br><span class=\"line\">#####################################################</span><br><span class=\"line\"></span><br><span class=\"line\">###Welcome to KubeSphere!###</span><br><span class=\"line\"></span><br><span class=\"line\">#####################################################</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Console: http://192.168.0.8:30880</span><br><span class=\"line\"></span><br><span class=\"line\">Account: admin</span><br><span class=\"line\"></span><br><span class=\"line\">Password: P@88w0rd</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">NOTES：</span><br><span class=\"line\"></span><br><span class=\"line\">1.After logging into theconsole, please check the</span><br><span class=\"line\"></span><br><span class=\"line\">monitoring statusofservice componentsin</span><br><span class=\"line\"></span><br><span class=\"line\">the&quot;Cluster Management&quot;. If any serviceisnot</span><br><span class=\"line\"></span><br><span class=\"line\">ready, please wait patientlyuntilall components</span><br><span class=\"line\"></span><br><span class=\"line\">are ready.</span><br><span class=\"line\"></span><br><span class=\"line\">2.Please modify thedefaultpassword after login.</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#####################################################</span><br><span class=\"line\"></span><br><span class=\"line\">https://kubesphere.io</span><br><span class=\"line\"></span><br><span class=\"line\">20xx-xx-xx xx:xx:xx</span><br><span class=\"line\"></span><br><span class=\"line\">#####################################################</span><br><span class=\"line\"></span><br><span class=\"line\">检查安装</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl logs -n kubesphere-system$(kubectl get pod -n kubesphere-system-l app=ks-install -o jsonpath=&#x27;&#123;.items[0].metadata.name&#125;&#x27;) -f</span><br><span class=\"line\"></span><br><span class=\"line\">7.集群清理/卸载</span><br><span class=\"line\"></span><br><span class=\"line\">./kk delete cluster –f config-sample.yaml</span><br><span class=\"line\"></span><br><span class=\"line\">8.集群增加节点</span><br><span class=\"line\"></span><br><span class=\"line\">编辑追加config-sample,host行</span><br><span class=\"line\"></span><br><span class=\"line\">./kk add nodes -f config-sample.yaml</span><br><span class=\"line\"></span><br><span class=\"line\">9.集群删除节点</span><br><span class=\"line\"></span><br><span class=\"line\">./kk delete node nodeName -f config-sample.yaml</span><br></pre></td></tr></table></figure>"},{"title":"lvm磁盘扩容","date":"2022-12-29T02:07:11.000Z","_content":"\n# lvm扩容\n\n\n\n<!--more-->\n\n**场景1：新增一个磁盘扩容**\n\n```\n[root@lb02 ~]# lsblk \nNAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsr0              11:0    1 1024M  0 rom  \nvda             252:0    0   40G  0 disk \n├─vda1          252:1    0    1G  0 part /boot\n└─vda2          252:2    0   39G  0 part \n  ├─centos-root 253:0    0 35.1G  0 lvm  /\n  └─centos-swap 253:1    0  3.9G  0 lvm  [SWAP]\nvdb             252:16   0  100G  0 disk\n\n[root@lb02 ~]# fdisk -l\n\nDisk /dev/vda: 42.9 GB, 42949672960 bytes, 83886080 sectors\nUnits = sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\nDisk label type: dos\nDisk identifier: 0x000bfa4f\n\n   Device Boot      Start         End      Blocks   Id  System\n/dev/vda1   *        2048     2099199     1048576   83  Linux\n/dev/vda2         2099200    83886079    40893440   8e  Linux LVM\n\nDisk /dev/mapper/centos-root: 37.7 GB, 37706792960 bytes, 73646080 sectors\nUnits = sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\n\n\nDisk /dev/mapper/centos-swap: 4160 MB, 4160749568 bytes, 8126464 sectors\nUnits = sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\n\n\nDisk /dev/vdb: 107.4 GB, 107374182400 bytes, 209715200 sectors\nUnits = sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\n\n新增的磁盘为/dev/vdb\n将/dev/vdb创建物理分区\n# pvcreate /dev/vdb\n\n查看物理卷\n# pvdisplay\n\n查看卷组\n# vgdisplay\n\n将物理卷加入到卷组\n# vgextend centos /dev/vdb\n\n加入后，再次查看卷组\n# vgdisplay\n\n查看逻辑卷\n# lvdisplay\n\n将剩余百分百空间都添加都逻辑卷中\nlvextend -l +100%free /dev/mapper/centos-root\n\n重新识别一下分区大小，就可以通过df -h看到新增的容量了\n# xfs_growfs /dev/mapper/centos-root\n```\n\n\n\n**场景2：在原有的磁盘上扩容**\n\n```\n[root@node01 ~]# df -h\nFilesystem                                        Size  Used Avail Use% Mounted on\n/dev/mapper/centos-root                           36G   30G  6.0G  83% /\ndevtmpfs                                          16G     0   16G   0% /dev\ntmpfs                                             16G  4.0K   16G   1% /dev/shm\ntmpfs                                             16G  100M   16G   1% /run\ntmpfs                                             16G     0   16G   0% /sys/fs/cgroup\n/dev/vda1                                         1014M  166M  849M  17% /boot\ntmpfs                                             3.2G     0  3.2G   0% /run/user/0\n\n[root@node01 ~]# lsblk \nNAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsr0              11:0    1 1024M  0 rom  \nvda             252:0    0  100G  0 disk \n├─vda1          252:1    0    1G  0 part /boot\n└─vda2          252:2    0   39G  0 part \n  ├─centos-root 253:0    0 35.1G  0 lvm  /\n  └─centos-swap 253:1    0  3.9G  0 lvm \n\n[root@node01 ~]# fdisk -l\n#还有空间没有使用先进行分区\nDisk /dev/vda: 107.4 GB, 107374182400 bytes, 209715200 sectors\nUnits = sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\nDisk label type: dos\nDisk identifier: 0x000bfa4f\n\n   Device Boot      Start         End      Blocks   Id  System\n/dev/vda1   *        2048     2099199     1048576   83  Linux\n/dev/vda2         2099200    83886079    40893440   8e  Linux LVM\n\nDisk /dev/mapper/centos-root: 37.7 GB, 37706792960 bytes, 73646080 sectors\nUnits = sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\n\n\nDisk /dev/mapper/centos-swap: 4160 MB, 4160749568 bytes, 8126464 sectors\nUnits = sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\n\n分区\n# fdisk /dev/vda  ## /dev/sda为通过fdisk -l 查看到的物理磁盘(第一行)\nWelcome to fdisk (util-linux 2.23.2).\n\nChanges will remain in memory only, until you decide to write them.\nBe careful before using the write command.\n\n\nCommand (m for help): n  ## n为创建一个新的分区\nPartition type:   ## 这里需要选择时创建主分区还是扩展分区&#xff0c;都可以&#xff0c;这里直接选了主分区\n   p   primary (2 primary, 0 extended, 2 free)   \n   e   extended\nSelect (default p): p  ## 选择创建一个主分区&#xff0c;主分区只能有4个&#xff0c;编号为1-4,下面的全部直接回车就好了&#xff0c;会自动将剩余所用空间都创建\nPartition number (3,4, default 3):   \nFirst sector (104857600-209715199, default 104857600): \nUsing default value 104857600\nLast sector, &#43;sectors or &#43;size{K,M,G} (104857600-209715199, default 209715199): \nUsing default value 209715199\nPartition 3 of type Linux and of size 50 GiB is set\n\nCommand (m for help): t   ## t为修改分区类型\nPartition number (1-3, default 3): 3  ## 刚才创建的分区编号为3\nHex code (type L to list all codes): 8e  ## 8e就是 lvm格式的分区\nChanged type of partition &#39;Linux&#39; to &#39;Linux LVM&#39;\n\nCommand (m for help): w  ## w保存并写入磁盘。\nThe partition table has been altered!\n\nCalling ioctl() to re-read partition table.\n\nWARNING: Re-reading the partition table failed with error 16: Device or resource busy.\nThe kernel still uses the old table. The new table will be used at\nthe next reboot or after you run partprobe(8) or kpartx(8)\nSyncing disks.\n\n这里，在保存后，会发现，可能会出现报错，显示繁忙，无法重新读取分区信息。下面有解决办法。可以用过重启或者执行 partprobe or kpartx。所以，这里直接执行partprobe\n# partprobe\n\n将/dev/vda3创建物理分区\n# pvcreate /dev/vda3\n\n查看物理卷\n# pvdisplay\n\n查看卷组\n# vgdisplay\n\n将物理卷加入到卷组\n# vgextend centos /dev/vda3\n\n加入后，再次查看卷组\n# vgdisplay\n\n查看逻辑卷\n# lvdisplay\n\n将剩余百分百空间都添加都逻辑卷中\n# lvextend -l +100%free /dev/mapper/centos-root\n\n重新识别一下分区大小，就可以通过df -h看到新增的容量了\n# xfs_growfs /dev/mapper/centos-root\n```\n\n\n\n**场景3：在同一个vg卷组下，不同逻辑卷，将空间的容量加到root卷组下**\n\n```\n# 列出所有可用块设备的信息\n[root@master01 software]# lsblk\nNAME                                  MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsr0                                    11:0    1 1024M  0 rom  \nvda                                   253:0    0  100G  0 disk \n├─vda1                                253:1    0  200M  0 part /boot/efi\n├─vda2                                253:2    0    1G  0 part /boot\n└─vda3                                253:3    0 98.8G  0 part \n  ├─klas_host--10--200--91--54-root   252:0    0 63.7G  0 lvm  /\n  ├─klas_host--10--200--91--54-swap   252:1    0    4G  0 lvm  \n  └─klas_host--10--200--91--54-backup 252:2    0 31.1G  0 lvm  \n```\n\n```\n# 查看卷组\n[root@master01 software]# vgdisplay\n  --- Volume group ---\n  VG Name               klas_host-10-200-91-54\n  System ID             \n  Format                lvm2\n  Metadata Areas        1\n  Metadata Sequence No  4\n  VG Access             read/write\n  VG Status             resizable\n  MAX LV                0\n  Cur LV                3\n  Open LV               1\n  Max PV                0\n  Cur PV                1\n  Act PV                1\n  VG Size               98.80 GiB\n  PE Size               4.00 MiB\n  Total PE              25293\n  Alloc PE / Size       25293 / 98.80 GiB\n  Free  PE / Size       0 / 0   \n  VG UUID               kkFp7N-fdS3-lf3n-Fylz-Q7LG-h6Ex-T7bvph\n```\n\n```\n# 查看逻辑卷\n[root@master01 software]# lvdisplay\n  --- Logical volume ---\n  LV Path                /dev/klas_host-10-200-91-54/swap\n  LV Name                swap\n  VG Name                klas_host-10-200-91-54\n  LV UUID                mJCfg8-LLgS-NXuL-WtJ1-4T1X-a9bV-LcLrdO\n  LV Write Access        read/write\n  LV Creation host, time host-10-200-91-54, 2022-01-18 17:41:43 +0800\n  LV Status              available\n  # open                 0\n  LV Size                <4.03 GiB\n  Current LE             1031\n  Segments               1\n  Allocation             inherit\n  Read ahead sectors     auto\n  - currently set to     4096\n  Block device           252:1\n   \n  --- Logical volume ---\n  LV Path                /dev/klas_host-10-200-91-54/backup\n  LV Name                backup\n  VG Name                klas_host-10-200-91-54\n  LV UUID                yul3Nj-Rtyd-YGu0-nWny-sIHF-gj21-3LARG6\n  LV Write Access        read/write\n  LV Creation host, time host-10-200-91-54, 2022-01-18 17:41:43 +0800\n  LV Status              available\n  # open                 0\n  LV Size                <31.09 GiB\n  Current LE             7959\n  Segments               1\n  Allocation             inherit\n  Read ahead sectors     auto\n  - currently set to     4096\n  Block device           252:2\n   \n  --- Logical volume ---\n  LV Path                /dev/klas_host-10-200-91-54/root\n  LV Name                root\n  VG Name                klas_host-10-200-91-54\n  LV UUID                NwRken-eyAM-njwk-l2IU-jz0N-YfCF-0mvzcJ\n  LV Write Access        read/write\n  LV Creation host, time host-10-200-91-54, 2022-01-18 17:41:44 +0800\n  LV Status              available\n  # open                 1\n  LV Size                63.68 GiB\n  Current LE             16303\n  Segments               1\n  Allocation             inherit\n  Read ahead sectors     auto\n  - currently set to     4096\n  Block device           252:0\n```\n\n```\n# 查看挂的云硬盘的名称\n[root@master01 software]# fdisk -l \nDisk /dev/vda: 100 GiB, 107374182400 bytes, 209715200 sectors\nUnits: sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\nDisklabel type: gpt\nDisk identifier: 26046881-8F99-4CA0-B01F-0473C537AC20\n\nDevice       Start       End   Sectors  Size Type\n/dev/vda1     2048    411647    409600  200M EFI System\n/dev/vda2   411648   2508799   2097152    1G Linux filesystem\n/dev/vda3  2508800 209713151 207204352 98.8G Linux LVM\n\n\n\n\nDisk /dev/mapper/klas_host--10--200--91--54-root: 63.7 GiB, 68379738112 bytes, 133554176 sectors\nUnits: sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\n\n\nDisk /dev/mapper/klas_host--10--200--91--54-swap: 4.3 GiB, 4324327424 bytes, 8445952 sectors\nUnits: sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\n\n\nDisk /dev/mapper/klas_host--10--200--91--54-backup: 31.9 GiB, 33382465536 bytes, 65200128 sectors\nUnits: sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\n```\n\n```\n# 从上面看到卷组有100G，逻辑卷有一个backup的空闲，把空闲的加到 /dev/klas_host-10-200-91-54/root\n# 删除卷组/dev/mapper/klas_host--10--200--91--54-backup\nlvremove /dev/mapper/klas_host--10--200--91--54-backup\n```\n\n```\n# 将剩余百分百空间都添加到逻辑卷中\nlvextend -l +100%free /dev/mapper/klas_host--10--200--91--54-root\n```\n\n```\n# 然后重新识别一下分区大小\nxfs_growfs /dev/mapper/klas_host--10--200--91--54-root  ## 命令，后面跟的是逻辑卷的path\n```\n","source":"_posts/lvm磁盘扩容.md","raw":"---\ntitle: lvm磁盘扩容\ndate: 2022-12-29 10:07:11\ntags: lvm扩容\n---\n\n# lvm扩容\n\n\n\n<!--more-->\n\n**场景1：新增一个磁盘扩容**\n\n```\n[root@lb02 ~]# lsblk \nNAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsr0              11:0    1 1024M  0 rom  \nvda             252:0    0   40G  0 disk \n├─vda1          252:1    0    1G  0 part /boot\n└─vda2          252:2    0   39G  0 part \n  ├─centos-root 253:0    0 35.1G  0 lvm  /\n  └─centos-swap 253:1    0  3.9G  0 lvm  [SWAP]\nvdb             252:16   0  100G  0 disk\n\n[root@lb02 ~]# fdisk -l\n\nDisk /dev/vda: 42.9 GB, 42949672960 bytes, 83886080 sectors\nUnits = sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\nDisk label type: dos\nDisk identifier: 0x000bfa4f\n\n   Device Boot      Start         End      Blocks   Id  System\n/dev/vda1   *        2048     2099199     1048576   83  Linux\n/dev/vda2         2099200    83886079    40893440   8e  Linux LVM\n\nDisk /dev/mapper/centos-root: 37.7 GB, 37706792960 bytes, 73646080 sectors\nUnits = sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\n\n\nDisk /dev/mapper/centos-swap: 4160 MB, 4160749568 bytes, 8126464 sectors\nUnits = sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\n\n\nDisk /dev/vdb: 107.4 GB, 107374182400 bytes, 209715200 sectors\nUnits = sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\n\n新增的磁盘为/dev/vdb\n将/dev/vdb创建物理分区\n# pvcreate /dev/vdb\n\n查看物理卷\n# pvdisplay\n\n查看卷组\n# vgdisplay\n\n将物理卷加入到卷组\n# vgextend centos /dev/vdb\n\n加入后，再次查看卷组\n# vgdisplay\n\n查看逻辑卷\n# lvdisplay\n\n将剩余百分百空间都添加都逻辑卷中\nlvextend -l +100%free /dev/mapper/centos-root\n\n重新识别一下分区大小，就可以通过df -h看到新增的容量了\n# xfs_growfs /dev/mapper/centos-root\n```\n\n\n\n**场景2：在原有的磁盘上扩容**\n\n```\n[root@node01 ~]# df -h\nFilesystem                                        Size  Used Avail Use% Mounted on\n/dev/mapper/centos-root                           36G   30G  6.0G  83% /\ndevtmpfs                                          16G     0   16G   0% /dev\ntmpfs                                             16G  4.0K   16G   1% /dev/shm\ntmpfs                                             16G  100M   16G   1% /run\ntmpfs                                             16G     0   16G   0% /sys/fs/cgroup\n/dev/vda1                                         1014M  166M  849M  17% /boot\ntmpfs                                             3.2G     0  3.2G   0% /run/user/0\n\n[root@node01 ~]# lsblk \nNAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsr0              11:0    1 1024M  0 rom  \nvda             252:0    0  100G  0 disk \n├─vda1          252:1    0    1G  0 part /boot\n└─vda2          252:2    0   39G  0 part \n  ├─centos-root 253:0    0 35.1G  0 lvm  /\n  └─centos-swap 253:1    0  3.9G  0 lvm \n\n[root@node01 ~]# fdisk -l\n#还有空间没有使用先进行分区\nDisk /dev/vda: 107.4 GB, 107374182400 bytes, 209715200 sectors\nUnits = sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\nDisk label type: dos\nDisk identifier: 0x000bfa4f\n\n   Device Boot      Start         End      Blocks   Id  System\n/dev/vda1   *        2048     2099199     1048576   83  Linux\n/dev/vda2         2099200    83886079    40893440   8e  Linux LVM\n\nDisk /dev/mapper/centos-root: 37.7 GB, 37706792960 bytes, 73646080 sectors\nUnits = sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\n\n\nDisk /dev/mapper/centos-swap: 4160 MB, 4160749568 bytes, 8126464 sectors\nUnits = sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\n\n分区\n# fdisk /dev/vda  ## /dev/sda为通过fdisk -l 查看到的物理磁盘(第一行)\nWelcome to fdisk (util-linux 2.23.2).\n\nChanges will remain in memory only, until you decide to write them.\nBe careful before using the write command.\n\n\nCommand (m for help): n  ## n为创建一个新的分区\nPartition type:   ## 这里需要选择时创建主分区还是扩展分区&#xff0c;都可以&#xff0c;这里直接选了主分区\n   p   primary (2 primary, 0 extended, 2 free)   \n   e   extended\nSelect (default p): p  ## 选择创建一个主分区&#xff0c;主分区只能有4个&#xff0c;编号为1-4,下面的全部直接回车就好了&#xff0c;会自动将剩余所用空间都创建\nPartition number (3,4, default 3):   \nFirst sector (104857600-209715199, default 104857600): \nUsing default value 104857600\nLast sector, &#43;sectors or &#43;size{K,M,G} (104857600-209715199, default 209715199): \nUsing default value 209715199\nPartition 3 of type Linux and of size 50 GiB is set\n\nCommand (m for help): t   ## t为修改分区类型\nPartition number (1-3, default 3): 3  ## 刚才创建的分区编号为3\nHex code (type L to list all codes): 8e  ## 8e就是 lvm格式的分区\nChanged type of partition &#39;Linux&#39; to &#39;Linux LVM&#39;\n\nCommand (m for help): w  ## w保存并写入磁盘。\nThe partition table has been altered!\n\nCalling ioctl() to re-read partition table.\n\nWARNING: Re-reading the partition table failed with error 16: Device or resource busy.\nThe kernel still uses the old table. The new table will be used at\nthe next reboot or after you run partprobe(8) or kpartx(8)\nSyncing disks.\n\n这里，在保存后，会发现，可能会出现报错，显示繁忙，无法重新读取分区信息。下面有解决办法。可以用过重启或者执行 partprobe or kpartx。所以，这里直接执行partprobe\n# partprobe\n\n将/dev/vda3创建物理分区\n# pvcreate /dev/vda3\n\n查看物理卷\n# pvdisplay\n\n查看卷组\n# vgdisplay\n\n将物理卷加入到卷组\n# vgextend centos /dev/vda3\n\n加入后，再次查看卷组\n# vgdisplay\n\n查看逻辑卷\n# lvdisplay\n\n将剩余百分百空间都添加都逻辑卷中\n# lvextend -l +100%free /dev/mapper/centos-root\n\n重新识别一下分区大小，就可以通过df -h看到新增的容量了\n# xfs_growfs /dev/mapper/centos-root\n```\n\n\n\n**场景3：在同一个vg卷组下，不同逻辑卷，将空间的容量加到root卷组下**\n\n```\n# 列出所有可用块设备的信息\n[root@master01 software]# lsblk\nNAME                                  MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsr0                                    11:0    1 1024M  0 rom  \nvda                                   253:0    0  100G  0 disk \n├─vda1                                253:1    0  200M  0 part /boot/efi\n├─vda2                                253:2    0    1G  0 part /boot\n└─vda3                                253:3    0 98.8G  0 part \n  ├─klas_host--10--200--91--54-root   252:0    0 63.7G  0 lvm  /\n  ├─klas_host--10--200--91--54-swap   252:1    0    4G  0 lvm  \n  └─klas_host--10--200--91--54-backup 252:2    0 31.1G  0 lvm  \n```\n\n```\n# 查看卷组\n[root@master01 software]# vgdisplay\n  --- Volume group ---\n  VG Name               klas_host-10-200-91-54\n  System ID             \n  Format                lvm2\n  Metadata Areas        1\n  Metadata Sequence No  4\n  VG Access             read/write\n  VG Status             resizable\n  MAX LV                0\n  Cur LV                3\n  Open LV               1\n  Max PV                0\n  Cur PV                1\n  Act PV                1\n  VG Size               98.80 GiB\n  PE Size               4.00 MiB\n  Total PE              25293\n  Alloc PE / Size       25293 / 98.80 GiB\n  Free  PE / Size       0 / 0   \n  VG UUID               kkFp7N-fdS3-lf3n-Fylz-Q7LG-h6Ex-T7bvph\n```\n\n```\n# 查看逻辑卷\n[root@master01 software]# lvdisplay\n  --- Logical volume ---\n  LV Path                /dev/klas_host-10-200-91-54/swap\n  LV Name                swap\n  VG Name                klas_host-10-200-91-54\n  LV UUID                mJCfg8-LLgS-NXuL-WtJ1-4T1X-a9bV-LcLrdO\n  LV Write Access        read/write\n  LV Creation host, time host-10-200-91-54, 2022-01-18 17:41:43 +0800\n  LV Status              available\n  # open                 0\n  LV Size                <4.03 GiB\n  Current LE             1031\n  Segments               1\n  Allocation             inherit\n  Read ahead sectors     auto\n  - currently set to     4096\n  Block device           252:1\n   \n  --- Logical volume ---\n  LV Path                /dev/klas_host-10-200-91-54/backup\n  LV Name                backup\n  VG Name                klas_host-10-200-91-54\n  LV UUID                yul3Nj-Rtyd-YGu0-nWny-sIHF-gj21-3LARG6\n  LV Write Access        read/write\n  LV Creation host, time host-10-200-91-54, 2022-01-18 17:41:43 +0800\n  LV Status              available\n  # open                 0\n  LV Size                <31.09 GiB\n  Current LE             7959\n  Segments               1\n  Allocation             inherit\n  Read ahead sectors     auto\n  - currently set to     4096\n  Block device           252:2\n   \n  --- Logical volume ---\n  LV Path                /dev/klas_host-10-200-91-54/root\n  LV Name                root\n  VG Name                klas_host-10-200-91-54\n  LV UUID                NwRken-eyAM-njwk-l2IU-jz0N-YfCF-0mvzcJ\n  LV Write Access        read/write\n  LV Creation host, time host-10-200-91-54, 2022-01-18 17:41:44 +0800\n  LV Status              available\n  # open                 1\n  LV Size                63.68 GiB\n  Current LE             16303\n  Segments               1\n  Allocation             inherit\n  Read ahead sectors     auto\n  - currently set to     4096\n  Block device           252:0\n```\n\n```\n# 查看挂的云硬盘的名称\n[root@master01 software]# fdisk -l \nDisk /dev/vda: 100 GiB, 107374182400 bytes, 209715200 sectors\nUnits: sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\nDisklabel type: gpt\nDisk identifier: 26046881-8F99-4CA0-B01F-0473C537AC20\n\nDevice       Start       End   Sectors  Size Type\n/dev/vda1     2048    411647    409600  200M EFI System\n/dev/vda2   411648   2508799   2097152    1G Linux filesystem\n/dev/vda3  2508800 209713151 207204352 98.8G Linux LVM\n\n\n\n\nDisk /dev/mapper/klas_host--10--200--91--54-root: 63.7 GiB, 68379738112 bytes, 133554176 sectors\nUnits: sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\n\n\nDisk /dev/mapper/klas_host--10--200--91--54-swap: 4.3 GiB, 4324327424 bytes, 8445952 sectors\nUnits: sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\n\n\nDisk /dev/mapper/klas_host--10--200--91--54-backup: 31.9 GiB, 33382465536 bytes, 65200128 sectors\nUnits: sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\n```\n\n```\n# 从上面看到卷组有100G，逻辑卷有一个backup的空闲，把空闲的加到 /dev/klas_host-10-200-91-54/root\n# 删除卷组/dev/mapper/klas_host--10--200--91--54-backup\nlvremove /dev/mapper/klas_host--10--200--91--54-backup\n```\n\n```\n# 将剩余百分百空间都添加到逻辑卷中\nlvextend -l +100%free /dev/mapper/klas_host--10--200--91--54-root\n```\n\n```\n# 然后重新识别一下分区大小\nxfs_growfs /dev/mapper/klas_host--10--200--91--54-root  ## 命令，后面跟的是逻辑卷的path\n```\n","slug":"lvm磁盘扩容","published":1,"updated":"2023-01-03T06:17:51.245Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clcfuykyp00093wrsh4otc2j6","content":"<h1 id=\"lvm扩容\"><a href=\"#lvm扩容\" class=\"headerlink\" title=\"lvm扩容\"></a>lvm扩容</h1><span id=\"more\"></span>\n\n<p><strong>场景1：新增一个磁盘扩容</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@lb02 ~]# lsblk </span><br><span class=\"line\">NAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class=\"line\">sr0              11:0    1 1024M  0 rom  </span><br><span class=\"line\">vda             252:0    0   40G  0 disk </span><br><span class=\"line\">├─vda1          252:1    0    1G  0 part /boot</span><br><span class=\"line\">└─vda2          252:2    0   39G  0 part </span><br><span class=\"line\">  ├─centos-root 253:0    0 35.1G  0 lvm  /</span><br><span class=\"line\">  └─centos-swap 253:1    0  3.9G  0 lvm  [SWAP]</span><br><span class=\"line\">vdb             252:16   0  100G  0 disk</span><br><span class=\"line\"></span><br><span class=\"line\">[root@lb02 ~]# fdisk -l</span><br><span class=\"line\"></span><br><span class=\"line\">Disk /dev/vda: 42.9 GB, 42949672960 bytes, 83886080 sectors</span><br><span class=\"line\">Units = sectors of 1 * 512 = 512 bytes</span><br><span class=\"line\">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class=\"line\">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class=\"line\">Disk label type: dos</span><br><span class=\"line\">Disk identifier: 0x000bfa4f</span><br><span class=\"line\"></span><br><span class=\"line\">   Device Boot      Start         End      Blocks   Id  System</span><br><span class=\"line\">/dev/vda1   *        2048     2099199     1048576   83  Linux</span><br><span class=\"line\">/dev/vda2         2099200    83886079    40893440   8e  Linux LVM</span><br><span class=\"line\"></span><br><span class=\"line\">Disk /dev/mapper/centos-root: 37.7 GB, 37706792960 bytes, 73646080 sectors</span><br><span class=\"line\">Units = sectors of 1 * 512 = 512 bytes</span><br><span class=\"line\">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class=\"line\">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Disk /dev/mapper/centos-swap: 4160 MB, 4160749568 bytes, 8126464 sectors</span><br><span class=\"line\">Units = sectors of 1 * 512 = 512 bytes</span><br><span class=\"line\">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class=\"line\">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Disk /dev/vdb: 107.4 GB, 107374182400 bytes, 209715200 sectors</span><br><span class=\"line\">Units = sectors of 1 * 512 = 512 bytes</span><br><span class=\"line\">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class=\"line\">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class=\"line\"></span><br><span class=\"line\">新增的磁盘为/dev/vdb</span><br><span class=\"line\">将/dev/vdb创建物理分区</span><br><span class=\"line\"># pvcreate /dev/vdb</span><br><span class=\"line\"></span><br><span class=\"line\">查看物理卷</span><br><span class=\"line\"># pvdisplay</span><br><span class=\"line\"></span><br><span class=\"line\">查看卷组</span><br><span class=\"line\"># vgdisplay</span><br><span class=\"line\"></span><br><span class=\"line\">将物理卷加入到卷组</span><br><span class=\"line\"># vgextend centos /dev/vdb</span><br><span class=\"line\"></span><br><span class=\"line\">加入后，再次查看卷组</span><br><span class=\"line\"># vgdisplay</span><br><span class=\"line\"></span><br><span class=\"line\">查看逻辑卷</span><br><span class=\"line\"># lvdisplay</span><br><span class=\"line\"></span><br><span class=\"line\">将剩余百分百空间都添加都逻辑卷中</span><br><span class=\"line\">lvextend -l +100%free /dev/mapper/centos-root</span><br><span class=\"line\"></span><br><span class=\"line\">重新识别一下分区大小，就可以通过df -h看到新增的容量了</span><br><span class=\"line\"># xfs_growfs /dev/mapper/centos-root</span><br></pre></td></tr></table></figure>\n\n\n\n<p><strong>场景2：在原有的磁盘上扩容</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@node01 ~]# df -h</span><br><span class=\"line\">Filesystem                                        Size  Used Avail Use% Mounted on</span><br><span class=\"line\">/dev/mapper/centos-root                           36G   30G  6.0G  83% /</span><br><span class=\"line\">devtmpfs                                          16G     0   16G   0% /dev</span><br><span class=\"line\">tmpfs                                             16G  4.0K   16G   1% /dev/shm</span><br><span class=\"line\">tmpfs                                             16G  100M   16G   1% /run</span><br><span class=\"line\">tmpfs                                             16G     0   16G   0% /sys/fs/cgroup</span><br><span class=\"line\">/dev/vda1                                         1014M  166M  849M  17% /boot</span><br><span class=\"line\">tmpfs                                             3.2G     0  3.2G   0% /run/user/0</span><br><span class=\"line\"></span><br><span class=\"line\">[root@node01 ~]# lsblk </span><br><span class=\"line\">NAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class=\"line\">sr0              11:0    1 1024M  0 rom  </span><br><span class=\"line\">vda             252:0    0  100G  0 disk </span><br><span class=\"line\">├─vda1          252:1    0    1G  0 part /boot</span><br><span class=\"line\">└─vda2          252:2    0   39G  0 part </span><br><span class=\"line\">  ├─centos-root 253:0    0 35.1G  0 lvm  /</span><br><span class=\"line\">  └─centos-swap 253:1    0  3.9G  0 lvm </span><br><span class=\"line\"></span><br><span class=\"line\">[root@node01 ~]# fdisk -l</span><br><span class=\"line\">#还有空间没有使用先进行分区</span><br><span class=\"line\">Disk /dev/vda: 107.4 GB, 107374182400 bytes, 209715200 sectors</span><br><span class=\"line\">Units = sectors of 1 * 512 = 512 bytes</span><br><span class=\"line\">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class=\"line\">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class=\"line\">Disk label type: dos</span><br><span class=\"line\">Disk identifier: 0x000bfa4f</span><br><span class=\"line\"></span><br><span class=\"line\">   Device Boot      Start         End      Blocks   Id  System</span><br><span class=\"line\">/dev/vda1   *        2048     2099199     1048576   83  Linux</span><br><span class=\"line\">/dev/vda2         2099200    83886079    40893440   8e  Linux LVM</span><br><span class=\"line\"></span><br><span class=\"line\">Disk /dev/mapper/centos-root: 37.7 GB, 37706792960 bytes, 73646080 sectors</span><br><span class=\"line\">Units = sectors of 1 * 512 = 512 bytes</span><br><span class=\"line\">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class=\"line\">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Disk /dev/mapper/centos-swap: 4160 MB, 4160749568 bytes, 8126464 sectors</span><br><span class=\"line\">Units = sectors of 1 * 512 = 512 bytes</span><br><span class=\"line\">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class=\"line\">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class=\"line\"></span><br><span class=\"line\">分区</span><br><span class=\"line\"># fdisk /dev/vda  ## /dev/sda为通过fdisk -l 查看到的物理磁盘(第一行)</span><br><span class=\"line\">Welcome to fdisk (util-linux 2.23.2).</span><br><span class=\"line\"></span><br><span class=\"line\">Changes will remain in memory only, until you decide to write them.</span><br><span class=\"line\">Be careful before using the write command.</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Command (m for help): n  ## n为创建一个新的分区</span><br><span class=\"line\">Partition type:   ## 这里需要选择时创建主分区还是扩展分区&amp;#xff0c;都可以&amp;#xff0c;这里直接选了主分区</span><br><span class=\"line\">   p   primary (2 primary, 0 extended, 2 free)   </span><br><span class=\"line\">   e   extended</span><br><span class=\"line\">Select (default p): p  ## 选择创建一个主分区&amp;#xff0c;主分区只能有4个&amp;#xff0c;编号为1-4,下面的全部直接回车就好了&amp;#xff0c;会自动将剩余所用空间都创建</span><br><span class=\"line\">Partition number (3,4, default 3):   </span><br><span class=\"line\">First sector (104857600-209715199, default 104857600): </span><br><span class=\"line\">Using default value 104857600</span><br><span class=\"line\">Last sector, &amp;#43;sectors or &amp;#43;size&#123;K,M,G&#125; (104857600-209715199, default 209715199): </span><br><span class=\"line\">Using default value 209715199</span><br><span class=\"line\">Partition 3 of type Linux and of size 50 GiB is set</span><br><span class=\"line\"></span><br><span class=\"line\">Command (m for help): t   ## t为修改分区类型</span><br><span class=\"line\">Partition number (1-3, default 3): 3  ## 刚才创建的分区编号为3</span><br><span class=\"line\">Hex code (type L to list all codes): 8e  ## 8e就是 lvm格式的分区</span><br><span class=\"line\">Changed type of partition &amp;#39;Linux&amp;#39; to &amp;#39;Linux LVM&amp;#39;</span><br><span class=\"line\"></span><br><span class=\"line\">Command (m for help): w  ## w保存并写入磁盘。</span><br><span class=\"line\">The partition table has been altered!</span><br><span class=\"line\"></span><br><span class=\"line\">Calling ioctl() to re-read partition table.</span><br><span class=\"line\"></span><br><span class=\"line\">WARNING: Re-reading the partition table failed with error 16: Device or resource busy.</span><br><span class=\"line\">The kernel still uses the old table. The new table will be used at</span><br><span class=\"line\">the next reboot or after you run partprobe(8) or kpartx(8)</span><br><span class=\"line\">Syncing disks.</span><br><span class=\"line\"></span><br><span class=\"line\">这里，在保存后，会发现，可能会出现报错，显示繁忙，无法重新读取分区信息。下面有解决办法。可以用过重启或者执行 partprobe or kpartx。所以，这里直接执行partprobe</span><br><span class=\"line\"># partprobe</span><br><span class=\"line\"></span><br><span class=\"line\">将/dev/vda3创建物理分区</span><br><span class=\"line\"># pvcreate /dev/vda3</span><br><span class=\"line\"></span><br><span class=\"line\">查看物理卷</span><br><span class=\"line\"># pvdisplay</span><br><span class=\"line\"></span><br><span class=\"line\">查看卷组</span><br><span class=\"line\"># vgdisplay</span><br><span class=\"line\"></span><br><span class=\"line\">将物理卷加入到卷组</span><br><span class=\"line\"># vgextend centos /dev/vda3</span><br><span class=\"line\"></span><br><span class=\"line\">加入后，再次查看卷组</span><br><span class=\"line\"># vgdisplay</span><br><span class=\"line\"></span><br><span class=\"line\">查看逻辑卷</span><br><span class=\"line\"># lvdisplay</span><br><span class=\"line\"></span><br><span class=\"line\">将剩余百分百空间都添加都逻辑卷中</span><br><span class=\"line\"># lvextend -l +100%free /dev/mapper/centos-root</span><br><span class=\"line\"></span><br><span class=\"line\">重新识别一下分区大小，就可以通过df -h看到新增的容量了</span><br><span class=\"line\"># xfs_growfs /dev/mapper/centos-root</span><br></pre></td></tr></table></figure>\n\n\n\n<p><strong>场景3：在同一个vg卷组下，不同逻辑卷，将空间的容量加到root卷组下</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 列出所有可用块设备的信息</span><br><span class=\"line\">[root@master01 software]# lsblk</span><br><span class=\"line\">NAME                                  MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class=\"line\">sr0                                    11:0    1 1024M  0 rom  </span><br><span class=\"line\">vda                                   253:0    0  100G  0 disk </span><br><span class=\"line\">├─vda1                                253:1    0  200M  0 part /boot/efi</span><br><span class=\"line\">├─vda2                                253:2    0    1G  0 part /boot</span><br><span class=\"line\">└─vda3                                253:3    0 98.8G  0 part </span><br><span class=\"line\">  ├─klas_host--10--200--91--54-root   252:0    0 63.7G  0 lvm  /</span><br><span class=\"line\">  ├─klas_host--10--200--91--54-swap   252:1    0    4G  0 lvm  </span><br><span class=\"line\">  └─klas_host--10--200--91--54-backup 252:2    0 31.1G  0 lvm  </span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 查看卷组</span><br><span class=\"line\">[root@master01 software]# vgdisplay</span><br><span class=\"line\">  --- Volume group ---</span><br><span class=\"line\">  VG Name               klas_host-10-200-91-54</span><br><span class=\"line\">  System ID             </span><br><span class=\"line\">  Format                lvm2</span><br><span class=\"line\">  Metadata Areas        1</span><br><span class=\"line\">  Metadata Sequence No  4</span><br><span class=\"line\">  VG Access             read/write</span><br><span class=\"line\">  VG Status             resizable</span><br><span class=\"line\">  MAX LV                0</span><br><span class=\"line\">  Cur LV                3</span><br><span class=\"line\">  Open LV               1</span><br><span class=\"line\">  Max PV                0</span><br><span class=\"line\">  Cur PV                1</span><br><span class=\"line\">  Act PV                1</span><br><span class=\"line\">  VG Size               98.80 GiB</span><br><span class=\"line\">  PE Size               4.00 MiB</span><br><span class=\"line\">  Total PE              25293</span><br><span class=\"line\">  Alloc PE / Size       25293 / 98.80 GiB</span><br><span class=\"line\">  Free  PE / Size       0 / 0   </span><br><span class=\"line\">  VG UUID               kkFp7N-fdS3-lf3n-Fylz-Q7LG-h6Ex-T7bvph</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 查看逻辑卷</span><br><span class=\"line\">[root@master01 software]# lvdisplay</span><br><span class=\"line\">  --- Logical volume ---</span><br><span class=\"line\">  LV Path                /dev/klas_host-10-200-91-54/swap</span><br><span class=\"line\">  LV Name                swap</span><br><span class=\"line\">  VG Name                klas_host-10-200-91-54</span><br><span class=\"line\">  LV UUID                mJCfg8-LLgS-NXuL-WtJ1-4T1X-a9bV-LcLrdO</span><br><span class=\"line\">  LV Write Access        read/write</span><br><span class=\"line\">  LV Creation host, time host-10-200-91-54, 2022-01-18 17:41:43 +0800</span><br><span class=\"line\">  LV Status              available</span><br><span class=\"line\">  # open                 0</span><br><span class=\"line\">  LV Size                &lt;4.03 GiB</span><br><span class=\"line\">  Current LE             1031</span><br><span class=\"line\">  Segments               1</span><br><span class=\"line\">  Allocation             inherit</span><br><span class=\"line\">  Read ahead sectors     auto</span><br><span class=\"line\">  - currently set to     4096</span><br><span class=\"line\">  Block device           252:1</span><br><span class=\"line\">   </span><br><span class=\"line\">  --- Logical volume ---</span><br><span class=\"line\">  LV Path                /dev/klas_host-10-200-91-54/backup</span><br><span class=\"line\">  LV Name                backup</span><br><span class=\"line\">  VG Name                klas_host-10-200-91-54</span><br><span class=\"line\">  LV UUID                yul3Nj-Rtyd-YGu0-nWny-sIHF-gj21-3LARG6</span><br><span class=\"line\">  LV Write Access        read/write</span><br><span class=\"line\">  LV Creation host, time host-10-200-91-54, 2022-01-18 17:41:43 +0800</span><br><span class=\"line\">  LV Status              available</span><br><span class=\"line\">  # open                 0</span><br><span class=\"line\">  LV Size                &lt;31.09 GiB</span><br><span class=\"line\">  Current LE             7959</span><br><span class=\"line\">  Segments               1</span><br><span class=\"line\">  Allocation             inherit</span><br><span class=\"line\">  Read ahead sectors     auto</span><br><span class=\"line\">  - currently set to     4096</span><br><span class=\"line\">  Block device           252:2</span><br><span class=\"line\">   </span><br><span class=\"line\">  --- Logical volume ---</span><br><span class=\"line\">  LV Path                /dev/klas_host-10-200-91-54/root</span><br><span class=\"line\">  LV Name                root</span><br><span class=\"line\">  VG Name                klas_host-10-200-91-54</span><br><span class=\"line\">  LV UUID                NwRken-eyAM-njwk-l2IU-jz0N-YfCF-0mvzcJ</span><br><span class=\"line\">  LV Write Access        read/write</span><br><span class=\"line\">  LV Creation host, time host-10-200-91-54, 2022-01-18 17:41:44 +0800</span><br><span class=\"line\">  LV Status              available</span><br><span class=\"line\">  # open                 1</span><br><span class=\"line\">  LV Size                63.68 GiB</span><br><span class=\"line\">  Current LE             16303</span><br><span class=\"line\">  Segments               1</span><br><span class=\"line\">  Allocation             inherit</span><br><span class=\"line\">  Read ahead sectors     auto</span><br><span class=\"line\">  - currently set to     4096</span><br><span class=\"line\">  Block device           252:0</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 查看挂的云硬盘的名称</span><br><span class=\"line\">[root@master01 software]# fdisk -l </span><br><span class=\"line\">Disk /dev/vda: 100 GiB, 107374182400 bytes, 209715200 sectors</span><br><span class=\"line\">Units: sectors of 1 * 512 = 512 bytes</span><br><span class=\"line\">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class=\"line\">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class=\"line\">Disklabel type: gpt</span><br><span class=\"line\">Disk identifier: 26046881-8F99-4CA0-B01F-0473C537AC20</span><br><span class=\"line\"></span><br><span class=\"line\">Device       Start       End   Sectors  Size Type</span><br><span class=\"line\">/dev/vda1     2048    411647    409600  200M EFI System</span><br><span class=\"line\">/dev/vda2   411648   2508799   2097152    1G Linux filesystem</span><br><span class=\"line\">/dev/vda3  2508800 209713151 207204352 98.8G Linux LVM</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Disk /dev/mapper/klas_host--10--200--91--54-root: 63.7 GiB, 68379738112 bytes, 133554176 sectors</span><br><span class=\"line\">Units: sectors of 1 * 512 = 512 bytes</span><br><span class=\"line\">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class=\"line\">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Disk /dev/mapper/klas_host--10--200--91--54-swap: 4.3 GiB, 4324327424 bytes, 8445952 sectors</span><br><span class=\"line\">Units: sectors of 1 * 512 = 512 bytes</span><br><span class=\"line\">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class=\"line\">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Disk /dev/mapper/klas_host--10--200--91--54-backup: 31.9 GiB, 33382465536 bytes, 65200128 sectors</span><br><span class=\"line\">Units: sectors of 1 * 512 = 512 bytes</span><br><span class=\"line\">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class=\"line\">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 从上面看到卷组有100G，逻辑卷有一个backup的空闲，把空闲的加到 /dev/klas_host-10-200-91-54/root</span><br><span class=\"line\"># 删除卷组/dev/mapper/klas_host--10--200--91--54-backup</span><br><span class=\"line\">lvremove /dev/mapper/klas_host--10--200--91--54-backup</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 将剩余百分百空间都添加到逻辑卷中</span><br><span class=\"line\">lvextend -l +100%free /dev/mapper/klas_host--10--200--91--54-root</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 然后重新识别一下分区大小</span><br><span class=\"line\">xfs_growfs /dev/mapper/klas_host--10--200--91--54-root  ## 命令，后面跟的是逻辑卷的path</span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"<h1 id=\"lvm扩容\"><a href=\"#lvm扩容\" class=\"headerlink\" title=\"lvm扩容\"></a>lvm扩容</h1>","more":"<p><strong>场景1：新增一个磁盘扩容</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@lb02 ~]# lsblk </span><br><span class=\"line\">NAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class=\"line\">sr0              11:0    1 1024M  0 rom  </span><br><span class=\"line\">vda             252:0    0   40G  0 disk </span><br><span class=\"line\">├─vda1          252:1    0    1G  0 part /boot</span><br><span class=\"line\">└─vda2          252:2    0   39G  0 part </span><br><span class=\"line\">  ├─centos-root 253:0    0 35.1G  0 lvm  /</span><br><span class=\"line\">  └─centos-swap 253:1    0  3.9G  0 lvm  [SWAP]</span><br><span class=\"line\">vdb             252:16   0  100G  0 disk</span><br><span class=\"line\"></span><br><span class=\"line\">[root@lb02 ~]# fdisk -l</span><br><span class=\"line\"></span><br><span class=\"line\">Disk /dev/vda: 42.9 GB, 42949672960 bytes, 83886080 sectors</span><br><span class=\"line\">Units = sectors of 1 * 512 = 512 bytes</span><br><span class=\"line\">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class=\"line\">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class=\"line\">Disk label type: dos</span><br><span class=\"line\">Disk identifier: 0x000bfa4f</span><br><span class=\"line\"></span><br><span class=\"line\">   Device Boot      Start         End      Blocks   Id  System</span><br><span class=\"line\">/dev/vda1   *        2048     2099199     1048576   83  Linux</span><br><span class=\"line\">/dev/vda2         2099200    83886079    40893440   8e  Linux LVM</span><br><span class=\"line\"></span><br><span class=\"line\">Disk /dev/mapper/centos-root: 37.7 GB, 37706792960 bytes, 73646080 sectors</span><br><span class=\"line\">Units = sectors of 1 * 512 = 512 bytes</span><br><span class=\"line\">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class=\"line\">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Disk /dev/mapper/centos-swap: 4160 MB, 4160749568 bytes, 8126464 sectors</span><br><span class=\"line\">Units = sectors of 1 * 512 = 512 bytes</span><br><span class=\"line\">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class=\"line\">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Disk /dev/vdb: 107.4 GB, 107374182400 bytes, 209715200 sectors</span><br><span class=\"line\">Units = sectors of 1 * 512 = 512 bytes</span><br><span class=\"line\">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class=\"line\">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class=\"line\"></span><br><span class=\"line\">新增的磁盘为/dev/vdb</span><br><span class=\"line\">将/dev/vdb创建物理分区</span><br><span class=\"line\"># pvcreate /dev/vdb</span><br><span class=\"line\"></span><br><span class=\"line\">查看物理卷</span><br><span class=\"line\"># pvdisplay</span><br><span class=\"line\"></span><br><span class=\"line\">查看卷组</span><br><span class=\"line\"># vgdisplay</span><br><span class=\"line\"></span><br><span class=\"line\">将物理卷加入到卷组</span><br><span class=\"line\"># vgextend centos /dev/vdb</span><br><span class=\"line\"></span><br><span class=\"line\">加入后，再次查看卷组</span><br><span class=\"line\"># vgdisplay</span><br><span class=\"line\"></span><br><span class=\"line\">查看逻辑卷</span><br><span class=\"line\"># lvdisplay</span><br><span class=\"line\"></span><br><span class=\"line\">将剩余百分百空间都添加都逻辑卷中</span><br><span class=\"line\">lvextend -l +100%free /dev/mapper/centos-root</span><br><span class=\"line\"></span><br><span class=\"line\">重新识别一下分区大小，就可以通过df -h看到新增的容量了</span><br><span class=\"line\"># xfs_growfs /dev/mapper/centos-root</span><br></pre></td></tr></table></figure>\n\n\n\n<p><strong>场景2：在原有的磁盘上扩容</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@node01 ~]# df -h</span><br><span class=\"line\">Filesystem                                        Size  Used Avail Use% Mounted on</span><br><span class=\"line\">/dev/mapper/centos-root                           36G   30G  6.0G  83% /</span><br><span class=\"line\">devtmpfs                                          16G     0   16G   0% /dev</span><br><span class=\"line\">tmpfs                                             16G  4.0K   16G   1% /dev/shm</span><br><span class=\"line\">tmpfs                                             16G  100M   16G   1% /run</span><br><span class=\"line\">tmpfs                                             16G     0   16G   0% /sys/fs/cgroup</span><br><span class=\"line\">/dev/vda1                                         1014M  166M  849M  17% /boot</span><br><span class=\"line\">tmpfs                                             3.2G     0  3.2G   0% /run/user/0</span><br><span class=\"line\"></span><br><span class=\"line\">[root@node01 ~]# lsblk </span><br><span class=\"line\">NAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class=\"line\">sr0              11:0    1 1024M  0 rom  </span><br><span class=\"line\">vda             252:0    0  100G  0 disk </span><br><span class=\"line\">├─vda1          252:1    0    1G  0 part /boot</span><br><span class=\"line\">└─vda2          252:2    0   39G  0 part </span><br><span class=\"line\">  ├─centos-root 253:0    0 35.1G  0 lvm  /</span><br><span class=\"line\">  └─centos-swap 253:1    0  3.9G  0 lvm </span><br><span class=\"line\"></span><br><span class=\"line\">[root@node01 ~]# fdisk -l</span><br><span class=\"line\">#还有空间没有使用先进行分区</span><br><span class=\"line\">Disk /dev/vda: 107.4 GB, 107374182400 bytes, 209715200 sectors</span><br><span class=\"line\">Units = sectors of 1 * 512 = 512 bytes</span><br><span class=\"line\">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class=\"line\">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class=\"line\">Disk label type: dos</span><br><span class=\"line\">Disk identifier: 0x000bfa4f</span><br><span class=\"line\"></span><br><span class=\"line\">   Device Boot      Start         End      Blocks   Id  System</span><br><span class=\"line\">/dev/vda1   *        2048     2099199     1048576   83  Linux</span><br><span class=\"line\">/dev/vda2         2099200    83886079    40893440   8e  Linux LVM</span><br><span class=\"line\"></span><br><span class=\"line\">Disk /dev/mapper/centos-root: 37.7 GB, 37706792960 bytes, 73646080 sectors</span><br><span class=\"line\">Units = sectors of 1 * 512 = 512 bytes</span><br><span class=\"line\">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class=\"line\">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Disk /dev/mapper/centos-swap: 4160 MB, 4160749568 bytes, 8126464 sectors</span><br><span class=\"line\">Units = sectors of 1 * 512 = 512 bytes</span><br><span class=\"line\">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class=\"line\">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class=\"line\"></span><br><span class=\"line\">分区</span><br><span class=\"line\"># fdisk /dev/vda  ## /dev/sda为通过fdisk -l 查看到的物理磁盘(第一行)</span><br><span class=\"line\">Welcome to fdisk (util-linux 2.23.2).</span><br><span class=\"line\"></span><br><span class=\"line\">Changes will remain in memory only, until you decide to write them.</span><br><span class=\"line\">Be careful before using the write command.</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Command (m for help): n  ## n为创建一个新的分区</span><br><span class=\"line\">Partition type:   ## 这里需要选择时创建主分区还是扩展分区&amp;#xff0c;都可以&amp;#xff0c;这里直接选了主分区</span><br><span class=\"line\">   p   primary (2 primary, 0 extended, 2 free)   </span><br><span class=\"line\">   e   extended</span><br><span class=\"line\">Select (default p): p  ## 选择创建一个主分区&amp;#xff0c;主分区只能有4个&amp;#xff0c;编号为1-4,下面的全部直接回车就好了&amp;#xff0c;会自动将剩余所用空间都创建</span><br><span class=\"line\">Partition number (3,4, default 3):   </span><br><span class=\"line\">First sector (104857600-209715199, default 104857600): </span><br><span class=\"line\">Using default value 104857600</span><br><span class=\"line\">Last sector, &amp;#43;sectors or &amp;#43;size&#123;K,M,G&#125; (104857600-209715199, default 209715199): </span><br><span class=\"line\">Using default value 209715199</span><br><span class=\"line\">Partition 3 of type Linux and of size 50 GiB is set</span><br><span class=\"line\"></span><br><span class=\"line\">Command (m for help): t   ## t为修改分区类型</span><br><span class=\"line\">Partition number (1-3, default 3): 3  ## 刚才创建的分区编号为3</span><br><span class=\"line\">Hex code (type L to list all codes): 8e  ## 8e就是 lvm格式的分区</span><br><span class=\"line\">Changed type of partition &amp;#39;Linux&amp;#39; to &amp;#39;Linux LVM&amp;#39;</span><br><span class=\"line\"></span><br><span class=\"line\">Command (m for help): w  ## w保存并写入磁盘。</span><br><span class=\"line\">The partition table has been altered!</span><br><span class=\"line\"></span><br><span class=\"line\">Calling ioctl() to re-read partition table.</span><br><span class=\"line\"></span><br><span class=\"line\">WARNING: Re-reading the partition table failed with error 16: Device or resource busy.</span><br><span class=\"line\">The kernel still uses the old table. The new table will be used at</span><br><span class=\"line\">the next reboot or after you run partprobe(8) or kpartx(8)</span><br><span class=\"line\">Syncing disks.</span><br><span class=\"line\"></span><br><span class=\"line\">这里，在保存后，会发现，可能会出现报错，显示繁忙，无法重新读取分区信息。下面有解决办法。可以用过重启或者执行 partprobe or kpartx。所以，这里直接执行partprobe</span><br><span class=\"line\"># partprobe</span><br><span class=\"line\"></span><br><span class=\"line\">将/dev/vda3创建物理分区</span><br><span class=\"line\"># pvcreate /dev/vda3</span><br><span class=\"line\"></span><br><span class=\"line\">查看物理卷</span><br><span class=\"line\"># pvdisplay</span><br><span class=\"line\"></span><br><span class=\"line\">查看卷组</span><br><span class=\"line\"># vgdisplay</span><br><span class=\"line\"></span><br><span class=\"line\">将物理卷加入到卷组</span><br><span class=\"line\"># vgextend centos /dev/vda3</span><br><span class=\"line\"></span><br><span class=\"line\">加入后，再次查看卷组</span><br><span class=\"line\"># vgdisplay</span><br><span class=\"line\"></span><br><span class=\"line\">查看逻辑卷</span><br><span class=\"line\"># lvdisplay</span><br><span class=\"line\"></span><br><span class=\"line\">将剩余百分百空间都添加都逻辑卷中</span><br><span class=\"line\"># lvextend -l +100%free /dev/mapper/centos-root</span><br><span class=\"line\"></span><br><span class=\"line\">重新识别一下分区大小，就可以通过df -h看到新增的容量了</span><br><span class=\"line\"># xfs_growfs /dev/mapper/centos-root</span><br></pre></td></tr></table></figure>\n\n\n\n<p><strong>场景3：在同一个vg卷组下，不同逻辑卷，将空间的容量加到root卷组下</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 列出所有可用块设备的信息</span><br><span class=\"line\">[root@master01 software]# lsblk</span><br><span class=\"line\">NAME                                  MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class=\"line\">sr0                                    11:0    1 1024M  0 rom  </span><br><span class=\"line\">vda                                   253:0    0  100G  0 disk </span><br><span class=\"line\">├─vda1                                253:1    0  200M  0 part /boot/efi</span><br><span class=\"line\">├─vda2                                253:2    0    1G  0 part /boot</span><br><span class=\"line\">└─vda3                                253:3    0 98.8G  0 part </span><br><span class=\"line\">  ├─klas_host--10--200--91--54-root   252:0    0 63.7G  0 lvm  /</span><br><span class=\"line\">  ├─klas_host--10--200--91--54-swap   252:1    0    4G  0 lvm  </span><br><span class=\"line\">  └─klas_host--10--200--91--54-backup 252:2    0 31.1G  0 lvm  </span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 查看卷组</span><br><span class=\"line\">[root@master01 software]# vgdisplay</span><br><span class=\"line\">  --- Volume group ---</span><br><span class=\"line\">  VG Name               klas_host-10-200-91-54</span><br><span class=\"line\">  System ID             </span><br><span class=\"line\">  Format                lvm2</span><br><span class=\"line\">  Metadata Areas        1</span><br><span class=\"line\">  Metadata Sequence No  4</span><br><span class=\"line\">  VG Access             read/write</span><br><span class=\"line\">  VG Status             resizable</span><br><span class=\"line\">  MAX LV                0</span><br><span class=\"line\">  Cur LV                3</span><br><span class=\"line\">  Open LV               1</span><br><span class=\"line\">  Max PV                0</span><br><span class=\"line\">  Cur PV                1</span><br><span class=\"line\">  Act PV                1</span><br><span class=\"line\">  VG Size               98.80 GiB</span><br><span class=\"line\">  PE Size               4.00 MiB</span><br><span class=\"line\">  Total PE              25293</span><br><span class=\"line\">  Alloc PE / Size       25293 / 98.80 GiB</span><br><span class=\"line\">  Free  PE / Size       0 / 0   </span><br><span class=\"line\">  VG UUID               kkFp7N-fdS3-lf3n-Fylz-Q7LG-h6Ex-T7bvph</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 查看逻辑卷</span><br><span class=\"line\">[root@master01 software]# lvdisplay</span><br><span class=\"line\">  --- Logical volume ---</span><br><span class=\"line\">  LV Path                /dev/klas_host-10-200-91-54/swap</span><br><span class=\"line\">  LV Name                swap</span><br><span class=\"line\">  VG Name                klas_host-10-200-91-54</span><br><span class=\"line\">  LV UUID                mJCfg8-LLgS-NXuL-WtJ1-4T1X-a9bV-LcLrdO</span><br><span class=\"line\">  LV Write Access        read/write</span><br><span class=\"line\">  LV Creation host, time host-10-200-91-54, 2022-01-18 17:41:43 +0800</span><br><span class=\"line\">  LV Status              available</span><br><span class=\"line\">  # open                 0</span><br><span class=\"line\">  LV Size                &lt;4.03 GiB</span><br><span class=\"line\">  Current LE             1031</span><br><span class=\"line\">  Segments               1</span><br><span class=\"line\">  Allocation             inherit</span><br><span class=\"line\">  Read ahead sectors     auto</span><br><span class=\"line\">  - currently set to     4096</span><br><span class=\"line\">  Block device           252:1</span><br><span class=\"line\">   </span><br><span class=\"line\">  --- Logical volume ---</span><br><span class=\"line\">  LV Path                /dev/klas_host-10-200-91-54/backup</span><br><span class=\"line\">  LV Name                backup</span><br><span class=\"line\">  VG Name                klas_host-10-200-91-54</span><br><span class=\"line\">  LV UUID                yul3Nj-Rtyd-YGu0-nWny-sIHF-gj21-3LARG6</span><br><span class=\"line\">  LV Write Access        read/write</span><br><span class=\"line\">  LV Creation host, time host-10-200-91-54, 2022-01-18 17:41:43 +0800</span><br><span class=\"line\">  LV Status              available</span><br><span class=\"line\">  # open                 0</span><br><span class=\"line\">  LV Size                &lt;31.09 GiB</span><br><span class=\"line\">  Current LE             7959</span><br><span class=\"line\">  Segments               1</span><br><span class=\"line\">  Allocation             inherit</span><br><span class=\"line\">  Read ahead sectors     auto</span><br><span class=\"line\">  - currently set to     4096</span><br><span class=\"line\">  Block device           252:2</span><br><span class=\"line\">   </span><br><span class=\"line\">  --- Logical volume ---</span><br><span class=\"line\">  LV Path                /dev/klas_host-10-200-91-54/root</span><br><span class=\"line\">  LV Name                root</span><br><span class=\"line\">  VG Name                klas_host-10-200-91-54</span><br><span class=\"line\">  LV UUID                NwRken-eyAM-njwk-l2IU-jz0N-YfCF-0mvzcJ</span><br><span class=\"line\">  LV Write Access        read/write</span><br><span class=\"line\">  LV Creation host, time host-10-200-91-54, 2022-01-18 17:41:44 +0800</span><br><span class=\"line\">  LV Status              available</span><br><span class=\"line\">  # open                 1</span><br><span class=\"line\">  LV Size                63.68 GiB</span><br><span class=\"line\">  Current LE             16303</span><br><span class=\"line\">  Segments               1</span><br><span class=\"line\">  Allocation             inherit</span><br><span class=\"line\">  Read ahead sectors     auto</span><br><span class=\"line\">  - currently set to     4096</span><br><span class=\"line\">  Block device           252:0</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 查看挂的云硬盘的名称</span><br><span class=\"line\">[root@master01 software]# fdisk -l </span><br><span class=\"line\">Disk /dev/vda: 100 GiB, 107374182400 bytes, 209715200 sectors</span><br><span class=\"line\">Units: sectors of 1 * 512 = 512 bytes</span><br><span class=\"line\">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class=\"line\">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class=\"line\">Disklabel type: gpt</span><br><span class=\"line\">Disk identifier: 26046881-8F99-4CA0-B01F-0473C537AC20</span><br><span class=\"line\"></span><br><span class=\"line\">Device       Start       End   Sectors  Size Type</span><br><span class=\"line\">/dev/vda1     2048    411647    409600  200M EFI System</span><br><span class=\"line\">/dev/vda2   411648   2508799   2097152    1G Linux filesystem</span><br><span class=\"line\">/dev/vda3  2508800 209713151 207204352 98.8G Linux LVM</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Disk /dev/mapper/klas_host--10--200--91--54-root: 63.7 GiB, 68379738112 bytes, 133554176 sectors</span><br><span class=\"line\">Units: sectors of 1 * 512 = 512 bytes</span><br><span class=\"line\">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class=\"line\">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Disk /dev/mapper/klas_host--10--200--91--54-swap: 4.3 GiB, 4324327424 bytes, 8445952 sectors</span><br><span class=\"line\">Units: sectors of 1 * 512 = 512 bytes</span><br><span class=\"line\">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class=\"line\">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Disk /dev/mapper/klas_host--10--200--91--54-backup: 31.9 GiB, 33382465536 bytes, 65200128 sectors</span><br><span class=\"line\">Units: sectors of 1 * 512 = 512 bytes</span><br><span class=\"line\">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class=\"line\">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 从上面看到卷组有100G，逻辑卷有一个backup的空闲，把空闲的加到 /dev/klas_host-10-200-91-54/root</span><br><span class=\"line\"># 删除卷组/dev/mapper/klas_host--10--200--91--54-backup</span><br><span class=\"line\">lvremove /dev/mapper/klas_host--10--200--91--54-backup</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 将剩余百分百空间都添加到逻辑卷中</span><br><span class=\"line\">lvextend -l +100%free /dev/mapper/klas_host--10--200--91--54-root</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 然后重新识别一下分区大小</span><br><span class=\"line\">xfs_growfs /dev/mapper/klas_host--10--200--91--54-root  ## 命令，后面跟的是逻辑卷的path</span><br></pre></td></tr></table></figure>"},{"title":"registry部署","date":"2022-11-25T01:59:52.000Z","_content":"\n# registry部署\n\n背景：使用registry作为部署kubesphere所需要镜像的镜像仓库。\n\n<!--more-->\n\n```\n\nregistry部署\n背景：使用registry作为部署kubesphere所需要镜像的镜像仓库。\n\n\n\n# 创建docker数据目录\n# mkdir -p /data1/docker\n# ln -s /data1/docker /var/lib/docker\n\n# 安装docker\n# yum install -y vim wget net-tools gcc gcc-c++ socat conntrack nfs-utils rpcbind yum-utils device-mapper-persistent-data lvm2 docker-ce\n\n# 配置私有仓库地址\n# mkdir -p /etc/docker/\n# vi /etc/docker/daemon.json\n{\n        \"exec-opts\": [\"native.cgroupdriver=systemd\"],\n        \"log-driver\": \"json-file\",\n        \"log-opts\": {\n                \"max-size\": \"100m\"\n        },\n        \"storage-driver\": \"overlay2\",\n        \"storage-opts\": [\n                \"overlay2.override_kernel_check=true\"\n        ],\n        \"insecure-registries\": [\"192.168.0.183:8080\",\"192.168.0.183:5000\"]\n}\n\n# 启动docker\n# systemctl daemon-reload\n# systemctl restart docker\n# systemctl status docker\n# systemctl enable docker\n\n# 上传registry.tar到/usr/local/目录\n\n# 新建镜像仓库目录\n# mkdir -p /data1/registry\n\n# 导入镜像\n# docker load -i /usr/local/registry.tar\n\n# 创建registry容器\n# docker run -d --name  training-dev-registry --restart=always -v /data1/registry:/var/lib/registry -p 5000:5000 registry:2\n\n# 验证镜像仓库是否可用\n# docker tag registry:2 192.168.0.183:5000/official/registry:2\n# docker push 192.168.0.183:5000/official/registry:2\n\n\n```\n\n","source":"_posts/registry部署.md","raw":"---\ntitle: registry部署\ndate: 2022-11-25 09:59:52\ntags: registry部署\n---\n\n# registry部署\n\n背景：使用registry作为部署kubesphere所需要镜像的镜像仓库。\n\n<!--more-->\n\n```\n\nregistry部署\n背景：使用registry作为部署kubesphere所需要镜像的镜像仓库。\n\n\n\n# 创建docker数据目录\n# mkdir -p /data1/docker\n# ln -s /data1/docker /var/lib/docker\n\n# 安装docker\n# yum install -y vim wget net-tools gcc gcc-c++ socat conntrack nfs-utils rpcbind yum-utils device-mapper-persistent-data lvm2 docker-ce\n\n# 配置私有仓库地址\n# mkdir -p /etc/docker/\n# vi /etc/docker/daemon.json\n{\n        \"exec-opts\": [\"native.cgroupdriver=systemd\"],\n        \"log-driver\": \"json-file\",\n        \"log-opts\": {\n                \"max-size\": \"100m\"\n        },\n        \"storage-driver\": \"overlay2\",\n        \"storage-opts\": [\n                \"overlay2.override_kernel_check=true\"\n        ],\n        \"insecure-registries\": [\"192.168.0.183:8080\",\"192.168.0.183:5000\"]\n}\n\n# 启动docker\n# systemctl daemon-reload\n# systemctl restart docker\n# systemctl status docker\n# systemctl enable docker\n\n# 上传registry.tar到/usr/local/目录\n\n# 新建镜像仓库目录\n# mkdir -p /data1/registry\n\n# 导入镜像\n# docker load -i /usr/local/registry.tar\n\n# 创建registry容器\n# docker run -d --name  training-dev-registry --restart=always -v /data1/registry:/var/lib/registry -p 5000:5000 registry:2\n\n# 验证镜像仓库是否可用\n# docker tag registry:2 192.168.0.183:5000/official/registry:2\n# docker push 192.168.0.183:5000/official/registry:2\n\n\n```\n\n","slug":"registry部署","published":1,"updated":"2023-01-03T06:17:51.245Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clcfuykyr000b3wrs3e3i918y","content":"<h1 id=\"registry部署\"><a href=\"#registry部署\" class=\"headerlink\" title=\"registry部署\"></a>registry部署</h1><p>背景：使用registry作为部署kubesphere所需要镜像的镜像仓库。</p>\n<span id=\"more\"></span>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">registry部署</span><br><span class=\"line\">背景：使用registry作为部署kubesphere所需要镜像的镜像仓库。</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 创建docker数据目录</span><br><span class=\"line\"># mkdir -p /data1/docker</span><br><span class=\"line\"># ln -s /data1/docker /var/lib/docker</span><br><span class=\"line\"></span><br><span class=\"line\"># 安装docker</span><br><span class=\"line\"># yum install -y vim wget net-tools gcc gcc-c++ socat conntrack nfs-utils rpcbind yum-utils device-mapper-persistent-data lvm2 docker-ce</span><br><span class=\"line\"></span><br><span class=\"line\"># 配置私有仓库地址</span><br><span class=\"line\"># mkdir -p /etc/docker/</span><br><span class=\"line\"># vi /etc/docker/daemon.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class=\"line\">        &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class=\"line\">        &quot;log-opts&quot;: &#123;</span><br><span class=\"line\">                &quot;max-size&quot;: &quot;100m&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;storage-driver&quot;: &quot;overlay2&quot;,</span><br><span class=\"line\">        &quot;storage-opts&quot;: [</span><br><span class=\"line\">                &quot;overlay2.override_kernel_check=true&quot;</span><br><span class=\"line\">        ],</span><br><span class=\"line\">        &quot;insecure-registries&quot;: [&quot;192.168.0.183:8080&quot;,&quot;192.168.0.183:5000&quot;]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 启动docker</span><br><span class=\"line\"># systemctl daemon-reload</span><br><span class=\"line\"># systemctl restart docker</span><br><span class=\"line\"># systemctl status docker</span><br><span class=\"line\"># systemctl enable docker</span><br><span class=\"line\"></span><br><span class=\"line\"># 上传registry.tar到/usr/local/目录</span><br><span class=\"line\"></span><br><span class=\"line\"># 新建镜像仓库目录</span><br><span class=\"line\"># mkdir -p /data1/registry</span><br><span class=\"line\"></span><br><span class=\"line\"># 导入镜像</span><br><span class=\"line\"># docker load -i /usr/local/registry.tar</span><br><span class=\"line\"></span><br><span class=\"line\"># 创建registry容器</span><br><span class=\"line\"># docker run -d --name  training-dev-registry --restart=always -v /data1/registry:/var/lib/registry -p 5000:5000 registry:2</span><br><span class=\"line\"></span><br><span class=\"line\"># 验证镜像仓库是否可用</span><br><span class=\"line\"># docker tag registry:2 192.168.0.183:5000/official/registry:2</span><br><span class=\"line\"># docker push 192.168.0.183:5000/official/registry:2</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n","site":{"data":{}},"excerpt":"<h1 id=\"registry部署\"><a href=\"#registry部署\" class=\"headerlink\" title=\"registry部署\"></a>registry部署</h1><p>背景：使用registry作为部署kubesphere所需要镜像的镜像仓库。</p>","more":"<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">registry部署</span><br><span class=\"line\">背景：使用registry作为部署kubesphere所需要镜像的镜像仓库。</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 创建docker数据目录</span><br><span class=\"line\"># mkdir -p /data1/docker</span><br><span class=\"line\"># ln -s /data1/docker /var/lib/docker</span><br><span class=\"line\"></span><br><span class=\"line\"># 安装docker</span><br><span class=\"line\"># yum install -y vim wget net-tools gcc gcc-c++ socat conntrack nfs-utils rpcbind yum-utils device-mapper-persistent-data lvm2 docker-ce</span><br><span class=\"line\"></span><br><span class=\"line\"># 配置私有仓库地址</span><br><span class=\"line\"># mkdir -p /etc/docker/</span><br><span class=\"line\"># vi /etc/docker/daemon.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class=\"line\">        &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class=\"line\">        &quot;log-opts&quot;: &#123;</span><br><span class=\"line\">                &quot;max-size&quot;: &quot;100m&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;storage-driver&quot;: &quot;overlay2&quot;,</span><br><span class=\"line\">        &quot;storage-opts&quot;: [</span><br><span class=\"line\">                &quot;overlay2.override_kernel_check=true&quot;</span><br><span class=\"line\">        ],</span><br><span class=\"line\">        &quot;insecure-registries&quot;: [&quot;192.168.0.183:8080&quot;,&quot;192.168.0.183:5000&quot;]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 启动docker</span><br><span class=\"line\"># systemctl daemon-reload</span><br><span class=\"line\"># systemctl restart docker</span><br><span class=\"line\"># systemctl status docker</span><br><span class=\"line\"># systemctl enable docker</span><br><span class=\"line\"></span><br><span class=\"line\"># 上传registry.tar到/usr/local/目录</span><br><span class=\"line\"></span><br><span class=\"line\"># 新建镜像仓库目录</span><br><span class=\"line\"># mkdir -p /data1/registry</span><br><span class=\"line\"></span><br><span class=\"line\"># 导入镜像</span><br><span class=\"line\"># docker load -i /usr/local/registry.tar</span><br><span class=\"line\"></span><br><span class=\"line\"># 创建registry容器</span><br><span class=\"line\"># docker run -d --name  training-dev-registry --restart=always -v /data1/registry:/var/lib/registry -p 5000:5000 registry:2</span><br><span class=\"line\"></span><br><span class=\"line\"># 验证镜像仓库是否可用</span><br><span class=\"line\"># docker tag registry:2 192.168.0.183:5000/official/registry:2</span><br><span class=\"line\"># docker push 192.168.0.183:5000/official/registry:2</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>"},{"title":"达梦数据库一主两备安装步骤","date":"2022-10-20T08:02:50.000Z","_content":"\n# 主备集群规范化部署\n\n本章节主要介绍在生产环境中（Linux 系统）规范化部署主备集群。\n\n<!--more-->\n\n## 服务器硬件需求\n\n按实际业务需求，选择合适的服务器，准备 **3 台服务器**，一台主库服务器，两台备库服务器，一台监视器服务器，服务器参数建议如下：\n\n| 硬件       | 要求                                                         |\n| :--------- | :----------------------------------------------------------- |\n| 物理内存   | >=16 GB                                                      |\n| 交换区     | Swap 空间>=物理内存                                          |\n| /tmp大小   | > 1000 MB                                                    |\n| 网络       | 物理机器需要 4 个网卡，2 个 public 网卡做 band，2 个 private 网卡做 band |\n| 磁盘       | 根据实际应用系统需要挂载合适大小磁盘                         |\n| 时间服务器 | 按机房要求配置连接时间服务器                                 |\n\n> 警告\n>\n> 守护进程配置自动切换时，必须在监视器服务器上配置确认监视器，并且保证网络高可用。\n\n## 操作系统要求\n\n### 操作系统版本安装\n\nDM 数据库安装在 Linux 操作系统所需条件：glibc 2.3 以上，内核 2.6，预先安装 UnixODBC，系统性能监控等组件。\n\n### 目录与存储规划\n\n| 用途               | 目录路径           | 备注                           |\n| :----------------- | :----------------- | :----------------------------- |\n| 数据库软件安装目录 | /home/dmdba/dmdbms | 可用空间>50 GB                 |\n| 实例安装目录       | /dmdata            | 单独挂载性能最好的磁盘建议 SSD |\n| 归档日志存放目录   | /dmarch            | 单独挂载磁盘                   |\n| 备份文件存放目录   | /dmbak             | 单独挂载磁盘                   |\n\n### 用户与组\n\nDM 数据库不应该使用 root 用户安装和维护。需要在安装之前为 DM 数据库创建一个专用的系统用户 (dmdba) 和用户组 (dinstall)。\n\n执行以下命令，新建用户组 dinstall：\n\n```\ngroupadd dinstall\n```\n\n执行以下命令，新建用户 dmdba：\n\n```\nuseradd  -g dinstall -m -d /home/dmdba -s /bin/bash  dmdba\n```\n\n执行以下命令，修改 dmdba 用户密码：\n\n```\npasswd dmdba\n```\n\n输入密码并确认。\n\n### 用户资源限制\n\n执行以下命令，修改 dmdba 用户资源限制：\n\n```\nvim /etc/security/limits.conf\n```\n\n文件末尾添加如下内容：\n\n```\ndmdba soft core unlimited\ndmdba hard core unlimited\ndmdba soft nofile 65536\ndmdba hard nofile 65536\ndmdba soft nproc  65536\ndmdba hard nproc  65536\ndmdba soft stack  65536\ndmdba hard stack  65536\n```\n\n### 用户环境变量\n\n执行以下命令，修改 dmdba 用户环境变量：\n\n```\nvi /home/dmdba/.bash_profile\n```\n\n文件末尾添加如下内容：\n\n```\nexport DM_HOME=/mnt/dmdba/dmdata\nexport PATH=$PATH:$DM_HOME/bin\nexport LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$DM_HOME/bin\n```\n\n### 防火墙设置\n\n关闭防火墙：systemctl stop firewalld\n\n禁止开机自启：systemctl disable firewalld\n\n#### 端口规划\n\n搭建 2 节点主备集群，端口规划如下：（实际中可以按需要修改端口号）\n\n| 主机名  |       ip       |       实例名        | 端口  |                  用途                   |\n| :-----: | :------------: | :-----------------: | :---: | :-------------------------------------: |\n| prddb01 | 192.168.118.18 | DmServiceDMSERVER01 | 5236  | 数据库实例 DmServiceDMSERVER01 监听端口 |\n| prddb01 | 192.168.118.18 | DmServiceDMSERVER01 | 61141 |       MAL 系统监听 TCP 连接的端口       |\n| prddb01 | 192.168.118.18 | DmServiceDMSERVER01 | 52141 |  实例本地的守护进程监听 TCP 连接的端口  |\n| prddb01 | 192.168.118.18 | DmServiceDMSERVER01 | 33141 |     实例监听守护进程 TCP 连接的端口     |\n| prddb02 | 192.168.118.19 | DmServiceDMSERVER02 | 5236  | 数据库实例 DmServiceDMSERVER02 监听端口 |\n| prddb02 | 192.168.118.19 | DmServiceDMSERVER02 | 61142 |       MAL 系统监听 TCP 连接的端口       |\n| prddb02 | 192.168.118.19 | DmServiceDMSERVER02 | 52142 |  实例本地的守护进程监听 TCP 连接的端口  |\n| prddb02 | 192.168.118.19 | DmServiceDMSERVER02 | 33142 |     实例监听守护进程 TCP 连接的端口     |\n| prddb03 | 192.168.118.20 | DmServiceDMSERVER03 | 5236  | 数据库实例 DmServiceDMSERVER03 监听端口 |\n| prddb03 | 192.168.118.20 | DmServiceDMSERVER03 | 61143 |       MAL 系统监听 TCP 连接的端口       |\n| prddb03 | 192.168.118.20 | DmServiceDMSERVER03 | 52143 |  实例本地的守护进程监听 TCP 连接的端口  |\n| prddb03 | 192.168.118.20 | DmServiceDMSERVER03 | 33143 |     实例监听守护进程 TCP 连接的端口     |\n| prddb02 | 192.168.118.19 |       监视器        |       |                监视节点                 |\n\n**防火墙集群之间需开放以上所有端口，**集群对客户端只需要开通数据库实例监听端口。\n\n## 安装数据库(三台都装)\n\n### 用户与组\n\nDM 数据库不应该使用 root 用户安装和维护。需要在安装之前为 DM 数据库创建一个专用的系统用户 (dmdba) 和用户组 (dinstall)。\n\n执行以下命令，新建用户组 dinstall：\n\n```\ngroupadd dinstall\n```\n\n执行以下命令，新建用户 dmdba：\n\n```\nuseradd  -g dinstall -m -d /home/dmdba -s /bin/bash  dmdba\n```\n\n执行以下命令，修改 dmdba 用户密码：\n\n```\npasswd dmdba\n```\n\n输入密码并确认。\n\n### 用户资源限制\n\n执行以下命令，修改 dmdba 用户资源限制：\n\n```\nvim /etc/security/limits.conf\n```\n\n文件末尾添加如下内容：\n\n```\ndmdba soft core unlimited\ndmdba hard core unlimited\ndmdba soft nofile 65536\ndmdba hard nofile 65536\ndmdba soft nproc  65536\ndmdba hard nproc  65536\ndmdba soft stack  65536\ndmdba hard stack  65536\n```\n\n### 用户环境变量\n\n执行以下命令，修改 dmdba 用户环境变量：\n\n```\nvi /home/dmdba/.bash_profile\n```\n\n文件末尾添加如下内容：\n\n```\nexport DM_HOME=/mnt/dmdba/dmdata\nexport PATH=$PATH:$DM_HOME/bin\nexport LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$DM_HOME/bin\n```\n\n### 软件申请\n\n可访问达梦云适配中心[下载试用](https://eco.dameng.com/download/?_blank)，下载 DM8 数据库试用版，如需其他版本，请联系达梦销售人员。\n\n查询操作系统（内核）版本，CPU 架构命令：`uname -a`。\n\n如上图所示，需申请 rh7，x86 版本数据库软件。\n\n以 iso 文件安装包为例，安装包命名规则如下：`dm8_20200930_x86_rh6_64_ent_8.1.1.134.iso`\n\n```\ndm8：数据库大版本为 dm8\n20200930：数据库版本发布日期\nx86：安装包匹配的 CPU 架构\nrh6：安装包匹配的系统版本 (redhat 6)\nent：数据库为企业版\n8.1.1.134：数据库详细版本号\n```\n\n### 安装数据库软件\n\n将安装包上传到服务器后使用 root 用户挂载 iso 安装包文件到 `/mnt` 目录下：\n\n```\nmount -oloop dm8_20211025_HWarm_centos7_64_sec_8.1.2.84.iso /data/mnt\n```\n\n执行以下命令，切换到 dmdba 用户：\n\n```\nsu - dmdba\n```\n\n执行以下命令，切换到 /mnt 目录下：\n\n```\ncd /data/mnt\n```\n\n执行以下命令，查看文件：\n\n```\nll\n```\n\n执行 `DMInstall.bin` 文件开始安装，选择【-i】参数以命令行方式安装：\n\n1. 选择安装程序的语言 c/C 为中文，e/E 为英文。\n2. 提示是否安装 key 文件，输入 N 跳过。\n3. 选择时区，21 即东 8 区。\n4. 选择安装类型，默认典型安装（包含所有内容）。\n\n```\n./DMInstall.bin -i\nPlease select the installer's language (E/e:English C/c:Chinese) [E/e]:c\n解压安装程序..........\n欢迎使用达梦数据库安装程序\n是否输入Key文件路径? (Y/y:是 N/n:否) [Y/y]:n\n是否设置时区? (Y/y:是 N/n:否) [Y/y]:\n设置时区:\n\n[ 1]: GTM-12=日界线西\n[ 2]: GTM-11=萨摩亚群岛\n[ 3]: GTM-10=夏威夷\n[ 4]: GTM-09=阿拉斯加\n[ 5]: GTM-08=太平洋时间（美国和加拿大）\n[ 6]: GTM-07=亚利桑那\n[ 7]: GTM-06=中部时间（美国和加拿大）\n[ 8]: GTM-05=东部部时间（美国和加拿大）\n[ 9]: GTM-04=大西洋时间（美国和加拿大）\n[10]: GTM-03=巴西利亚\n[11]: GTM-02=中大西洋\n[12]: GTM-01=亚速尔群岛\n[13]: GTM=格林威治标准时间\n[14]: GTM+01=萨拉热窝\n[15]: GTM+02=开罗\n[16]: GTM+03=莫斯科\n[17]: GTM+04=阿布扎比\n[18]: GTM+05=伊斯兰堡\n[19]: GTM+06=达卡\n[20]: GTM+07=曼谷，河内\n[21]: GTM+08=中国标准时间\n[22]: GTM+09=汉城\n[23]: GTM+10=关岛\n[24]: GTM+11=所罗门群岛\n[25]: GTM+12=斐济\n[26]: GTM+13=努库阿勒法\n[27]: GTM+14=基里巴斯\n\n请选择设置时区 [21]:\n安装类型:\n1 典型安装\n2 服务器\n3 客户端\n4 自定义\n请选择安装类型的数字序号 [1 典型安装]:4 #这里可直接典型安装\n1 服务器组件\n2 客户端组件\n  2.1 DM管理工具\n  2.2 DM性能监视工具\n  2.3 DM数据迁移工具\n  2.4 DM控制台工具\n  2.5 DM审计分析工具\n  2.6 SQL交互式查询工具\n3 驱动\n4 用户手册\n5 数据库服务\n  5.1 实时审计服务\n  5.2 作业服务\n  5.3 实例监控服务\n  5.4 辅助插件服务\n请选择安装组件的序号 (使用空格间隔) [1 2 3 4 5]:1 2 3 4 5\n所需空间: 1223M\n请选择安装目录 [/mnt/dmdba/dmdbms]:/mnt/dmdba/dmdata\n可用空间: 495G\n是否确认安装路径(/mnt/dmdba/dmdata)? (Y/y:是 N/n:否)  [Y/y]:\n安装前小结\n安装位置: /mnt/dmdba/dmdata\n所需空间: 1223M\n可用空间: 495G\n版本信息: \n有效日期: \n安装类型: 自定义\n是否确认安装? (Y/y:是 N/n:否):y\n2022-05-09 10:23:18 \n[INFO] 安装达梦数据库...\n2022-05-09 10:23:18 \n[INFO] 安装 基础 模块...\n2022-05-09 10:23:19 \n[INFO] 安装 服务器 模块...\n2022-05-09 10:23:19 \n[INFO] 安装 客户端 模块...\n2022-05-09 10:23:20 \n[INFO] 安装 驱动 模块...\n2022-05-09 10:23:20 \n[INFO] 安装 手册 模块...\n2022-05-09 10:23:20 \n[INFO] 安装 服务 模块...\n2022-05-09 10:23:21 \n[INFO] 移动日志文件。\n2022-05-09 10:23:21 \n[INFO] 安装达梦数据库完成。\n```\n\n**安装完成后，按照系统提示使用 root 用户执行脚本。**\n\n```\n/mnt/dmdba/dmdata/script/root/root_installer.sh\n```\n\n提示 `DmAPService 服务启动成功`，则安装完成。\n\n### 使用 dminit 工具初始化实例\n\n```\n[root@prddb01 bin]# ./dminit help\ninitdb V8\ndb version: 0x7000c\n格式: ./dminit     KEYWORD=value\n\n例程: ./dminit     PATH=/public/dmdb/dmData PAGE_SIZE=16\n\n关键字                     说明（默认值）\n--------------------------------------------------------------------------------\nINI_FILE                   初始化文件dm.ini存放的路径\nPATH                       初始数据库存放的路径\nCTL_PATH                   控制文件路径\nLOG_PATH                   日志文件路径\nEXTENT_SIZE                数据文件使用的簇大小(16)，可选值：16, 32, 64，单位：页\nPAGE_SIZE                  数据页大小(8)，可选值：4, 8, 16, 32，单位：K\nLOG_SIZE                   日志文件大小(256)，单位为：M，范围为：256M ~ 2G\nCASE_SENSITIVE             大小敏感(Y)，可选值：Y/N，1/0\nCHARSET/UNICODE_FLAG       字符集(0)，可选值：0[GB18030]，1[UTF-8]，2[EUC-KR]\nSEC_PRIV_MODE              权限管理模式(0)，可选值：0[TRADITION]，1[BMJ]，2[EVAL]\nLENGTH_IN_CHAR             VARCHAR类型长度是否以字符为单位(N)，可选值：Y/N，1/0\nSYSDBA_PWD                 设置SYSDBA密码(SYSDBA)\nSYSAUDITOR_PWD             设置SYSAUDITOR密码(SYSAUDITOR)\nDB_NAME                    数据库名(DAMENG)\nINSTANCE_NAME              实例名(DMSERVER)\nPORT_NUM                   监听端口号(5236)\nBUFFER                     系统缓存大小(100)，单位M\nTIME_ZONE                  设置时区(+08:00)\nPAGE_CHECK                 页检查模式(0)，可选值：0/1/2\nPAGE_HASH_NAME             设置页检查HASH算法\nEXTERNAL_CIPHER_NAME       设置默认加密算法\nEXTERNAL_HASH_NAME         设置默认HASH算法\nEXTERNAL_CRYPTO_NAME       设置根密钥加密引擎\nRLOG_ENC_FLAG              设置日志文件是否加密(N)，可选值：Y/N，1/0\nUSBKEY_PIN                 设置USBKEY PIN\nPAGE_ENC_SLICE_SIZE        设置页加密分片大小，可选值：0、512、4096，单位：Byte\nENCRYPT_NAME               设置全库加密算法\nBLANK_PAD_MODE             设置空格填充模式(0)，可选值：0/1\nSYSTEM_MIRROR_PATH         SYSTEM数据文件镜像路径\nMAIN_MIRROR_PATH           MAIN数据文件镜像\nROLL_MIRROR_PATH           回滚文件镜像路径\nMAL_FLAG                   初始化时设置dm.ini中的MAL_INI(0)\nARCH_FLAG                  初始化时设置dm.ini中的ARCH_INI(0)\nMPP_FLAG                   Mpp系统内的库初始化时设置dm.ini中的mpp_ini(0)\nCONTROL                    初始化配置文件（配置文件格式见系统管理员手册）\nAUTO_OVERWRITE             是否覆盖所有同名文件(0) 0:不覆盖 1:部分覆盖 2:完全覆盖\nUSE_NEW_HASH               是否使用改进的字符类型HASH算法(1)\nELOG_PATH                  指定初始化过程中生成的日志文件所在路径\nAP_PORT_NUM                ECS模式下AP协同工作的监听端口\nDFS_FLAG                   初始化时设置dm.ini中的DFS_INI(0)\nDFS_PATH                   启用dfs时指定数据文件的缺省路径\nDFS_HOST                   指定连接分布式系统DFS的服务地址(localhost)\nDFS_PORT                   指定连接分布式系统DFS的服务端口号(3332)\nDFS_COPY_NUM               指定分布式系统的副本数(3)\nDFS_DB_NAME                指定分布式系统的中数据库名(默认与DB_NAME一致)\nSHARE_FLAG                 指定分布式系统中该数据库的共享属性(0)\nREGION_MODE                指定分布式系统中该数据库的系统表空间数据文件的区块策略(0) 0:微区策略 1:宏区策略\nHUGE_WITH_DELTA            是否仅支持创建事务型HUGE表(1) 1:是 0:否\nRLOG_GEN_FOR_HUGE          是否生成HUGE表REDO日志(0) 1:是 0:否\nPSEG_MGR_FLAG              是否仅使用管理段记录事务信息(0) 1:是 0:否\nCHAR_FIX_STORAGE           CHAR是否按定长存储(N)，可选值：Y/N，1/0\nSQL_LOG_FORBID             是否禁止打开SQL日志(N)，可选值：Y/N，1/0\nSYSSSO_PWD                 设置SYSSSO密码(SYSSSO)\nSYSDBO_PWD                 设置SYSDBO密码(SYSDBO)\nPRIV_FLAG                  设置权限标记(0)，可选值：0[三权分立]，1[四权分立]\nHELP                       打印帮助信息\n\n```\n\n执行以下命令，切换到 /dm8/bin 目录。\n\n```\ncd /mnt/dmdba/dmdata/bin\n./dminit PATH=/mnt/dmdba/dmdata/ PAGE_SIZE=32 EXTENT_SIZE=32 CASE_SENSITIVE=0 LENGTH_IN_CHAR=1 CHARSET=1\n```\n\n> 注意\n>\n> 初始化参数中除了 path 参数必须指定，其它参数都有默认值，如果需求与默认值不同，初始化的时候请指定需要的值。因为部分参数初始化后是无法修改的例如：page_size（页大小），charset（字符集），case_sensitive（大小写敏感）等。更多参数`./dminit help` 查看，是否无法修改的参数可以查询 v$dm_ini 视图，para_type=’READ ONLY’ 表示无法修改。\n\n### **启动数据库**\n\n```\n[dmdba@prddb01 bin]$ ./dmserver /mnt/dmdba/dmdata/DAMENG/dm.ini\nfile dm.key not found, use default license!\n\tversion info: develop\n\tDM Database Server x64 V8 1-2-84-21.10.21-149328-10032-ENT  startup...\n\tNormal of FAST\n\tNormal of DEFAULT\n\tNormal of RECYCLE\n\tNormal of KEEP\n\tNormal of ROLL\n\tDatabase mode = 0, oguid = 0\n\tLicense will expire on 2022-10-21\n\tfile lsn: 28025\n\tndct db load finished\n\tndct second level fill fast pool finished\n\tndct third level fill fast pool finished\n\tndct fill fast pool finished\n\tiid page's trxid[5010]\n\tNEXT TRX ID = 5011\n\tpseg_collect_mgr_items, total collect 0 active_trxs, 0 cmt_trxs, 0 pre_cmt_trxs, 0 active_pages, 0 cmt_pages, 0 pre_cmt_pages, 0 mgr pages, 0 mgr recs!\n\tiid page's trxid[6012]\n\tNEXT TRX ID = 7014.\n\ttotal 0 active crash trx, pseg_crash_trx_rollback sys_only(0) begin ...\n\tpseg_crash_trx_rollback end, total 0 active crash trx, include 0 empty_trxs, 0 empty_pages which only need to delete mgr recs.\n\tpseg_crash_trx_rollback end\n\tpseg recv finished\n\tnsvr_startup end.\n\taud sys init success.\n\taud rt sys init success.\n\tsystables desc init success.\n\tndct_db_load_info success.\n\tnsvr_process_before_open begin.\n\tnsvr_process_before_open success.\n\ttotal 0 active crash trx, pseg_crash_trx_rollback sys_only(0) begin ...\n\tpseg_crash_trx_rollback end, total 0 active crash trx, include 0 empty_trxs, 0 empty_pages which only need to delete mgr recs.\n\tpseg_crash_trx_rollback end\n\tSYSTEM IS READY.\n\texit\n```\n\n### 主节点上脱机备份\n\n如果备份过程中出现错误，通过ps -ef | grep dmap查看dmap服务是否在运行中\n如果不在运行中\n\n```\n[dmdba@prddb01 ~]$ cd /mnt/dmdba/dmdata/bin\n\n[dmdba@prddb01 bin]$ ./DmAPService start\n```\n\n### 主节点备份\n\n主节点：192.168.118.18\n\n```\ncd /mnt/dmdba/dmdata/bin   #dmdba用户\n[dmdba@prddb01 bin]$ ./dmrman\ndmrman V8\nRMAN> backup database '/mnt/dmdba/dmdata/DAMENG/dm.ini' full to backup_file1 backupset '/mnt/dmdba/dmdata/DAMENG/backup01'        \nbackup database '/mnt/dmdba/dmdata/DAMENG/dm.ini' full to backup_file1 backupset '/mnt/dmdba/dmdata/DAMENG/backup01'\nfile dm.key not found, use default license!\nDatabase mode = 0, oguid = 0\nNormal of FAST\nNormal of DEFAULT\nNormal of RECYCLE\nNormal of KEEP\nNormal of ROLL\nEP[0]'s cur_lsn[30600], file_lsn[30600]\nProcessing backupset /mnt/dmdba/dmdata/DAMENG/backup01\n[Percent:100.00%][Speed:0.00M/s][Cost:00:00:00][Remaining:00:00:00]                                 \nbackup successfully!\ntime used: 00:00:01.052\nRMAN> \n```\n\n#### 打开另一窗口(dmdba用户)：\n\n```\nscp -r /mnt/dmdba/dmdata/DAMENG/backup01 dmdba@192.168.118.19:/mnt/dmdba/dmdata/DAMENG/\nscp -r /mnt/dmdba/dmdata/DAMENG/backup01 dmdba@192.168.118.20:/mnt/dmdba/dmdata/DAMENG/\n```\n\n### 从节点还原\n\n#### 从节点：192.168.118.19\n\n**执行 recover。**\n\n```\ncd /mnt/dmdba/dmdata/bin  #dmdba用户                    \n  [dmdba@db-0001 bin]$ ./dmrman\n  dmrman V8\n  RMAN> restore database '/mnt/dmdba/dmdata/DAMENG/dm.ini' from backupset '/mnt/dmdba/dmdata/DAMENG/backup01'\n  restore database '/mnt/dmdba/dmdata/DAMENG/dm.ini' from backupset '/mnt/dmdba/dmdata/DAMENG/backup01'\n  file dm.key not found, use default license!\n  Normal of FAST\n  Normal of DEFAULT\n  Normal of RECYCLE\n  Normal of KEEP\n  Normal of ROLL\n  [Percent:100.00%][Speed:0.00M/s][Cost:00:00:02][Remaining:00:00:00]                                 \n  restore successfully.\n  time used: 00:00:02.396\n  RMAN> recover database '/mnt/dmdba/dmdata/DAMENG/dm.ini' from backupset '/mnt/dmdba/dmdata/DAMENG/backup01'\n  recover database '/mnt/dmdba/dmdata/DAMENG/dm.ini' from backupset '/mnt/dmdba/dmdata/DAMENG/backup01'\n  Database mode = 0, oguid = 0\n  Normal of FAST\n  Normal of DEFAULT\n  Normal of RECYCLE\n  Normal of KEEP\n  Normal of ROLL\n  EP[0]'s cur_lsn[30600], file_lsn[30600]\n  备份集[/mnt/dmdba/dmdata/DAMENG/backup01]备份过程中未产生日志\n  recover successfully!\n  time used: 246.930(ms)\n  RMAN> recover database '/mnt/dmdba/dmdata/DAMENG/dm.ini' update db_magic\n  recover database '/mnt/dmdba/dmdata/DAMENG/dm.ini' update db_magic\n  Database mode = 0, oguid = 0\n  Normal of FAST\n  Normal of DEFAULT\n  Normal of RECYCLE\n  Normal of KEEP\n  Normal of ROLL\n  EP[0]'s cur_lsn[30600], file_lsn[30600]\n  recover successfully!\n  time used: 991.310(ms)\n  RMAN> \n```\n\n  **执行 recover update db_magic。**\n\n```\nrecover database '/mnt/dmdba/dmdata/DAMENG/dm.ini' update db_magic;\n```\n\n#### 从节点：192.168.118.20\n\n**执行 recover。**\n\n```\ncd /mnt/dmdba/dmdata/bin  #dmdba用户                    \n  [dmdba@db-0001 bin]$ ./dmrman\n  dmrman V8\n  RMAN> restore database '/mnt/dmdba/dmdata/DAMENG/dm.ini' from backupset '/mnt/dmdba/dmdata/DAMENG/backup01'\n  restore database '/mnt/dmdba/dmdata/DAMENG/dm.ini' from backupset '/mnt/dmdba/dmdata/DAMENG/backup01'\n  file dm.key not found, use default license!\n  Normal of FAST\n  Normal of DEFAULT\n  Normal of RECYCLE\n  Normal of KEEP\n  Normal of ROLL\n  [Percent:100.00%][Speed:0.00M/s][Cost:00:00:02][Remaining:00:00:00]                                 \n  restore successfully.\n  time used: 00:00:02.396\n  RMAN> recover database '/mnt/dmdba/dmdata/DAMENG/dm.ini' from backupset '/mnt/dmdba/dmdata/DAMENG/backup01'\n  recover database '/mnt/dmdba/dmdata/DAMENG/dm.ini' from backupset '/mnt/dmdba/dmdata/DAMENG/backup01'\n  Database mode = 0, oguid = 0\n  Normal of FAST\n  Normal of DEFAULT\n  Normal of RECYCLE\n  Normal of KEEP\n  Normal of ROLL\n  EP[0]'s cur_lsn[30600], file_lsn[30600]\n  备份集[/mnt/dmdba/dmdata/DAMENG/backup01]备份过程中未产生日志\n  recover successfully!\n  time used: 246.930(ms)\n  RMAN> recover database '/mnt/dmdba/dmdata/DAMENG/dm.ini' update db_magic\n  recover database '/mnt/dmdba/dmdata/DAMENG/dm.ini' update db_magic\n  Database mode = 0, oguid = 0\n  Normal of FAST\n  Normal of DEFAULT\n  Normal of RECYCLE\n  Normal of KEEP\n  Normal of ROLL\n  EP[0]'s cur_lsn[30600], file_lsn[30600]\n  recover successfully!\n  time used: 991.310(ms)\n  RMAN> \n```\n\n  **执行 recover update db_magic。**\n\n```\nrecover database '/mnt/dmdba/dmdata/DAMENG/dm.ini' update db_magic;\n```\n\n\n\n## 主节点配置192.168.118.18\n\n### 修改dm.ini\n\n```\n[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dm.ini\n\n#修改如下参数\n\nINSTANCE_NAME  = DMSERVER01\n\nPORT_NUM  = 5236                      #数据库实例监听端口\n\nDW_INACTIVE_INTERVAL  = 60       #接收守护进程消息超时时间\n\nALTER_MODE_STATUS  = 0             #不允许手工方式修改实例模式/状态/OGUID\n\nENABLE_OFFLINE_TS  = 2         #不允许备库 OFFLINE 表空间\n\nMAL_INI = 1                       #打开 MAL 系统\n\nARCH_INI  = 1                         #打开归档配置\n\nRLOG_SEND_APPLY_MON = 64        #统计最近 64 次的日志发送信息\n```\n\n### 修改dmmal.ini(创建这个文件，内容如下，主备库文件内容要相同)\n\n```\n[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmmal.ini\n\nMAL_CHECK_INTERVAL =  5  #MAL 链路检测时间间隔 \nMAL_CONN_FAIL_INTERVAL =  5  #判定 MAL 链路断开的时间 \n[MAL_INST1]\nMAL_INST_NAME  =  DMSERVER01  #实例名&#xff0c;和 dm.ini 中的 INSTANCE_NAME 一致 \nMAL_HOST  =  192.168.118.18 #MAL 系统监听 TCP 连接的 IP 地址 \nMAL_PORT  = 61141  #MAL 系统监听 TCP 连接的端口 \nMAL_INST_HOST  =  192.168.118.18  #实例的对外服务 IP 地址 \nMAL_INST_PORT  =  5236  #实例的对外服务端口&#xff0c;和 dm.ini 中的 PORT_NUM 一致 \nMAL_DW_PORT =  52141  #实例对应的守护进程监听 TCP 连接的端口 \nMAL_INST_DW_PORT  =  33141  #实例监听守护进程 TCP 连接的端口 \n[MAL_INST2]\nMAL_INST_NAME =  DMSERVER02\nMAL_HOST =  192.168.118.19\nMAL_PORT =  61142\nMAL_INST_HOST =  192.168.118.19\nMAL_INST_PORT =  5236\nMAL_DW_PORT =  52142\nMAL_INST_DW_PORT  =  33142\n[MAL_INST3]\nMAL_INST_NAME =  DMSERVER03\nMAL_HOST =  192.168.118.20\nMAL_PORT  = 61143\nMAL_INST_HOST =  192.168.118.20\nMAL_INST_PORT  = 5236\nMAL_DW_PORT =  52143\nMAL_INST_DW_PORT  =  33143\n\n```\n\n### 配置dmarch.ini文件(创建这个文件，内容如下)\n\n```\n[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmarch.ini\n\n[ARCHIVE_TIMELY1]\n  \nARCH_TYPE = TIMELY       #即时归档类型\n\nARCH_DEST = DMSERVER02  #即时归档目标实例名\n\n[ARCHIVE_TIMELY2]\n\nARCH_TYPE = TIMELY       #即时归档类型\n\nARCH_DEST = DMSERVER03  #即时归档目标实例名\n\n[ARCHIVE_LOCAL1]\n\nARCH_TYPE = LOCAL        #本地归档类型\n\nARCH_DEST = /mnt/dmdba/dmdata/DAMENG/arch #本地归档文件存放路径\n\nARCH_FILE_SIZE = 128     #单位 Mb，本地单个归档文件最大值\n\nARCH_SPACE_LIMIT  = 10240    #单位 Mb，0 表示无限制，范围 1024~4294967294M\n\n```\n\n### 配置dmwatcher.ini文件(创建这个文件，内容如下，主备库文件内容要相同)\n\n```\n[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmwatcher.ini\n\n[GRP1]\n  \nDW_TYPE = GLOBAL          #全局守护类型\n\nDW_MODE = AUTO                  #自动切换模式\n\nDW_ERROR_TIME = 10      #远程守护进程故障认定时间\n\nINST_RECOVER_TIME = 60 #主库守护进程启动恢复的间隔时间\n\nINST_ERROR_TIME = 10     #本地实例故障认定时间\n\nINST_OGUID = 453332      #守护系统唯一 OGUID 值\n\nINST_INI = /mnt/dmdba/dmdata/DAMENG/dm.ini  #dm.ini 配置文件路径\n\nINST_AUTO_RESTART = 1   #打开实例的自动启动功能\n\nINST_STARTUP_CMD = /mnt/dmdba/dmdata/bin/dmserver    #命令行方式启动\n\nRLOG_SEND_THRESHOLD = 0   #指定主库发送日志到备库的时间阈值，默认关闭\n\nRLOG_APPLY_THRESHOLD = 0 #指定备库重演日志的时间阈值，默认关闭\n```\n\n### 开启主节点\n\n```\n[dmdba@prddb01 bin]$  ./dmserver ../DAMENG/dm.ini mount\nfile dm.key not found, use default license!\n\tversion info: develop\n\tDM Database Server x64 V8 1-2-84-21.10.21-149328-10032-ENT  startup...\n\tNormal of FAST\n\tNormal of DEFAULT\n\tNormal of RECYCLE\n\tNormal of KEEP\n\tNormal of ROLL\n\tDatabase mode = 0, oguid = 0\n\tLicense will expire on 2022-10-21\n\tfile lsn: 30600\n\tndct db load finished\n\tndct second level fill fast pool finished\n\tndct third level fill fast pool finished\n\tndct fill fast pool finished\n\tnsvr_startup end.\n\taud sys init success.\n\taud rt sys init success.\n\tsystables desc init success.\n\tndct_db_load_info success.\n\tSYSTEM IS READY.\n\tcheckpoint requested, rlog free space[536862720], used space[0]\n\tcheckpoint generate by ckpt_interval\n\tcheckpoint begin, used_space[0], free_space[536862720]...\n\tcheckpoint end, 0 pages flushed, used_space[0], free_space[536862720].\n\tcheckpoint requested by CKPT_INTERVAL, rlog free space[536862720], used space[0]\n\tcheckpoint generate by ckpt_interval\n\tcheckpoint begin, used_space[0], free_space[536862720]...\n\tcheckpoint end, 0 pages flushed, used_space[0], free_space[536862720].\n```\n\n**一直到显示SYSTEM IS READY启动完成。此时不要关闭这个窗口，重新在主服务器上开启一个窗口。**\n\n```\n[root@prddb01 ~]# su - dmdba\n[dmdba@prddb01 ~]$ cd /mnt/dmdba/dmdata/bin\n[dmdba@prddb01 bin]$ ./disql SYSDBA/SYSDBA@localhost:5236\n服务器[localhost:5236]:处于主库打开状态\n登录使用时间 : 1.616(ms)\n上次登录ip       : ::ffff:192.168.118.18\n上次登录时间   : 2022-05-29 22:55:12\n登录失败次数   : 0\n口令是否过期   : 未过期\ndisql V8\nSQL>sp_set_para_value(1,'ALTER_MODE_STATUS',1);\nDMSQL 过程已成功完成\n已用时间: 4.570(毫秒). 执行号:0.\nSQL> sp_set_oguid(453332);\nDMSQL 过程已成功完成\n已用时间: 5.223(毫秒). 执行号:1.\nSQL> sp_set_para_value(1,'ALTER_MODE_STATUS',0);\nDMSQL 过程已成功完成\n已用时间: 4.021(毫秒). 执行号:2.\nSQL> alter database primary;\n操作已执行\n已用时间: 8.797(毫秒). 执行号:0.\n```\n\n**主节点：192.168.118.18 打开另一窗口(root用户)**\n\n```\n[root@prddb01 ~]# cd /mnt/dmdba/dmdata/script/root\n# 注册数据库实例服务\n./dm_service_installer.sh -t dmserver -dm_ini /mnt/dmdba/dmdata/DAMENG/dm.ini -m mount -p DMSERVER01\n# 注册守护进程服务\n./dm_service_installer.sh -t dmwatcher -watcher_ini /mnt/dmdba/dmdata/DAMENG/dmwatcher.ini -p DMSERVER01\n\n以服务方式启动\n[root@prddb01 ~]# cd /mnt/dmdba/dmdata/bin\n[root@prddb01 bin]# ./DmServiceDMSERVER01 start # 启动数据库实例\n[root@prddb01 bin]# ./DmWatcherServiceDMSERVER01 start #启动守护进程\n```\n\n## 从节点配置192.168.118.19\n\n### 修改dm.ini\n\n```\n[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dm.ini\n\n#修改如下参数\n\nINSTANCE_NAME  = DMSERVER02\n\nPORT_NUM  = 5236                      #数据库实例监听端口\n\nDW_INACTIVE_INTERVAL  = 60       #接收守护进程消息超时时间\n\nALTER_MODE_STATUS  = 0             #不允许手工方式修改实例模式/状态/OGUID\n\nENABLE_OFFLINE_TS  = 2         #不允许备库 OFFLINE 表空间\n\nMAL_INI = 1                       #打开 MAL 系统\n\nARCH_INI  = 1                         #打开归档配置\n\nRLOG_SEND_APPLY_MON = 64        #统计最近 64 次的日志发送信息\n```\n\n### 修改dmmal.ini(创建这个文件，内容如下，主备库文件内容要相同)\n\n```\n[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmmal.ini\n\nMAL_CHECK_INTERVAL =  5  #MAL 链路检测时间间隔 \nMAL_CONN_FAIL_INTERVAL =  5  #判定 MAL 链路断开的时间 \n[MAL_INST1]\nMAL_INST_NAME  =  DMSERVER01  #实例名&#xff0c;和 dm.ini 中的 INSTANCE_NAME 一致 \nMAL_HOST  =  192.168.118.18 #MAL 系统监听 TCP 连接的 IP 地址 \nMAL_PORT  = 61141  #MAL 系统监听 TCP 连接的端口 \nMAL_INST_HOST  =  192.168.118.18  #实例的对外服务 IP 地址 \nMAL_INST_PORT  =  5236  #实例的对外服务端口&#xff0c;和 dm.ini 中的 PORT_NUM 一致 \nMAL_DW_PORT =  52141  #实例对应的守护进程监听 TCP 连接的端口 \nMAL_INST_DW_PORT  =  33141  #实例监听守护进程 TCP 连接的端口 \n[MAL_INST2]\nMAL_INST_NAME =  DMSERVER02\nMAL_HOST =  192.168.118.19\nMAL_PORT =  61142\nMAL_INST_HOST =  192.168.118.19\nMAL_INST_PORT =  5236\nMAL_DW_PORT =  52142\nMAL_INST_DW_PORT  =  33142\n[MAL_INST3]\nMAL_INST_NAME =  DMSERVER03\nMAL_HOST =  192.168.118.20\nMAL_PORT  = 61143\nMAL_INST_HOST =  192.168.118.20\nMAL_INST_PORT  = 5236\nMAL_DW_PORT =  52143\nMAL_INST_DW_PORT  =  33143\n\n```\n\n### 配置dmarch.ini文件(创建这个文件，内容如下)\n\n```\n[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmarch.ini\n\n[ARCHIVE_TIMELY1]\n\nARCH_TYPE = TIMELY       #即时归档类型\n\nARCH_DEST = DMSERVER01  #即时归档目标实例名\n\n[ARCHIVE_TIMELY2]\n\nARCH_TYPE = TIMELY       #即时归档类型\n\nARCH_DEST = DMSERVER03  #即时归档目标实例名\n\n[ARCHIVE_LOCAL1]\n\nARCH_TYPE = LOCAL        #本地归档类型\n\nARCH_DEST = /mnt/dmdba/dmdata/DAMENG/arch #本地归档文件存放路径\n\nARCH_FILE_SIZE = 128     #单位 Mb，本地单个归档文件最大值\n\nARCH_SPACE_LIMIT  = 10240    #单位 Mb，0 表示无限制，范围 1024~4294967294M\n\n```\n\n### 配置dmwatcher.ini文件(创建这个文件，内容如下，主备库文件内容要相同)\n\n```\n[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmwatcher.ini\n\n[GRP1]\n  \nDW_TYPE = GLOBAL          #全局守护类型\n\nDW_MODE = AUTO                  #自动切换模式\n\nDW_ERROR_TIME = 10      #远程守护进程故障认定时间\n\nINST_RECOVER_TIME = 60 #主库守护进程启动恢复的间隔时间\n\nINST_ERROR_TIME = 10     #本地实例故障认定时间\n\nINST_OGUID = 453332      #守护系统唯一 OGUID 值\n\nINST_INI = /mnt/dmdba/dmdata/DAMENG/dm.ini  #dm.ini 配置文件路径\n\nINST_AUTO_RESTART = 1   #打开实例的自动启动功能\n\nINST_STARTUP_CMD = /mnt/dmdba/dmdata/bin/dmserver    #命令行方式启动\n\nRLOG_SEND_THRESHOLD = 0   #指定主库发送日志到备库的时间阈值，默认关闭\n\nRLOG_APPLY_THRESHOLD = 0 #指定备库重演日志的时间阈值，默认关闭\n```\n\n### 配置dmmonitor.ini文件监视服务器(创建这个文件，内容如下)\n\n**监视器只在prddb02配置**\n\n```\n[root@prddb02 ~]# vim /mnt/dmdba/dmdata/DAMENG/dmmonitor.ini\n\nMON_DW_CONFIRM    = 0   #1.确认监视器模式 0.非确认监视模式\nMON_LOG_PATH    = /mnt/dmdba/dmdata/log #监视器日志文件存放路径\nMON_LOG_INTERVAL  = 60 #每隔 60 s 定时记录系统信息到日志文件\nMON_LOG_FILE_SIZE   = 32 #每个日志文件最大 32 MB\nMON_LOG_SPACE_LIMIT  = 0  #不限定日志文件总占用空间\n[GRP1]\n MON_INST_OGUID    = 453332 #组 GRP_RW 的唯一 OGUID 值\n#以下配置为监视器到组 GRP_RW 的守护进程的连接信息，以“IP:PORT”的形式配置\n#IP 对应 dmmal.ini 中的 MAL_HOST，PORT 对应 dmmal.ini 中的 MAL_DW_PORT\nMON_DW_IP = 192.168.118.18:52141\nMON_DW_IP = 192.168.118.19:52142\nMON_DW_IP = 192.168.118.20:52143\n```\n\n\n\n### 开启从节点\n\n```\n[dmdba@prddb02 bin]$  ./dmserver ../DAMENG/dm.ini mount\nfile dm.key not found, use default license!\n\tversion info: develop\n\tDM Database Server x64 V8 1-2-84-21.10.21-149328-10032-ENT  startup...\n\tNormal of FAST\n\tNormal of DEFAULT\n\tNormal of RECYCLE\n\tNormal of KEEP\n\tNormal of ROLL\n\tDatabase mode = 0, oguid = 0\n\tLicense will expire on 2022-10-21\n\tfile lsn: 30600\n\tndct db load finished\n\tndct second level fill fast pool finished\n\tndct third level fill fast pool finished\n\tndct fill fast pool finished\n\tnsvr_startup end.\n\taud sys init success.\n\taud rt sys init success.\n\tsystables desc init success.\n\tndct_db_load_info success.\n\tSYSTEM IS READY.\n\tcheckpoint requested, rlog free space[536862720], used space[0]\n\tcheckpoint generate by ckpt_interval\n\tcheckpoint begin, used_space[0], free_space[536862720]...\n\tcheckpoint end, 0 pages flushed, used_space[0], free_space[536862720].\n\tcheckpoint requested by CKPT_INTERVAL, rlog free space[536862720], used space[0]\n\tcheckpoint generate by ckpt_interval\n\tcheckpoint begin, used_space[0], free_space[536862720]...\n\tcheckpoint end, 0 pages flushed, used_space[0], free_space[536862720].\n```\n\n**一直到显示SYSTEM IS READY启动完成。此时不要关闭这个窗口，重新在主服务器上开启一个窗口。**\n\n```\n[root@prddb02 ~]# su - dmdba\n[dmdba@prddb02 ~]$ cd /mnt/dmdba/dmdata/bin\n[dmdba@prddb02 bin]$ ./disql SYSDBA/SYSDBA@localhost:5236\n服务器[localhost:5236]:处于主库打开状态\n登录使用时间 : 1.616(ms)\n上次登录ip       : ::ffff:192.168.118.18\n上次登录时间   : 2022-05-29 22:55:12\n登录失败次数   : 0\n口令是否过期   : 未过期\ndisql V8\nSQL>sp_set_para_value(1,'ALTER_MODE_STATUS',1);\nDMSQL 过程已成功完成\n已用时间: 4.570(毫秒). 执行号:0.\nSQL> sp_set_oguid(453332);\nDMSQL 过程已成功完成\n已用时间: 5.223(毫秒). 执行号:1.\nSQL> sp_set_para_value(1,'ALTER_MODE_STATUS',0);\nDMSQL 过程已成功完成\n已用时间: 4.021(毫秒). 执行号:2.\nSQL> alter database standby;\n操作已执行\n已用时间: 8.797(毫秒). 执行号:0.\n```\n\n\n\n\n\n## 从节点配置192.168.118.20\n\n### 修改dm.ini\n\n```\n[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dm.ini\n\n#修改如下参数\n\nINSTANCE_NAME  = DMSERVER03\n\nPORT_NUM  = 5236                      #数据库实例监听端口\n\nDW_INACTIVE_INTERVAL  = 60       #接收守护进程消息超时时间\n\nALTER_MODE_STATUS  = 0             #不允许手工方式修改实例模式/状态/OGUID\n\nENABLE_OFFLINE_TS  = 2         #不允许备库 OFFLINE 表空间\n\nMAL_INI = 1                       #打开 MAL 系统\n\nARCH_INI  = 1                         #打开归档配置\n\nRLOG_SEND_APPLY_MON = 64        #统计最近 64 次的日志发送信息\n```\n\n### 修改dmmal.ini(创建这个文件，内容如下，主备库文件内容要相同)\n\n```\n[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmmal.ini\n\nMAL_CHECK_INTERVAL =  5  #MAL 链路检测时间间隔 \nMAL_CONN_FAIL_INTERVAL =  5  #判定 MAL 链路断开的时间 \n[MAL_INST1]\nMAL_INST_NAME  =  DMSERVER01  #实例名&#xff0c;和 dm.ini 中的 INSTANCE_NAME 一致 \nMAL_HOST  =  192.168.118.18 #MAL 系统监听 TCP 连接的 IP 地址 \nMAL_PORT  = 61141  #MAL 系统监听 TCP 连接的端口 \nMAL_INST_HOST  =  192.168.118.18  #实例的对外服务 IP 地址 \nMAL_INST_PORT  =  5236  #实例的对外服务端口&#xff0c;和 dm.ini 中的 PORT_NUM 一致 \nMAL_DW_PORT =  52141  #实例对应的守护进程监听 TCP 连接的端口 \nMAL_INST_DW_PORT  =  33141  #实例监听守护进程 TCP 连接的端口 \n[MAL_INST2]\nMAL_INST_NAME =  DMSERVER02\nMAL_HOST =  192.168.118.19\nMAL_PORT =  61142\nMAL_INST_HOST =  192.168.118.19\nMAL_INST_PORT =  5236\nMAL_DW_PORT =  52142\nMAL_INST_DW_PORT  =  33142\n[MAL_INST3]\nMAL_INST_NAME =  DMSERVER03\nMAL_HOST =  192.168.118.20\nMAL_PORT  = 61143\nMAL_INST_HOST =  192.168.118.20\nMAL_INST_PORT  = 5236\nMAL_DW_PORT =  52143\nMAL_INST_DW_PORT  =  33143\n\n```\n\n### 配置dmarch.ini文件(创建这个文件，内容如下)\n\n```\n[dmdba@prddb03 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmarch.ini\n\n[ARCHIVE_TIMELY1]\n\nARCH_TYPE = TIMELY       #即时归档类型\n\nARCH_DEST = DMSERVER01  #即时归档目标实例名\n\n[ARCHIVE_TIMELY2]\n\nARCH_TYPE = TIMELY       #即时归档类型\n\nARCH_DEST = DMSERVER02  #即时归档目标实例名\n\n[ARCHIVE_LOCAL1]\n\nARCH_TYPE = LOCAL        #本地归档类型\n\nARCH_DEST = /mnt/dmdba/dmdata/DAMENG/arch #本地归档文件存放路径\n\nARCH_FILE_SIZE = 128     #单位 Mb，本地单个归档文件最大值\n\nARCH_SPACE_LIMIT  = 10240    #单位 Mb，0 表示无限制，范围 1024~4294967294M\n\n```\n\n### 配置dmwatcher.ini文件(创建这个文件，内容如下，主备库文件内容要相同)\n\n```\n[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmwatcher.ini\n\n[GRP1]\n  \nDW_TYPE = GLOBAL          #全局守护类型\n\nDW_MODE = AUTO                  #自动切换模式\n\nDW_ERROR_TIME = 10      #远程守护进程故障认定时间\n\nINST_RECOVER_TIME = 60 #主库守护进程启动恢复的间隔时间\n\nINST_ERROR_TIME = 10     #本地实例故障认定时间\n\nINST_OGUID = 453332      #守护系统唯一 OGUID 值\n\nINST_INI = /mnt/dmdba/dmdata/DAMENG/dm.ini  #dm.ini 配置文件路径\n\nINST_AUTO_RESTART = 1   #打开实例的自动启动功能\n\nINST_STARTUP_CMD = /mnt/dmdba/dmdata/bin/dmserver    #命令行方式启动\n\nRLOG_SEND_THRESHOLD = 0   #指定主库发送日志到备库的时间阈值，默认关闭\n\nRLOG_APPLY_THRESHOLD = 0 #指定备库重演日志的时间阈值，默认关闭\n```\n\n### 开启从节点\n\n```\n[dmdba@prddb03 bin]$  ./dmserver ../DAMENG/dm.ini mount\nfile dm.key not found, use default license!\n\tversion info: develop\n\tDM Database Server x64 V8 1-2-84-21.10.21-149328-10032-ENT  startup...\n\tNormal of FAST\n\tNormal of DEFAULT\n\tNormal of RECYCLE\n\tNormal of KEEP\n\tNormal of ROLL\n\tDatabase mode = 0, oguid = 0\n\tLicense will expire on 2022-10-21\n\tfile lsn: 30600\n\tndct db load finished\n\tndct second level fill fast pool finished\n\tndct third level fill fast pool finished\n\tndct fill fast pool finished\n\tnsvr_startup end.\n\taud sys init success.\n\taud rt sys init success.\n\tsystables desc init success.\n\tndct_db_load_info success.\n\tSYSTEM IS READY.\n\tcheckpoint requested, rlog free space[536862720], used space[0]\n\tcheckpoint generate by ckpt_interval\n\tcheckpoint begin, used_space[0], free_space[536862720]...\n\tcheckpoint end, 0 pages flushed, used_space[0], free_space[536862720].\n\tcheckpoint requested by CKPT_INTERVAL, rlog free space[536862720], used space[0]\n\tcheckpoint generate by ckpt_interval\n\tcheckpoint begin, used_space[0], free_space[536862720]...\n\tcheckpoint end, 0 pages flushed, used_space[0], free_space[536862720].\n```\n\n**一直到显示SYSTEM IS READY启动完成。此时不要关闭这个窗口，重新在主服务器上开启一个窗口。**\n\n```\n[root@prddb03 ~]# su - dmdba\n[dmdba@prddb03 ~]$ cd /mnt/dmdba/dmdata/bin\n[dmdba@prddb03 bin]$ ./disql SYSDBA/SYSDBA@localhost:5236\n服务器[localhost:5236]:处于主库打开状态\n登录使用时间 : 1.616(ms)\n上次登录ip       : ::ffff:192.168.118.18\n上次登录时间   : 2022-05-29 22:55:12\n登录失败次数   : 0\n口令是否过期   : 未过期\ndisql V8\nSQL>sp_set_para_value(1,'ALTER_MODE_STATUS',1);\nDMSQL 过程已成功完成\n已用时间: 4.570(毫秒). 执行号:0.\nSQL> sp_set_oguid(453332);\nDMSQL 过程已成功完成\n已用时间: 5.223(毫秒). 执行号:1.\nSQL> sp_set_para_value(1,'ALTER_MODE_STATUS',0);\nDMSQL 过程已成功完成\n已用时间: 4.021(毫秒). 执行号:2.\nSQL> alter database standby;\n操作已执行\n已用时间: 8.797(毫秒). 执行号:0.\n```\n\n## 注册服务\n\n### 使用root用户在主库（192.168.118.18）上执行以下命令\n\n```\n[root@prddb01 root]# cd /mnt/dmdba/dmdata/script/root\n\n./dm_service_installer.sh -t dmserver -dm_ini /mnt/dmdba/dmdata/DAMENG/dm.ini -m mount -p DMSERVER01  # 注册数据库实例服务\n\n./dm_service_installer.sh -t dmwatcher -watcher_ini /mnt/dmdba/dmdata/DAMENG/dmwatcher.ini -p DMSERVER01  # 注册数据库实例服务\n```\n\n### 使用root用户在从库（192.168.118.19）上执行以下命令\n\n```\n[root@prddb01 root]# cd /mnt/dmdba/dmdata/script/root\n\n./dm_service_installer.sh -t dmserver -dm_ini /mnt/dmdba/dmdata/DAMENG/dm.ini -m mount -p DMSERVER01  # 注册数据库实例服务\n\n./dm_service_installer.sh -t dmwatcher -watcher_ini /mnt/dmdba/dmdata/DAMENG/dmwatcher.ini -p DMSERVER01  # 注册数据库实例服务\n\n./dm_service_installer.sh -t dmmonitor -monitor_ini /mnt/dmdba/dmdata/DAMENG/dmmonitor.ini -p DMSERVER02 # 注册监视器服务（只需在监视器服务器上执行）\n```\n\n### 使用root用户在从库（192.168.118.20）上执行以下命令\n\n```\n[root@prddb01 root]# cd /mnt/dmdba/dmdata/script/root\n\n./dm_service_installer.sh -t dmserver -dm_ini /mnt/dmdba/dmdata/DAMENG/dm.ini -m mount -p DMSERVER01  # 注册数据库实例服务\n\n./dm_service_installer.sh -t dmwatcher -watcher_ini /mnt/dmdba/dmdata/DAMENG/dmwatcher.ini -p DMSERVER01  # 注册数据库实例服务\n```\n\n\n\n## 启动管理集群\n\n### 启动集群的顺序为：\n\n**主库实例—>备库实例—>主库守护进程—>备库守护进程—>监视器服务**\n\n#### 1.启动192.168.178.18主库实例\n\n```\n[root@prddb01 root]# cd /mnt/dmdba/dmdata/bin\n[root@prddb01 bin]# ./DmServiceDMSERVER01 start\n```\n\n#### 2.启动192.168.178.19从库实例\n\n```\n[root@prddb02 root]# cd /mnt/dmdba/dmdata/bin\n[root@prddb02 bin]# ./DmServiceDMSERVER02 start\n```\n\n#### 3.启动192.168.178.20从库实例\n\n```\n[root@prddb03 root]# cd /mnt/dmdba/dmdata/bin\n[root@prddb03 bin]# ./DmServiceDMSERVER03 start\n```\n\n#### 4.启动192.168.178.18主库守护进程\n\n```\n[root@prddb01 root]# cd /mnt/dmdba/dmdata/bin\n[root@prddb01 bin]# ./DmWatcherServiceDMSERVER01 start\n```\n\n#### 5.启动192.168.178.19从库守护进程\n\n```\n[root@prddb02 root]# cd /mnt/dmdba/dmdata/bin\n[root@prddb02 bin]# ./DmWatcherServiceDMSERVER02 start\n```\n\n#### 6.启动192.168.178.20从库守护进程\n\n```\n[root@prddb03 root]# cd /mnt/dmdba/dmdata/bin\n[root@prddb03 bin]# ./DmWatcherServiceDMSERVER03 start\n```\n\n#### 7.启动192.168.178.19监视服务\n\n```\n[root@prddb02 root]# cd /mnt/dmdba/dmdata/bin\n[root@prddb02 bin]# ./DmMonitorServiceDMSERVER02 start\n```\n\n#### \n\n## 验证主备集群同步状态\n\n### 监视器查看读写分离集群状态\n\n集群任意节点，配置普通监视器配置文件 `dmmonitor.ini`，执行以下命令：\n\n```\nvi /mnt/dmdba/dmdata/DAMENG/dmmonitor.ini\n```\n\n添加以下内容：\n\n```\nMON_DW_CONFIRM    = 0   #1.确认监视器模式 0.非确认监视模式\nMON_LOG_PATH    = /mnt/dmdba/dmdata/log #监视器日志文件存放路径\nMON_LOG_INTERVAL  = 60 #每隔 60 s 定时记录系统信息到日志文件\nMON_LOG_FILE_SIZE   = 32 #每个日志文件最大 32 MB\nMON_LOG_SPACE_LIMIT  = 0  #不限定日志文件总占用空间\n[GRP1]\n MON_INST_OGUID    = 453332 #组 GRP_RW 的唯一 OGUID 值\n#以下配置为监视器到组 GRP_RW 的守护进程的连接信息，以“IP:PORT”的形式配置\n#IP 对应 dmmal.ini 中的 MAL_HOST，PORT 对应 dmmal.ini 中的 MAL_DW_PORT\nMON_DW_IP = 192.168.118.18:52141\nMON_DW_IP = 192.168.118.19:52142\nMON_DW_IP = 192.168.118.20:52143\n```\n\n启动监视器，执行以下命令：\n\n```\ncd /mnt/dmdba/dmdata/bin\n./dmmonitor mnt/dmdba/dmdata/DAMENG/dmmonitor.ini\n```\n\n输入 show 命令查看集群状态，执行以下命令：\n\n![dm](/images/dm.png)\n\n其中守护进程状态 WSTATUS 为 OPEN，实例状态 ISTATUS 为 OPEN，归档类型 RTYPE 为 REALTIME，归档状态 RSTAT 为VALID。\n\n## 重启集群\n\n**主备集群重启有顺序要求：**（在/mnt/dmdba/dmdata/bin目录下执行）\n\n1. 关闭监视器：./DmMonitorServiceDMSERVER02 stop\n2. 关闭主库守护进程：./DmWatcherServiceDMSERVER01 stop\n3. 关闭备库守护进程：./DmWatcherServiceDMSERVER02 stop\n4. 关闭备库守护进程：./DmWatcherServiceDMSERVER03 stop\n5. 关闭主库实例：./DmServiceDMSERVER01 stop\n6. 关闭备库实例：./DmServiceDMSERVER02 stop\n7. 关闭备库实例：./DmServiceDMSERVER03 stop\n8. 启动主库实例：./DmServiceDMSERVER01 start\n9. 启动备库实例：./DmServiceDMSERVER02 start\n10. 启动备库实例：./DmServiceDMSERVER03 start\n11. 启动主库守护进程：./DmWatcherServiceDMSERVER01 start\n12. 启动备库守护进程：./DmWatcherServiceDMSERVER02 start\n13. 启动备库守护进程：./DmWatcherServiceDMSERVER03 start\n14. 启动监视器：./DmMonitorServiceDMSERVER02 start\n\n\n\n详见请参考官方文档：https://eco.dameng.com/docs/zh-cn/ops/standard-dw-cluster.html\n","source":"_posts/达梦数据库一主两备安装步骤.md","raw":"---\ntitle: 达梦数据库一主两备安装步骤\ndate: 2022-10-20 16:02:50\ntags: 达梦\n---\n\n# 主备集群规范化部署\n\n本章节主要介绍在生产环境中（Linux 系统）规范化部署主备集群。\n\n<!--more-->\n\n## 服务器硬件需求\n\n按实际业务需求，选择合适的服务器，准备 **3 台服务器**，一台主库服务器，两台备库服务器，一台监视器服务器，服务器参数建议如下：\n\n| 硬件       | 要求                                                         |\n| :--------- | :----------------------------------------------------------- |\n| 物理内存   | >=16 GB                                                      |\n| 交换区     | Swap 空间>=物理内存                                          |\n| /tmp大小   | > 1000 MB                                                    |\n| 网络       | 物理机器需要 4 个网卡，2 个 public 网卡做 band，2 个 private 网卡做 band |\n| 磁盘       | 根据实际应用系统需要挂载合适大小磁盘                         |\n| 时间服务器 | 按机房要求配置连接时间服务器                                 |\n\n> 警告\n>\n> 守护进程配置自动切换时，必须在监视器服务器上配置确认监视器，并且保证网络高可用。\n\n## 操作系统要求\n\n### 操作系统版本安装\n\nDM 数据库安装在 Linux 操作系统所需条件：glibc 2.3 以上，内核 2.6，预先安装 UnixODBC，系统性能监控等组件。\n\n### 目录与存储规划\n\n| 用途               | 目录路径           | 备注                           |\n| :----------------- | :----------------- | :----------------------------- |\n| 数据库软件安装目录 | /home/dmdba/dmdbms | 可用空间>50 GB                 |\n| 实例安装目录       | /dmdata            | 单独挂载性能最好的磁盘建议 SSD |\n| 归档日志存放目录   | /dmarch            | 单独挂载磁盘                   |\n| 备份文件存放目录   | /dmbak             | 单独挂载磁盘                   |\n\n### 用户与组\n\nDM 数据库不应该使用 root 用户安装和维护。需要在安装之前为 DM 数据库创建一个专用的系统用户 (dmdba) 和用户组 (dinstall)。\n\n执行以下命令，新建用户组 dinstall：\n\n```\ngroupadd dinstall\n```\n\n执行以下命令，新建用户 dmdba：\n\n```\nuseradd  -g dinstall -m -d /home/dmdba -s /bin/bash  dmdba\n```\n\n执行以下命令，修改 dmdba 用户密码：\n\n```\npasswd dmdba\n```\n\n输入密码并确认。\n\n### 用户资源限制\n\n执行以下命令，修改 dmdba 用户资源限制：\n\n```\nvim /etc/security/limits.conf\n```\n\n文件末尾添加如下内容：\n\n```\ndmdba soft core unlimited\ndmdba hard core unlimited\ndmdba soft nofile 65536\ndmdba hard nofile 65536\ndmdba soft nproc  65536\ndmdba hard nproc  65536\ndmdba soft stack  65536\ndmdba hard stack  65536\n```\n\n### 用户环境变量\n\n执行以下命令，修改 dmdba 用户环境变量：\n\n```\nvi /home/dmdba/.bash_profile\n```\n\n文件末尾添加如下内容：\n\n```\nexport DM_HOME=/mnt/dmdba/dmdata\nexport PATH=$PATH:$DM_HOME/bin\nexport LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$DM_HOME/bin\n```\n\n### 防火墙设置\n\n关闭防火墙：systemctl stop firewalld\n\n禁止开机自启：systemctl disable firewalld\n\n#### 端口规划\n\n搭建 2 节点主备集群，端口规划如下：（实际中可以按需要修改端口号）\n\n| 主机名  |       ip       |       实例名        | 端口  |                  用途                   |\n| :-----: | :------------: | :-----------------: | :---: | :-------------------------------------: |\n| prddb01 | 192.168.118.18 | DmServiceDMSERVER01 | 5236  | 数据库实例 DmServiceDMSERVER01 监听端口 |\n| prddb01 | 192.168.118.18 | DmServiceDMSERVER01 | 61141 |       MAL 系统监听 TCP 连接的端口       |\n| prddb01 | 192.168.118.18 | DmServiceDMSERVER01 | 52141 |  实例本地的守护进程监听 TCP 连接的端口  |\n| prddb01 | 192.168.118.18 | DmServiceDMSERVER01 | 33141 |     实例监听守护进程 TCP 连接的端口     |\n| prddb02 | 192.168.118.19 | DmServiceDMSERVER02 | 5236  | 数据库实例 DmServiceDMSERVER02 监听端口 |\n| prddb02 | 192.168.118.19 | DmServiceDMSERVER02 | 61142 |       MAL 系统监听 TCP 连接的端口       |\n| prddb02 | 192.168.118.19 | DmServiceDMSERVER02 | 52142 |  实例本地的守护进程监听 TCP 连接的端口  |\n| prddb02 | 192.168.118.19 | DmServiceDMSERVER02 | 33142 |     实例监听守护进程 TCP 连接的端口     |\n| prddb03 | 192.168.118.20 | DmServiceDMSERVER03 | 5236  | 数据库实例 DmServiceDMSERVER03 监听端口 |\n| prddb03 | 192.168.118.20 | DmServiceDMSERVER03 | 61143 |       MAL 系统监听 TCP 连接的端口       |\n| prddb03 | 192.168.118.20 | DmServiceDMSERVER03 | 52143 |  实例本地的守护进程监听 TCP 连接的端口  |\n| prddb03 | 192.168.118.20 | DmServiceDMSERVER03 | 33143 |     实例监听守护进程 TCP 连接的端口     |\n| prddb02 | 192.168.118.19 |       监视器        |       |                监视节点                 |\n\n**防火墙集群之间需开放以上所有端口，**集群对客户端只需要开通数据库实例监听端口。\n\n## 安装数据库(三台都装)\n\n### 用户与组\n\nDM 数据库不应该使用 root 用户安装和维护。需要在安装之前为 DM 数据库创建一个专用的系统用户 (dmdba) 和用户组 (dinstall)。\n\n执行以下命令，新建用户组 dinstall：\n\n```\ngroupadd dinstall\n```\n\n执行以下命令，新建用户 dmdba：\n\n```\nuseradd  -g dinstall -m -d /home/dmdba -s /bin/bash  dmdba\n```\n\n执行以下命令，修改 dmdba 用户密码：\n\n```\npasswd dmdba\n```\n\n输入密码并确认。\n\n### 用户资源限制\n\n执行以下命令，修改 dmdba 用户资源限制：\n\n```\nvim /etc/security/limits.conf\n```\n\n文件末尾添加如下内容：\n\n```\ndmdba soft core unlimited\ndmdba hard core unlimited\ndmdba soft nofile 65536\ndmdba hard nofile 65536\ndmdba soft nproc  65536\ndmdba hard nproc  65536\ndmdba soft stack  65536\ndmdba hard stack  65536\n```\n\n### 用户环境变量\n\n执行以下命令，修改 dmdba 用户环境变量：\n\n```\nvi /home/dmdba/.bash_profile\n```\n\n文件末尾添加如下内容：\n\n```\nexport DM_HOME=/mnt/dmdba/dmdata\nexport PATH=$PATH:$DM_HOME/bin\nexport LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$DM_HOME/bin\n```\n\n### 软件申请\n\n可访问达梦云适配中心[下载试用](https://eco.dameng.com/download/?_blank)，下载 DM8 数据库试用版，如需其他版本，请联系达梦销售人员。\n\n查询操作系统（内核）版本，CPU 架构命令：`uname -a`。\n\n如上图所示，需申请 rh7，x86 版本数据库软件。\n\n以 iso 文件安装包为例，安装包命名规则如下：`dm8_20200930_x86_rh6_64_ent_8.1.1.134.iso`\n\n```\ndm8：数据库大版本为 dm8\n20200930：数据库版本发布日期\nx86：安装包匹配的 CPU 架构\nrh6：安装包匹配的系统版本 (redhat 6)\nent：数据库为企业版\n8.1.1.134：数据库详细版本号\n```\n\n### 安装数据库软件\n\n将安装包上传到服务器后使用 root 用户挂载 iso 安装包文件到 `/mnt` 目录下：\n\n```\nmount -oloop dm8_20211025_HWarm_centos7_64_sec_8.1.2.84.iso /data/mnt\n```\n\n执行以下命令，切换到 dmdba 用户：\n\n```\nsu - dmdba\n```\n\n执行以下命令，切换到 /mnt 目录下：\n\n```\ncd /data/mnt\n```\n\n执行以下命令，查看文件：\n\n```\nll\n```\n\n执行 `DMInstall.bin` 文件开始安装，选择【-i】参数以命令行方式安装：\n\n1. 选择安装程序的语言 c/C 为中文，e/E 为英文。\n2. 提示是否安装 key 文件，输入 N 跳过。\n3. 选择时区，21 即东 8 区。\n4. 选择安装类型，默认典型安装（包含所有内容）。\n\n```\n./DMInstall.bin -i\nPlease select the installer's language (E/e:English C/c:Chinese) [E/e]:c\n解压安装程序..........\n欢迎使用达梦数据库安装程序\n是否输入Key文件路径? (Y/y:是 N/n:否) [Y/y]:n\n是否设置时区? (Y/y:是 N/n:否) [Y/y]:\n设置时区:\n\n[ 1]: GTM-12=日界线西\n[ 2]: GTM-11=萨摩亚群岛\n[ 3]: GTM-10=夏威夷\n[ 4]: GTM-09=阿拉斯加\n[ 5]: GTM-08=太平洋时间（美国和加拿大）\n[ 6]: GTM-07=亚利桑那\n[ 7]: GTM-06=中部时间（美国和加拿大）\n[ 8]: GTM-05=东部部时间（美国和加拿大）\n[ 9]: GTM-04=大西洋时间（美国和加拿大）\n[10]: GTM-03=巴西利亚\n[11]: GTM-02=中大西洋\n[12]: GTM-01=亚速尔群岛\n[13]: GTM=格林威治标准时间\n[14]: GTM+01=萨拉热窝\n[15]: GTM+02=开罗\n[16]: GTM+03=莫斯科\n[17]: GTM+04=阿布扎比\n[18]: GTM+05=伊斯兰堡\n[19]: GTM+06=达卡\n[20]: GTM+07=曼谷，河内\n[21]: GTM+08=中国标准时间\n[22]: GTM+09=汉城\n[23]: GTM+10=关岛\n[24]: GTM+11=所罗门群岛\n[25]: GTM+12=斐济\n[26]: GTM+13=努库阿勒法\n[27]: GTM+14=基里巴斯\n\n请选择设置时区 [21]:\n安装类型:\n1 典型安装\n2 服务器\n3 客户端\n4 自定义\n请选择安装类型的数字序号 [1 典型安装]:4 #这里可直接典型安装\n1 服务器组件\n2 客户端组件\n  2.1 DM管理工具\n  2.2 DM性能监视工具\n  2.3 DM数据迁移工具\n  2.4 DM控制台工具\n  2.5 DM审计分析工具\n  2.6 SQL交互式查询工具\n3 驱动\n4 用户手册\n5 数据库服务\n  5.1 实时审计服务\n  5.2 作业服务\n  5.3 实例监控服务\n  5.4 辅助插件服务\n请选择安装组件的序号 (使用空格间隔) [1 2 3 4 5]:1 2 3 4 5\n所需空间: 1223M\n请选择安装目录 [/mnt/dmdba/dmdbms]:/mnt/dmdba/dmdata\n可用空间: 495G\n是否确认安装路径(/mnt/dmdba/dmdata)? (Y/y:是 N/n:否)  [Y/y]:\n安装前小结\n安装位置: /mnt/dmdba/dmdata\n所需空间: 1223M\n可用空间: 495G\n版本信息: \n有效日期: \n安装类型: 自定义\n是否确认安装? (Y/y:是 N/n:否):y\n2022-05-09 10:23:18 \n[INFO] 安装达梦数据库...\n2022-05-09 10:23:18 \n[INFO] 安装 基础 模块...\n2022-05-09 10:23:19 \n[INFO] 安装 服务器 模块...\n2022-05-09 10:23:19 \n[INFO] 安装 客户端 模块...\n2022-05-09 10:23:20 \n[INFO] 安装 驱动 模块...\n2022-05-09 10:23:20 \n[INFO] 安装 手册 模块...\n2022-05-09 10:23:20 \n[INFO] 安装 服务 模块...\n2022-05-09 10:23:21 \n[INFO] 移动日志文件。\n2022-05-09 10:23:21 \n[INFO] 安装达梦数据库完成。\n```\n\n**安装完成后，按照系统提示使用 root 用户执行脚本。**\n\n```\n/mnt/dmdba/dmdata/script/root/root_installer.sh\n```\n\n提示 `DmAPService 服务启动成功`，则安装完成。\n\n### 使用 dminit 工具初始化实例\n\n```\n[root@prddb01 bin]# ./dminit help\ninitdb V8\ndb version: 0x7000c\n格式: ./dminit     KEYWORD=value\n\n例程: ./dminit     PATH=/public/dmdb/dmData PAGE_SIZE=16\n\n关键字                     说明（默认值）\n--------------------------------------------------------------------------------\nINI_FILE                   初始化文件dm.ini存放的路径\nPATH                       初始数据库存放的路径\nCTL_PATH                   控制文件路径\nLOG_PATH                   日志文件路径\nEXTENT_SIZE                数据文件使用的簇大小(16)，可选值：16, 32, 64，单位：页\nPAGE_SIZE                  数据页大小(8)，可选值：4, 8, 16, 32，单位：K\nLOG_SIZE                   日志文件大小(256)，单位为：M，范围为：256M ~ 2G\nCASE_SENSITIVE             大小敏感(Y)，可选值：Y/N，1/0\nCHARSET/UNICODE_FLAG       字符集(0)，可选值：0[GB18030]，1[UTF-8]，2[EUC-KR]\nSEC_PRIV_MODE              权限管理模式(0)，可选值：0[TRADITION]，1[BMJ]，2[EVAL]\nLENGTH_IN_CHAR             VARCHAR类型长度是否以字符为单位(N)，可选值：Y/N，1/0\nSYSDBA_PWD                 设置SYSDBA密码(SYSDBA)\nSYSAUDITOR_PWD             设置SYSAUDITOR密码(SYSAUDITOR)\nDB_NAME                    数据库名(DAMENG)\nINSTANCE_NAME              实例名(DMSERVER)\nPORT_NUM                   监听端口号(5236)\nBUFFER                     系统缓存大小(100)，单位M\nTIME_ZONE                  设置时区(+08:00)\nPAGE_CHECK                 页检查模式(0)，可选值：0/1/2\nPAGE_HASH_NAME             设置页检查HASH算法\nEXTERNAL_CIPHER_NAME       设置默认加密算法\nEXTERNAL_HASH_NAME         设置默认HASH算法\nEXTERNAL_CRYPTO_NAME       设置根密钥加密引擎\nRLOG_ENC_FLAG              设置日志文件是否加密(N)，可选值：Y/N，1/0\nUSBKEY_PIN                 设置USBKEY PIN\nPAGE_ENC_SLICE_SIZE        设置页加密分片大小，可选值：0、512、4096，单位：Byte\nENCRYPT_NAME               设置全库加密算法\nBLANK_PAD_MODE             设置空格填充模式(0)，可选值：0/1\nSYSTEM_MIRROR_PATH         SYSTEM数据文件镜像路径\nMAIN_MIRROR_PATH           MAIN数据文件镜像\nROLL_MIRROR_PATH           回滚文件镜像路径\nMAL_FLAG                   初始化时设置dm.ini中的MAL_INI(0)\nARCH_FLAG                  初始化时设置dm.ini中的ARCH_INI(0)\nMPP_FLAG                   Mpp系统内的库初始化时设置dm.ini中的mpp_ini(0)\nCONTROL                    初始化配置文件（配置文件格式见系统管理员手册）\nAUTO_OVERWRITE             是否覆盖所有同名文件(0) 0:不覆盖 1:部分覆盖 2:完全覆盖\nUSE_NEW_HASH               是否使用改进的字符类型HASH算法(1)\nELOG_PATH                  指定初始化过程中生成的日志文件所在路径\nAP_PORT_NUM                ECS模式下AP协同工作的监听端口\nDFS_FLAG                   初始化时设置dm.ini中的DFS_INI(0)\nDFS_PATH                   启用dfs时指定数据文件的缺省路径\nDFS_HOST                   指定连接分布式系统DFS的服务地址(localhost)\nDFS_PORT                   指定连接分布式系统DFS的服务端口号(3332)\nDFS_COPY_NUM               指定分布式系统的副本数(3)\nDFS_DB_NAME                指定分布式系统的中数据库名(默认与DB_NAME一致)\nSHARE_FLAG                 指定分布式系统中该数据库的共享属性(0)\nREGION_MODE                指定分布式系统中该数据库的系统表空间数据文件的区块策略(0) 0:微区策略 1:宏区策略\nHUGE_WITH_DELTA            是否仅支持创建事务型HUGE表(1) 1:是 0:否\nRLOG_GEN_FOR_HUGE          是否生成HUGE表REDO日志(0) 1:是 0:否\nPSEG_MGR_FLAG              是否仅使用管理段记录事务信息(0) 1:是 0:否\nCHAR_FIX_STORAGE           CHAR是否按定长存储(N)，可选值：Y/N，1/0\nSQL_LOG_FORBID             是否禁止打开SQL日志(N)，可选值：Y/N，1/0\nSYSSSO_PWD                 设置SYSSSO密码(SYSSSO)\nSYSDBO_PWD                 设置SYSDBO密码(SYSDBO)\nPRIV_FLAG                  设置权限标记(0)，可选值：0[三权分立]，1[四权分立]\nHELP                       打印帮助信息\n\n```\n\n执行以下命令，切换到 /dm8/bin 目录。\n\n```\ncd /mnt/dmdba/dmdata/bin\n./dminit PATH=/mnt/dmdba/dmdata/ PAGE_SIZE=32 EXTENT_SIZE=32 CASE_SENSITIVE=0 LENGTH_IN_CHAR=1 CHARSET=1\n```\n\n> 注意\n>\n> 初始化参数中除了 path 参数必须指定，其它参数都有默认值，如果需求与默认值不同，初始化的时候请指定需要的值。因为部分参数初始化后是无法修改的例如：page_size（页大小），charset（字符集），case_sensitive（大小写敏感）等。更多参数`./dminit help` 查看，是否无法修改的参数可以查询 v$dm_ini 视图，para_type=’READ ONLY’ 表示无法修改。\n\n### **启动数据库**\n\n```\n[dmdba@prddb01 bin]$ ./dmserver /mnt/dmdba/dmdata/DAMENG/dm.ini\nfile dm.key not found, use default license!\n\tversion info: develop\n\tDM Database Server x64 V8 1-2-84-21.10.21-149328-10032-ENT  startup...\n\tNormal of FAST\n\tNormal of DEFAULT\n\tNormal of RECYCLE\n\tNormal of KEEP\n\tNormal of ROLL\n\tDatabase mode = 0, oguid = 0\n\tLicense will expire on 2022-10-21\n\tfile lsn: 28025\n\tndct db load finished\n\tndct second level fill fast pool finished\n\tndct third level fill fast pool finished\n\tndct fill fast pool finished\n\tiid page's trxid[5010]\n\tNEXT TRX ID = 5011\n\tpseg_collect_mgr_items, total collect 0 active_trxs, 0 cmt_trxs, 0 pre_cmt_trxs, 0 active_pages, 0 cmt_pages, 0 pre_cmt_pages, 0 mgr pages, 0 mgr recs!\n\tiid page's trxid[6012]\n\tNEXT TRX ID = 7014.\n\ttotal 0 active crash trx, pseg_crash_trx_rollback sys_only(0) begin ...\n\tpseg_crash_trx_rollback end, total 0 active crash trx, include 0 empty_trxs, 0 empty_pages which only need to delete mgr recs.\n\tpseg_crash_trx_rollback end\n\tpseg recv finished\n\tnsvr_startup end.\n\taud sys init success.\n\taud rt sys init success.\n\tsystables desc init success.\n\tndct_db_load_info success.\n\tnsvr_process_before_open begin.\n\tnsvr_process_before_open success.\n\ttotal 0 active crash trx, pseg_crash_trx_rollback sys_only(0) begin ...\n\tpseg_crash_trx_rollback end, total 0 active crash trx, include 0 empty_trxs, 0 empty_pages which only need to delete mgr recs.\n\tpseg_crash_trx_rollback end\n\tSYSTEM IS READY.\n\texit\n```\n\n### 主节点上脱机备份\n\n如果备份过程中出现错误，通过ps -ef | grep dmap查看dmap服务是否在运行中\n如果不在运行中\n\n```\n[dmdba@prddb01 ~]$ cd /mnt/dmdba/dmdata/bin\n\n[dmdba@prddb01 bin]$ ./DmAPService start\n```\n\n### 主节点备份\n\n主节点：192.168.118.18\n\n```\ncd /mnt/dmdba/dmdata/bin   #dmdba用户\n[dmdba@prddb01 bin]$ ./dmrman\ndmrman V8\nRMAN> backup database '/mnt/dmdba/dmdata/DAMENG/dm.ini' full to backup_file1 backupset '/mnt/dmdba/dmdata/DAMENG/backup01'        \nbackup database '/mnt/dmdba/dmdata/DAMENG/dm.ini' full to backup_file1 backupset '/mnt/dmdba/dmdata/DAMENG/backup01'\nfile dm.key not found, use default license!\nDatabase mode = 0, oguid = 0\nNormal of FAST\nNormal of DEFAULT\nNormal of RECYCLE\nNormal of KEEP\nNormal of ROLL\nEP[0]'s cur_lsn[30600], file_lsn[30600]\nProcessing backupset /mnt/dmdba/dmdata/DAMENG/backup01\n[Percent:100.00%][Speed:0.00M/s][Cost:00:00:00][Remaining:00:00:00]                                 \nbackup successfully!\ntime used: 00:00:01.052\nRMAN> \n```\n\n#### 打开另一窗口(dmdba用户)：\n\n```\nscp -r /mnt/dmdba/dmdata/DAMENG/backup01 dmdba@192.168.118.19:/mnt/dmdba/dmdata/DAMENG/\nscp -r /mnt/dmdba/dmdata/DAMENG/backup01 dmdba@192.168.118.20:/mnt/dmdba/dmdata/DAMENG/\n```\n\n### 从节点还原\n\n#### 从节点：192.168.118.19\n\n**执行 recover。**\n\n```\ncd /mnt/dmdba/dmdata/bin  #dmdba用户                    \n  [dmdba@db-0001 bin]$ ./dmrman\n  dmrman V8\n  RMAN> restore database '/mnt/dmdba/dmdata/DAMENG/dm.ini' from backupset '/mnt/dmdba/dmdata/DAMENG/backup01'\n  restore database '/mnt/dmdba/dmdata/DAMENG/dm.ini' from backupset '/mnt/dmdba/dmdata/DAMENG/backup01'\n  file dm.key not found, use default license!\n  Normal of FAST\n  Normal of DEFAULT\n  Normal of RECYCLE\n  Normal of KEEP\n  Normal of ROLL\n  [Percent:100.00%][Speed:0.00M/s][Cost:00:00:02][Remaining:00:00:00]                                 \n  restore successfully.\n  time used: 00:00:02.396\n  RMAN> recover database '/mnt/dmdba/dmdata/DAMENG/dm.ini' from backupset '/mnt/dmdba/dmdata/DAMENG/backup01'\n  recover database '/mnt/dmdba/dmdata/DAMENG/dm.ini' from backupset '/mnt/dmdba/dmdata/DAMENG/backup01'\n  Database mode = 0, oguid = 0\n  Normal of FAST\n  Normal of DEFAULT\n  Normal of RECYCLE\n  Normal of KEEP\n  Normal of ROLL\n  EP[0]'s cur_lsn[30600], file_lsn[30600]\n  备份集[/mnt/dmdba/dmdata/DAMENG/backup01]备份过程中未产生日志\n  recover successfully!\n  time used: 246.930(ms)\n  RMAN> recover database '/mnt/dmdba/dmdata/DAMENG/dm.ini' update db_magic\n  recover database '/mnt/dmdba/dmdata/DAMENG/dm.ini' update db_magic\n  Database mode = 0, oguid = 0\n  Normal of FAST\n  Normal of DEFAULT\n  Normal of RECYCLE\n  Normal of KEEP\n  Normal of ROLL\n  EP[0]'s cur_lsn[30600], file_lsn[30600]\n  recover successfully!\n  time used: 991.310(ms)\n  RMAN> \n```\n\n  **执行 recover update db_magic。**\n\n```\nrecover database '/mnt/dmdba/dmdata/DAMENG/dm.ini' update db_magic;\n```\n\n#### 从节点：192.168.118.20\n\n**执行 recover。**\n\n```\ncd /mnt/dmdba/dmdata/bin  #dmdba用户                    \n  [dmdba@db-0001 bin]$ ./dmrman\n  dmrman V8\n  RMAN> restore database '/mnt/dmdba/dmdata/DAMENG/dm.ini' from backupset '/mnt/dmdba/dmdata/DAMENG/backup01'\n  restore database '/mnt/dmdba/dmdata/DAMENG/dm.ini' from backupset '/mnt/dmdba/dmdata/DAMENG/backup01'\n  file dm.key not found, use default license!\n  Normal of FAST\n  Normal of DEFAULT\n  Normal of RECYCLE\n  Normal of KEEP\n  Normal of ROLL\n  [Percent:100.00%][Speed:0.00M/s][Cost:00:00:02][Remaining:00:00:00]                                 \n  restore successfully.\n  time used: 00:00:02.396\n  RMAN> recover database '/mnt/dmdba/dmdata/DAMENG/dm.ini' from backupset '/mnt/dmdba/dmdata/DAMENG/backup01'\n  recover database '/mnt/dmdba/dmdata/DAMENG/dm.ini' from backupset '/mnt/dmdba/dmdata/DAMENG/backup01'\n  Database mode = 0, oguid = 0\n  Normal of FAST\n  Normal of DEFAULT\n  Normal of RECYCLE\n  Normal of KEEP\n  Normal of ROLL\n  EP[0]'s cur_lsn[30600], file_lsn[30600]\n  备份集[/mnt/dmdba/dmdata/DAMENG/backup01]备份过程中未产生日志\n  recover successfully!\n  time used: 246.930(ms)\n  RMAN> recover database '/mnt/dmdba/dmdata/DAMENG/dm.ini' update db_magic\n  recover database '/mnt/dmdba/dmdata/DAMENG/dm.ini' update db_magic\n  Database mode = 0, oguid = 0\n  Normal of FAST\n  Normal of DEFAULT\n  Normal of RECYCLE\n  Normal of KEEP\n  Normal of ROLL\n  EP[0]'s cur_lsn[30600], file_lsn[30600]\n  recover successfully!\n  time used: 991.310(ms)\n  RMAN> \n```\n\n  **执行 recover update db_magic。**\n\n```\nrecover database '/mnt/dmdba/dmdata/DAMENG/dm.ini' update db_magic;\n```\n\n\n\n## 主节点配置192.168.118.18\n\n### 修改dm.ini\n\n```\n[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dm.ini\n\n#修改如下参数\n\nINSTANCE_NAME  = DMSERVER01\n\nPORT_NUM  = 5236                      #数据库实例监听端口\n\nDW_INACTIVE_INTERVAL  = 60       #接收守护进程消息超时时间\n\nALTER_MODE_STATUS  = 0             #不允许手工方式修改实例模式/状态/OGUID\n\nENABLE_OFFLINE_TS  = 2         #不允许备库 OFFLINE 表空间\n\nMAL_INI = 1                       #打开 MAL 系统\n\nARCH_INI  = 1                         #打开归档配置\n\nRLOG_SEND_APPLY_MON = 64        #统计最近 64 次的日志发送信息\n```\n\n### 修改dmmal.ini(创建这个文件，内容如下，主备库文件内容要相同)\n\n```\n[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmmal.ini\n\nMAL_CHECK_INTERVAL =  5  #MAL 链路检测时间间隔 \nMAL_CONN_FAIL_INTERVAL =  5  #判定 MAL 链路断开的时间 \n[MAL_INST1]\nMAL_INST_NAME  =  DMSERVER01  #实例名&#xff0c;和 dm.ini 中的 INSTANCE_NAME 一致 \nMAL_HOST  =  192.168.118.18 #MAL 系统监听 TCP 连接的 IP 地址 \nMAL_PORT  = 61141  #MAL 系统监听 TCP 连接的端口 \nMAL_INST_HOST  =  192.168.118.18  #实例的对外服务 IP 地址 \nMAL_INST_PORT  =  5236  #实例的对外服务端口&#xff0c;和 dm.ini 中的 PORT_NUM 一致 \nMAL_DW_PORT =  52141  #实例对应的守护进程监听 TCP 连接的端口 \nMAL_INST_DW_PORT  =  33141  #实例监听守护进程 TCP 连接的端口 \n[MAL_INST2]\nMAL_INST_NAME =  DMSERVER02\nMAL_HOST =  192.168.118.19\nMAL_PORT =  61142\nMAL_INST_HOST =  192.168.118.19\nMAL_INST_PORT =  5236\nMAL_DW_PORT =  52142\nMAL_INST_DW_PORT  =  33142\n[MAL_INST3]\nMAL_INST_NAME =  DMSERVER03\nMAL_HOST =  192.168.118.20\nMAL_PORT  = 61143\nMAL_INST_HOST =  192.168.118.20\nMAL_INST_PORT  = 5236\nMAL_DW_PORT =  52143\nMAL_INST_DW_PORT  =  33143\n\n```\n\n### 配置dmarch.ini文件(创建这个文件，内容如下)\n\n```\n[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmarch.ini\n\n[ARCHIVE_TIMELY1]\n  \nARCH_TYPE = TIMELY       #即时归档类型\n\nARCH_DEST = DMSERVER02  #即时归档目标实例名\n\n[ARCHIVE_TIMELY2]\n\nARCH_TYPE = TIMELY       #即时归档类型\n\nARCH_DEST = DMSERVER03  #即时归档目标实例名\n\n[ARCHIVE_LOCAL1]\n\nARCH_TYPE = LOCAL        #本地归档类型\n\nARCH_DEST = /mnt/dmdba/dmdata/DAMENG/arch #本地归档文件存放路径\n\nARCH_FILE_SIZE = 128     #单位 Mb，本地单个归档文件最大值\n\nARCH_SPACE_LIMIT  = 10240    #单位 Mb，0 表示无限制，范围 1024~4294967294M\n\n```\n\n### 配置dmwatcher.ini文件(创建这个文件，内容如下，主备库文件内容要相同)\n\n```\n[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmwatcher.ini\n\n[GRP1]\n  \nDW_TYPE = GLOBAL          #全局守护类型\n\nDW_MODE = AUTO                  #自动切换模式\n\nDW_ERROR_TIME = 10      #远程守护进程故障认定时间\n\nINST_RECOVER_TIME = 60 #主库守护进程启动恢复的间隔时间\n\nINST_ERROR_TIME = 10     #本地实例故障认定时间\n\nINST_OGUID = 453332      #守护系统唯一 OGUID 值\n\nINST_INI = /mnt/dmdba/dmdata/DAMENG/dm.ini  #dm.ini 配置文件路径\n\nINST_AUTO_RESTART = 1   #打开实例的自动启动功能\n\nINST_STARTUP_CMD = /mnt/dmdba/dmdata/bin/dmserver    #命令行方式启动\n\nRLOG_SEND_THRESHOLD = 0   #指定主库发送日志到备库的时间阈值，默认关闭\n\nRLOG_APPLY_THRESHOLD = 0 #指定备库重演日志的时间阈值，默认关闭\n```\n\n### 开启主节点\n\n```\n[dmdba@prddb01 bin]$  ./dmserver ../DAMENG/dm.ini mount\nfile dm.key not found, use default license!\n\tversion info: develop\n\tDM Database Server x64 V8 1-2-84-21.10.21-149328-10032-ENT  startup...\n\tNormal of FAST\n\tNormal of DEFAULT\n\tNormal of RECYCLE\n\tNormal of KEEP\n\tNormal of ROLL\n\tDatabase mode = 0, oguid = 0\n\tLicense will expire on 2022-10-21\n\tfile lsn: 30600\n\tndct db load finished\n\tndct second level fill fast pool finished\n\tndct third level fill fast pool finished\n\tndct fill fast pool finished\n\tnsvr_startup end.\n\taud sys init success.\n\taud rt sys init success.\n\tsystables desc init success.\n\tndct_db_load_info success.\n\tSYSTEM IS READY.\n\tcheckpoint requested, rlog free space[536862720], used space[0]\n\tcheckpoint generate by ckpt_interval\n\tcheckpoint begin, used_space[0], free_space[536862720]...\n\tcheckpoint end, 0 pages flushed, used_space[0], free_space[536862720].\n\tcheckpoint requested by CKPT_INTERVAL, rlog free space[536862720], used space[0]\n\tcheckpoint generate by ckpt_interval\n\tcheckpoint begin, used_space[0], free_space[536862720]...\n\tcheckpoint end, 0 pages flushed, used_space[0], free_space[536862720].\n```\n\n**一直到显示SYSTEM IS READY启动完成。此时不要关闭这个窗口，重新在主服务器上开启一个窗口。**\n\n```\n[root@prddb01 ~]# su - dmdba\n[dmdba@prddb01 ~]$ cd /mnt/dmdba/dmdata/bin\n[dmdba@prddb01 bin]$ ./disql SYSDBA/SYSDBA@localhost:5236\n服务器[localhost:5236]:处于主库打开状态\n登录使用时间 : 1.616(ms)\n上次登录ip       : ::ffff:192.168.118.18\n上次登录时间   : 2022-05-29 22:55:12\n登录失败次数   : 0\n口令是否过期   : 未过期\ndisql V8\nSQL>sp_set_para_value(1,'ALTER_MODE_STATUS',1);\nDMSQL 过程已成功完成\n已用时间: 4.570(毫秒). 执行号:0.\nSQL> sp_set_oguid(453332);\nDMSQL 过程已成功完成\n已用时间: 5.223(毫秒). 执行号:1.\nSQL> sp_set_para_value(1,'ALTER_MODE_STATUS',0);\nDMSQL 过程已成功完成\n已用时间: 4.021(毫秒). 执行号:2.\nSQL> alter database primary;\n操作已执行\n已用时间: 8.797(毫秒). 执行号:0.\n```\n\n**主节点：192.168.118.18 打开另一窗口(root用户)**\n\n```\n[root@prddb01 ~]# cd /mnt/dmdba/dmdata/script/root\n# 注册数据库实例服务\n./dm_service_installer.sh -t dmserver -dm_ini /mnt/dmdba/dmdata/DAMENG/dm.ini -m mount -p DMSERVER01\n# 注册守护进程服务\n./dm_service_installer.sh -t dmwatcher -watcher_ini /mnt/dmdba/dmdata/DAMENG/dmwatcher.ini -p DMSERVER01\n\n以服务方式启动\n[root@prddb01 ~]# cd /mnt/dmdba/dmdata/bin\n[root@prddb01 bin]# ./DmServiceDMSERVER01 start # 启动数据库实例\n[root@prddb01 bin]# ./DmWatcherServiceDMSERVER01 start #启动守护进程\n```\n\n## 从节点配置192.168.118.19\n\n### 修改dm.ini\n\n```\n[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dm.ini\n\n#修改如下参数\n\nINSTANCE_NAME  = DMSERVER02\n\nPORT_NUM  = 5236                      #数据库实例监听端口\n\nDW_INACTIVE_INTERVAL  = 60       #接收守护进程消息超时时间\n\nALTER_MODE_STATUS  = 0             #不允许手工方式修改实例模式/状态/OGUID\n\nENABLE_OFFLINE_TS  = 2         #不允许备库 OFFLINE 表空间\n\nMAL_INI = 1                       #打开 MAL 系统\n\nARCH_INI  = 1                         #打开归档配置\n\nRLOG_SEND_APPLY_MON = 64        #统计最近 64 次的日志发送信息\n```\n\n### 修改dmmal.ini(创建这个文件，内容如下，主备库文件内容要相同)\n\n```\n[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmmal.ini\n\nMAL_CHECK_INTERVAL =  5  #MAL 链路检测时间间隔 \nMAL_CONN_FAIL_INTERVAL =  5  #判定 MAL 链路断开的时间 \n[MAL_INST1]\nMAL_INST_NAME  =  DMSERVER01  #实例名&#xff0c;和 dm.ini 中的 INSTANCE_NAME 一致 \nMAL_HOST  =  192.168.118.18 #MAL 系统监听 TCP 连接的 IP 地址 \nMAL_PORT  = 61141  #MAL 系统监听 TCP 连接的端口 \nMAL_INST_HOST  =  192.168.118.18  #实例的对外服务 IP 地址 \nMAL_INST_PORT  =  5236  #实例的对外服务端口&#xff0c;和 dm.ini 中的 PORT_NUM 一致 \nMAL_DW_PORT =  52141  #实例对应的守护进程监听 TCP 连接的端口 \nMAL_INST_DW_PORT  =  33141  #实例监听守护进程 TCP 连接的端口 \n[MAL_INST2]\nMAL_INST_NAME =  DMSERVER02\nMAL_HOST =  192.168.118.19\nMAL_PORT =  61142\nMAL_INST_HOST =  192.168.118.19\nMAL_INST_PORT =  5236\nMAL_DW_PORT =  52142\nMAL_INST_DW_PORT  =  33142\n[MAL_INST3]\nMAL_INST_NAME =  DMSERVER03\nMAL_HOST =  192.168.118.20\nMAL_PORT  = 61143\nMAL_INST_HOST =  192.168.118.20\nMAL_INST_PORT  = 5236\nMAL_DW_PORT =  52143\nMAL_INST_DW_PORT  =  33143\n\n```\n\n### 配置dmarch.ini文件(创建这个文件，内容如下)\n\n```\n[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmarch.ini\n\n[ARCHIVE_TIMELY1]\n\nARCH_TYPE = TIMELY       #即时归档类型\n\nARCH_DEST = DMSERVER01  #即时归档目标实例名\n\n[ARCHIVE_TIMELY2]\n\nARCH_TYPE = TIMELY       #即时归档类型\n\nARCH_DEST = DMSERVER03  #即时归档目标实例名\n\n[ARCHIVE_LOCAL1]\n\nARCH_TYPE = LOCAL        #本地归档类型\n\nARCH_DEST = /mnt/dmdba/dmdata/DAMENG/arch #本地归档文件存放路径\n\nARCH_FILE_SIZE = 128     #单位 Mb，本地单个归档文件最大值\n\nARCH_SPACE_LIMIT  = 10240    #单位 Mb，0 表示无限制，范围 1024~4294967294M\n\n```\n\n### 配置dmwatcher.ini文件(创建这个文件，内容如下，主备库文件内容要相同)\n\n```\n[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmwatcher.ini\n\n[GRP1]\n  \nDW_TYPE = GLOBAL          #全局守护类型\n\nDW_MODE = AUTO                  #自动切换模式\n\nDW_ERROR_TIME = 10      #远程守护进程故障认定时间\n\nINST_RECOVER_TIME = 60 #主库守护进程启动恢复的间隔时间\n\nINST_ERROR_TIME = 10     #本地实例故障认定时间\n\nINST_OGUID = 453332      #守护系统唯一 OGUID 值\n\nINST_INI = /mnt/dmdba/dmdata/DAMENG/dm.ini  #dm.ini 配置文件路径\n\nINST_AUTO_RESTART = 1   #打开实例的自动启动功能\n\nINST_STARTUP_CMD = /mnt/dmdba/dmdata/bin/dmserver    #命令行方式启动\n\nRLOG_SEND_THRESHOLD = 0   #指定主库发送日志到备库的时间阈值，默认关闭\n\nRLOG_APPLY_THRESHOLD = 0 #指定备库重演日志的时间阈值，默认关闭\n```\n\n### 配置dmmonitor.ini文件监视服务器(创建这个文件，内容如下)\n\n**监视器只在prddb02配置**\n\n```\n[root@prddb02 ~]# vim /mnt/dmdba/dmdata/DAMENG/dmmonitor.ini\n\nMON_DW_CONFIRM    = 0   #1.确认监视器模式 0.非确认监视模式\nMON_LOG_PATH    = /mnt/dmdba/dmdata/log #监视器日志文件存放路径\nMON_LOG_INTERVAL  = 60 #每隔 60 s 定时记录系统信息到日志文件\nMON_LOG_FILE_SIZE   = 32 #每个日志文件最大 32 MB\nMON_LOG_SPACE_LIMIT  = 0  #不限定日志文件总占用空间\n[GRP1]\n MON_INST_OGUID    = 453332 #组 GRP_RW 的唯一 OGUID 值\n#以下配置为监视器到组 GRP_RW 的守护进程的连接信息，以“IP:PORT”的形式配置\n#IP 对应 dmmal.ini 中的 MAL_HOST，PORT 对应 dmmal.ini 中的 MAL_DW_PORT\nMON_DW_IP = 192.168.118.18:52141\nMON_DW_IP = 192.168.118.19:52142\nMON_DW_IP = 192.168.118.20:52143\n```\n\n\n\n### 开启从节点\n\n```\n[dmdba@prddb02 bin]$  ./dmserver ../DAMENG/dm.ini mount\nfile dm.key not found, use default license!\n\tversion info: develop\n\tDM Database Server x64 V8 1-2-84-21.10.21-149328-10032-ENT  startup...\n\tNormal of FAST\n\tNormal of DEFAULT\n\tNormal of RECYCLE\n\tNormal of KEEP\n\tNormal of ROLL\n\tDatabase mode = 0, oguid = 0\n\tLicense will expire on 2022-10-21\n\tfile lsn: 30600\n\tndct db load finished\n\tndct second level fill fast pool finished\n\tndct third level fill fast pool finished\n\tndct fill fast pool finished\n\tnsvr_startup end.\n\taud sys init success.\n\taud rt sys init success.\n\tsystables desc init success.\n\tndct_db_load_info success.\n\tSYSTEM IS READY.\n\tcheckpoint requested, rlog free space[536862720], used space[0]\n\tcheckpoint generate by ckpt_interval\n\tcheckpoint begin, used_space[0], free_space[536862720]...\n\tcheckpoint end, 0 pages flushed, used_space[0], free_space[536862720].\n\tcheckpoint requested by CKPT_INTERVAL, rlog free space[536862720], used space[0]\n\tcheckpoint generate by ckpt_interval\n\tcheckpoint begin, used_space[0], free_space[536862720]...\n\tcheckpoint end, 0 pages flushed, used_space[0], free_space[536862720].\n```\n\n**一直到显示SYSTEM IS READY启动完成。此时不要关闭这个窗口，重新在主服务器上开启一个窗口。**\n\n```\n[root@prddb02 ~]# su - dmdba\n[dmdba@prddb02 ~]$ cd /mnt/dmdba/dmdata/bin\n[dmdba@prddb02 bin]$ ./disql SYSDBA/SYSDBA@localhost:5236\n服务器[localhost:5236]:处于主库打开状态\n登录使用时间 : 1.616(ms)\n上次登录ip       : ::ffff:192.168.118.18\n上次登录时间   : 2022-05-29 22:55:12\n登录失败次数   : 0\n口令是否过期   : 未过期\ndisql V8\nSQL>sp_set_para_value(1,'ALTER_MODE_STATUS',1);\nDMSQL 过程已成功完成\n已用时间: 4.570(毫秒). 执行号:0.\nSQL> sp_set_oguid(453332);\nDMSQL 过程已成功完成\n已用时间: 5.223(毫秒). 执行号:1.\nSQL> sp_set_para_value(1,'ALTER_MODE_STATUS',0);\nDMSQL 过程已成功完成\n已用时间: 4.021(毫秒). 执行号:2.\nSQL> alter database standby;\n操作已执行\n已用时间: 8.797(毫秒). 执行号:0.\n```\n\n\n\n\n\n## 从节点配置192.168.118.20\n\n### 修改dm.ini\n\n```\n[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dm.ini\n\n#修改如下参数\n\nINSTANCE_NAME  = DMSERVER03\n\nPORT_NUM  = 5236                      #数据库实例监听端口\n\nDW_INACTIVE_INTERVAL  = 60       #接收守护进程消息超时时间\n\nALTER_MODE_STATUS  = 0             #不允许手工方式修改实例模式/状态/OGUID\n\nENABLE_OFFLINE_TS  = 2         #不允许备库 OFFLINE 表空间\n\nMAL_INI = 1                       #打开 MAL 系统\n\nARCH_INI  = 1                         #打开归档配置\n\nRLOG_SEND_APPLY_MON = 64        #统计最近 64 次的日志发送信息\n```\n\n### 修改dmmal.ini(创建这个文件，内容如下，主备库文件内容要相同)\n\n```\n[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmmal.ini\n\nMAL_CHECK_INTERVAL =  5  #MAL 链路检测时间间隔 \nMAL_CONN_FAIL_INTERVAL =  5  #判定 MAL 链路断开的时间 \n[MAL_INST1]\nMAL_INST_NAME  =  DMSERVER01  #实例名&#xff0c;和 dm.ini 中的 INSTANCE_NAME 一致 \nMAL_HOST  =  192.168.118.18 #MAL 系统监听 TCP 连接的 IP 地址 \nMAL_PORT  = 61141  #MAL 系统监听 TCP 连接的端口 \nMAL_INST_HOST  =  192.168.118.18  #实例的对外服务 IP 地址 \nMAL_INST_PORT  =  5236  #实例的对外服务端口&#xff0c;和 dm.ini 中的 PORT_NUM 一致 \nMAL_DW_PORT =  52141  #实例对应的守护进程监听 TCP 连接的端口 \nMAL_INST_DW_PORT  =  33141  #实例监听守护进程 TCP 连接的端口 \n[MAL_INST2]\nMAL_INST_NAME =  DMSERVER02\nMAL_HOST =  192.168.118.19\nMAL_PORT =  61142\nMAL_INST_HOST =  192.168.118.19\nMAL_INST_PORT =  5236\nMAL_DW_PORT =  52142\nMAL_INST_DW_PORT  =  33142\n[MAL_INST3]\nMAL_INST_NAME =  DMSERVER03\nMAL_HOST =  192.168.118.20\nMAL_PORT  = 61143\nMAL_INST_HOST =  192.168.118.20\nMAL_INST_PORT  = 5236\nMAL_DW_PORT =  52143\nMAL_INST_DW_PORT  =  33143\n\n```\n\n### 配置dmarch.ini文件(创建这个文件，内容如下)\n\n```\n[dmdba@prddb03 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmarch.ini\n\n[ARCHIVE_TIMELY1]\n\nARCH_TYPE = TIMELY       #即时归档类型\n\nARCH_DEST = DMSERVER01  #即时归档目标实例名\n\n[ARCHIVE_TIMELY2]\n\nARCH_TYPE = TIMELY       #即时归档类型\n\nARCH_DEST = DMSERVER02  #即时归档目标实例名\n\n[ARCHIVE_LOCAL1]\n\nARCH_TYPE = LOCAL        #本地归档类型\n\nARCH_DEST = /mnt/dmdba/dmdata/DAMENG/arch #本地归档文件存放路径\n\nARCH_FILE_SIZE = 128     #单位 Mb，本地单个归档文件最大值\n\nARCH_SPACE_LIMIT  = 10240    #单位 Mb，0 表示无限制，范围 1024~4294967294M\n\n```\n\n### 配置dmwatcher.ini文件(创建这个文件，内容如下，主备库文件内容要相同)\n\n```\n[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmwatcher.ini\n\n[GRP1]\n  \nDW_TYPE = GLOBAL          #全局守护类型\n\nDW_MODE = AUTO                  #自动切换模式\n\nDW_ERROR_TIME = 10      #远程守护进程故障认定时间\n\nINST_RECOVER_TIME = 60 #主库守护进程启动恢复的间隔时间\n\nINST_ERROR_TIME = 10     #本地实例故障认定时间\n\nINST_OGUID = 453332      #守护系统唯一 OGUID 值\n\nINST_INI = /mnt/dmdba/dmdata/DAMENG/dm.ini  #dm.ini 配置文件路径\n\nINST_AUTO_RESTART = 1   #打开实例的自动启动功能\n\nINST_STARTUP_CMD = /mnt/dmdba/dmdata/bin/dmserver    #命令行方式启动\n\nRLOG_SEND_THRESHOLD = 0   #指定主库发送日志到备库的时间阈值，默认关闭\n\nRLOG_APPLY_THRESHOLD = 0 #指定备库重演日志的时间阈值，默认关闭\n```\n\n### 开启从节点\n\n```\n[dmdba@prddb03 bin]$  ./dmserver ../DAMENG/dm.ini mount\nfile dm.key not found, use default license!\n\tversion info: develop\n\tDM Database Server x64 V8 1-2-84-21.10.21-149328-10032-ENT  startup...\n\tNormal of FAST\n\tNormal of DEFAULT\n\tNormal of RECYCLE\n\tNormal of KEEP\n\tNormal of ROLL\n\tDatabase mode = 0, oguid = 0\n\tLicense will expire on 2022-10-21\n\tfile lsn: 30600\n\tndct db load finished\n\tndct second level fill fast pool finished\n\tndct third level fill fast pool finished\n\tndct fill fast pool finished\n\tnsvr_startup end.\n\taud sys init success.\n\taud rt sys init success.\n\tsystables desc init success.\n\tndct_db_load_info success.\n\tSYSTEM IS READY.\n\tcheckpoint requested, rlog free space[536862720], used space[0]\n\tcheckpoint generate by ckpt_interval\n\tcheckpoint begin, used_space[0], free_space[536862720]...\n\tcheckpoint end, 0 pages flushed, used_space[0], free_space[536862720].\n\tcheckpoint requested by CKPT_INTERVAL, rlog free space[536862720], used space[0]\n\tcheckpoint generate by ckpt_interval\n\tcheckpoint begin, used_space[0], free_space[536862720]...\n\tcheckpoint end, 0 pages flushed, used_space[0], free_space[536862720].\n```\n\n**一直到显示SYSTEM IS READY启动完成。此时不要关闭这个窗口，重新在主服务器上开启一个窗口。**\n\n```\n[root@prddb03 ~]# su - dmdba\n[dmdba@prddb03 ~]$ cd /mnt/dmdba/dmdata/bin\n[dmdba@prddb03 bin]$ ./disql SYSDBA/SYSDBA@localhost:5236\n服务器[localhost:5236]:处于主库打开状态\n登录使用时间 : 1.616(ms)\n上次登录ip       : ::ffff:192.168.118.18\n上次登录时间   : 2022-05-29 22:55:12\n登录失败次数   : 0\n口令是否过期   : 未过期\ndisql V8\nSQL>sp_set_para_value(1,'ALTER_MODE_STATUS',1);\nDMSQL 过程已成功完成\n已用时间: 4.570(毫秒). 执行号:0.\nSQL> sp_set_oguid(453332);\nDMSQL 过程已成功完成\n已用时间: 5.223(毫秒). 执行号:1.\nSQL> sp_set_para_value(1,'ALTER_MODE_STATUS',0);\nDMSQL 过程已成功完成\n已用时间: 4.021(毫秒). 执行号:2.\nSQL> alter database standby;\n操作已执行\n已用时间: 8.797(毫秒). 执行号:0.\n```\n\n## 注册服务\n\n### 使用root用户在主库（192.168.118.18）上执行以下命令\n\n```\n[root@prddb01 root]# cd /mnt/dmdba/dmdata/script/root\n\n./dm_service_installer.sh -t dmserver -dm_ini /mnt/dmdba/dmdata/DAMENG/dm.ini -m mount -p DMSERVER01  # 注册数据库实例服务\n\n./dm_service_installer.sh -t dmwatcher -watcher_ini /mnt/dmdba/dmdata/DAMENG/dmwatcher.ini -p DMSERVER01  # 注册数据库实例服务\n```\n\n### 使用root用户在从库（192.168.118.19）上执行以下命令\n\n```\n[root@prddb01 root]# cd /mnt/dmdba/dmdata/script/root\n\n./dm_service_installer.sh -t dmserver -dm_ini /mnt/dmdba/dmdata/DAMENG/dm.ini -m mount -p DMSERVER01  # 注册数据库实例服务\n\n./dm_service_installer.sh -t dmwatcher -watcher_ini /mnt/dmdba/dmdata/DAMENG/dmwatcher.ini -p DMSERVER01  # 注册数据库实例服务\n\n./dm_service_installer.sh -t dmmonitor -monitor_ini /mnt/dmdba/dmdata/DAMENG/dmmonitor.ini -p DMSERVER02 # 注册监视器服务（只需在监视器服务器上执行）\n```\n\n### 使用root用户在从库（192.168.118.20）上执行以下命令\n\n```\n[root@prddb01 root]# cd /mnt/dmdba/dmdata/script/root\n\n./dm_service_installer.sh -t dmserver -dm_ini /mnt/dmdba/dmdata/DAMENG/dm.ini -m mount -p DMSERVER01  # 注册数据库实例服务\n\n./dm_service_installer.sh -t dmwatcher -watcher_ini /mnt/dmdba/dmdata/DAMENG/dmwatcher.ini -p DMSERVER01  # 注册数据库实例服务\n```\n\n\n\n## 启动管理集群\n\n### 启动集群的顺序为：\n\n**主库实例—>备库实例—>主库守护进程—>备库守护进程—>监视器服务**\n\n#### 1.启动192.168.178.18主库实例\n\n```\n[root@prddb01 root]# cd /mnt/dmdba/dmdata/bin\n[root@prddb01 bin]# ./DmServiceDMSERVER01 start\n```\n\n#### 2.启动192.168.178.19从库实例\n\n```\n[root@prddb02 root]# cd /mnt/dmdba/dmdata/bin\n[root@prddb02 bin]# ./DmServiceDMSERVER02 start\n```\n\n#### 3.启动192.168.178.20从库实例\n\n```\n[root@prddb03 root]# cd /mnt/dmdba/dmdata/bin\n[root@prddb03 bin]# ./DmServiceDMSERVER03 start\n```\n\n#### 4.启动192.168.178.18主库守护进程\n\n```\n[root@prddb01 root]# cd /mnt/dmdba/dmdata/bin\n[root@prddb01 bin]# ./DmWatcherServiceDMSERVER01 start\n```\n\n#### 5.启动192.168.178.19从库守护进程\n\n```\n[root@prddb02 root]# cd /mnt/dmdba/dmdata/bin\n[root@prddb02 bin]# ./DmWatcherServiceDMSERVER02 start\n```\n\n#### 6.启动192.168.178.20从库守护进程\n\n```\n[root@prddb03 root]# cd /mnt/dmdba/dmdata/bin\n[root@prddb03 bin]# ./DmWatcherServiceDMSERVER03 start\n```\n\n#### 7.启动192.168.178.19监视服务\n\n```\n[root@prddb02 root]# cd /mnt/dmdba/dmdata/bin\n[root@prddb02 bin]# ./DmMonitorServiceDMSERVER02 start\n```\n\n#### \n\n## 验证主备集群同步状态\n\n### 监视器查看读写分离集群状态\n\n集群任意节点，配置普通监视器配置文件 `dmmonitor.ini`，执行以下命令：\n\n```\nvi /mnt/dmdba/dmdata/DAMENG/dmmonitor.ini\n```\n\n添加以下内容：\n\n```\nMON_DW_CONFIRM    = 0   #1.确认监视器模式 0.非确认监视模式\nMON_LOG_PATH    = /mnt/dmdba/dmdata/log #监视器日志文件存放路径\nMON_LOG_INTERVAL  = 60 #每隔 60 s 定时记录系统信息到日志文件\nMON_LOG_FILE_SIZE   = 32 #每个日志文件最大 32 MB\nMON_LOG_SPACE_LIMIT  = 0  #不限定日志文件总占用空间\n[GRP1]\n MON_INST_OGUID    = 453332 #组 GRP_RW 的唯一 OGUID 值\n#以下配置为监视器到组 GRP_RW 的守护进程的连接信息，以“IP:PORT”的形式配置\n#IP 对应 dmmal.ini 中的 MAL_HOST，PORT 对应 dmmal.ini 中的 MAL_DW_PORT\nMON_DW_IP = 192.168.118.18:52141\nMON_DW_IP = 192.168.118.19:52142\nMON_DW_IP = 192.168.118.20:52143\n```\n\n启动监视器，执行以下命令：\n\n```\ncd /mnt/dmdba/dmdata/bin\n./dmmonitor mnt/dmdba/dmdata/DAMENG/dmmonitor.ini\n```\n\n输入 show 命令查看集群状态，执行以下命令：\n\n![dm](/images/dm.png)\n\n其中守护进程状态 WSTATUS 为 OPEN，实例状态 ISTATUS 为 OPEN，归档类型 RTYPE 为 REALTIME，归档状态 RSTAT 为VALID。\n\n## 重启集群\n\n**主备集群重启有顺序要求：**（在/mnt/dmdba/dmdata/bin目录下执行）\n\n1. 关闭监视器：./DmMonitorServiceDMSERVER02 stop\n2. 关闭主库守护进程：./DmWatcherServiceDMSERVER01 stop\n3. 关闭备库守护进程：./DmWatcherServiceDMSERVER02 stop\n4. 关闭备库守护进程：./DmWatcherServiceDMSERVER03 stop\n5. 关闭主库实例：./DmServiceDMSERVER01 stop\n6. 关闭备库实例：./DmServiceDMSERVER02 stop\n7. 关闭备库实例：./DmServiceDMSERVER03 stop\n8. 启动主库实例：./DmServiceDMSERVER01 start\n9. 启动备库实例：./DmServiceDMSERVER02 start\n10. 启动备库实例：./DmServiceDMSERVER03 start\n11. 启动主库守护进程：./DmWatcherServiceDMSERVER01 start\n12. 启动备库守护进程：./DmWatcherServiceDMSERVER02 start\n13. 启动备库守护进程：./DmWatcherServiceDMSERVER03 start\n14. 启动监视器：./DmMonitorServiceDMSERVER02 start\n\n\n\n详见请参考官方文档：https://eco.dameng.com/docs/zh-cn/ops/standard-dw-cluster.html\n","slug":"达梦数据库一主两备安装步骤","published":1,"updated":"2023-01-03T06:17:51.246Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clcfuykys000d3wrs2e6bhzst","content":"<h1 id=\"主备集群规范化部署\"><a href=\"#主备集群规范化部署\" class=\"headerlink\" title=\"主备集群规范化部署\"></a>主备集群规范化部署</h1><p>本章节主要介绍在生产环境中（Linux 系统）规范化部署主备集群。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"服务器硬件需求\"><a href=\"#服务器硬件需求\" class=\"headerlink\" title=\"服务器硬件需求\"></a>服务器硬件需求</h2><p>按实际业务需求，选择合适的服务器，准备 <strong>3 台服务器</strong>，一台主库服务器，两台备库服务器，一台监视器服务器，服务器参数建议如下：</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">硬件</th>\n<th align=\"left\">要求</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\">物理内存</td>\n<td align=\"left\">&gt;=16 GB</td>\n</tr>\n<tr>\n<td align=\"left\">交换区</td>\n<td align=\"left\">Swap 空间&gt;=物理内存</td>\n</tr>\n<tr>\n<td align=\"left\">/tmp大小</td>\n<td align=\"left\">&gt; 1000 MB</td>\n</tr>\n<tr>\n<td align=\"left\">网络</td>\n<td align=\"left\">物理机器需要 4 个网卡，2 个 public 网卡做 band，2 个 private 网卡做 band</td>\n</tr>\n<tr>\n<td align=\"left\">磁盘</td>\n<td align=\"left\">根据实际应用系统需要挂载合适大小磁盘</td>\n</tr>\n<tr>\n<td align=\"left\">时间服务器</td>\n<td align=\"left\">按机房要求配置连接时间服务器</td>\n</tr>\n</tbody></table>\n<blockquote>\n<p>警告</p>\n<p>守护进程配置自动切换时，必须在监视器服务器上配置确认监视器，并且保证网络高可用。</p>\n</blockquote>\n<h2 id=\"操作系统要求\"><a href=\"#操作系统要求\" class=\"headerlink\" title=\"操作系统要求\"></a>操作系统要求</h2><h3 id=\"操作系统版本安装\"><a href=\"#操作系统版本安装\" class=\"headerlink\" title=\"操作系统版本安装\"></a>操作系统版本安装</h3><p>DM 数据库安装在 Linux 操作系统所需条件：glibc 2.3 以上，内核 2.6，预先安装 UnixODBC，系统性能监控等组件。</p>\n<h3 id=\"目录与存储规划\"><a href=\"#目录与存储规划\" class=\"headerlink\" title=\"目录与存储规划\"></a>目录与存储规划</h3><table>\n<thead>\n<tr>\n<th align=\"left\">用途</th>\n<th align=\"left\">目录路径</th>\n<th align=\"left\">备注</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\">数据库软件安装目录</td>\n<td align=\"left\">/home/dmdba/dmdbms</td>\n<td align=\"left\">可用空间&gt;50 GB</td>\n</tr>\n<tr>\n<td align=\"left\">实例安装目录</td>\n<td align=\"left\">/dmdata</td>\n<td align=\"left\">单独挂载性能最好的磁盘建议 SSD</td>\n</tr>\n<tr>\n<td align=\"left\">归档日志存放目录</td>\n<td align=\"left\">/dmarch</td>\n<td align=\"left\">单独挂载磁盘</td>\n</tr>\n<tr>\n<td align=\"left\">备份文件存放目录</td>\n<td align=\"left\">/dmbak</td>\n<td align=\"left\">单独挂载磁盘</td>\n</tr>\n</tbody></table>\n<h3 id=\"用户与组\"><a href=\"#用户与组\" class=\"headerlink\" title=\"用户与组\"></a>用户与组</h3><p>DM 数据库不应该使用 root 用户安装和维护。需要在安装之前为 DM 数据库创建一个专用的系统用户 (dmdba) 和用户组 (dinstall)。</p>\n<p>执行以下命令，新建用户组 dinstall：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">groupadd dinstall</span><br></pre></td></tr></table></figure>\n\n<p>执行以下命令，新建用户 dmdba：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">useradd  -g dinstall -m -d /home/dmdba -s /bin/bash  dmdba</span><br></pre></td></tr></table></figure>\n\n<p>执行以下命令，修改 dmdba 用户密码：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">passwd dmdba</span><br></pre></td></tr></table></figure>\n\n<p>输入密码并确认。</p>\n<h3 id=\"用户资源限制\"><a href=\"#用户资源限制\" class=\"headerlink\" title=\"用户资源限制\"></a>用户资源限制</h3><p>执行以下命令，修改 dmdba 用户资源限制：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /etc/security/limits.conf</span><br></pre></td></tr></table></figure>\n\n<p>文件末尾添加如下内容：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dmdba soft core unlimited</span><br><span class=\"line\">dmdba hard core unlimited</span><br><span class=\"line\">dmdba soft nofile 65536</span><br><span class=\"line\">dmdba hard nofile 65536</span><br><span class=\"line\">dmdba soft nproc  65536</span><br><span class=\"line\">dmdba hard nproc  65536</span><br><span class=\"line\">dmdba soft stack  65536</span><br><span class=\"line\">dmdba hard stack  65536</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"用户环境变量\"><a href=\"#用户环境变量\" class=\"headerlink\" title=\"用户环境变量\"></a>用户环境变量</h3><p>执行以下命令，修改 dmdba 用户环境变量：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vi /home/dmdba/.bash_profile</span><br></pre></td></tr></table></figure>\n\n<p>文件末尾添加如下内容：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export DM_HOME=/mnt/dmdba/dmdata</span><br><span class=\"line\">export PATH=$PATH:$DM_HOME/bin</span><br><span class=\"line\">export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$DM_HOME/bin</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"防火墙设置\"><a href=\"#防火墙设置\" class=\"headerlink\" title=\"防火墙设置\"></a>防火墙设置</h3><p>关闭防火墙：systemctl stop firewalld</p>\n<p>禁止开机自启：systemctl disable firewalld</p>\n<h4 id=\"端口规划\"><a href=\"#端口规划\" class=\"headerlink\" title=\"端口规划\"></a>端口规划</h4><p>搭建 2 节点主备集群，端口规划如下：（实际中可以按需要修改端口号）</p>\n<table>\n<thead>\n<tr>\n<th align=\"center\">主机名</th>\n<th align=\"center\">ip</th>\n<th align=\"center\">实例名</th>\n<th align=\"center\">端口</th>\n<th align=\"center\">用途</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">prddb01</td>\n<td align=\"center\">192.168.118.18</td>\n<td align=\"center\">DmServiceDMSERVER01</td>\n<td align=\"center\">5236</td>\n<td align=\"center\">数据库实例 DmServiceDMSERVER01 监听端口</td>\n</tr>\n<tr>\n<td align=\"center\">prddb01</td>\n<td align=\"center\">192.168.118.18</td>\n<td align=\"center\">DmServiceDMSERVER01</td>\n<td align=\"center\">61141</td>\n<td align=\"center\">MAL 系统监听 TCP 连接的端口</td>\n</tr>\n<tr>\n<td align=\"center\">prddb01</td>\n<td align=\"center\">192.168.118.18</td>\n<td align=\"center\">DmServiceDMSERVER01</td>\n<td align=\"center\">52141</td>\n<td align=\"center\">实例本地的守护进程监听 TCP 连接的端口</td>\n</tr>\n<tr>\n<td align=\"center\">prddb01</td>\n<td align=\"center\">192.168.118.18</td>\n<td align=\"center\">DmServiceDMSERVER01</td>\n<td align=\"center\">33141</td>\n<td align=\"center\">实例监听守护进程 TCP 连接的端口</td>\n</tr>\n<tr>\n<td align=\"center\">prddb02</td>\n<td align=\"center\">192.168.118.19</td>\n<td align=\"center\">DmServiceDMSERVER02</td>\n<td align=\"center\">5236</td>\n<td align=\"center\">数据库实例 DmServiceDMSERVER02 监听端口</td>\n</tr>\n<tr>\n<td align=\"center\">prddb02</td>\n<td align=\"center\">192.168.118.19</td>\n<td align=\"center\">DmServiceDMSERVER02</td>\n<td align=\"center\">61142</td>\n<td align=\"center\">MAL 系统监听 TCP 连接的端口</td>\n</tr>\n<tr>\n<td align=\"center\">prddb02</td>\n<td align=\"center\">192.168.118.19</td>\n<td align=\"center\">DmServiceDMSERVER02</td>\n<td align=\"center\">52142</td>\n<td align=\"center\">实例本地的守护进程监听 TCP 连接的端口</td>\n</tr>\n<tr>\n<td align=\"center\">prddb02</td>\n<td align=\"center\">192.168.118.19</td>\n<td align=\"center\">DmServiceDMSERVER02</td>\n<td align=\"center\">33142</td>\n<td align=\"center\">实例监听守护进程 TCP 连接的端口</td>\n</tr>\n<tr>\n<td align=\"center\">prddb03</td>\n<td align=\"center\">192.168.118.20</td>\n<td align=\"center\">DmServiceDMSERVER03</td>\n<td align=\"center\">5236</td>\n<td align=\"center\">数据库实例 DmServiceDMSERVER03 监听端口</td>\n</tr>\n<tr>\n<td align=\"center\">prddb03</td>\n<td align=\"center\">192.168.118.20</td>\n<td align=\"center\">DmServiceDMSERVER03</td>\n<td align=\"center\">61143</td>\n<td align=\"center\">MAL 系统监听 TCP 连接的端口</td>\n</tr>\n<tr>\n<td align=\"center\">prddb03</td>\n<td align=\"center\">192.168.118.20</td>\n<td align=\"center\">DmServiceDMSERVER03</td>\n<td align=\"center\">52143</td>\n<td align=\"center\">实例本地的守护进程监听 TCP 连接的端口</td>\n</tr>\n<tr>\n<td align=\"center\">prddb03</td>\n<td align=\"center\">192.168.118.20</td>\n<td align=\"center\">DmServiceDMSERVER03</td>\n<td align=\"center\">33143</td>\n<td align=\"center\">实例监听守护进程 TCP 连接的端口</td>\n</tr>\n<tr>\n<td align=\"center\">prddb02</td>\n<td align=\"center\">192.168.118.19</td>\n<td align=\"center\">监视器</td>\n<td align=\"center\"></td>\n<td align=\"center\">监视节点</td>\n</tr>\n</tbody></table>\n<p><strong>防火墙集群之间需开放以上所有端口，</strong>集群对客户端只需要开通数据库实例监听端口。</p>\n<h2 id=\"安装数据库-三台都装\"><a href=\"#安装数据库-三台都装\" class=\"headerlink\" title=\"安装数据库(三台都装)\"></a>安装数据库(三台都装)</h2><h3 id=\"用户与组-1\"><a href=\"#用户与组-1\" class=\"headerlink\" title=\"用户与组\"></a>用户与组</h3><p>DM 数据库不应该使用 root 用户安装和维护。需要在安装之前为 DM 数据库创建一个专用的系统用户 (dmdba) 和用户组 (dinstall)。</p>\n<p>执行以下命令，新建用户组 dinstall：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">groupadd dinstall</span><br></pre></td></tr></table></figure>\n\n<p>执行以下命令，新建用户 dmdba：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">useradd  -g dinstall -m -d /home/dmdba -s /bin/bash  dmdba</span><br></pre></td></tr></table></figure>\n\n<p>执行以下命令，修改 dmdba 用户密码：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">passwd dmdba</span><br></pre></td></tr></table></figure>\n\n<p>输入密码并确认。</p>\n<h3 id=\"用户资源限制-1\"><a href=\"#用户资源限制-1\" class=\"headerlink\" title=\"用户资源限制\"></a>用户资源限制</h3><p>执行以下命令，修改 dmdba 用户资源限制：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /etc/security/limits.conf</span><br></pre></td></tr></table></figure>\n\n<p>文件末尾添加如下内容：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dmdba soft core unlimited</span><br><span class=\"line\">dmdba hard core unlimited</span><br><span class=\"line\">dmdba soft nofile 65536</span><br><span class=\"line\">dmdba hard nofile 65536</span><br><span class=\"line\">dmdba soft nproc  65536</span><br><span class=\"line\">dmdba hard nproc  65536</span><br><span class=\"line\">dmdba soft stack  65536</span><br><span class=\"line\">dmdba hard stack  65536</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"用户环境变量-1\"><a href=\"#用户环境变量-1\" class=\"headerlink\" title=\"用户环境变量\"></a>用户环境变量</h3><p>执行以下命令，修改 dmdba 用户环境变量：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vi /home/dmdba/.bash_profile</span><br></pre></td></tr></table></figure>\n\n<p>文件末尾添加如下内容：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export DM_HOME=/mnt/dmdba/dmdata</span><br><span class=\"line\">export PATH=$PATH:$DM_HOME/bin</span><br><span class=\"line\">export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$DM_HOME/bin</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"软件申请\"><a href=\"#软件申请\" class=\"headerlink\" title=\"软件申请\"></a>软件申请</h3><p>可访问达梦云适配中心<a href=\"https://eco.dameng.com/download/?_blank\">下载试用</a>，下载 DM8 数据库试用版，如需其他版本，请联系达梦销售人员。</p>\n<p>查询操作系统（内核）版本，CPU 架构命令：<code>uname -a</code>。</p>\n<p>如上图所示，需申请 rh7，x86 版本数据库软件。</p>\n<p>以 iso 文件安装包为例，安装包命名规则如下：<code>dm8_20200930_x86_rh6_64_ent_8.1.1.134.iso</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dm8：数据库大版本为 dm8</span><br><span class=\"line\">20200930：数据库版本发布日期</span><br><span class=\"line\">x86：安装包匹配的 CPU 架构</span><br><span class=\"line\">rh6：安装包匹配的系统版本 (redhat 6)</span><br><span class=\"line\">ent：数据库为企业版</span><br><span class=\"line\">8.1.1.134：数据库详细版本号</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"安装数据库软件\"><a href=\"#安装数据库软件\" class=\"headerlink\" title=\"安装数据库软件\"></a>安装数据库软件</h3><p>将安装包上传到服务器后使用 root 用户挂载 iso 安装包文件到 <code>/mnt</code> 目录下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mount -oloop dm8_20211025_HWarm_centos7_64_sec_8.1.2.84.iso /data/mnt</span><br></pre></td></tr></table></figure>\n\n<p>执行以下命令，切换到 dmdba 用户：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">su - dmdba</span><br></pre></td></tr></table></figure>\n\n<p>执行以下命令，切换到 /mnt 目录下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /data/mnt</span><br></pre></td></tr></table></figure>\n\n<p>执行以下命令，查看文件：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ll</span><br></pre></td></tr></table></figure>\n\n<p>执行 <code>DMInstall.bin</code> 文件开始安装，选择【-i】参数以命令行方式安装：</p>\n<ol>\n<li>选择安装程序的语言 c/C 为中文，e/E 为英文。</li>\n<li>提示是否安装 key 文件，输入 N 跳过。</li>\n<li>选择时区，21 即东 8 区。</li>\n<li>选择安装类型，默认典型安装（包含所有内容）。</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./DMInstall.bin -i</span><br><span class=\"line\">Please select the installer&#x27;s language (E/e:English C/c:Chinese) [E/e]:c</span><br><span class=\"line\">解压安装程序..........</span><br><span class=\"line\">欢迎使用达梦数据库安装程序</span><br><span class=\"line\">是否输入Key文件路径? (Y/y:是 N/n:否) [Y/y]:n</span><br><span class=\"line\">是否设置时区? (Y/y:是 N/n:否) [Y/y]:</span><br><span class=\"line\">设置时区:</span><br><span class=\"line\"></span><br><span class=\"line\">[ 1]: GTM-12=日界线西</span><br><span class=\"line\">[ 2]: GTM-11=萨摩亚群岛</span><br><span class=\"line\">[ 3]: GTM-10=夏威夷</span><br><span class=\"line\">[ 4]: GTM-09=阿拉斯加</span><br><span class=\"line\">[ 5]: GTM-08=太平洋时间（美国和加拿大）</span><br><span class=\"line\">[ 6]: GTM-07=亚利桑那</span><br><span class=\"line\">[ 7]: GTM-06=中部时间（美国和加拿大）</span><br><span class=\"line\">[ 8]: GTM-05=东部部时间（美国和加拿大）</span><br><span class=\"line\">[ 9]: GTM-04=大西洋时间（美国和加拿大）</span><br><span class=\"line\">[10]: GTM-03=巴西利亚</span><br><span class=\"line\">[11]: GTM-02=中大西洋</span><br><span class=\"line\">[12]: GTM-01=亚速尔群岛</span><br><span class=\"line\">[13]: GTM=格林威治标准时间</span><br><span class=\"line\">[14]: GTM+01=萨拉热窝</span><br><span class=\"line\">[15]: GTM+02=开罗</span><br><span class=\"line\">[16]: GTM+03=莫斯科</span><br><span class=\"line\">[17]: GTM+04=阿布扎比</span><br><span class=\"line\">[18]: GTM+05=伊斯兰堡</span><br><span class=\"line\">[19]: GTM+06=达卡</span><br><span class=\"line\">[20]: GTM+07=曼谷，河内</span><br><span class=\"line\">[21]: GTM+08=中国标准时间</span><br><span class=\"line\">[22]: GTM+09=汉城</span><br><span class=\"line\">[23]: GTM+10=关岛</span><br><span class=\"line\">[24]: GTM+11=所罗门群岛</span><br><span class=\"line\">[25]: GTM+12=斐济</span><br><span class=\"line\">[26]: GTM+13=努库阿勒法</span><br><span class=\"line\">[27]: GTM+14=基里巴斯</span><br><span class=\"line\"></span><br><span class=\"line\">请选择设置时区 [21]:</span><br><span class=\"line\">安装类型:</span><br><span class=\"line\">1 典型安装</span><br><span class=\"line\">2 服务器</span><br><span class=\"line\">3 客户端</span><br><span class=\"line\">4 自定义</span><br><span class=\"line\">请选择安装类型的数字序号 [1 典型安装]:4 #这里可直接典型安装</span><br><span class=\"line\">1 服务器组件</span><br><span class=\"line\">2 客户端组件</span><br><span class=\"line\">  2.1 DM管理工具</span><br><span class=\"line\">  2.2 DM性能监视工具</span><br><span class=\"line\">  2.3 DM数据迁移工具</span><br><span class=\"line\">  2.4 DM控制台工具</span><br><span class=\"line\">  2.5 DM审计分析工具</span><br><span class=\"line\">  2.6 SQL交互式查询工具</span><br><span class=\"line\">3 驱动</span><br><span class=\"line\">4 用户手册</span><br><span class=\"line\">5 数据库服务</span><br><span class=\"line\">  5.1 实时审计服务</span><br><span class=\"line\">  5.2 作业服务</span><br><span class=\"line\">  5.3 实例监控服务</span><br><span class=\"line\">  5.4 辅助插件服务</span><br><span class=\"line\">请选择安装组件的序号 (使用空格间隔) [1 2 3 4 5]:1 2 3 4 5</span><br><span class=\"line\">所需空间: 1223M</span><br><span class=\"line\">请选择安装目录 [/mnt/dmdba/dmdbms]:/mnt/dmdba/dmdata</span><br><span class=\"line\">可用空间: 495G</span><br><span class=\"line\">是否确认安装路径(/mnt/dmdba/dmdata)? (Y/y:是 N/n:否)  [Y/y]:</span><br><span class=\"line\">安装前小结</span><br><span class=\"line\">安装位置: /mnt/dmdba/dmdata</span><br><span class=\"line\">所需空间: 1223M</span><br><span class=\"line\">可用空间: 495G</span><br><span class=\"line\">版本信息: </span><br><span class=\"line\">有效日期: </span><br><span class=\"line\">安装类型: 自定义</span><br><span class=\"line\">是否确认安装? (Y/y:是 N/n:否):y</span><br><span class=\"line\">2022-05-09 10:23:18 </span><br><span class=\"line\">[INFO] 安装达梦数据库...</span><br><span class=\"line\">2022-05-09 10:23:18 </span><br><span class=\"line\">[INFO] 安装 基础 模块...</span><br><span class=\"line\">2022-05-09 10:23:19 </span><br><span class=\"line\">[INFO] 安装 服务器 模块...</span><br><span class=\"line\">2022-05-09 10:23:19 </span><br><span class=\"line\">[INFO] 安装 客户端 模块...</span><br><span class=\"line\">2022-05-09 10:23:20 </span><br><span class=\"line\">[INFO] 安装 驱动 模块...</span><br><span class=\"line\">2022-05-09 10:23:20 </span><br><span class=\"line\">[INFO] 安装 手册 模块...</span><br><span class=\"line\">2022-05-09 10:23:20 </span><br><span class=\"line\">[INFO] 安装 服务 模块...</span><br><span class=\"line\">2022-05-09 10:23:21 </span><br><span class=\"line\">[INFO] 移动日志文件。</span><br><span class=\"line\">2022-05-09 10:23:21 </span><br><span class=\"line\">[INFO] 安装达梦数据库完成。</span><br></pre></td></tr></table></figure>\n\n<p><strong>安装完成后，按照系统提示使用 root 用户执行脚本。</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/mnt/dmdba/dmdata/script/root/root_installer.sh</span><br></pre></td></tr></table></figure>\n\n<p>提示 <code>DmAPService 服务启动成功</code>，则安装完成。</p>\n<h3 id=\"使用-dminit-工具初始化实例\"><a href=\"#使用-dminit-工具初始化实例\" class=\"headerlink\" title=\"使用 dminit 工具初始化实例\"></a>使用 dminit 工具初始化实例</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@prddb01 bin]# ./dminit help</span><br><span class=\"line\">initdb V8</span><br><span class=\"line\">db version: 0x7000c</span><br><span class=\"line\">格式: ./dminit     KEYWORD=value</span><br><span class=\"line\"></span><br><span class=\"line\">例程: ./dminit     PATH=/public/dmdb/dmData PAGE_SIZE=16</span><br><span class=\"line\"></span><br><span class=\"line\">关键字                     说明（默认值）</span><br><span class=\"line\">--------------------------------------------------------------------------------</span><br><span class=\"line\">INI_FILE                   初始化文件dm.ini存放的路径</span><br><span class=\"line\">PATH                       初始数据库存放的路径</span><br><span class=\"line\">CTL_PATH                   控制文件路径</span><br><span class=\"line\">LOG_PATH                   日志文件路径</span><br><span class=\"line\">EXTENT_SIZE                数据文件使用的簇大小(16)，可选值：16, 32, 64，单位：页</span><br><span class=\"line\">PAGE_SIZE                  数据页大小(8)，可选值：4, 8, 16, 32，单位：K</span><br><span class=\"line\">LOG_SIZE                   日志文件大小(256)，单位为：M，范围为：256M ~ 2G</span><br><span class=\"line\">CASE_SENSITIVE             大小敏感(Y)，可选值：Y/N，1/0</span><br><span class=\"line\">CHARSET/UNICODE_FLAG       字符集(0)，可选值：0[GB18030]，1[UTF-8]，2[EUC-KR]</span><br><span class=\"line\">SEC_PRIV_MODE              权限管理模式(0)，可选值：0[TRADITION]，1[BMJ]，2[EVAL]</span><br><span class=\"line\">LENGTH_IN_CHAR             VARCHAR类型长度是否以字符为单位(N)，可选值：Y/N，1/0</span><br><span class=\"line\">SYSDBA_PWD                 设置SYSDBA密码(SYSDBA)</span><br><span class=\"line\">SYSAUDITOR_PWD             设置SYSAUDITOR密码(SYSAUDITOR)</span><br><span class=\"line\">DB_NAME                    数据库名(DAMENG)</span><br><span class=\"line\">INSTANCE_NAME              实例名(DMSERVER)</span><br><span class=\"line\">PORT_NUM                   监听端口号(5236)</span><br><span class=\"line\">BUFFER                     系统缓存大小(100)，单位M</span><br><span class=\"line\">TIME_ZONE                  设置时区(+08:00)</span><br><span class=\"line\">PAGE_CHECK                 页检查模式(0)，可选值：0/1/2</span><br><span class=\"line\">PAGE_HASH_NAME             设置页检查HASH算法</span><br><span class=\"line\">EXTERNAL_CIPHER_NAME       设置默认加密算法</span><br><span class=\"line\">EXTERNAL_HASH_NAME         设置默认HASH算法</span><br><span class=\"line\">EXTERNAL_CRYPTO_NAME       设置根密钥加密引擎</span><br><span class=\"line\">RLOG_ENC_FLAG              设置日志文件是否加密(N)，可选值：Y/N，1/0</span><br><span class=\"line\">USBKEY_PIN                 设置USBKEY PIN</span><br><span class=\"line\">PAGE_ENC_SLICE_SIZE        设置页加密分片大小，可选值：0、512、4096，单位：Byte</span><br><span class=\"line\">ENCRYPT_NAME               设置全库加密算法</span><br><span class=\"line\">BLANK_PAD_MODE             设置空格填充模式(0)，可选值：0/1</span><br><span class=\"line\">SYSTEM_MIRROR_PATH         SYSTEM数据文件镜像路径</span><br><span class=\"line\">MAIN_MIRROR_PATH           MAIN数据文件镜像</span><br><span class=\"line\">ROLL_MIRROR_PATH           回滚文件镜像路径</span><br><span class=\"line\">MAL_FLAG                   初始化时设置dm.ini中的MAL_INI(0)</span><br><span class=\"line\">ARCH_FLAG                  初始化时设置dm.ini中的ARCH_INI(0)</span><br><span class=\"line\">MPP_FLAG                   Mpp系统内的库初始化时设置dm.ini中的mpp_ini(0)</span><br><span class=\"line\">CONTROL                    初始化配置文件（配置文件格式见系统管理员手册）</span><br><span class=\"line\">AUTO_OVERWRITE             是否覆盖所有同名文件(0) 0:不覆盖 1:部分覆盖 2:完全覆盖</span><br><span class=\"line\">USE_NEW_HASH               是否使用改进的字符类型HASH算法(1)</span><br><span class=\"line\">ELOG_PATH                  指定初始化过程中生成的日志文件所在路径</span><br><span class=\"line\">AP_PORT_NUM                ECS模式下AP协同工作的监听端口</span><br><span class=\"line\">DFS_FLAG                   初始化时设置dm.ini中的DFS_INI(0)</span><br><span class=\"line\">DFS_PATH                   启用dfs时指定数据文件的缺省路径</span><br><span class=\"line\">DFS_HOST                   指定连接分布式系统DFS的服务地址(localhost)</span><br><span class=\"line\">DFS_PORT                   指定连接分布式系统DFS的服务端口号(3332)</span><br><span class=\"line\">DFS_COPY_NUM               指定分布式系统的副本数(3)</span><br><span class=\"line\">DFS_DB_NAME                指定分布式系统的中数据库名(默认与DB_NAME一致)</span><br><span class=\"line\">SHARE_FLAG                 指定分布式系统中该数据库的共享属性(0)</span><br><span class=\"line\">REGION_MODE                指定分布式系统中该数据库的系统表空间数据文件的区块策略(0) 0:微区策略 1:宏区策略</span><br><span class=\"line\">HUGE_WITH_DELTA            是否仅支持创建事务型HUGE表(1) 1:是 0:否</span><br><span class=\"line\">RLOG_GEN_FOR_HUGE          是否生成HUGE表REDO日志(0) 1:是 0:否</span><br><span class=\"line\">PSEG_MGR_FLAG              是否仅使用管理段记录事务信息(0) 1:是 0:否</span><br><span class=\"line\">CHAR_FIX_STORAGE           CHAR是否按定长存储(N)，可选值：Y/N，1/0</span><br><span class=\"line\">SQL_LOG_FORBID             是否禁止打开SQL日志(N)，可选值：Y/N，1/0</span><br><span class=\"line\">SYSSSO_PWD                 设置SYSSSO密码(SYSSSO)</span><br><span class=\"line\">SYSDBO_PWD                 设置SYSDBO密码(SYSDBO)</span><br><span class=\"line\">PRIV_FLAG                  设置权限标记(0)，可选值：0[三权分立]，1[四权分立]</span><br><span class=\"line\">HELP                       打印帮助信息</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>执行以下命令，切换到 /dm8/bin 目录。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /mnt/dmdba/dmdata/bin</span><br><span class=\"line\">./dminit PATH=/mnt/dmdba/dmdata/ PAGE_SIZE=32 EXTENT_SIZE=32 CASE_SENSITIVE=0 LENGTH_IN_CHAR=1 CHARSET=1</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>注意</p>\n<p>初始化参数中除了 path 参数必须指定，其它参数都有默认值，如果需求与默认值不同，初始化的时候请指定需要的值。因为部分参数初始化后是无法修改的例如：page_size（页大小），charset（字符集），case_sensitive（大小写敏感）等。更多参数<code>./dminit help</code> 查看，是否无法修改的参数可以查询 v$dm_ini 视图，para_type=’READ ONLY’ 表示无法修改。</p>\n</blockquote>\n<h3 id=\"启动数据库\"><a href=\"#启动数据库\" class=\"headerlink\" title=\"启动数据库\"></a><strong>启动数据库</strong></h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb01 bin]$ ./dmserver /mnt/dmdba/dmdata/DAMENG/dm.ini</span><br><span class=\"line\">file dm.key not found, use default license!</span><br><span class=\"line\">\tversion info: develop</span><br><span class=\"line\">\tDM Database Server x64 V8 1-2-84-21.10.21-149328-10032-ENT  startup...</span><br><span class=\"line\">\tNormal of FAST</span><br><span class=\"line\">\tNormal of DEFAULT</span><br><span class=\"line\">\tNormal of RECYCLE</span><br><span class=\"line\">\tNormal of KEEP</span><br><span class=\"line\">\tNormal of ROLL</span><br><span class=\"line\">\tDatabase mode = 0, oguid = 0</span><br><span class=\"line\">\tLicense will expire on 2022-10-21</span><br><span class=\"line\">\tfile lsn: 28025</span><br><span class=\"line\">\tndct db load finished</span><br><span class=\"line\">\tndct second level fill fast pool finished</span><br><span class=\"line\">\tndct third level fill fast pool finished</span><br><span class=\"line\">\tndct fill fast pool finished</span><br><span class=\"line\">\tiid page&#x27;s trxid[5010]</span><br><span class=\"line\">\tNEXT TRX ID = 5011</span><br><span class=\"line\">\tpseg_collect_mgr_items, total collect 0 active_trxs, 0 cmt_trxs, 0 pre_cmt_trxs, 0 active_pages, 0 cmt_pages, 0 pre_cmt_pages, 0 mgr pages, 0 mgr recs!</span><br><span class=\"line\">\tiid page&#x27;s trxid[6012]</span><br><span class=\"line\">\tNEXT TRX ID = 7014.</span><br><span class=\"line\">\ttotal 0 active crash trx, pseg_crash_trx_rollback sys_only(0) begin ...</span><br><span class=\"line\">\tpseg_crash_trx_rollback end, total 0 active crash trx, include 0 empty_trxs, 0 empty_pages which only need to delete mgr recs.</span><br><span class=\"line\">\tpseg_crash_trx_rollback end</span><br><span class=\"line\">\tpseg recv finished</span><br><span class=\"line\">\tnsvr_startup end.</span><br><span class=\"line\">\taud sys init success.</span><br><span class=\"line\">\taud rt sys init success.</span><br><span class=\"line\">\tsystables desc init success.</span><br><span class=\"line\">\tndct_db_load_info success.</span><br><span class=\"line\">\tnsvr_process_before_open begin.</span><br><span class=\"line\">\tnsvr_process_before_open success.</span><br><span class=\"line\">\ttotal 0 active crash trx, pseg_crash_trx_rollback sys_only(0) begin ...</span><br><span class=\"line\">\tpseg_crash_trx_rollback end, total 0 active crash trx, include 0 empty_trxs, 0 empty_pages which only need to delete mgr recs.</span><br><span class=\"line\">\tpseg_crash_trx_rollback end</span><br><span class=\"line\">\tSYSTEM IS READY.</span><br><span class=\"line\">\texit</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"主节点上脱机备份\"><a href=\"#主节点上脱机备份\" class=\"headerlink\" title=\"主节点上脱机备份\"></a>主节点上脱机备份</h3><p>如果备份过程中出现错误，通过ps -ef | grep dmap查看dmap服务是否在运行中<br>如果不在运行中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb01 ~]$ cd /mnt/dmdba/dmdata/bin</span><br><span class=\"line\"></span><br><span class=\"line\">[dmdba@prddb01 bin]$ ./DmAPService start</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"主节点备份\"><a href=\"#主节点备份\" class=\"headerlink\" title=\"主节点备份\"></a>主节点备份</h3><p>主节点：192.168.118.18</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /mnt/dmdba/dmdata/bin   #dmdba用户</span><br><span class=\"line\">[dmdba@prddb01 bin]$ ./dmrman</span><br><span class=\"line\">dmrman V8</span><br><span class=\"line\">RMAN&gt; backup database &#x27;/mnt/dmdba/dmdata/DAMENG/dm.ini&#x27; full to backup_file1 backupset &#x27;/mnt/dmdba/dmdata/DAMENG/backup01&#x27;        </span><br><span class=\"line\">backup database &#x27;/mnt/dmdba/dmdata/DAMENG/dm.ini&#x27; full to backup_file1 backupset &#x27;/mnt/dmdba/dmdata/DAMENG/backup01&#x27;</span><br><span class=\"line\">file dm.key not found, use default license!</span><br><span class=\"line\">Database mode = 0, oguid = 0</span><br><span class=\"line\">Normal of FAST</span><br><span class=\"line\">Normal of DEFAULT</span><br><span class=\"line\">Normal of RECYCLE</span><br><span class=\"line\">Normal of KEEP</span><br><span class=\"line\">Normal of ROLL</span><br><span class=\"line\">EP[0]&#x27;s cur_lsn[30600], file_lsn[30600]</span><br><span class=\"line\">Processing backupset /mnt/dmdba/dmdata/DAMENG/backup01</span><br><span class=\"line\">[Percent:100.00%][Speed:0.00M/s][Cost:00:00:00][Remaining:00:00:00]                                 </span><br><span class=\"line\">backup successfully!</span><br><span class=\"line\">time used: 00:00:01.052</span><br><span class=\"line\">RMAN&gt; </span><br></pre></td></tr></table></figure>\n\n<h4 id=\"打开另一窗口-dmdba用户-：\"><a href=\"#打开另一窗口-dmdba用户-：\" class=\"headerlink\" title=\"打开另一窗口(dmdba用户)：\"></a>打开另一窗口(dmdba用户)：</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">scp -r /mnt/dmdba/dmdata/DAMENG/backup01 dmdba@192.168.118.19:/mnt/dmdba/dmdata/DAMENG/</span><br><span class=\"line\">scp -r /mnt/dmdba/dmdata/DAMENG/backup01 dmdba@192.168.118.20:/mnt/dmdba/dmdata/DAMENG/</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"从节点还原\"><a href=\"#从节点还原\" class=\"headerlink\" title=\"从节点还原\"></a>从节点还原</h3><h4 id=\"从节点：192-168-118-19\"><a href=\"#从节点：192-168-118-19\" class=\"headerlink\" title=\"从节点：192.168.118.19\"></a>从节点：192.168.118.19</h4><p><strong>执行 recover。</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /mnt/dmdba/dmdata/bin  #dmdba用户                    </span><br><span class=\"line\">  [dmdba@db-0001 bin]$ ./dmrman</span><br><span class=\"line\">  dmrman V8</span><br><span class=\"line\">  RMAN&gt; restore database &#x27;/mnt/dmdba/dmdata/DAMENG/dm.ini&#x27; from backupset &#x27;/mnt/dmdba/dmdata/DAMENG/backup01&#x27;</span><br><span class=\"line\">  restore database &#x27;/mnt/dmdba/dmdata/DAMENG/dm.ini&#x27; from backupset &#x27;/mnt/dmdba/dmdata/DAMENG/backup01&#x27;</span><br><span class=\"line\">  file dm.key not found, use default license!</span><br><span class=\"line\">  Normal of FAST</span><br><span class=\"line\">  Normal of DEFAULT</span><br><span class=\"line\">  Normal of RECYCLE</span><br><span class=\"line\">  Normal of KEEP</span><br><span class=\"line\">  Normal of ROLL</span><br><span class=\"line\">  [Percent:100.00%][Speed:0.00M/s][Cost:00:00:02][Remaining:00:00:00]                                 </span><br><span class=\"line\">  restore successfully.</span><br><span class=\"line\">  time used: 00:00:02.396</span><br><span class=\"line\">  RMAN&gt; recover database &#x27;/mnt/dmdba/dmdata/DAMENG/dm.ini&#x27; from backupset &#x27;/mnt/dmdba/dmdata/DAMENG/backup01&#x27;</span><br><span class=\"line\">  recover database &#x27;/mnt/dmdba/dmdata/DAMENG/dm.ini&#x27; from backupset &#x27;/mnt/dmdba/dmdata/DAMENG/backup01&#x27;</span><br><span class=\"line\">  Database mode = 0, oguid = 0</span><br><span class=\"line\">  Normal of FAST</span><br><span class=\"line\">  Normal of DEFAULT</span><br><span class=\"line\">  Normal of RECYCLE</span><br><span class=\"line\">  Normal of KEEP</span><br><span class=\"line\">  Normal of ROLL</span><br><span class=\"line\">  EP[0]&#x27;s cur_lsn[30600], file_lsn[30600]</span><br><span class=\"line\">  备份集[/mnt/dmdba/dmdata/DAMENG/backup01]备份过程中未产生日志</span><br><span class=\"line\">  recover successfully!</span><br><span class=\"line\">  time used: 246.930(ms)</span><br><span class=\"line\">  RMAN&gt; recover database &#x27;/mnt/dmdba/dmdata/DAMENG/dm.ini&#x27; update db_magic</span><br><span class=\"line\">  recover database &#x27;/mnt/dmdba/dmdata/DAMENG/dm.ini&#x27; update db_magic</span><br><span class=\"line\">  Database mode = 0, oguid = 0</span><br><span class=\"line\">  Normal of FAST</span><br><span class=\"line\">  Normal of DEFAULT</span><br><span class=\"line\">  Normal of RECYCLE</span><br><span class=\"line\">  Normal of KEEP</span><br><span class=\"line\">  Normal of ROLL</span><br><span class=\"line\">  EP[0]&#x27;s cur_lsn[30600], file_lsn[30600]</span><br><span class=\"line\">  recover successfully!</span><br><span class=\"line\">  time used: 991.310(ms)</span><br><span class=\"line\">  RMAN&gt; </span><br></pre></td></tr></table></figure>\n\n<p>  <strong>执行 recover update db_magic。</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">recover database &#x27;/mnt/dmdba/dmdata/DAMENG/dm.ini&#x27; update db_magic;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"从节点：192-168-118-20\"><a href=\"#从节点：192-168-118-20\" class=\"headerlink\" title=\"从节点：192.168.118.20\"></a>从节点：192.168.118.20</h4><p><strong>执行 recover。</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /mnt/dmdba/dmdata/bin  #dmdba用户                    </span><br><span class=\"line\">  [dmdba@db-0001 bin]$ ./dmrman</span><br><span class=\"line\">  dmrman V8</span><br><span class=\"line\">  RMAN&gt; restore database &#x27;/mnt/dmdba/dmdata/DAMENG/dm.ini&#x27; from backupset &#x27;/mnt/dmdba/dmdata/DAMENG/backup01&#x27;</span><br><span class=\"line\">  restore database &#x27;/mnt/dmdba/dmdata/DAMENG/dm.ini&#x27; from backupset &#x27;/mnt/dmdba/dmdata/DAMENG/backup01&#x27;</span><br><span class=\"line\">  file dm.key not found, use default license!</span><br><span class=\"line\">  Normal of FAST</span><br><span class=\"line\">  Normal of DEFAULT</span><br><span class=\"line\">  Normal of RECYCLE</span><br><span class=\"line\">  Normal of KEEP</span><br><span class=\"line\">  Normal of ROLL</span><br><span class=\"line\">  [Percent:100.00%][Speed:0.00M/s][Cost:00:00:02][Remaining:00:00:00]                                 </span><br><span class=\"line\">  restore successfully.</span><br><span class=\"line\">  time used: 00:00:02.396</span><br><span class=\"line\">  RMAN&gt; recover database &#x27;/mnt/dmdba/dmdata/DAMENG/dm.ini&#x27; from backupset &#x27;/mnt/dmdba/dmdata/DAMENG/backup01&#x27;</span><br><span class=\"line\">  recover database &#x27;/mnt/dmdba/dmdata/DAMENG/dm.ini&#x27; from backupset &#x27;/mnt/dmdba/dmdata/DAMENG/backup01&#x27;</span><br><span class=\"line\">  Database mode = 0, oguid = 0</span><br><span class=\"line\">  Normal of FAST</span><br><span class=\"line\">  Normal of DEFAULT</span><br><span class=\"line\">  Normal of RECYCLE</span><br><span class=\"line\">  Normal of KEEP</span><br><span class=\"line\">  Normal of ROLL</span><br><span class=\"line\">  EP[0]&#x27;s cur_lsn[30600], file_lsn[30600]</span><br><span class=\"line\">  备份集[/mnt/dmdba/dmdata/DAMENG/backup01]备份过程中未产生日志</span><br><span class=\"line\">  recover successfully!</span><br><span class=\"line\">  time used: 246.930(ms)</span><br><span class=\"line\">  RMAN&gt; recover database &#x27;/mnt/dmdba/dmdata/DAMENG/dm.ini&#x27; update db_magic</span><br><span class=\"line\">  recover database &#x27;/mnt/dmdba/dmdata/DAMENG/dm.ini&#x27; update db_magic</span><br><span class=\"line\">  Database mode = 0, oguid = 0</span><br><span class=\"line\">  Normal of FAST</span><br><span class=\"line\">  Normal of DEFAULT</span><br><span class=\"line\">  Normal of RECYCLE</span><br><span class=\"line\">  Normal of KEEP</span><br><span class=\"line\">  Normal of ROLL</span><br><span class=\"line\">  EP[0]&#x27;s cur_lsn[30600], file_lsn[30600]</span><br><span class=\"line\">  recover successfully!</span><br><span class=\"line\">  time used: 991.310(ms)</span><br><span class=\"line\">  RMAN&gt; </span><br></pre></td></tr></table></figure>\n\n<p>  <strong>执行 recover update db_magic。</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">recover database &#x27;/mnt/dmdba/dmdata/DAMENG/dm.ini&#x27; update db_magic;</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"主节点配置192-168-118-18\"><a href=\"#主节点配置192-168-118-18\" class=\"headerlink\" title=\"主节点配置192.168.118.18\"></a>主节点配置192.168.118.18</h2><h3 id=\"修改dm-ini\"><a href=\"#修改dm-ini\" class=\"headerlink\" title=\"修改dm.ini\"></a>修改dm.ini</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dm.ini</span><br><span class=\"line\"></span><br><span class=\"line\">#修改如下参数</span><br><span class=\"line\"></span><br><span class=\"line\">INSTANCE_NAME  = DMSERVER01</span><br><span class=\"line\"></span><br><span class=\"line\">PORT_NUM  = 5236                      #数据库实例监听端口</span><br><span class=\"line\"></span><br><span class=\"line\">DW_INACTIVE_INTERVAL  = 60       #接收守护进程消息超时时间</span><br><span class=\"line\"></span><br><span class=\"line\">ALTER_MODE_STATUS  = 0             #不允许手工方式修改实例模式/状态/OGUID</span><br><span class=\"line\"></span><br><span class=\"line\">ENABLE_OFFLINE_TS  = 2         #不允许备库 OFFLINE 表空间</span><br><span class=\"line\"></span><br><span class=\"line\">MAL_INI = 1                       #打开 MAL 系统</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_INI  = 1                         #打开归档配置</span><br><span class=\"line\"></span><br><span class=\"line\">RLOG_SEND_APPLY_MON = 64        #统计最近 64 次的日志发送信息</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"修改dmmal-ini-创建这个文件，内容如下，主备库文件内容要相同\"><a href=\"#修改dmmal-ini-创建这个文件，内容如下，主备库文件内容要相同\" class=\"headerlink\" title=\"修改dmmal.ini(创建这个文件，内容如下，主备库文件内容要相同)\"></a>修改dmmal.ini(创建这个文件，内容如下，主备库文件内容要相同)</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmmal.ini</span><br><span class=\"line\"></span><br><span class=\"line\">MAL_CHECK_INTERVAL =  5  #MAL 链路检测时间间隔 </span><br><span class=\"line\">MAL_CONN_FAIL_INTERVAL =  5  #判定 MAL 链路断开的时间 </span><br><span class=\"line\">[MAL_INST1]</span><br><span class=\"line\">MAL_INST_NAME  =  DMSERVER01  #实例名&amp;#xff0c;和 dm.ini 中的 INSTANCE_NAME 一致 </span><br><span class=\"line\">MAL_HOST  =  192.168.118.18 #MAL 系统监听 TCP 连接的 IP 地址 </span><br><span class=\"line\">MAL_PORT  = 61141  #MAL 系统监听 TCP 连接的端口 </span><br><span class=\"line\">MAL_INST_HOST  =  192.168.118.18  #实例的对外服务 IP 地址 </span><br><span class=\"line\">MAL_INST_PORT  =  5236  #实例的对外服务端口&amp;#xff0c;和 dm.ini 中的 PORT_NUM 一致 </span><br><span class=\"line\">MAL_DW_PORT =  52141  #实例对应的守护进程监听 TCP 连接的端口 </span><br><span class=\"line\">MAL_INST_DW_PORT  =  33141  #实例监听守护进程 TCP 连接的端口 </span><br><span class=\"line\">[MAL_INST2]</span><br><span class=\"line\">MAL_INST_NAME =  DMSERVER02</span><br><span class=\"line\">MAL_HOST =  192.168.118.19</span><br><span class=\"line\">MAL_PORT =  61142</span><br><span class=\"line\">MAL_INST_HOST =  192.168.118.19</span><br><span class=\"line\">MAL_INST_PORT =  5236</span><br><span class=\"line\">MAL_DW_PORT =  52142</span><br><span class=\"line\">MAL_INST_DW_PORT  =  33142</span><br><span class=\"line\">[MAL_INST3]</span><br><span class=\"line\">MAL_INST_NAME =  DMSERVER03</span><br><span class=\"line\">MAL_HOST =  192.168.118.20</span><br><span class=\"line\">MAL_PORT  = 61143</span><br><span class=\"line\">MAL_INST_HOST =  192.168.118.20</span><br><span class=\"line\">MAL_INST_PORT  = 5236</span><br><span class=\"line\">MAL_DW_PORT =  52143</span><br><span class=\"line\">MAL_INST_DW_PORT  =  33143</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"配置dmarch-ini文件-创建这个文件，内容如下\"><a href=\"#配置dmarch-ini文件-创建这个文件，内容如下\" class=\"headerlink\" title=\"配置dmarch.ini文件(创建这个文件，内容如下)\"></a>配置dmarch.ini文件(创建这个文件，内容如下)</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmarch.ini</span><br><span class=\"line\"></span><br><span class=\"line\">[ARCHIVE_TIMELY1]</span><br><span class=\"line\">  </span><br><span class=\"line\">ARCH_TYPE = TIMELY       #即时归档类型</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_DEST = DMSERVER02  #即时归档目标实例名</span><br><span class=\"line\"></span><br><span class=\"line\">[ARCHIVE_TIMELY2]</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_TYPE = TIMELY       #即时归档类型</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_DEST = DMSERVER03  #即时归档目标实例名</span><br><span class=\"line\"></span><br><span class=\"line\">[ARCHIVE_LOCAL1]</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_TYPE = LOCAL        #本地归档类型</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_DEST = /mnt/dmdba/dmdata/DAMENG/arch #本地归档文件存放路径</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_FILE_SIZE = 128     #单位 Mb，本地单个归档文件最大值</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_SPACE_LIMIT  = 10240    #单位 Mb，0 表示无限制，范围 1024~4294967294M</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"配置dmwatcher-ini文件-创建这个文件，内容如下，主备库文件内容要相同\"><a href=\"#配置dmwatcher-ini文件-创建这个文件，内容如下，主备库文件内容要相同\" class=\"headerlink\" title=\"配置dmwatcher.ini文件(创建这个文件，内容如下，主备库文件内容要相同)\"></a>配置dmwatcher.ini文件(创建这个文件，内容如下，主备库文件内容要相同)</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmwatcher.ini</span><br><span class=\"line\"></span><br><span class=\"line\">[GRP1]</span><br><span class=\"line\">  </span><br><span class=\"line\">DW_TYPE = GLOBAL          #全局守护类型</span><br><span class=\"line\"></span><br><span class=\"line\">DW_MODE = AUTO                  #自动切换模式</span><br><span class=\"line\"></span><br><span class=\"line\">DW_ERROR_TIME = 10      #远程守护进程故障认定时间</span><br><span class=\"line\"></span><br><span class=\"line\">INST_RECOVER_TIME = 60 #主库守护进程启动恢复的间隔时间</span><br><span class=\"line\"></span><br><span class=\"line\">INST_ERROR_TIME = 10     #本地实例故障认定时间</span><br><span class=\"line\"></span><br><span class=\"line\">INST_OGUID = 453332      #守护系统唯一 OGUID 值</span><br><span class=\"line\"></span><br><span class=\"line\">INST_INI = /mnt/dmdba/dmdata/DAMENG/dm.ini  #dm.ini 配置文件路径</span><br><span class=\"line\"></span><br><span class=\"line\">INST_AUTO_RESTART = 1   #打开实例的自动启动功能</span><br><span class=\"line\"></span><br><span class=\"line\">INST_STARTUP_CMD = /mnt/dmdba/dmdata/bin/dmserver    #命令行方式启动</span><br><span class=\"line\"></span><br><span class=\"line\">RLOG_SEND_THRESHOLD = 0   #指定主库发送日志到备库的时间阈值，默认关闭</span><br><span class=\"line\"></span><br><span class=\"line\">RLOG_APPLY_THRESHOLD = 0 #指定备库重演日志的时间阈值，默认关闭</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"开启主节点\"><a href=\"#开启主节点\" class=\"headerlink\" title=\"开启主节点\"></a>开启主节点</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb01 bin]$  ./dmserver ../DAMENG/dm.ini mount</span><br><span class=\"line\">file dm.key not found, use default license!</span><br><span class=\"line\">\tversion info: develop</span><br><span class=\"line\">\tDM Database Server x64 V8 1-2-84-21.10.21-149328-10032-ENT  startup...</span><br><span class=\"line\">\tNormal of FAST</span><br><span class=\"line\">\tNormal of DEFAULT</span><br><span class=\"line\">\tNormal of RECYCLE</span><br><span class=\"line\">\tNormal of KEEP</span><br><span class=\"line\">\tNormal of ROLL</span><br><span class=\"line\">\tDatabase mode = 0, oguid = 0</span><br><span class=\"line\">\tLicense will expire on 2022-10-21</span><br><span class=\"line\">\tfile lsn: 30600</span><br><span class=\"line\">\tndct db load finished</span><br><span class=\"line\">\tndct second level fill fast pool finished</span><br><span class=\"line\">\tndct third level fill fast pool finished</span><br><span class=\"line\">\tndct fill fast pool finished</span><br><span class=\"line\">\tnsvr_startup end.</span><br><span class=\"line\">\taud sys init success.</span><br><span class=\"line\">\taud rt sys init success.</span><br><span class=\"line\">\tsystables desc init success.</span><br><span class=\"line\">\tndct_db_load_info success.</span><br><span class=\"line\">\tSYSTEM IS READY.</span><br><span class=\"line\">\tcheckpoint requested, rlog free space[536862720], used space[0]</span><br><span class=\"line\">\tcheckpoint generate by ckpt_interval</span><br><span class=\"line\">\tcheckpoint begin, used_space[0], free_space[536862720]...</span><br><span class=\"line\">\tcheckpoint end, 0 pages flushed, used_space[0], free_space[536862720].</span><br><span class=\"line\">\tcheckpoint requested by CKPT_INTERVAL, rlog free space[536862720], used space[0]</span><br><span class=\"line\">\tcheckpoint generate by ckpt_interval</span><br><span class=\"line\">\tcheckpoint begin, used_space[0], free_space[536862720]...</span><br><span class=\"line\">\tcheckpoint end, 0 pages flushed, used_space[0], free_space[536862720].</span><br></pre></td></tr></table></figure>\n\n<p><strong>一直到显示SYSTEM IS READY启动完成。此时不要关闭这个窗口，重新在主服务器上开启一个窗口。</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@prddb01 ~]# su - dmdba</span><br><span class=\"line\">[dmdba@prddb01 ~]$ cd /mnt/dmdba/dmdata/bin</span><br><span class=\"line\">[dmdba@prddb01 bin]$ ./disql SYSDBA/SYSDBA@localhost:5236</span><br><span class=\"line\">服务器[localhost:5236]:处于主库打开状态</span><br><span class=\"line\">登录使用时间 : 1.616(ms)</span><br><span class=\"line\">上次登录ip       : ::ffff:192.168.118.18</span><br><span class=\"line\">上次登录时间   : 2022-05-29 22:55:12</span><br><span class=\"line\">登录失败次数   : 0</span><br><span class=\"line\">口令是否过期   : 未过期</span><br><span class=\"line\">disql V8</span><br><span class=\"line\">SQL&gt;sp_set_para_value(1,&#x27;ALTER_MODE_STATUS&#x27;,1);</span><br><span class=\"line\">DMSQL 过程已成功完成</span><br><span class=\"line\">已用时间: 4.570(毫秒). 执行号:0.</span><br><span class=\"line\">SQL&gt; sp_set_oguid(453332);</span><br><span class=\"line\">DMSQL 过程已成功完成</span><br><span class=\"line\">已用时间: 5.223(毫秒). 执行号:1.</span><br><span class=\"line\">SQL&gt; sp_set_para_value(1,&#x27;ALTER_MODE_STATUS&#x27;,0);</span><br><span class=\"line\">DMSQL 过程已成功完成</span><br><span class=\"line\">已用时间: 4.021(毫秒). 执行号:2.</span><br><span class=\"line\">SQL&gt; alter database primary;</span><br><span class=\"line\">操作已执行</span><br><span class=\"line\">已用时间: 8.797(毫秒). 执行号:0.</span><br></pre></td></tr></table></figure>\n\n<p><strong>主节点：192.168.118.18 打开另一窗口(root用户)</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@prddb01 ~]# cd /mnt/dmdba/dmdata/script/root</span><br><span class=\"line\"># 注册数据库实例服务</span><br><span class=\"line\">./dm_service_installer.sh -t dmserver -dm_ini /mnt/dmdba/dmdata/DAMENG/dm.ini -m mount -p DMSERVER01</span><br><span class=\"line\"># 注册守护进程服务</span><br><span class=\"line\">./dm_service_installer.sh -t dmwatcher -watcher_ini /mnt/dmdba/dmdata/DAMENG/dmwatcher.ini -p DMSERVER01</span><br><span class=\"line\"></span><br><span class=\"line\">以服务方式启动</span><br><span class=\"line\">[root@prddb01 ~]# cd /mnt/dmdba/dmdata/bin</span><br><span class=\"line\">[root@prddb01 bin]# ./DmServiceDMSERVER01 start # 启动数据库实例</span><br><span class=\"line\">[root@prddb01 bin]# ./DmWatcherServiceDMSERVER01 start #启动守护进程</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"从节点配置192-168-118-19\"><a href=\"#从节点配置192-168-118-19\" class=\"headerlink\" title=\"从节点配置192.168.118.19\"></a>从节点配置192.168.118.19</h2><h3 id=\"修改dm-ini-1\"><a href=\"#修改dm-ini-1\" class=\"headerlink\" title=\"修改dm.ini\"></a>修改dm.ini</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dm.ini</span><br><span class=\"line\"></span><br><span class=\"line\">#修改如下参数</span><br><span class=\"line\"></span><br><span class=\"line\">INSTANCE_NAME  = DMSERVER02</span><br><span class=\"line\"></span><br><span class=\"line\">PORT_NUM  = 5236                      #数据库实例监听端口</span><br><span class=\"line\"></span><br><span class=\"line\">DW_INACTIVE_INTERVAL  = 60       #接收守护进程消息超时时间</span><br><span class=\"line\"></span><br><span class=\"line\">ALTER_MODE_STATUS  = 0             #不允许手工方式修改实例模式/状态/OGUID</span><br><span class=\"line\"></span><br><span class=\"line\">ENABLE_OFFLINE_TS  = 2         #不允许备库 OFFLINE 表空间</span><br><span class=\"line\"></span><br><span class=\"line\">MAL_INI = 1                       #打开 MAL 系统</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_INI  = 1                         #打开归档配置</span><br><span class=\"line\"></span><br><span class=\"line\">RLOG_SEND_APPLY_MON = 64        #统计最近 64 次的日志发送信息</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"修改dmmal-ini-创建这个文件，内容如下，主备库文件内容要相同-1\"><a href=\"#修改dmmal-ini-创建这个文件，内容如下，主备库文件内容要相同-1\" class=\"headerlink\" title=\"修改dmmal.ini(创建这个文件，内容如下，主备库文件内容要相同)\"></a>修改dmmal.ini(创建这个文件，内容如下，主备库文件内容要相同)</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmmal.ini</span><br><span class=\"line\"></span><br><span class=\"line\">MAL_CHECK_INTERVAL =  5  #MAL 链路检测时间间隔 </span><br><span class=\"line\">MAL_CONN_FAIL_INTERVAL =  5  #判定 MAL 链路断开的时间 </span><br><span class=\"line\">[MAL_INST1]</span><br><span class=\"line\">MAL_INST_NAME  =  DMSERVER01  #实例名&amp;#xff0c;和 dm.ini 中的 INSTANCE_NAME 一致 </span><br><span class=\"line\">MAL_HOST  =  192.168.118.18 #MAL 系统监听 TCP 连接的 IP 地址 </span><br><span class=\"line\">MAL_PORT  = 61141  #MAL 系统监听 TCP 连接的端口 </span><br><span class=\"line\">MAL_INST_HOST  =  192.168.118.18  #实例的对外服务 IP 地址 </span><br><span class=\"line\">MAL_INST_PORT  =  5236  #实例的对外服务端口&amp;#xff0c;和 dm.ini 中的 PORT_NUM 一致 </span><br><span class=\"line\">MAL_DW_PORT =  52141  #实例对应的守护进程监听 TCP 连接的端口 </span><br><span class=\"line\">MAL_INST_DW_PORT  =  33141  #实例监听守护进程 TCP 连接的端口 </span><br><span class=\"line\">[MAL_INST2]</span><br><span class=\"line\">MAL_INST_NAME =  DMSERVER02</span><br><span class=\"line\">MAL_HOST =  192.168.118.19</span><br><span class=\"line\">MAL_PORT =  61142</span><br><span class=\"line\">MAL_INST_HOST =  192.168.118.19</span><br><span class=\"line\">MAL_INST_PORT =  5236</span><br><span class=\"line\">MAL_DW_PORT =  52142</span><br><span class=\"line\">MAL_INST_DW_PORT  =  33142</span><br><span class=\"line\">[MAL_INST3]</span><br><span class=\"line\">MAL_INST_NAME =  DMSERVER03</span><br><span class=\"line\">MAL_HOST =  192.168.118.20</span><br><span class=\"line\">MAL_PORT  = 61143</span><br><span class=\"line\">MAL_INST_HOST =  192.168.118.20</span><br><span class=\"line\">MAL_INST_PORT  = 5236</span><br><span class=\"line\">MAL_DW_PORT =  52143</span><br><span class=\"line\">MAL_INST_DW_PORT  =  33143</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"配置dmarch-ini文件-创建这个文件，内容如下-1\"><a href=\"#配置dmarch-ini文件-创建这个文件，内容如下-1\" class=\"headerlink\" title=\"配置dmarch.ini文件(创建这个文件，内容如下)\"></a>配置dmarch.ini文件(创建这个文件，内容如下)</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmarch.ini</span><br><span class=\"line\"></span><br><span class=\"line\">[ARCHIVE_TIMELY1]</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_TYPE = TIMELY       #即时归档类型</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_DEST = DMSERVER01  #即时归档目标实例名</span><br><span class=\"line\"></span><br><span class=\"line\">[ARCHIVE_TIMELY2]</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_TYPE = TIMELY       #即时归档类型</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_DEST = DMSERVER03  #即时归档目标实例名</span><br><span class=\"line\"></span><br><span class=\"line\">[ARCHIVE_LOCAL1]</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_TYPE = LOCAL        #本地归档类型</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_DEST = /mnt/dmdba/dmdata/DAMENG/arch #本地归档文件存放路径</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_FILE_SIZE = 128     #单位 Mb，本地单个归档文件最大值</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_SPACE_LIMIT  = 10240    #单位 Mb，0 表示无限制，范围 1024~4294967294M</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"配置dmwatcher-ini文件-创建这个文件，内容如下，主备库文件内容要相同-1\"><a href=\"#配置dmwatcher-ini文件-创建这个文件，内容如下，主备库文件内容要相同-1\" class=\"headerlink\" title=\"配置dmwatcher.ini文件(创建这个文件，内容如下，主备库文件内容要相同)\"></a>配置dmwatcher.ini文件(创建这个文件，内容如下，主备库文件内容要相同)</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmwatcher.ini</span><br><span class=\"line\"></span><br><span class=\"line\">[GRP1]</span><br><span class=\"line\">  </span><br><span class=\"line\">DW_TYPE = GLOBAL          #全局守护类型</span><br><span class=\"line\"></span><br><span class=\"line\">DW_MODE = AUTO                  #自动切换模式</span><br><span class=\"line\"></span><br><span class=\"line\">DW_ERROR_TIME = 10      #远程守护进程故障认定时间</span><br><span class=\"line\"></span><br><span class=\"line\">INST_RECOVER_TIME = 60 #主库守护进程启动恢复的间隔时间</span><br><span class=\"line\"></span><br><span class=\"line\">INST_ERROR_TIME = 10     #本地实例故障认定时间</span><br><span class=\"line\"></span><br><span class=\"line\">INST_OGUID = 453332      #守护系统唯一 OGUID 值</span><br><span class=\"line\"></span><br><span class=\"line\">INST_INI = /mnt/dmdba/dmdata/DAMENG/dm.ini  #dm.ini 配置文件路径</span><br><span class=\"line\"></span><br><span class=\"line\">INST_AUTO_RESTART = 1   #打开实例的自动启动功能</span><br><span class=\"line\"></span><br><span class=\"line\">INST_STARTUP_CMD = /mnt/dmdba/dmdata/bin/dmserver    #命令行方式启动</span><br><span class=\"line\"></span><br><span class=\"line\">RLOG_SEND_THRESHOLD = 0   #指定主库发送日志到备库的时间阈值，默认关闭</span><br><span class=\"line\"></span><br><span class=\"line\">RLOG_APPLY_THRESHOLD = 0 #指定备库重演日志的时间阈值，默认关闭</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"配置dmmonitor-ini文件监视服务器-创建这个文件，内容如下\"><a href=\"#配置dmmonitor-ini文件监视服务器-创建这个文件，内容如下\" class=\"headerlink\" title=\"配置dmmonitor.ini文件监视服务器(创建这个文件，内容如下)\"></a>配置dmmonitor.ini文件监视服务器(创建这个文件，内容如下)</h3><p><strong>监视器只在prddb02配置</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@prddb02 ~]# vim /mnt/dmdba/dmdata/DAMENG/dmmonitor.ini</span><br><span class=\"line\"></span><br><span class=\"line\">MON_DW_CONFIRM    = 0   #1.确认监视器模式 0.非确认监视模式</span><br><span class=\"line\">MON_LOG_PATH    = /mnt/dmdba/dmdata/log #监视器日志文件存放路径</span><br><span class=\"line\">MON_LOG_INTERVAL  = 60 #每隔 60 s 定时记录系统信息到日志文件</span><br><span class=\"line\">MON_LOG_FILE_SIZE   = 32 #每个日志文件最大 32 MB</span><br><span class=\"line\">MON_LOG_SPACE_LIMIT  = 0  #不限定日志文件总占用空间</span><br><span class=\"line\">[GRP1]</span><br><span class=\"line\"> MON_INST_OGUID    = 453332 #组 GRP_RW 的唯一 OGUID 值</span><br><span class=\"line\">#以下配置为监视器到组 GRP_RW 的守护进程的连接信息，以“IP:PORT”的形式配置</span><br><span class=\"line\">#IP 对应 dmmal.ini 中的 MAL_HOST，PORT 对应 dmmal.ini 中的 MAL_DW_PORT</span><br><span class=\"line\">MON_DW_IP = 192.168.118.18:52141</span><br><span class=\"line\">MON_DW_IP = 192.168.118.19:52142</span><br><span class=\"line\">MON_DW_IP = 192.168.118.20:52143</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"开启从节点\"><a href=\"#开启从节点\" class=\"headerlink\" title=\"开启从节点\"></a>开启从节点</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb02 bin]$  ./dmserver ../DAMENG/dm.ini mount</span><br><span class=\"line\">file dm.key not found, use default license!</span><br><span class=\"line\">\tversion info: develop</span><br><span class=\"line\">\tDM Database Server x64 V8 1-2-84-21.10.21-149328-10032-ENT  startup...</span><br><span class=\"line\">\tNormal of FAST</span><br><span class=\"line\">\tNormal of DEFAULT</span><br><span class=\"line\">\tNormal of RECYCLE</span><br><span class=\"line\">\tNormal of KEEP</span><br><span class=\"line\">\tNormal of ROLL</span><br><span class=\"line\">\tDatabase mode = 0, oguid = 0</span><br><span class=\"line\">\tLicense will expire on 2022-10-21</span><br><span class=\"line\">\tfile lsn: 30600</span><br><span class=\"line\">\tndct db load finished</span><br><span class=\"line\">\tndct second level fill fast pool finished</span><br><span class=\"line\">\tndct third level fill fast pool finished</span><br><span class=\"line\">\tndct fill fast pool finished</span><br><span class=\"line\">\tnsvr_startup end.</span><br><span class=\"line\">\taud sys init success.</span><br><span class=\"line\">\taud rt sys init success.</span><br><span class=\"line\">\tsystables desc init success.</span><br><span class=\"line\">\tndct_db_load_info success.</span><br><span class=\"line\">\tSYSTEM IS READY.</span><br><span class=\"line\">\tcheckpoint requested, rlog free space[536862720], used space[0]</span><br><span class=\"line\">\tcheckpoint generate by ckpt_interval</span><br><span class=\"line\">\tcheckpoint begin, used_space[0], free_space[536862720]...</span><br><span class=\"line\">\tcheckpoint end, 0 pages flushed, used_space[0], free_space[536862720].</span><br><span class=\"line\">\tcheckpoint requested by CKPT_INTERVAL, rlog free space[536862720], used space[0]</span><br><span class=\"line\">\tcheckpoint generate by ckpt_interval</span><br><span class=\"line\">\tcheckpoint begin, used_space[0], free_space[536862720]...</span><br><span class=\"line\">\tcheckpoint end, 0 pages flushed, used_space[0], free_space[536862720].</span><br></pre></td></tr></table></figure>\n\n<p><strong>一直到显示SYSTEM IS READY启动完成。此时不要关闭这个窗口，重新在主服务器上开启一个窗口。</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@prddb02 ~]# su - dmdba</span><br><span class=\"line\">[dmdba@prddb02 ~]$ cd /mnt/dmdba/dmdata/bin</span><br><span class=\"line\">[dmdba@prddb02 bin]$ ./disql SYSDBA/SYSDBA@localhost:5236</span><br><span class=\"line\">服务器[localhost:5236]:处于主库打开状态</span><br><span class=\"line\">登录使用时间 : 1.616(ms)</span><br><span class=\"line\">上次登录ip       : ::ffff:192.168.118.18</span><br><span class=\"line\">上次登录时间   : 2022-05-29 22:55:12</span><br><span class=\"line\">登录失败次数   : 0</span><br><span class=\"line\">口令是否过期   : 未过期</span><br><span class=\"line\">disql V8</span><br><span class=\"line\">SQL&gt;sp_set_para_value(1,&#x27;ALTER_MODE_STATUS&#x27;,1);</span><br><span class=\"line\">DMSQL 过程已成功完成</span><br><span class=\"line\">已用时间: 4.570(毫秒). 执行号:0.</span><br><span class=\"line\">SQL&gt; sp_set_oguid(453332);</span><br><span class=\"line\">DMSQL 过程已成功完成</span><br><span class=\"line\">已用时间: 5.223(毫秒). 执行号:1.</span><br><span class=\"line\">SQL&gt; sp_set_para_value(1,&#x27;ALTER_MODE_STATUS&#x27;,0);</span><br><span class=\"line\">DMSQL 过程已成功完成</span><br><span class=\"line\">已用时间: 4.021(毫秒). 执行号:2.</span><br><span class=\"line\">SQL&gt; alter database standby;</span><br><span class=\"line\">操作已执行</span><br><span class=\"line\">已用时间: 8.797(毫秒). 执行号:0.</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h2 id=\"从节点配置192-168-118-20\"><a href=\"#从节点配置192-168-118-20\" class=\"headerlink\" title=\"从节点配置192.168.118.20\"></a>从节点配置192.168.118.20</h2><h3 id=\"修改dm-ini-2\"><a href=\"#修改dm-ini-2\" class=\"headerlink\" title=\"修改dm.ini\"></a>修改dm.ini</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dm.ini</span><br><span class=\"line\"></span><br><span class=\"line\">#修改如下参数</span><br><span class=\"line\"></span><br><span class=\"line\">INSTANCE_NAME  = DMSERVER03</span><br><span class=\"line\"></span><br><span class=\"line\">PORT_NUM  = 5236                      #数据库实例监听端口</span><br><span class=\"line\"></span><br><span class=\"line\">DW_INACTIVE_INTERVAL  = 60       #接收守护进程消息超时时间</span><br><span class=\"line\"></span><br><span class=\"line\">ALTER_MODE_STATUS  = 0             #不允许手工方式修改实例模式/状态/OGUID</span><br><span class=\"line\"></span><br><span class=\"line\">ENABLE_OFFLINE_TS  = 2         #不允许备库 OFFLINE 表空间</span><br><span class=\"line\"></span><br><span class=\"line\">MAL_INI = 1                       #打开 MAL 系统</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_INI  = 1                         #打开归档配置</span><br><span class=\"line\"></span><br><span class=\"line\">RLOG_SEND_APPLY_MON = 64        #统计最近 64 次的日志发送信息</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"修改dmmal-ini-创建这个文件，内容如下，主备库文件内容要相同-2\"><a href=\"#修改dmmal-ini-创建这个文件，内容如下，主备库文件内容要相同-2\" class=\"headerlink\" title=\"修改dmmal.ini(创建这个文件，内容如下，主备库文件内容要相同)\"></a>修改dmmal.ini(创建这个文件，内容如下，主备库文件内容要相同)</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmmal.ini</span><br><span class=\"line\"></span><br><span class=\"line\">MAL_CHECK_INTERVAL =  5  #MAL 链路检测时间间隔 </span><br><span class=\"line\">MAL_CONN_FAIL_INTERVAL =  5  #判定 MAL 链路断开的时间 </span><br><span class=\"line\">[MAL_INST1]</span><br><span class=\"line\">MAL_INST_NAME  =  DMSERVER01  #实例名&amp;#xff0c;和 dm.ini 中的 INSTANCE_NAME 一致 </span><br><span class=\"line\">MAL_HOST  =  192.168.118.18 #MAL 系统监听 TCP 连接的 IP 地址 </span><br><span class=\"line\">MAL_PORT  = 61141  #MAL 系统监听 TCP 连接的端口 </span><br><span class=\"line\">MAL_INST_HOST  =  192.168.118.18  #实例的对外服务 IP 地址 </span><br><span class=\"line\">MAL_INST_PORT  =  5236  #实例的对外服务端口&amp;#xff0c;和 dm.ini 中的 PORT_NUM 一致 </span><br><span class=\"line\">MAL_DW_PORT =  52141  #实例对应的守护进程监听 TCP 连接的端口 </span><br><span class=\"line\">MAL_INST_DW_PORT  =  33141  #实例监听守护进程 TCP 连接的端口 </span><br><span class=\"line\">[MAL_INST2]</span><br><span class=\"line\">MAL_INST_NAME =  DMSERVER02</span><br><span class=\"line\">MAL_HOST =  192.168.118.19</span><br><span class=\"line\">MAL_PORT =  61142</span><br><span class=\"line\">MAL_INST_HOST =  192.168.118.19</span><br><span class=\"line\">MAL_INST_PORT =  5236</span><br><span class=\"line\">MAL_DW_PORT =  52142</span><br><span class=\"line\">MAL_INST_DW_PORT  =  33142</span><br><span class=\"line\">[MAL_INST3]</span><br><span class=\"line\">MAL_INST_NAME =  DMSERVER03</span><br><span class=\"line\">MAL_HOST =  192.168.118.20</span><br><span class=\"line\">MAL_PORT  = 61143</span><br><span class=\"line\">MAL_INST_HOST =  192.168.118.20</span><br><span class=\"line\">MAL_INST_PORT  = 5236</span><br><span class=\"line\">MAL_DW_PORT =  52143</span><br><span class=\"line\">MAL_INST_DW_PORT  =  33143</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"配置dmarch-ini文件-创建这个文件，内容如下-2\"><a href=\"#配置dmarch-ini文件-创建这个文件，内容如下-2\" class=\"headerlink\" title=\"配置dmarch.ini文件(创建这个文件，内容如下)\"></a>配置dmarch.ini文件(创建这个文件，内容如下)</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb03 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmarch.ini</span><br><span class=\"line\"></span><br><span class=\"line\">[ARCHIVE_TIMELY1]</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_TYPE = TIMELY       #即时归档类型</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_DEST = DMSERVER01  #即时归档目标实例名</span><br><span class=\"line\"></span><br><span class=\"line\">[ARCHIVE_TIMELY2]</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_TYPE = TIMELY       #即时归档类型</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_DEST = DMSERVER02  #即时归档目标实例名</span><br><span class=\"line\"></span><br><span class=\"line\">[ARCHIVE_LOCAL1]</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_TYPE = LOCAL        #本地归档类型</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_DEST = /mnt/dmdba/dmdata/DAMENG/arch #本地归档文件存放路径</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_FILE_SIZE = 128     #单位 Mb，本地单个归档文件最大值</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_SPACE_LIMIT  = 10240    #单位 Mb，0 表示无限制，范围 1024~4294967294M</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"配置dmwatcher-ini文件-创建这个文件，内容如下，主备库文件内容要相同-2\"><a href=\"#配置dmwatcher-ini文件-创建这个文件，内容如下，主备库文件内容要相同-2\" class=\"headerlink\" title=\"配置dmwatcher.ini文件(创建这个文件，内容如下，主备库文件内容要相同)\"></a>配置dmwatcher.ini文件(创建这个文件，内容如下，主备库文件内容要相同)</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmwatcher.ini</span><br><span class=\"line\"></span><br><span class=\"line\">[GRP1]</span><br><span class=\"line\">  </span><br><span class=\"line\">DW_TYPE = GLOBAL          #全局守护类型</span><br><span class=\"line\"></span><br><span class=\"line\">DW_MODE = AUTO                  #自动切换模式</span><br><span class=\"line\"></span><br><span class=\"line\">DW_ERROR_TIME = 10      #远程守护进程故障认定时间</span><br><span class=\"line\"></span><br><span class=\"line\">INST_RECOVER_TIME = 60 #主库守护进程启动恢复的间隔时间</span><br><span class=\"line\"></span><br><span class=\"line\">INST_ERROR_TIME = 10     #本地实例故障认定时间</span><br><span class=\"line\"></span><br><span class=\"line\">INST_OGUID = 453332      #守护系统唯一 OGUID 值</span><br><span class=\"line\"></span><br><span class=\"line\">INST_INI = /mnt/dmdba/dmdata/DAMENG/dm.ini  #dm.ini 配置文件路径</span><br><span class=\"line\"></span><br><span class=\"line\">INST_AUTO_RESTART = 1   #打开实例的自动启动功能</span><br><span class=\"line\"></span><br><span class=\"line\">INST_STARTUP_CMD = /mnt/dmdba/dmdata/bin/dmserver    #命令行方式启动</span><br><span class=\"line\"></span><br><span class=\"line\">RLOG_SEND_THRESHOLD = 0   #指定主库发送日志到备库的时间阈值，默认关闭</span><br><span class=\"line\"></span><br><span class=\"line\">RLOG_APPLY_THRESHOLD = 0 #指定备库重演日志的时间阈值，默认关闭</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"开启从节点-1\"><a href=\"#开启从节点-1\" class=\"headerlink\" title=\"开启从节点\"></a>开启从节点</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb03 bin]$  ./dmserver ../DAMENG/dm.ini mount</span><br><span class=\"line\">file dm.key not found, use default license!</span><br><span class=\"line\">\tversion info: develop</span><br><span class=\"line\">\tDM Database Server x64 V8 1-2-84-21.10.21-149328-10032-ENT  startup...</span><br><span class=\"line\">\tNormal of FAST</span><br><span class=\"line\">\tNormal of DEFAULT</span><br><span class=\"line\">\tNormal of RECYCLE</span><br><span class=\"line\">\tNormal of KEEP</span><br><span class=\"line\">\tNormal of ROLL</span><br><span class=\"line\">\tDatabase mode = 0, oguid = 0</span><br><span class=\"line\">\tLicense will expire on 2022-10-21</span><br><span class=\"line\">\tfile lsn: 30600</span><br><span class=\"line\">\tndct db load finished</span><br><span class=\"line\">\tndct second level fill fast pool finished</span><br><span class=\"line\">\tndct third level fill fast pool finished</span><br><span class=\"line\">\tndct fill fast pool finished</span><br><span class=\"line\">\tnsvr_startup end.</span><br><span class=\"line\">\taud sys init success.</span><br><span class=\"line\">\taud rt sys init success.</span><br><span class=\"line\">\tsystables desc init success.</span><br><span class=\"line\">\tndct_db_load_info success.</span><br><span class=\"line\">\tSYSTEM IS READY.</span><br><span class=\"line\">\tcheckpoint requested, rlog free space[536862720], used space[0]</span><br><span class=\"line\">\tcheckpoint generate by ckpt_interval</span><br><span class=\"line\">\tcheckpoint begin, used_space[0], free_space[536862720]...</span><br><span class=\"line\">\tcheckpoint end, 0 pages flushed, used_space[0], free_space[536862720].</span><br><span class=\"line\">\tcheckpoint requested by CKPT_INTERVAL, rlog free space[536862720], used space[0]</span><br><span class=\"line\">\tcheckpoint generate by ckpt_interval</span><br><span class=\"line\">\tcheckpoint begin, used_space[0], free_space[536862720]...</span><br><span class=\"line\">\tcheckpoint end, 0 pages flushed, used_space[0], free_space[536862720].</span><br></pre></td></tr></table></figure>\n\n<p><strong>一直到显示SYSTEM IS READY启动完成。此时不要关闭这个窗口，重新在主服务器上开启一个窗口。</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@prddb03 ~]# su - dmdba</span><br><span class=\"line\">[dmdba@prddb03 ~]$ cd /mnt/dmdba/dmdata/bin</span><br><span class=\"line\">[dmdba@prddb03 bin]$ ./disql SYSDBA/SYSDBA@localhost:5236</span><br><span class=\"line\">服务器[localhost:5236]:处于主库打开状态</span><br><span class=\"line\">登录使用时间 : 1.616(ms)</span><br><span class=\"line\">上次登录ip       : ::ffff:192.168.118.18</span><br><span class=\"line\">上次登录时间   : 2022-05-29 22:55:12</span><br><span class=\"line\">登录失败次数   : 0</span><br><span class=\"line\">口令是否过期   : 未过期</span><br><span class=\"line\">disql V8</span><br><span class=\"line\">SQL&gt;sp_set_para_value(1,&#x27;ALTER_MODE_STATUS&#x27;,1);</span><br><span class=\"line\">DMSQL 过程已成功完成</span><br><span class=\"line\">已用时间: 4.570(毫秒). 执行号:0.</span><br><span class=\"line\">SQL&gt; sp_set_oguid(453332);</span><br><span class=\"line\">DMSQL 过程已成功完成</span><br><span class=\"line\">已用时间: 5.223(毫秒). 执行号:1.</span><br><span class=\"line\">SQL&gt; sp_set_para_value(1,&#x27;ALTER_MODE_STATUS&#x27;,0);</span><br><span class=\"line\">DMSQL 过程已成功完成</span><br><span class=\"line\">已用时间: 4.021(毫秒). 执行号:2.</span><br><span class=\"line\">SQL&gt; alter database standby;</span><br><span class=\"line\">操作已执行</span><br><span class=\"line\">已用时间: 8.797(毫秒). 执行号:0.</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"注册服务\"><a href=\"#注册服务\" class=\"headerlink\" title=\"注册服务\"></a>注册服务</h2><h3 id=\"使用root用户在主库（192-168-118-18）上执行以下命令\"><a href=\"#使用root用户在主库（192-168-118-18）上执行以下命令\" class=\"headerlink\" title=\"使用root用户在主库（192.168.118.18）上执行以下命令\"></a>使用root用户在主库（192.168.118.18）上执行以下命令</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@prddb01 root]# cd /mnt/dmdba/dmdata/script/root</span><br><span class=\"line\"></span><br><span class=\"line\">./dm_service_installer.sh -t dmserver -dm_ini /mnt/dmdba/dmdata/DAMENG/dm.ini -m mount -p DMSERVER01  # 注册数据库实例服务</span><br><span class=\"line\"></span><br><span class=\"line\">./dm_service_installer.sh -t dmwatcher -watcher_ini /mnt/dmdba/dmdata/DAMENG/dmwatcher.ini -p DMSERVER01  # 注册数据库实例服务</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"使用root用户在从库（192-168-118-19）上执行以下命令\"><a href=\"#使用root用户在从库（192-168-118-19）上执行以下命令\" class=\"headerlink\" title=\"使用root用户在从库（192.168.118.19）上执行以下命令\"></a>使用root用户在从库（192.168.118.19）上执行以下命令</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@prddb01 root]# cd /mnt/dmdba/dmdata/script/root</span><br><span class=\"line\"></span><br><span class=\"line\">./dm_service_installer.sh -t dmserver -dm_ini /mnt/dmdba/dmdata/DAMENG/dm.ini -m mount -p DMSERVER01  # 注册数据库实例服务</span><br><span class=\"line\"></span><br><span class=\"line\">./dm_service_installer.sh -t dmwatcher -watcher_ini /mnt/dmdba/dmdata/DAMENG/dmwatcher.ini -p DMSERVER01  # 注册数据库实例服务</span><br><span class=\"line\"></span><br><span class=\"line\">./dm_service_installer.sh -t dmmonitor -monitor_ini /mnt/dmdba/dmdata/DAMENG/dmmonitor.ini -p DMSERVER02 # 注册监视器服务（只需在监视器服务器上执行）</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"使用root用户在从库（192-168-118-20）上执行以下命令\"><a href=\"#使用root用户在从库（192-168-118-20）上执行以下命令\" class=\"headerlink\" title=\"使用root用户在从库（192.168.118.20）上执行以下命令\"></a>使用root用户在从库（192.168.118.20）上执行以下命令</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@prddb01 root]# cd /mnt/dmdba/dmdata/script/root</span><br><span class=\"line\"></span><br><span class=\"line\">./dm_service_installer.sh -t dmserver -dm_ini /mnt/dmdba/dmdata/DAMENG/dm.ini -m mount -p DMSERVER01  # 注册数据库实例服务</span><br><span class=\"line\"></span><br><span class=\"line\">./dm_service_installer.sh -t dmwatcher -watcher_ini /mnt/dmdba/dmdata/DAMENG/dmwatcher.ini -p DMSERVER01  # 注册数据库实例服务</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"启动管理集群\"><a href=\"#启动管理集群\" class=\"headerlink\" title=\"启动管理集群\"></a>启动管理集群</h2><h3 id=\"启动集群的顺序为：\"><a href=\"#启动集群的顺序为：\" class=\"headerlink\" title=\"启动集群的顺序为：\"></a>启动集群的顺序为：</h3><p><strong>主库实例—&gt;备库实例—&gt;主库守护进程—&gt;备库守护进程—&gt;监视器服务</strong></p>\n<h4 id=\"1-启动192-168-178-18主库实例\"><a href=\"#1-启动192-168-178-18主库实例\" class=\"headerlink\" title=\"1.启动192.168.178.18主库实例\"></a>1.启动192.168.178.18主库实例</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@prddb01 root]# cd /mnt/dmdba/dmdata/bin</span><br><span class=\"line\">[root@prddb01 bin]# ./DmServiceDMSERVER01 start</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-启动192-168-178-19从库实例\"><a href=\"#2-启动192-168-178-19从库实例\" class=\"headerlink\" title=\"2.启动192.168.178.19从库实例\"></a>2.启动192.168.178.19从库实例</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@prddb02 root]# cd /mnt/dmdba/dmdata/bin</span><br><span class=\"line\">[root@prddb02 bin]# ./DmServiceDMSERVER02 start</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"3-启动192-168-178-20从库实例\"><a href=\"#3-启动192-168-178-20从库实例\" class=\"headerlink\" title=\"3.启动192.168.178.20从库实例\"></a>3.启动192.168.178.20从库实例</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@prddb03 root]# cd /mnt/dmdba/dmdata/bin</span><br><span class=\"line\">[root@prddb03 bin]# ./DmServiceDMSERVER03 start</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"4-启动192-168-178-18主库守护进程\"><a href=\"#4-启动192-168-178-18主库守护进程\" class=\"headerlink\" title=\"4.启动192.168.178.18主库守护进程\"></a>4.启动192.168.178.18主库守护进程</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@prddb01 root]# cd /mnt/dmdba/dmdata/bin</span><br><span class=\"line\">[root@prddb01 bin]# ./DmWatcherServiceDMSERVER01 start</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"5-启动192-168-178-19从库守护进程\"><a href=\"#5-启动192-168-178-19从库守护进程\" class=\"headerlink\" title=\"5.启动192.168.178.19从库守护进程\"></a>5.启动192.168.178.19从库守护进程</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@prddb02 root]# cd /mnt/dmdba/dmdata/bin</span><br><span class=\"line\">[root@prddb02 bin]# ./DmWatcherServiceDMSERVER02 start</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"6-启动192-168-178-20从库守护进程\"><a href=\"#6-启动192-168-178-20从库守护进程\" class=\"headerlink\" title=\"6.启动192.168.178.20从库守护进程\"></a>6.启动192.168.178.20从库守护进程</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@prddb03 root]# cd /mnt/dmdba/dmdata/bin</span><br><span class=\"line\">[root@prddb03 bin]# ./DmWatcherServiceDMSERVER03 start</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"7-启动192-168-178-19监视服务\"><a href=\"#7-启动192-168-178-19监视服务\" class=\"headerlink\" title=\"7.启动192.168.178.19监视服务\"></a>7.启动192.168.178.19监视服务</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@prddb02 root]# cd /mnt/dmdba/dmdata/bin</span><br><span class=\"line\">[root@prddb02 bin]# ./DmMonitorServiceDMSERVER02 start</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><h2 id=\"验证主备集群同步状态\"><a href=\"#验证主备集群同步状态\" class=\"headerlink\" title=\"验证主备集群同步状态\"></a>验证主备集群同步状态</h2><h3 id=\"监视器查看读写分离集群状态\"><a href=\"#监视器查看读写分离集群状态\" class=\"headerlink\" title=\"监视器查看读写分离集群状态\"></a>监视器查看读写分离集群状态</h3><p>集群任意节点，配置普通监视器配置文件 <code>dmmonitor.ini</code>，执行以下命令：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vi /mnt/dmdba/dmdata/DAMENG/dmmonitor.ini</span><br></pre></td></tr></table></figure>\n\n<p>添加以下内容：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MON_DW_CONFIRM    = 0   #1.确认监视器模式 0.非确认监视模式</span><br><span class=\"line\">MON_LOG_PATH    = /mnt/dmdba/dmdata/log #监视器日志文件存放路径</span><br><span class=\"line\">MON_LOG_INTERVAL  = 60 #每隔 60 s 定时记录系统信息到日志文件</span><br><span class=\"line\">MON_LOG_FILE_SIZE   = 32 #每个日志文件最大 32 MB</span><br><span class=\"line\">MON_LOG_SPACE_LIMIT  = 0  #不限定日志文件总占用空间</span><br><span class=\"line\">[GRP1]</span><br><span class=\"line\"> MON_INST_OGUID    = 453332 #组 GRP_RW 的唯一 OGUID 值</span><br><span class=\"line\">#以下配置为监视器到组 GRP_RW 的守护进程的连接信息，以“IP:PORT”的形式配置</span><br><span class=\"line\">#IP 对应 dmmal.ini 中的 MAL_HOST，PORT 对应 dmmal.ini 中的 MAL_DW_PORT</span><br><span class=\"line\">MON_DW_IP = 192.168.118.18:52141</span><br><span class=\"line\">MON_DW_IP = 192.168.118.19:52142</span><br><span class=\"line\">MON_DW_IP = 192.168.118.20:52143</span><br></pre></td></tr></table></figure>\n\n<p>启动监视器，执行以下命令：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /mnt/dmdba/dmdata/bin</span><br><span class=\"line\">./dmmonitor mnt/dmdba/dmdata/DAMENG/dmmonitor.ini</span><br></pre></td></tr></table></figure>\n\n<p>输入 show 命令查看集群状态，执行以下命令：</p>\n<p><img src=\"/images/dm.png\" alt=\"dm\"></p>\n<p>其中守护进程状态 WSTATUS 为 OPEN，实例状态 ISTATUS 为 OPEN，归档类型 RTYPE 为 REALTIME，归档状态 RSTAT 为VALID。</p>\n<h2 id=\"重启集群\"><a href=\"#重启集群\" class=\"headerlink\" title=\"重启集群\"></a>重启集群</h2><p><strong>主备集群重启有顺序要求：</strong>（在/mnt/dmdba/dmdata/bin目录下执行）</p>\n<ol>\n<li>关闭监视器：./DmMonitorServiceDMSERVER02 stop</li>\n<li>关闭主库守护进程：./DmWatcherServiceDMSERVER01 stop</li>\n<li>关闭备库守护进程：./DmWatcherServiceDMSERVER02 stop</li>\n<li>关闭备库守护进程：./DmWatcherServiceDMSERVER03 stop</li>\n<li>关闭主库实例：./DmServiceDMSERVER01 stop</li>\n<li>关闭备库实例：./DmServiceDMSERVER02 stop</li>\n<li>关闭备库实例：./DmServiceDMSERVER03 stop</li>\n<li>启动主库实例：./DmServiceDMSERVER01 start</li>\n<li>启动备库实例：./DmServiceDMSERVER02 start</li>\n<li>启动备库实例：./DmServiceDMSERVER03 start</li>\n<li>启动主库守护进程：./DmWatcherServiceDMSERVER01 start</li>\n<li>启动备库守护进程：./DmWatcherServiceDMSERVER02 start</li>\n<li>启动备库守护进程：./DmWatcherServiceDMSERVER03 start</li>\n<li>启动监视器：./DmMonitorServiceDMSERVER02 start</li>\n</ol>\n<p>详见请参考官方文档：<a href=\"https://eco.dameng.com/docs/zh-cn/ops/standard-dw-cluster.html\">https://eco.dameng.com/docs/zh-cn/ops/standard-dw-cluster.html</a></p>\n","site":{"data":{}},"excerpt":"<h1 id=\"主备集群规范化部署\"><a href=\"#主备集群规范化部署\" class=\"headerlink\" title=\"主备集群规范化部署\"></a>主备集群规范化部署</h1><p>本章节主要介绍在生产环境中（Linux 系统）规范化部署主备集群。</p>","more":"<h2 id=\"服务器硬件需求\"><a href=\"#服务器硬件需求\" class=\"headerlink\" title=\"服务器硬件需求\"></a>服务器硬件需求</h2><p>按实际业务需求，选择合适的服务器，准备 <strong>3 台服务器</strong>，一台主库服务器，两台备库服务器，一台监视器服务器，服务器参数建议如下：</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">硬件</th>\n<th align=\"left\">要求</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\">物理内存</td>\n<td align=\"left\">&gt;=16 GB</td>\n</tr>\n<tr>\n<td align=\"left\">交换区</td>\n<td align=\"left\">Swap 空间&gt;=物理内存</td>\n</tr>\n<tr>\n<td align=\"left\">/tmp大小</td>\n<td align=\"left\">&gt; 1000 MB</td>\n</tr>\n<tr>\n<td align=\"left\">网络</td>\n<td align=\"left\">物理机器需要 4 个网卡，2 个 public 网卡做 band，2 个 private 网卡做 band</td>\n</tr>\n<tr>\n<td align=\"left\">磁盘</td>\n<td align=\"left\">根据实际应用系统需要挂载合适大小磁盘</td>\n</tr>\n<tr>\n<td align=\"left\">时间服务器</td>\n<td align=\"left\">按机房要求配置连接时间服务器</td>\n</tr>\n</tbody></table>\n<blockquote>\n<p>警告</p>\n<p>守护进程配置自动切换时，必须在监视器服务器上配置确认监视器，并且保证网络高可用。</p>\n</blockquote>\n<h2 id=\"操作系统要求\"><a href=\"#操作系统要求\" class=\"headerlink\" title=\"操作系统要求\"></a>操作系统要求</h2><h3 id=\"操作系统版本安装\"><a href=\"#操作系统版本安装\" class=\"headerlink\" title=\"操作系统版本安装\"></a>操作系统版本安装</h3><p>DM 数据库安装在 Linux 操作系统所需条件：glibc 2.3 以上，内核 2.6，预先安装 UnixODBC，系统性能监控等组件。</p>\n<h3 id=\"目录与存储规划\"><a href=\"#目录与存储规划\" class=\"headerlink\" title=\"目录与存储规划\"></a>目录与存储规划</h3><table>\n<thead>\n<tr>\n<th align=\"left\">用途</th>\n<th align=\"left\">目录路径</th>\n<th align=\"left\">备注</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\">数据库软件安装目录</td>\n<td align=\"left\">/home/dmdba/dmdbms</td>\n<td align=\"left\">可用空间&gt;50 GB</td>\n</tr>\n<tr>\n<td align=\"left\">实例安装目录</td>\n<td align=\"left\">/dmdata</td>\n<td align=\"left\">单独挂载性能最好的磁盘建议 SSD</td>\n</tr>\n<tr>\n<td align=\"left\">归档日志存放目录</td>\n<td align=\"left\">/dmarch</td>\n<td align=\"left\">单独挂载磁盘</td>\n</tr>\n<tr>\n<td align=\"left\">备份文件存放目录</td>\n<td align=\"left\">/dmbak</td>\n<td align=\"left\">单独挂载磁盘</td>\n</tr>\n</tbody></table>\n<h3 id=\"用户与组\"><a href=\"#用户与组\" class=\"headerlink\" title=\"用户与组\"></a>用户与组</h3><p>DM 数据库不应该使用 root 用户安装和维护。需要在安装之前为 DM 数据库创建一个专用的系统用户 (dmdba) 和用户组 (dinstall)。</p>\n<p>执行以下命令，新建用户组 dinstall：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">groupadd dinstall</span><br></pre></td></tr></table></figure>\n\n<p>执行以下命令，新建用户 dmdba：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">useradd  -g dinstall -m -d /home/dmdba -s /bin/bash  dmdba</span><br></pre></td></tr></table></figure>\n\n<p>执行以下命令，修改 dmdba 用户密码：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">passwd dmdba</span><br></pre></td></tr></table></figure>\n\n<p>输入密码并确认。</p>\n<h3 id=\"用户资源限制\"><a href=\"#用户资源限制\" class=\"headerlink\" title=\"用户资源限制\"></a>用户资源限制</h3><p>执行以下命令，修改 dmdba 用户资源限制：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /etc/security/limits.conf</span><br></pre></td></tr></table></figure>\n\n<p>文件末尾添加如下内容：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dmdba soft core unlimited</span><br><span class=\"line\">dmdba hard core unlimited</span><br><span class=\"line\">dmdba soft nofile 65536</span><br><span class=\"line\">dmdba hard nofile 65536</span><br><span class=\"line\">dmdba soft nproc  65536</span><br><span class=\"line\">dmdba hard nproc  65536</span><br><span class=\"line\">dmdba soft stack  65536</span><br><span class=\"line\">dmdba hard stack  65536</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"用户环境变量\"><a href=\"#用户环境变量\" class=\"headerlink\" title=\"用户环境变量\"></a>用户环境变量</h3><p>执行以下命令，修改 dmdba 用户环境变量：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vi /home/dmdba/.bash_profile</span><br></pre></td></tr></table></figure>\n\n<p>文件末尾添加如下内容：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export DM_HOME=/mnt/dmdba/dmdata</span><br><span class=\"line\">export PATH=$PATH:$DM_HOME/bin</span><br><span class=\"line\">export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$DM_HOME/bin</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"防火墙设置\"><a href=\"#防火墙设置\" class=\"headerlink\" title=\"防火墙设置\"></a>防火墙设置</h3><p>关闭防火墙：systemctl stop firewalld</p>\n<p>禁止开机自启：systemctl disable firewalld</p>\n<h4 id=\"端口规划\"><a href=\"#端口规划\" class=\"headerlink\" title=\"端口规划\"></a>端口规划</h4><p>搭建 2 节点主备集群，端口规划如下：（实际中可以按需要修改端口号）</p>\n<table>\n<thead>\n<tr>\n<th align=\"center\">主机名</th>\n<th align=\"center\">ip</th>\n<th align=\"center\">实例名</th>\n<th align=\"center\">端口</th>\n<th align=\"center\">用途</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">prddb01</td>\n<td align=\"center\">192.168.118.18</td>\n<td align=\"center\">DmServiceDMSERVER01</td>\n<td align=\"center\">5236</td>\n<td align=\"center\">数据库实例 DmServiceDMSERVER01 监听端口</td>\n</tr>\n<tr>\n<td align=\"center\">prddb01</td>\n<td align=\"center\">192.168.118.18</td>\n<td align=\"center\">DmServiceDMSERVER01</td>\n<td align=\"center\">61141</td>\n<td align=\"center\">MAL 系统监听 TCP 连接的端口</td>\n</tr>\n<tr>\n<td align=\"center\">prddb01</td>\n<td align=\"center\">192.168.118.18</td>\n<td align=\"center\">DmServiceDMSERVER01</td>\n<td align=\"center\">52141</td>\n<td align=\"center\">实例本地的守护进程监听 TCP 连接的端口</td>\n</tr>\n<tr>\n<td align=\"center\">prddb01</td>\n<td align=\"center\">192.168.118.18</td>\n<td align=\"center\">DmServiceDMSERVER01</td>\n<td align=\"center\">33141</td>\n<td align=\"center\">实例监听守护进程 TCP 连接的端口</td>\n</tr>\n<tr>\n<td align=\"center\">prddb02</td>\n<td align=\"center\">192.168.118.19</td>\n<td align=\"center\">DmServiceDMSERVER02</td>\n<td align=\"center\">5236</td>\n<td align=\"center\">数据库实例 DmServiceDMSERVER02 监听端口</td>\n</tr>\n<tr>\n<td align=\"center\">prddb02</td>\n<td align=\"center\">192.168.118.19</td>\n<td align=\"center\">DmServiceDMSERVER02</td>\n<td align=\"center\">61142</td>\n<td align=\"center\">MAL 系统监听 TCP 连接的端口</td>\n</tr>\n<tr>\n<td align=\"center\">prddb02</td>\n<td align=\"center\">192.168.118.19</td>\n<td align=\"center\">DmServiceDMSERVER02</td>\n<td align=\"center\">52142</td>\n<td align=\"center\">实例本地的守护进程监听 TCP 连接的端口</td>\n</tr>\n<tr>\n<td align=\"center\">prddb02</td>\n<td align=\"center\">192.168.118.19</td>\n<td align=\"center\">DmServiceDMSERVER02</td>\n<td align=\"center\">33142</td>\n<td align=\"center\">实例监听守护进程 TCP 连接的端口</td>\n</tr>\n<tr>\n<td align=\"center\">prddb03</td>\n<td align=\"center\">192.168.118.20</td>\n<td align=\"center\">DmServiceDMSERVER03</td>\n<td align=\"center\">5236</td>\n<td align=\"center\">数据库实例 DmServiceDMSERVER03 监听端口</td>\n</tr>\n<tr>\n<td align=\"center\">prddb03</td>\n<td align=\"center\">192.168.118.20</td>\n<td align=\"center\">DmServiceDMSERVER03</td>\n<td align=\"center\">61143</td>\n<td align=\"center\">MAL 系统监听 TCP 连接的端口</td>\n</tr>\n<tr>\n<td align=\"center\">prddb03</td>\n<td align=\"center\">192.168.118.20</td>\n<td align=\"center\">DmServiceDMSERVER03</td>\n<td align=\"center\">52143</td>\n<td align=\"center\">实例本地的守护进程监听 TCP 连接的端口</td>\n</tr>\n<tr>\n<td align=\"center\">prddb03</td>\n<td align=\"center\">192.168.118.20</td>\n<td align=\"center\">DmServiceDMSERVER03</td>\n<td align=\"center\">33143</td>\n<td align=\"center\">实例监听守护进程 TCP 连接的端口</td>\n</tr>\n<tr>\n<td align=\"center\">prddb02</td>\n<td align=\"center\">192.168.118.19</td>\n<td align=\"center\">监视器</td>\n<td align=\"center\"></td>\n<td align=\"center\">监视节点</td>\n</tr>\n</tbody></table>\n<p><strong>防火墙集群之间需开放以上所有端口，</strong>集群对客户端只需要开通数据库实例监听端口。</p>\n<h2 id=\"安装数据库-三台都装\"><a href=\"#安装数据库-三台都装\" class=\"headerlink\" title=\"安装数据库(三台都装)\"></a>安装数据库(三台都装)</h2><h3 id=\"用户与组-1\"><a href=\"#用户与组-1\" class=\"headerlink\" title=\"用户与组\"></a>用户与组</h3><p>DM 数据库不应该使用 root 用户安装和维护。需要在安装之前为 DM 数据库创建一个专用的系统用户 (dmdba) 和用户组 (dinstall)。</p>\n<p>执行以下命令，新建用户组 dinstall：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">groupadd dinstall</span><br></pre></td></tr></table></figure>\n\n<p>执行以下命令，新建用户 dmdba：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">useradd  -g dinstall -m -d /home/dmdba -s /bin/bash  dmdba</span><br></pre></td></tr></table></figure>\n\n<p>执行以下命令，修改 dmdba 用户密码：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">passwd dmdba</span><br></pre></td></tr></table></figure>\n\n<p>输入密码并确认。</p>\n<h3 id=\"用户资源限制-1\"><a href=\"#用户资源限制-1\" class=\"headerlink\" title=\"用户资源限制\"></a>用户资源限制</h3><p>执行以下命令，修改 dmdba 用户资源限制：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /etc/security/limits.conf</span><br></pre></td></tr></table></figure>\n\n<p>文件末尾添加如下内容：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dmdba soft core unlimited</span><br><span class=\"line\">dmdba hard core unlimited</span><br><span class=\"line\">dmdba soft nofile 65536</span><br><span class=\"line\">dmdba hard nofile 65536</span><br><span class=\"line\">dmdba soft nproc  65536</span><br><span class=\"line\">dmdba hard nproc  65536</span><br><span class=\"line\">dmdba soft stack  65536</span><br><span class=\"line\">dmdba hard stack  65536</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"用户环境变量-1\"><a href=\"#用户环境变量-1\" class=\"headerlink\" title=\"用户环境变量\"></a>用户环境变量</h3><p>执行以下命令，修改 dmdba 用户环境变量：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vi /home/dmdba/.bash_profile</span><br></pre></td></tr></table></figure>\n\n<p>文件末尾添加如下内容：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export DM_HOME=/mnt/dmdba/dmdata</span><br><span class=\"line\">export PATH=$PATH:$DM_HOME/bin</span><br><span class=\"line\">export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$DM_HOME/bin</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"软件申请\"><a href=\"#软件申请\" class=\"headerlink\" title=\"软件申请\"></a>软件申请</h3><p>可访问达梦云适配中心<a href=\"https://eco.dameng.com/download/?_blank\">下载试用</a>，下载 DM8 数据库试用版，如需其他版本，请联系达梦销售人员。</p>\n<p>查询操作系统（内核）版本，CPU 架构命令：<code>uname -a</code>。</p>\n<p>如上图所示，需申请 rh7，x86 版本数据库软件。</p>\n<p>以 iso 文件安装包为例，安装包命名规则如下：<code>dm8_20200930_x86_rh6_64_ent_8.1.1.134.iso</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dm8：数据库大版本为 dm8</span><br><span class=\"line\">20200930：数据库版本发布日期</span><br><span class=\"line\">x86：安装包匹配的 CPU 架构</span><br><span class=\"line\">rh6：安装包匹配的系统版本 (redhat 6)</span><br><span class=\"line\">ent：数据库为企业版</span><br><span class=\"line\">8.1.1.134：数据库详细版本号</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"安装数据库软件\"><a href=\"#安装数据库软件\" class=\"headerlink\" title=\"安装数据库软件\"></a>安装数据库软件</h3><p>将安装包上传到服务器后使用 root 用户挂载 iso 安装包文件到 <code>/mnt</code> 目录下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mount -oloop dm8_20211025_HWarm_centos7_64_sec_8.1.2.84.iso /data/mnt</span><br></pre></td></tr></table></figure>\n\n<p>执行以下命令，切换到 dmdba 用户：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">su - dmdba</span><br></pre></td></tr></table></figure>\n\n<p>执行以下命令，切换到 /mnt 目录下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /data/mnt</span><br></pre></td></tr></table></figure>\n\n<p>执行以下命令，查看文件：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ll</span><br></pre></td></tr></table></figure>\n\n<p>执行 <code>DMInstall.bin</code> 文件开始安装，选择【-i】参数以命令行方式安装：</p>\n<ol>\n<li>选择安装程序的语言 c/C 为中文，e/E 为英文。</li>\n<li>提示是否安装 key 文件，输入 N 跳过。</li>\n<li>选择时区，21 即东 8 区。</li>\n<li>选择安装类型，默认典型安装（包含所有内容）。</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./DMInstall.bin -i</span><br><span class=\"line\">Please select the installer&#x27;s language (E/e:English C/c:Chinese) [E/e]:c</span><br><span class=\"line\">解压安装程序..........</span><br><span class=\"line\">欢迎使用达梦数据库安装程序</span><br><span class=\"line\">是否输入Key文件路径? (Y/y:是 N/n:否) [Y/y]:n</span><br><span class=\"line\">是否设置时区? (Y/y:是 N/n:否) [Y/y]:</span><br><span class=\"line\">设置时区:</span><br><span class=\"line\"></span><br><span class=\"line\">[ 1]: GTM-12=日界线西</span><br><span class=\"line\">[ 2]: GTM-11=萨摩亚群岛</span><br><span class=\"line\">[ 3]: GTM-10=夏威夷</span><br><span class=\"line\">[ 4]: GTM-09=阿拉斯加</span><br><span class=\"line\">[ 5]: GTM-08=太平洋时间（美国和加拿大）</span><br><span class=\"line\">[ 6]: GTM-07=亚利桑那</span><br><span class=\"line\">[ 7]: GTM-06=中部时间（美国和加拿大）</span><br><span class=\"line\">[ 8]: GTM-05=东部部时间（美国和加拿大）</span><br><span class=\"line\">[ 9]: GTM-04=大西洋时间（美国和加拿大）</span><br><span class=\"line\">[10]: GTM-03=巴西利亚</span><br><span class=\"line\">[11]: GTM-02=中大西洋</span><br><span class=\"line\">[12]: GTM-01=亚速尔群岛</span><br><span class=\"line\">[13]: GTM=格林威治标准时间</span><br><span class=\"line\">[14]: GTM+01=萨拉热窝</span><br><span class=\"line\">[15]: GTM+02=开罗</span><br><span class=\"line\">[16]: GTM+03=莫斯科</span><br><span class=\"line\">[17]: GTM+04=阿布扎比</span><br><span class=\"line\">[18]: GTM+05=伊斯兰堡</span><br><span class=\"line\">[19]: GTM+06=达卡</span><br><span class=\"line\">[20]: GTM+07=曼谷，河内</span><br><span class=\"line\">[21]: GTM+08=中国标准时间</span><br><span class=\"line\">[22]: GTM+09=汉城</span><br><span class=\"line\">[23]: GTM+10=关岛</span><br><span class=\"line\">[24]: GTM+11=所罗门群岛</span><br><span class=\"line\">[25]: GTM+12=斐济</span><br><span class=\"line\">[26]: GTM+13=努库阿勒法</span><br><span class=\"line\">[27]: GTM+14=基里巴斯</span><br><span class=\"line\"></span><br><span class=\"line\">请选择设置时区 [21]:</span><br><span class=\"line\">安装类型:</span><br><span class=\"line\">1 典型安装</span><br><span class=\"line\">2 服务器</span><br><span class=\"line\">3 客户端</span><br><span class=\"line\">4 自定义</span><br><span class=\"line\">请选择安装类型的数字序号 [1 典型安装]:4 #这里可直接典型安装</span><br><span class=\"line\">1 服务器组件</span><br><span class=\"line\">2 客户端组件</span><br><span class=\"line\">  2.1 DM管理工具</span><br><span class=\"line\">  2.2 DM性能监视工具</span><br><span class=\"line\">  2.3 DM数据迁移工具</span><br><span class=\"line\">  2.4 DM控制台工具</span><br><span class=\"line\">  2.5 DM审计分析工具</span><br><span class=\"line\">  2.6 SQL交互式查询工具</span><br><span class=\"line\">3 驱动</span><br><span class=\"line\">4 用户手册</span><br><span class=\"line\">5 数据库服务</span><br><span class=\"line\">  5.1 实时审计服务</span><br><span class=\"line\">  5.2 作业服务</span><br><span class=\"line\">  5.3 实例监控服务</span><br><span class=\"line\">  5.4 辅助插件服务</span><br><span class=\"line\">请选择安装组件的序号 (使用空格间隔) [1 2 3 4 5]:1 2 3 4 5</span><br><span class=\"line\">所需空间: 1223M</span><br><span class=\"line\">请选择安装目录 [/mnt/dmdba/dmdbms]:/mnt/dmdba/dmdata</span><br><span class=\"line\">可用空间: 495G</span><br><span class=\"line\">是否确认安装路径(/mnt/dmdba/dmdata)? (Y/y:是 N/n:否)  [Y/y]:</span><br><span class=\"line\">安装前小结</span><br><span class=\"line\">安装位置: /mnt/dmdba/dmdata</span><br><span class=\"line\">所需空间: 1223M</span><br><span class=\"line\">可用空间: 495G</span><br><span class=\"line\">版本信息: </span><br><span class=\"line\">有效日期: </span><br><span class=\"line\">安装类型: 自定义</span><br><span class=\"line\">是否确认安装? (Y/y:是 N/n:否):y</span><br><span class=\"line\">2022-05-09 10:23:18 </span><br><span class=\"line\">[INFO] 安装达梦数据库...</span><br><span class=\"line\">2022-05-09 10:23:18 </span><br><span class=\"line\">[INFO] 安装 基础 模块...</span><br><span class=\"line\">2022-05-09 10:23:19 </span><br><span class=\"line\">[INFO] 安装 服务器 模块...</span><br><span class=\"line\">2022-05-09 10:23:19 </span><br><span class=\"line\">[INFO] 安装 客户端 模块...</span><br><span class=\"line\">2022-05-09 10:23:20 </span><br><span class=\"line\">[INFO] 安装 驱动 模块...</span><br><span class=\"line\">2022-05-09 10:23:20 </span><br><span class=\"line\">[INFO] 安装 手册 模块...</span><br><span class=\"line\">2022-05-09 10:23:20 </span><br><span class=\"line\">[INFO] 安装 服务 模块...</span><br><span class=\"line\">2022-05-09 10:23:21 </span><br><span class=\"line\">[INFO] 移动日志文件。</span><br><span class=\"line\">2022-05-09 10:23:21 </span><br><span class=\"line\">[INFO] 安装达梦数据库完成。</span><br></pre></td></tr></table></figure>\n\n<p><strong>安装完成后，按照系统提示使用 root 用户执行脚本。</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/mnt/dmdba/dmdata/script/root/root_installer.sh</span><br></pre></td></tr></table></figure>\n\n<p>提示 <code>DmAPService 服务启动成功</code>，则安装完成。</p>\n<h3 id=\"使用-dminit-工具初始化实例\"><a href=\"#使用-dminit-工具初始化实例\" class=\"headerlink\" title=\"使用 dminit 工具初始化实例\"></a>使用 dminit 工具初始化实例</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@prddb01 bin]# ./dminit help</span><br><span class=\"line\">initdb V8</span><br><span class=\"line\">db version: 0x7000c</span><br><span class=\"line\">格式: ./dminit     KEYWORD=value</span><br><span class=\"line\"></span><br><span class=\"line\">例程: ./dminit     PATH=/public/dmdb/dmData PAGE_SIZE=16</span><br><span class=\"line\"></span><br><span class=\"line\">关键字                     说明（默认值）</span><br><span class=\"line\">--------------------------------------------------------------------------------</span><br><span class=\"line\">INI_FILE                   初始化文件dm.ini存放的路径</span><br><span class=\"line\">PATH                       初始数据库存放的路径</span><br><span class=\"line\">CTL_PATH                   控制文件路径</span><br><span class=\"line\">LOG_PATH                   日志文件路径</span><br><span class=\"line\">EXTENT_SIZE                数据文件使用的簇大小(16)，可选值：16, 32, 64，单位：页</span><br><span class=\"line\">PAGE_SIZE                  数据页大小(8)，可选值：4, 8, 16, 32，单位：K</span><br><span class=\"line\">LOG_SIZE                   日志文件大小(256)，单位为：M，范围为：256M ~ 2G</span><br><span class=\"line\">CASE_SENSITIVE             大小敏感(Y)，可选值：Y/N，1/0</span><br><span class=\"line\">CHARSET/UNICODE_FLAG       字符集(0)，可选值：0[GB18030]，1[UTF-8]，2[EUC-KR]</span><br><span class=\"line\">SEC_PRIV_MODE              权限管理模式(0)，可选值：0[TRADITION]，1[BMJ]，2[EVAL]</span><br><span class=\"line\">LENGTH_IN_CHAR             VARCHAR类型长度是否以字符为单位(N)，可选值：Y/N，1/0</span><br><span class=\"line\">SYSDBA_PWD                 设置SYSDBA密码(SYSDBA)</span><br><span class=\"line\">SYSAUDITOR_PWD             设置SYSAUDITOR密码(SYSAUDITOR)</span><br><span class=\"line\">DB_NAME                    数据库名(DAMENG)</span><br><span class=\"line\">INSTANCE_NAME              实例名(DMSERVER)</span><br><span class=\"line\">PORT_NUM                   监听端口号(5236)</span><br><span class=\"line\">BUFFER                     系统缓存大小(100)，单位M</span><br><span class=\"line\">TIME_ZONE                  设置时区(+08:00)</span><br><span class=\"line\">PAGE_CHECK                 页检查模式(0)，可选值：0/1/2</span><br><span class=\"line\">PAGE_HASH_NAME             设置页检查HASH算法</span><br><span class=\"line\">EXTERNAL_CIPHER_NAME       设置默认加密算法</span><br><span class=\"line\">EXTERNAL_HASH_NAME         设置默认HASH算法</span><br><span class=\"line\">EXTERNAL_CRYPTO_NAME       设置根密钥加密引擎</span><br><span class=\"line\">RLOG_ENC_FLAG              设置日志文件是否加密(N)，可选值：Y/N，1/0</span><br><span class=\"line\">USBKEY_PIN                 设置USBKEY PIN</span><br><span class=\"line\">PAGE_ENC_SLICE_SIZE        设置页加密分片大小，可选值：0、512、4096，单位：Byte</span><br><span class=\"line\">ENCRYPT_NAME               设置全库加密算法</span><br><span class=\"line\">BLANK_PAD_MODE             设置空格填充模式(0)，可选值：0/1</span><br><span class=\"line\">SYSTEM_MIRROR_PATH         SYSTEM数据文件镜像路径</span><br><span class=\"line\">MAIN_MIRROR_PATH           MAIN数据文件镜像</span><br><span class=\"line\">ROLL_MIRROR_PATH           回滚文件镜像路径</span><br><span class=\"line\">MAL_FLAG                   初始化时设置dm.ini中的MAL_INI(0)</span><br><span class=\"line\">ARCH_FLAG                  初始化时设置dm.ini中的ARCH_INI(0)</span><br><span class=\"line\">MPP_FLAG                   Mpp系统内的库初始化时设置dm.ini中的mpp_ini(0)</span><br><span class=\"line\">CONTROL                    初始化配置文件（配置文件格式见系统管理员手册）</span><br><span class=\"line\">AUTO_OVERWRITE             是否覆盖所有同名文件(0) 0:不覆盖 1:部分覆盖 2:完全覆盖</span><br><span class=\"line\">USE_NEW_HASH               是否使用改进的字符类型HASH算法(1)</span><br><span class=\"line\">ELOG_PATH                  指定初始化过程中生成的日志文件所在路径</span><br><span class=\"line\">AP_PORT_NUM                ECS模式下AP协同工作的监听端口</span><br><span class=\"line\">DFS_FLAG                   初始化时设置dm.ini中的DFS_INI(0)</span><br><span class=\"line\">DFS_PATH                   启用dfs时指定数据文件的缺省路径</span><br><span class=\"line\">DFS_HOST                   指定连接分布式系统DFS的服务地址(localhost)</span><br><span class=\"line\">DFS_PORT                   指定连接分布式系统DFS的服务端口号(3332)</span><br><span class=\"line\">DFS_COPY_NUM               指定分布式系统的副本数(3)</span><br><span class=\"line\">DFS_DB_NAME                指定分布式系统的中数据库名(默认与DB_NAME一致)</span><br><span class=\"line\">SHARE_FLAG                 指定分布式系统中该数据库的共享属性(0)</span><br><span class=\"line\">REGION_MODE                指定分布式系统中该数据库的系统表空间数据文件的区块策略(0) 0:微区策略 1:宏区策略</span><br><span class=\"line\">HUGE_WITH_DELTA            是否仅支持创建事务型HUGE表(1) 1:是 0:否</span><br><span class=\"line\">RLOG_GEN_FOR_HUGE          是否生成HUGE表REDO日志(0) 1:是 0:否</span><br><span class=\"line\">PSEG_MGR_FLAG              是否仅使用管理段记录事务信息(0) 1:是 0:否</span><br><span class=\"line\">CHAR_FIX_STORAGE           CHAR是否按定长存储(N)，可选值：Y/N，1/0</span><br><span class=\"line\">SQL_LOG_FORBID             是否禁止打开SQL日志(N)，可选值：Y/N，1/0</span><br><span class=\"line\">SYSSSO_PWD                 设置SYSSSO密码(SYSSSO)</span><br><span class=\"line\">SYSDBO_PWD                 设置SYSDBO密码(SYSDBO)</span><br><span class=\"line\">PRIV_FLAG                  设置权限标记(0)，可选值：0[三权分立]，1[四权分立]</span><br><span class=\"line\">HELP                       打印帮助信息</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>执行以下命令，切换到 /dm8/bin 目录。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /mnt/dmdba/dmdata/bin</span><br><span class=\"line\">./dminit PATH=/mnt/dmdba/dmdata/ PAGE_SIZE=32 EXTENT_SIZE=32 CASE_SENSITIVE=0 LENGTH_IN_CHAR=1 CHARSET=1</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>注意</p>\n<p>初始化参数中除了 path 参数必须指定，其它参数都有默认值，如果需求与默认值不同，初始化的时候请指定需要的值。因为部分参数初始化后是无法修改的例如：page_size（页大小），charset（字符集），case_sensitive（大小写敏感）等。更多参数<code>./dminit help</code> 查看，是否无法修改的参数可以查询 v$dm_ini 视图，para_type=’READ ONLY’ 表示无法修改。</p>\n</blockquote>\n<h3 id=\"启动数据库\"><a href=\"#启动数据库\" class=\"headerlink\" title=\"启动数据库\"></a><strong>启动数据库</strong></h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb01 bin]$ ./dmserver /mnt/dmdba/dmdata/DAMENG/dm.ini</span><br><span class=\"line\">file dm.key not found, use default license!</span><br><span class=\"line\">\tversion info: develop</span><br><span class=\"line\">\tDM Database Server x64 V8 1-2-84-21.10.21-149328-10032-ENT  startup...</span><br><span class=\"line\">\tNormal of FAST</span><br><span class=\"line\">\tNormal of DEFAULT</span><br><span class=\"line\">\tNormal of RECYCLE</span><br><span class=\"line\">\tNormal of KEEP</span><br><span class=\"line\">\tNormal of ROLL</span><br><span class=\"line\">\tDatabase mode = 0, oguid = 0</span><br><span class=\"line\">\tLicense will expire on 2022-10-21</span><br><span class=\"line\">\tfile lsn: 28025</span><br><span class=\"line\">\tndct db load finished</span><br><span class=\"line\">\tndct second level fill fast pool finished</span><br><span class=\"line\">\tndct third level fill fast pool finished</span><br><span class=\"line\">\tndct fill fast pool finished</span><br><span class=\"line\">\tiid page&#x27;s trxid[5010]</span><br><span class=\"line\">\tNEXT TRX ID = 5011</span><br><span class=\"line\">\tpseg_collect_mgr_items, total collect 0 active_trxs, 0 cmt_trxs, 0 pre_cmt_trxs, 0 active_pages, 0 cmt_pages, 0 pre_cmt_pages, 0 mgr pages, 0 mgr recs!</span><br><span class=\"line\">\tiid page&#x27;s trxid[6012]</span><br><span class=\"line\">\tNEXT TRX ID = 7014.</span><br><span class=\"line\">\ttotal 0 active crash trx, pseg_crash_trx_rollback sys_only(0) begin ...</span><br><span class=\"line\">\tpseg_crash_trx_rollback end, total 0 active crash trx, include 0 empty_trxs, 0 empty_pages which only need to delete mgr recs.</span><br><span class=\"line\">\tpseg_crash_trx_rollback end</span><br><span class=\"line\">\tpseg recv finished</span><br><span class=\"line\">\tnsvr_startup end.</span><br><span class=\"line\">\taud sys init success.</span><br><span class=\"line\">\taud rt sys init success.</span><br><span class=\"line\">\tsystables desc init success.</span><br><span class=\"line\">\tndct_db_load_info success.</span><br><span class=\"line\">\tnsvr_process_before_open begin.</span><br><span class=\"line\">\tnsvr_process_before_open success.</span><br><span class=\"line\">\ttotal 0 active crash trx, pseg_crash_trx_rollback sys_only(0) begin ...</span><br><span class=\"line\">\tpseg_crash_trx_rollback end, total 0 active crash trx, include 0 empty_trxs, 0 empty_pages which only need to delete mgr recs.</span><br><span class=\"line\">\tpseg_crash_trx_rollback end</span><br><span class=\"line\">\tSYSTEM IS READY.</span><br><span class=\"line\">\texit</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"主节点上脱机备份\"><a href=\"#主节点上脱机备份\" class=\"headerlink\" title=\"主节点上脱机备份\"></a>主节点上脱机备份</h3><p>如果备份过程中出现错误，通过ps -ef | grep dmap查看dmap服务是否在运行中<br>如果不在运行中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb01 ~]$ cd /mnt/dmdba/dmdata/bin</span><br><span class=\"line\"></span><br><span class=\"line\">[dmdba@prddb01 bin]$ ./DmAPService start</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"主节点备份\"><a href=\"#主节点备份\" class=\"headerlink\" title=\"主节点备份\"></a>主节点备份</h3><p>主节点：192.168.118.18</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /mnt/dmdba/dmdata/bin   #dmdba用户</span><br><span class=\"line\">[dmdba@prddb01 bin]$ ./dmrman</span><br><span class=\"line\">dmrman V8</span><br><span class=\"line\">RMAN&gt; backup database &#x27;/mnt/dmdba/dmdata/DAMENG/dm.ini&#x27; full to backup_file1 backupset &#x27;/mnt/dmdba/dmdata/DAMENG/backup01&#x27;        </span><br><span class=\"line\">backup database &#x27;/mnt/dmdba/dmdata/DAMENG/dm.ini&#x27; full to backup_file1 backupset &#x27;/mnt/dmdba/dmdata/DAMENG/backup01&#x27;</span><br><span class=\"line\">file dm.key not found, use default license!</span><br><span class=\"line\">Database mode = 0, oguid = 0</span><br><span class=\"line\">Normal of FAST</span><br><span class=\"line\">Normal of DEFAULT</span><br><span class=\"line\">Normal of RECYCLE</span><br><span class=\"line\">Normal of KEEP</span><br><span class=\"line\">Normal of ROLL</span><br><span class=\"line\">EP[0]&#x27;s cur_lsn[30600], file_lsn[30600]</span><br><span class=\"line\">Processing backupset /mnt/dmdba/dmdata/DAMENG/backup01</span><br><span class=\"line\">[Percent:100.00%][Speed:0.00M/s][Cost:00:00:00][Remaining:00:00:00]                                 </span><br><span class=\"line\">backup successfully!</span><br><span class=\"line\">time used: 00:00:01.052</span><br><span class=\"line\">RMAN&gt; </span><br></pre></td></tr></table></figure>\n\n<h4 id=\"打开另一窗口-dmdba用户-：\"><a href=\"#打开另一窗口-dmdba用户-：\" class=\"headerlink\" title=\"打开另一窗口(dmdba用户)：\"></a>打开另一窗口(dmdba用户)：</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">scp -r /mnt/dmdba/dmdata/DAMENG/backup01 dmdba@192.168.118.19:/mnt/dmdba/dmdata/DAMENG/</span><br><span class=\"line\">scp -r /mnt/dmdba/dmdata/DAMENG/backup01 dmdba@192.168.118.20:/mnt/dmdba/dmdata/DAMENG/</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"从节点还原\"><a href=\"#从节点还原\" class=\"headerlink\" title=\"从节点还原\"></a>从节点还原</h3><h4 id=\"从节点：192-168-118-19\"><a href=\"#从节点：192-168-118-19\" class=\"headerlink\" title=\"从节点：192.168.118.19\"></a>从节点：192.168.118.19</h4><p><strong>执行 recover。</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /mnt/dmdba/dmdata/bin  #dmdba用户                    </span><br><span class=\"line\">  [dmdba@db-0001 bin]$ ./dmrman</span><br><span class=\"line\">  dmrman V8</span><br><span class=\"line\">  RMAN&gt; restore database &#x27;/mnt/dmdba/dmdata/DAMENG/dm.ini&#x27; from backupset &#x27;/mnt/dmdba/dmdata/DAMENG/backup01&#x27;</span><br><span class=\"line\">  restore database &#x27;/mnt/dmdba/dmdata/DAMENG/dm.ini&#x27; from backupset &#x27;/mnt/dmdba/dmdata/DAMENG/backup01&#x27;</span><br><span class=\"line\">  file dm.key not found, use default license!</span><br><span class=\"line\">  Normal of FAST</span><br><span class=\"line\">  Normal of DEFAULT</span><br><span class=\"line\">  Normal of RECYCLE</span><br><span class=\"line\">  Normal of KEEP</span><br><span class=\"line\">  Normal of ROLL</span><br><span class=\"line\">  [Percent:100.00%][Speed:0.00M/s][Cost:00:00:02][Remaining:00:00:00]                                 </span><br><span class=\"line\">  restore successfully.</span><br><span class=\"line\">  time used: 00:00:02.396</span><br><span class=\"line\">  RMAN&gt; recover database &#x27;/mnt/dmdba/dmdata/DAMENG/dm.ini&#x27; from backupset &#x27;/mnt/dmdba/dmdata/DAMENG/backup01&#x27;</span><br><span class=\"line\">  recover database &#x27;/mnt/dmdba/dmdata/DAMENG/dm.ini&#x27; from backupset &#x27;/mnt/dmdba/dmdata/DAMENG/backup01&#x27;</span><br><span class=\"line\">  Database mode = 0, oguid = 0</span><br><span class=\"line\">  Normal of FAST</span><br><span class=\"line\">  Normal of DEFAULT</span><br><span class=\"line\">  Normal of RECYCLE</span><br><span class=\"line\">  Normal of KEEP</span><br><span class=\"line\">  Normal of ROLL</span><br><span class=\"line\">  EP[0]&#x27;s cur_lsn[30600], file_lsn[30600]</span><br><span class=\"line\">  备份集[/mnt/dmdba/dmdata/DAMENG/backup01]备份过程中未产生日志</span><br><span class=\"line\">  recover successfully!</span><br><span class=\"line\">  time used: 246.930(ms)</span><br><span class=\"line\">  RMAN&gt; recover database &#x27;/mnt/dmdba/dmdata/DAMENG/dm.ini&#x27; update db_magic</span><br><span class=\"line\">  recover database &#x27;/mnt/dmdba/dmdata/DAMENG/dm.ini&#x27; update db_magic</span><br><span class=\"line\">  Database mode = 0, oguid = 0</span><br><span class=\"line\">  Normal of FAST</span><br><span class=\"line\">  Normal of DEFAULT</span><br><span class=\"line\">  Normal of RECYCLE</span><br><span class=\"line\">  Normal of KEEP</span><br><span class=\"line\">  Normal of ROLL</span><br><span class=\"line\">  EP[0]&#x27;s cur_lsn[30600], file_lsn[30600]</span><br><span class=\"line\">  recover successfully!</span><br><span class=\"line\">  time used: 991.310(ms)</span><br><span class=\"line\">  RMAN&gt; </span><br></pre></td></tr></table></figure>\n\n<p>  <strong>执行 recover update db_magic。</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">recover database &#x27;/mnt/dmdba/dmdata/DAMENG/dm.ini&#x27; update db_magic;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"从节点：192-168-118-20\"><a href=\"#从节点：192-168-118-20\" class=\"headerlink\" title=\"从节点：192.168.118.20\"></a>从节点：192.168.118.20</h4><p><strong>执行 recover。</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /mnt/dmdba/dmdata/bin  #dmdba用户                    </span><br><span class=\"line\">  [dmdba@db-0001 bin]$ ./dmrman</span><br><span class=\"line\">  dmrman V8</span><br><span class=\"line\">  RMAN&gt; restore database &#x27;/mnt/dmdba/dmdata/DAMENG/dm.ini&#x27; from backupset &#x27;/mnt/dmdba/dmdata/DAMENG/backup01&#x27;</span><br><span class=\"line\">  restore database &#x27;/mnt/dmdba/dmdata/DAMENG/dm.ini&#x27; from backupset &#x27;/mnt/dmdba/dmdata/DAMENG/backup01&#x27;</span><br><span class=\"line\">  file dm.key not found, use default license!</span><br><span class=\"line\">  Normal of FAST</span><br><span class=\"line\">  Normal of DEFAULT</span><br><span class=\"line\">  Normal of RECYCLE</span><br><span class=\"line\">  Normal of KEEP</span><br><span class=\"line\">  Normal of ROLL</span><br><span class=\"line\">  [Percent:100.00%][Speed:0.00M/s][Cost:00:00:02][Remaining:00:00:00]                                 </span><br><span class=\"line\">  restore successfully.</span><br><span class=\"line\">  time used: 00:00:02.396</span><br><span class=\"line\">  RMAN&gt; recover database &#x27;/mnt/dmdba/dmdata/DAMENG/dm.ini&#x27; from backupset &#x27;/mnt/dmdba/dmdata/DAMENG/backup01&#x27;</span><br><span class=\"line\">  recover database &#x27;/mnt/dmdba/dmdata/DAMENG/dm.ini&#x27; from backupset &#x27;/mnt/dmdba/dmdata/DAMENG/backup01&#x27;</span><br><span class=\"line\">  Database mode = 0, oguid = 0</span><br><span class=\"line\">  Normal of FAST</span><br><span class=\"line\">  Normal of DEFAULT</span><br><span class=\"line\">  Normal of RECYCLE</span><br><span class=\"line\">  Normal of KEEP</span><br><span class=\"line\">  Normal of ROLL</span><br><span class=\"line\">  EP[0]&#x27;s cur_lsn[30600], file_lsn[30600]</span><br><span class=\"line\">  备份集[/mnt/dmdba/dmdata/DAMENG/backup01]备份过程中未产生日志</span><br><span class=\"line\">  recover successfully!</span><br><span class=\"line\">  time used: 246.930(ms)</span><br><span class=\"line\">  RMAN&gt; recover database &#x27;/mnt/dmdba/dmdata/DAMENG/dm.ini&#x27; update db_magic</span><br><span class=\"line\">  recover database &#x27;/mnt/dmdba/dmdata/DAMENG/dm.ini&#x27; update db_magic</span><br><span class=\"line\">  Database mode = 0, oguid = 0</span><br><span class=\"line\">  Normal of FAST</span><br><span class=\"line\">  Normal of DEFAULT</span><br><span class=\"line\">  Normal of RECYCLE</span><br><span class=\"line\">  Normal of KEEP</span><br><span class=\"line\">  Normal of ROLL</span><br><span class=\"line\">  EP[0]&#x27;s cur_lsn[30600], file_lsn[30600]</span><br><span class=\"line\">  recover successfully!</span><br><span class=\"line\">  time used: 991.310(ms)</span><br><span class=\"line\">  RMAN&gt; </span><br></pre></td></tr></table></figure>\n\n<p>  <strong>执行 recover update db_magic。</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">recover database &#x27;/mnt/dmdba/dmdata/DAMENG/dm.ini&#x27; update db_magic;</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"主节点配置192-168-118-18\"><a href=\"#主节点配置192-168-118-18\" class=\"headerlink\" title=\"主节点配置192.168.118.18\"></a>主节点配置192.168.118.18</h2><h3 id=\"修改dm-ini\"><a href=\"#修改dm-ini\" class=\"headerlink\" title=\"修改dm.ini\"></a>修改dm.ini</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dm.ini</span><br><span class=\"line\"></span><br><span class=\"line\">#修改如下参数</span><br><span class=\"line\"></span><br><span class=\"line\">INSTANCE_NAME  = DMSERVER01</span><br><span class=\"line\"></span><br><span class=\"line\">PORT_NUM  = 5236                      #数据库实例监听端口</span><br><span class=\"line\"></span><br><span class=\"line\">DW_INACTIVE_INTERVAL  = 60       #接收守护进程消息超时时间</span><br><span class=\"line\"></span><br><span class=\"line\">ALTER_MODE_STATUS  = 0             #不允许手工方式修改实例模式/状态/OGUID</span><br><span class=\"line\"></span><br><span class=\"line\">ENABLE_OFFLINE_TS  = 2         #不允许备库 OFFLINE 表空间</span><br><span class=\"line\"></span><br><span class=\"line\">MAL_INI = 1                       #打开 MAL 系统</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_INI  = 1                         #打开归档配置</span><br><span class=\"line\"></span><br><span class=\"line\">RLOG_SEND_APPLY_MON = 64        #统计最近 64 次的日志发送信息</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"修改dmmal-ini-创建这个文件，内容如下，主备库文件内容要相同\"><a href=\"#修改dmmal-ini-创建这个文件，内容如下，主备库文件内容要相同\" class=\"headerlink\" title=\"修改dmmal.ini(创建这个文件，内容如下，主备库文件内容要相同)\"></a>修改dmmal.ini(创建这个文件，内容如下，主备库文件内容要相同)</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmmal.ini</span><br><span class=\"line\"></span><br><span class=\"line\">MAL_CHECK_INTERVAL =  5  #MAL 链路检测时间间隔 </span><br><span class=\"line\">MAL_CONN_FAIL_INTERVAL =  5  #判定 MAL 链路断开的时间 </span><br><span class=\"line\">[MAL_INST1]</span><br><span class=\"line\">MAL_INST_NAME  =  DMSERVER01  #实例名&amp;#xff0c;和 dm.ini 中的 INSTANCE_NAME 一致 </span><br><span class=\"line\">MAL_HOST  =  192.168.118.18 #MAL 系统监听 TCP 连接的 IP 地址 </span><br><span class=\"line\">MAL_PORT  = 61141  #MAL 系统监听 TCP 连接的端口 </span><br><span class=\"line\">MAL_INST_HOST  =  192.168.118.18  #实例的对外服务 IP 地址 </span><br><span class=\"line\">MAL_INST_PORT  =  5236  #实例的对外服务端口&amp;#xff0c;和 dm.ini 中的 PORT_NUM 一致 </span><br><span class=\"line\">MAL_DW_PORT =  52141  #实例对应的守护进程监听 TCP 连接的端口 </span><br><span class=\"line\">MAL_INST_DW_PORT  =  33141  #实例监听守护进程 TCP 连接的端口 </span><br><span class=\"line\">[MAL_INST2]</span><br><span class=\"line\">MAL_INST_NAME =  DMSERVER02</span><br><span class=\"line\">MAL_HOST =  192.168.118.19</span><br><span class=\"line\">MAL_PORT =  61142</span><br><span class=\"line\">MAL_INST_HOST =  192.168.118.19</span><br><span class=\"line\">MAL_INST_PORT =  5236</span><br><span class=\"line\">MAL_DW_PORT =  52142</span><br><span class=\"line\">MAL_INST_DW_PORT  =  33142</span><br><span class=\"line\">[MAL_INST3]</span><br><span class=\"line\">MAL_INST_NAME =  DMSERVER03</span><br><span class=\"line\">MAL_HOST =  192.168.118.20</span><br><span class=\"line\">MAL_PORT  = 61143</span><br><span class=\"line\">MAL_INST_HOST =  192.168.118.20</span><br><span class=\"line\">MAL_INST_PORT  = 5236</span><br><span class=\"line\">MAL_DW_PORT =  52143</span><br><span class=\"line\">MAL_INST_DW_PORT  =  33143</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"配置dmarch-ini文件-创建这个文件，内容如下\"><a href=\"#配置dmarch-ini文件-创建这个文件，内容如下\" class=\"headerlink\" title=\"配置dmarch.ini文件(创建这个文件，内容如下)\"></a>配置dmarch.ini文件(创建这个文件，内容如下)</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmarch.ini</span><br><span class=\"line\"></span><br><span class=\"line\">[ARCHIVE_TIMELY1]</span><br><span class=\"line\">  </span><br><span class=\"line\">ARCH_TYPE = TIMELY       #即时归档类型</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_DEST = DMSERVER02  #即时归档目标实例名</span><br><span class=\"line\"></span><br><span class=\"line\">[ARCHIVE_TIMELY2]</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_TYPE = TIMELY       #即时归档类型</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_DEST = DMSERVER03  #即时归档目标实例名</span><br><span class=\"line\"></span><br><span class=\"line\">[ARCHIVE_LOCAL1]</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_TYPE = LOCAL        #本地归档类型</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_DEST = /mnt/dmdba/dmdata/DAMENG/arch #本地归档文件存放路径</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_FILE_SIZE = 128     #单位 Mb，本地单个归档文件最大值</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_SPACE_LIMIT  = 10240    #单位 Mb，0 表示无限制，范围 1024~4294967294M</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"配置dmwatcher-ini文件-创建这个文件，内容如下，主备库文件内容要相同\"><a href=\"#配置dmwatcher-ini文件-创建这个文件，内容如下，主备库文件内容要相同\" class=\"headerlink\" title=\"配置dmwatcher.ini文件(创建这个文件，内容如下，主备库文件内容要相同)\"></a>配置dmwatcher.ini文件(创建这个文件，内容如下，主备库文件内容要相同)</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmwatcher.ini</span><br><span class=\"line\"></span><br><span class=\"line\">[GRP1]</span><br><span class=\"line\">  </span><br><span class=\"line\">DW_TYPE = GLOBAL          #全局守护类型</span><br><span class=\"line\"></span><br><span class=\"line\">DW_MODE = AUTO                  #自动切换模式</span><br><span class=\"line\"></span><br><span class=\"line\">DW_ERROR_TIME = 10      #远程守护进程故障认定时间</span><br><span class=\"line\"></span><br><span class=\"line\">INST_RECOVER_TIME = 60 #主库守护进程启动恢复的间隔时间</span><br><span class=\"line\"></span><br><span class=\"line\">INST_ERROR_TIME = 10     #本地实例故障认定时间</span><br><span class=\"line\"></span><br><span class=\"line\">INST_OGUID = 453332      #守护系统唯一 OGUID 值</span><br><span class=\"line\"></span><br><span class=\"line\">INST_INI = /mnt/dmdba/dmdata/DAMENG/dm.ini  #dm.ini 配置文件路径</span><br><span class=\"line\"></span><br><span class=\"line\">INST_AUTO_RESTART = 1   #打开实例的自动启动功能</span><br><span class=\"line\"></span><br><span class=\"line\">INST_STARTUP_CMD = /mnt/dmdba/dmdata/bin/dmserver    #命令行方式启动</span><br><span class=\"line\"></span><br><span class=\"line\">RLOG_SEND_THRESHOLD = 0   #指定主库发送日志到备库的时间阈值，默认关闭</span><br><span class=\"line\"></span><br><span class=\"line\">RLOG_APPLY_THRESHOLD = 0 #指定备库重演日志的时间阈值，默认关闭</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"开启主节点\"><a href=\"#开启主节点\" class=\"headerlink\" title=\"开启主节点\"></a>开启主节点</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb01 bin]$  ./dmserver ../DAMENG/dm.ini mount</span><br><span class=\"line\">file dm.key not found, use default license!</span><br><span class=\"line\">\tversion info: develop</span><br><span class=\"line\">\tDM Database Server x64 V8 1-2-84-21.10.21-149328-10032-ENT  startup...</span><br><span class=\"line\">\tNormal of FAST</span><br><span class=\"line\">\tNormal of DEFAULT</span><br><span class=\"line\">\tNormal of RECYCLE</span><br><span class=\"line\">\tNormal of KEEP</span><br><span class=\"line\">\tNormal of ROLL</span><br><span class=\"line\">\tDatabase mode = 0, oguid = 0</span><br><span class=\"line\">\tLicense will expire on 2022-10-21</span><br><span class=\"line\">\tfile lsn: 30600</span><br><span class=\"line\">\tndct db load finished</span><br><span class=\"line\">\tndct second level fill fast pool finished</span><br><span class=\"line\">\tndct third level fill fast pool finished</span><br><span class=\"line\">\tndct fill fast pool finished</span><br><span class=\"line\">\tnsvr_startup end.</span><br><span class=\"line\">\taud sys init success.</span><br><span class=\"line\">\taud rt sys init success.</span><br><span class=\"line\">\tsystables desc init success.</span><br><span class=\"line\">\tndct_db_load_info success.</span><br><span class=\"line\">\tSYSTEM IS READY.</span><br><span class=\"line\">\tcheckpoint requested, rlog free space[536862720], used space[0]</span><br><span class=\"line\">\tcheckpoint generate by ckpt_interval</span><br><span class=\"line\">\tcheckpoint begin, used_space[0], free_space[536862720]...</span><br><span class=\"line\">\tcheckpoint end, 0 pages flushed, used_space[0], free_space[536862720].</span><br><span class=\"line\">\tcheckpoint requested by CKPT_INTERVAL, rlog free space[536862720], used space[0]</span><br><span class=\"line\">\tcheckpoint generate by ckpt_interval</span><br><span class=\"line\">\tcheckpoint begin, used_space[0], free_space[536862720]...</span><br><span class=\"line\">\tcheckpoint end, 0 pages flushed, used_space[0], free_space[536862720].</span><br></pre></td></tr></table></figure>\n\n<p><strong>一直到显示SYSTEM IS READY启动完成。此时不要关闭这个窗口，重新在主服务器上开启一个窗口。</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@prddb01 ~]# su - dmdba</span><br><span class=\"line\">[dmdba@prddb01 ~]$ cd /mnt/dmdba/dmdata/bin</span><br><span class=\"line\">[dmdba@prddb01 bin]$ ./disql SYSDBA/SYSDBA@localhost:5236</span><br><span class=\"line\">服务器[localhost:5236]:处于主库打开状态</span><br><span class=\"line\">登录使用时间 : 1.616(ms)</span><br><span class=\"line\">上次登录ip       : ::ffff:192.168.118.18</span><br><span class=\"line\">上次登录时间   : 2022-05-29 22:55:12</span><br><span class=\"line\">登录失败次数   : 0</span><br><span class=\"line\">口令是否过期   : 未过期</span><br><span class=\"line\">disql V8</span><br><span class=\"line\">SQL&gt;sp_set_para_value(1,&#x27;ALTER_MODE_STATUS&#x27;,1);</span><br><span class=\"line\">DMSQL 过程已成功完成</span><br><span class=\"line\">已用时间: 4.570(毫秒). 执行号:0.</span><br><span class=\"line\">SQL&gt; sp_set_oguid(453332);</span><br><span class=\"line\">DMSQL 过程已成功完成</span><br><span class=\"line\">已用时间: 5.223(毫秒). 执行号:1.</span><br><span class=\"line\">SQL&gt; sp_set_para_value(1,&#x27;ALTER_MODE_STATUS&#x27;,0);</span><br><span class=\"line\">DMSQL 过程已成功完成</span><br><span class=\"line\">已用时间: 4.021(毫秒). 执行号:2.</span><br><span class=\"line\">SQL&gt; alter database primary;</span><br><span class=\"line\">操作已执行</span><br><span class=\"line\">已用时间: 8.797(毫秒). 执行号:0.</span><br></pre></td></tr></table></figure>\n\n<p><strong>主节点：192.168.118.18 打开另一窗口(root用户)</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@prddb01 ~]# cd /mnt/dmdba/dmdata/script/root</span><br><span class=\"line\"># 注册数据库实例服务</span><br><span class=\"line\">./dm_service_installer.sh -t dmserver -dm_ini /mnt/dmdba/dmdata/DAMENG/dm.ini -m mount -p DMSERVER01</span><br><span class=\"line\"># 注册守护进程服务</span><br><span class=\"line\">./dm_service_installer.sh -t dmwatcher -watcher_ini /mnt/dmdba/dmdata/DAMENG/dmwatcher.ini -p DMSERVER01</span><br><span class=\"line\"></span><br><span class=\"line\">以服务方式启动</span><br><span class=\"line\">[root@prddb01 ~]# cd /mnt/dmdba/dmdata/bin</span><br><span class=\"line\">[root@prddb01 bin]# ./DmServiceDMSERVER01 start # 启动数据库实例</span><br><span class=\"line\">[root@prddb01 bin]# ./DmWatcherServiceDMSERVER01 start #启动守护进程</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"从节点配置192-168-118-19\"><a href=\"#从节点配置192-168-118-19\" class=\"headerlink\" title=\"从节点配置192.168.118.19\"></a>从节点配置192.168.118.19</h2><h3 id=\"修改dm-ini-1\"><a href=\"#修改dm-ini-1\" class=\"headerlink\" title=\"修改dm.ini\"></a>修改dm.ini</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dm.ini</span><br><span class=\"line\"></span><br><span class=\"line\">#修改如下参数</span><br><span class=\"line\"></span><br><span class=\"line\">INSTANCE_NAME  = DMSERVER02</span><br><span class=\"line\"></span><br><span class=\"line\">PORT_NUM  = 5236                      #数据库实例监听端口</span><br><span class=\"line\"></span><br><span class=\"line\">DW_INACTIVE_INTERVAL  = 60       #接收守护进程消息超时时间</span><br><span class=\"line\"></span><br><span class=\"line\">ALTER_MODE_STATUS  = 0             #不允许手工方式修改实例模式/状态/OGUID</span><br><span class=\"line\"></span><br><span class=\"line\">ENABLE_OFFLINE_TS  = 2         #不允许备库 OFFLINE 表空间</span><br><span class=\"line\"></span><br><span class=\"line\">MAL_INI = 1                       #打开 MAL 系统</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_INI  = 1                         #打开归档配置</span><br><span class=\"line\"></span><br><span class=\"line\">RLOG_SEND_APPLY_MON = 64        #统计最近 64 次的日志发送信息</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"修改dmmal-ini-创建这个文件，内容如下，主备库文件内容要相同-1\"><a href=\"#修改dmmal-ini-创建这个文件，内容如下，主备库文件内容要相同-1\" class=\"headerlink\" title=\"修改dmmal.ini(创建这个文件，内容如下，主备库文件内容要相同)\"></a>修改dmmal.ini(创建这个文件，内容如下，主备库文件内容要相同)</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmmal.ini</span><br><span class=\"line\"></span><br><span class=\"line\">MAL_CHECK_INTERVAL =  5  #MAL 链路检测时间间隔 </span><br><span class=\"line\">MAL_CONN_FAIL_INTERVAL =  5  #判定 MAL 链路断开的时间 </span><br><span class=\"line\">[MAL_INST1]</span><br><span class=\"line\">MAL_INST_NAME  =  DMSERVER01  #实例名&amp;#xff0c;和 dm.ini 中的 INSTANCE_NAME 一致 </span><br><span class=\"line\">MAL_HOST  =  192.168.118.18 #MAL 系统监听 TCP 连接的 IP 地址 </span><br><span class=\"line\">MAL_PORT  = 61141  #MAL 系统监听 TCP 连接的端口 </span><br><span class=\"line\">MAL_INST_HOST  =  192.168.118.18  #实例的对外服务 IP 地址 </span><br><span class=\"line\">MAL_INST_PORT  =  5236  #实例的对外服务端口&amp;#xff0c;和 dm.ini 中的 PORT_NUM 一致 </span><br><span class=\"line\">MAL_DW_PORT =  52141  #实例对应的守护进程监听 TCP 连接的端口 </span><br><span class=\"line\">MAL_INST_DW_PORT  =  33141  #实例监听守护进程 TCP 连接的端口 </span><br><span class=\"line\">[MAL_INST2]</span><br><span class=\"line\">MAL_INST_NAME =  DMSERVER02</span><br><span class=\"line\">MAL_HOST =  192.168.118.19</span><br><span class=\"line\">MAL_PORT =  61142</span><br><span class=\"line\">MAL_INST_HOST =  192.168.118.19</span><br><span class=\"line\">MAL_INST_PORT =  5236</span><br><span class=\"line\">MAL_DW_PORT =  52142</span><br><span class=\"line\">MAL_INST_DW_PORT  =  33142</span><br><span class=\"line\">[MAL_INST3]</span><br><span class=\"line\">MAL_INST_NAME =  DMSERVER03</span><br><span class=\"line\">MAL_HOST =  192.168.118.20</span><br><span class=\"line\">MAL_PORT  = 61143</span><br><span class=\"line\">MAL_INST_HOST =  192.168.118.20</span><br><span class=\"line\">MAL_INST_PORT  = 5236</span><br><span class=\"line\">MAL_DW_PORT =  52143</span><br><span class=\"line\">MAL_INST_DW_PORT  =  33143</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"配置dmarch-ini文件-创建这个文件，内容如下-1\"><a href=\"#配置dmarch-ini文件-创建这个文件，内容如下-1\" class=\"headerlink\" title=\"配置dmarch.ini文件(创建这个文件，内容如下)\"></a>配置dmarch.ini文件(创建这个文件，内容如下)</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmarch.ini</span><br><span class=\"line\"></span><br><span class=\"line\">[ARCHIVE_TIMELY1]</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_TYPE = TIMELY       #即时归档类型</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_DEST = DMSERVER01  #即时归档目标实例名</span><br><span class=\"line\"></span><br><span class=\"line\">[ARCHIVE_TIMELY2]</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_TYPE = TIMELY       #即时归档类型</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_DEST = DMSERVER03  #即时归档目标实例名</span><br><span class=\"line\"></span><br><span class=\"line\">[ARCHIVE_LOCAL1]</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_TYPE = LOCAL        #本地归档类型</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_DEST = /mnt/dmdba/dmdata/DAMENG/arch #本地归档文件存放路径</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_FILE_SIZE = 128     #单位 Mb，本地单个归档文件最大值</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_SPACE_LIMIT  = 10240    #单位 Mb，0 表示无限制，范围 1024~4294967294M</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"配置dmwatcher-ini文件-创建这个文件，内容如下，主备库文件内容要相同-1\"><a href=\"#配置dmwatcher-ini文件-创建这个文件，内容如下，主备库文件内容要相同-1\" class=\"headerlink\" title=\"配置dmwatcher.ini文件(创建这个文件，内容如下，主备库文件内容要相同)\"></a>配置dmwatcher.ini文件(创建这个文件，内容如下，主备库文件内容要相同)</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmwatcher.ini</span><br><span class=\"line\"></span><br><span class=\"line\">[GRP1]</span><br><span class=\"line\">  </span><br><span class=\"line\">DW_TYPE = GLOBAL          #全局守护类型</span><br><span class=\"line\"></span><br><span class=\"line\">DW_MODE = AUTO                  #自动切换模式</span><br><span class=\"line\"></span><br><span class=\"line\">DW_ERROR_TIME = 10      #远程守护进程故障认定时间</span><br><span class=\"line\"></span><br><span class=\"line\">INST_RECOVER_TIME = 60 #主库守护进程启动恢复的间隔时间</span><br><span class=\"line\"></span><br><span class=\"line\">INST_ERROR_TIME = 10     #本地实例故障认定时间</span><br><span class=\"line\"></span><br><span class=\"line\">INST_OGUID = 453332      #守护系统唯一 OGUID 值</span><br><span class=\"line\"></span><br><span class=\"line\">INST_INI = /mnt/dmdba/dmdata/DAMENG/dm.ini  #dm.ini 配置文件路径</span><br><span class=\"line\"></span><br><span class=\"line\">INST_AUTO_RESTART = 1   #打开实例的自动启动功能</span><br><span class=\"line\"></span><br><span class=\"line\">INST_STARTUP_CMD = /mnt/dmdba/dmdata/bin/dmserver    #命令行方式启动</span><br><span class=\"line\"></span><br><span class=\"line\">RLOG_SEND_THRESHOLD = 0   #指定主库发送日志到备库的时间阈值，默认关闭</span><br><span class=\"line\"></span><br><span class=\"line\">RLOG_APPLY_THRESHOLD = 0 #指定备库重演日志的时间阈值，默认关闭</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"配置dmmonitor-ini文件监视服务器-创建这个文件，内容如下\"><a href=\"#配置dmmonitor-ini文件监视服务器-创建这个文件，内容如下\" class=\"headerlink\" title=\"配置dmmonitor.ini文件监视服务器(创建这个文件，内容如下)\"></a>配置dmmonitor.ini文件监视服务器(创建这个文件，内容如下)</h3><p><strong>监视器只在prddb02配置</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@prddb02 ~]# vim /mnt/dmdba/dmdata/DAMENG/dmmonitor.ini</span><br><span class=\"line\"></span><br><span class=\"line\">MON_DW_CONFIRM    = 0   #1.确认监视器模式 0.非确认监视模式</span><br><span class=\"line\">MON_LOG_PATH    = /mnt/dmdba/dmdata/log #监视器日志文件存放路径</span><br><span class=\"line\">MON_LOG_INTERVAL  = 60 #每隔 60 s 定时记录系统信息到日志文件</span><br><span class=\"line\">MON_LOG_FILE_SIZE   = 32 #每个日志文件最大 32 MB</span><br><span class=\"line\">MON_LOG_SPACE_LIMIT  = 0  #不限定日志文件总占用空间</span><br><span class=\"line\">[GRP1]</span><br><span class=\"line\"> MON_INST_OGUID    = 453332 #组 GRP_RW 的唯一 OGUID 值</span><br><span class=\"line\">#以下配置为监视器到组 GRP_RW 的守护进程的连接信息，以“IP:PORT”的形式配置</span><br><span class=\"line\">#IP 对应 dmmal.ini 中的 MAL_HOST，PORT 对应 dmmal.ini 中的 MAL_DW_PORT</span><br><span class=\"line\">MON_DW_IP = 192.168.118.18:52141</span><br><span class=\"line\">MON_DW_IP = 192.168.118.19:52142</span><br><span class=\"line\">MON_DW_IP = 192.168.118.20:52143</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"开启从节点\"><a href=\"#开启从节点\" class=\"headerlink\" title=\"开启从节点\"></a>开启从节点</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb02 bin]$  ./dmserver ../DAMENG/dm.ini mount</span><br><span class=\"line\">file dm.key not found, use default license!</span><br><span class=\"line\">\tversion info: develop</span><br><span class=\"line\">\tDM Database Server x64 V8 1-2-84-21.10.21-149328-10032-ENT  startup...</span><br><span class=\"line\">\tNormal of FAST</span><br><span class=\"line\">\tNormal of DEFAULT</span><br><span class=\"line\">\tNormal of RECYCLE</span><br><span class=\"line\">\tNormal of KEEP</span><br><span class=\"line\">\tNormal of ROLL</span><br><span class=\"line\">\tDatabase mode = 0, oguid = 0</span><br><span class=\"line\">\tLicense will expire on 2022-10-21</span><br><span class=\"line\">\tfile lsn: 30600</span><br><span class=\"line\">\tndct db load finished</span><br><span class=\"line\">\tndct second level fill fast pool finished</span><br><span class=\"line\">\tndct third level fill fast pool finished</span><br><span class=\"line\">\tndct fill fast pool finished</span><br><span class=\"line\">\tnsvr_startup end.</span><br><span class=\"line\">\taud sys init success.</span><br><span class=\"line\">\taud rt sys init success.</span><br><span class=\"line\">\tsystables desc init success.</span><br><span class=\"line\">\tndct_db_load_info success.</span><br><span class=\"line\">\tSYSTEM IS READY.</span><br><span class=\"line\">\tcheckpoint requested, rlog free space[536862720], used space[0]</span><br><span class=\"line\">\tcheckpoint generate by ckpt_interval</span><br><span class=\"line\">\tcheckpoint begin, used_space[0], free_space[536862720]...</span><br><span class=\"line\">\tcheckpoint end, 0 pages flushed, used_space[0], free_space[536862720].</span><br><span class=\"line\">\tcheckpoint requested by CKPT_INTERVAL, rlog free space[536862720], used space[0]</span><br><span class=\"line\">\tcheckpoint generate by ckpt_interval</span><br><span class=\"line\">\tcheckpoint begin, used_space[0], free_space[536862720]...</span><br><span class=\"line\">\tcheckpoint end, 0 pages flushed, used_space[0], free_space[536862720].</span><br></pre></td></tr></table></figure>\n\n<p><strong>一直到显示SYSTEM IS READY启动完成。此时不要关闭这个窗口，重新在主服务器上开启一个窗口。</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@prddb02 ~]# su - dmdba</span><br><span class=\"line\">[dmdba@prddb02 ~]$ cd /mnt/dmdba/dmdata/bin</span><br><span class=\"line\">[dmdba@prddb02 bin]$ ./disql SYSDBA/SYSDBA@localhost:5236</span><br><span class=\"line\">服务器[localhost:5236]:处于主库打开状态</span><br><span class=\"line\">登录使用时间 : 1.616(ms)</span><br><span class=\"line\">上次登录ip       : ::ffff:192.168.118.18</span><br><span class=\"line\">上次登录时间   : 2022-05-29 22:55:12</span><br><span class=\"line\">登录失败次数   : 0</span><br><span class=\"line\">口令是否过期   : 未过期</span><br><span class=\"line\">disql V8</span><br><span class=\"line\">SQL&gt;sp_set_para_value(1,&#x27;ALTER_MODE_STATUS&#x27;,1);</span><br><span class=\"line\">DMSQL 过程已成功完成</span><br><span class=\"line\">已用时间: 4.570(毫秒). 执行号:0.</span><br><span class=\"line\">SQL&gt; sp_set_oguid(453332);</span><br><span class=\"line\">DMSQL 过程已成功完成</span><br><span class=\"line\">已用时间: 5.223(毫秒). 执行号:1.</span><br><span class=\"line\">SQL&gt; sp_set_para_value(1,&#x27;ALTER_MODE_STATUS&#x27;,0);</span><br><span class=\"line\">DMSQL 过程已成功完成</span><br><span class=\"line\">已用时间: 4.021(毫秒). 执行号:2.</span><br><span class=\"line\">SQL&gt; alter database standby;</span><br><span class=\"line\">操作已执行</span><br><span class=\"line\">已用时间: 8.797(毫秒). 执行号:0.</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h2 id=\"从节点配置192-168-118-20\"><a href=\"#从节点配置192-168-118-20\" class=\"headerlink\" title=\"从节点配置192.168.118.20\"></a>从节点配置192.168.118.20</h2><h3 id=\"修改dm-ini-2\"><a href=\"#修改dm-ini-2\" class=\"headerlink\" title=\"修改dm.ini\"></a>修改dm.ini</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dm.ini</span><br><span class=\"line\"></span><br><span class=\"line\">#修改如下参数</span><br><span class=\"line\"></span><br><span class=\"line\">INSTANCE_NAME  = DMSERVER03</span><br><span class=\"line\"></span><br><span class=\"line\">PORT_NUM  = 5236                      #数据库实例监听端口</span><br><span class=\"line\"></span><br><span class=\"line\">DW_INACTIVE_INTERVAL  = 60       #接收守护进程消息超时时间</span><br><span class=\"line\"></span><br><span class=\"line\">ALTER_MODE_STATUS  = 0             #不允许手工方式修改实例模式/状态/OGUID</span><br><span class=\"line\"></span><br><span class=\"line\">ENABLE_OFFLINE_TS  = 2         #不允许备库 OFFLINE 表空间</span><br><span class=\"line\"></span><br><span class=\"line\">MAL_INI = 1                       #打开 MAL 系统</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_INI  = 1                         #打开归档配置</span><br><span class=\"line\"></span><br><span class=\"line\">RLOG_SEND_APPLY_MON = 64        #统计最近 64 次的日志发送信息</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"修改dmmal-ini-创建这个文件，内容如下，主备库文件内容要相同-2\"><a href=\"#修改dmmal-ini-创建这个文件，内容如下，主备库文件内容要相同-2\" class=\"headerlink\" title=\"修改dmmal.ini(创建这个文件，内容如下，主备库文件内容要相同)\"></a>修改dmmal.ini(创建这个文件，内容如下，主备库文件内容要相同)</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmmal.ini</span><br><span class=\"line\"></span><br><span class=\"line\">MAL_CHECK_INTERVAL =  5  #MAL 链路检测时间间隔 </span><br><span class=\"line\">MAL_CONN_FAIL_INTERVAL =  5  #判定 MAL 链路断开的时间 </span><br><span class=\"line\">[MAL_INST1]</span><br><span class=\"line\">MAL_INST_NAME  =  DMSERVER01  #实例名&amp;#xff0c;和 dm.ini 中的 INSTANCE_NAME 一致 </span><br><span class=\"line\">MAL_HOST  =  192.168.118.18 #MAL 系统监听 TCP 连接的 IP 地址 </span><br><span class=\"line\">MAL_PORT  = 61141  #MAL 系统监听 TCP 连接的端口 </span><br><span class=\"line\">MAL_INST_HOST  =  192.168.118.18  #实例的对外服务 IP 地址 </span><br><span class=\"line\">MAL_INST_PORT  =  5236  #实例的对外服务端口&amp;#xff0c;和 dm.ini 中的 PORT_NUM 一致 </span><br><span class=\"line\">MAL_DW_PORT =  52141  #实例对应的守护进程监听 TCP 连接的端口 </span><br><span class=\"line\">MAL_INST_DW_PORT  =  33141  #实例监听守护进程 TCP 连接的端口 </span><br><span class=\"line\">[MAL_INST2]</span><br><span class=\"line\">MAL_INST_NAME =  DMSERVER02</span><br><span class=\"line\">MAL_HOST =  192.168.118.19</span><br><span class=\"line\">MAL_PORT =  61142</span><br><span class=\"line\">MAL_INST_HOST =  192.168.118.19</span><br><span class=\"line\">MAL_INST_PORT =  5236</span><br><span class=\"line\">MAL_DW_PORT =  52142</span><br><span class=\"line\">MAL_INST_DW_PORT  =  33142</span><br><span class=\"line\">[MAL_INST3]</span><br><span class=\"line\">MAL_INST_NAME =  DMSERVER03</span><br><span class=\"line\">MAL_HOST =  192.168.118.20</span><br><span class=\"line\">MAL_PORT  = 61143</span><br><span class=\"line\">MAL_INST_HOST =  192.168.118.20</span><br><span class=\"line\">MAL_INST_PORT  = 5236</span><br><span class=\"line\">MAL_DW_PORT =  52143</span><br><span class=\"line\">MAL_INST_DW_PORT  =  33143</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"配置dmarch-ini文件-创建这个文件，内容如下-2\"><a href=\"#配置dmarch-ini文件-创建这个文件，内容如下-2\" class=\"headerlink\" title=\"配置dmarch.ini文件(创建这个文件，内容如下)\"></a>配置dmarch.ini文件(创建这个文件，内容如下)</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb03 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmarch.ini</span><br><span class=\"line\"></span><br><span class=\"line\">[ARCHIVE_TIMELY1]</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_TYPE = TIMELY       #即时归档类型</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_DEST = DMSERVER01  #即时归档目标实例名</span><br><span class=\"line\"></span><br><span class=\"line\">[ARCHIVE_TIMELY2]</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_TYPE = TIMELY       #即时归档类型</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_DEST = DMSERVER02  #即时归档目标实例名</span><br><span class=\"line\"></span><br><span class=\"line\">[ARCHIVE_LOCAL1]</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_TYPE = LOCAL        #本地归档类型</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_DEST = /mnt/dmdba/dmdata/DAMENG/arch #本地归档文件存放路径</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_FILE_SIZE = 128     #单位 Mb，本地单个归档文件最大值</span><br><span class=\"line\"></span><br><span class=\"line\">ARCH_SPACE_LIMIT  = 10240    #单位 Mb，0 表示无限制，范围 1024~4294967294M</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"配置dmwatcher-ini文件-创建这个文件，内容如下，主备库文件内容要相同-2\"><a href=\"#配置dmwatcher-ini文件-创建这个文件，内容如下，主备库文件内容要相同-2\" class=\"headerlink\" title=\"配置dmwatcher.ini文件(创建这个文件，内容如下，主备库文件内容要相同)\"></a>配置dmwatcher.ini文件(创建这个文件，内容如下，主备库文件内容要相同)</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb01 bin]$ vim /mnt/dmdba/dmdata/DAMENG/dmwatcher.ini</span><br><span class=\"line\"></span><br><span class=\"line\">[GRP1]</span><br><span class=\"line\">  </span><br><span class=\"line\">DW_TYPE = GLOBAL          #全局守护类型</span><br><span class=\"line\"></span><br><span class=\"line\">DW_MODE = AUTO                  #自动切换模式</span><br><span class=\"line\"></span><br><span class=\"line\">DW_ERROR_TIME = 10      #远程守护进程故障认定时间</span><br><span class=\"line\"></span><br><span class=\"line\">INST_RECOVER_TIME = 60 #主库守护进程启动恢复的间隔时间</span><br><span class=\"line\"></span><br><span class=\"line\">INST_ERROR_TIME = 10     #本地实例故障认定时间</span><br><span class=\"line\"></span><br><span class=\"line\">INST_OGUID = 453332      #守护系统唯一 OGUID 值</span><br><span class=\"line\"></span><br><span class=\"line\">INST_INI = /mnt/dmdba/dmdata/DAMENG/dm.ini  #dm.ini 配置文件路径</span><br><span class=\"line\"></span><br><span class=\"line\">INST_AUTO_RESTART = 1   #打开实例的自动启动功能</span><br><span class=\"line\"></span><br><span class=\"line\">INST_STARTUP_CMD = /mnt/dmdba/dmdata/bin/dmserver    #命令行方式启动</span><br><span class=\"line\"></span><br><span class=\"line\">RLOG_SEND_THRESHOLD = 0   #指定主库发送日志到备库的时间阈值，默认关闭</span><br><span class=\"line\"></span><br><span class=\"line\">RLOG_APPLY_THRESHOLD = 0 #指定备库重演日志的时间阈值，默认关闭</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"开启从节点-1\"><a href=\"#开启从节点-1\" class=\"headerlink\" title=\"开启从节点\"></a>开启从节点</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@prddb03 bin]$  ./dmserver ../DAMENG/dm.ini mount</span><br><span class=\"line\">file dm.key not found, use default license!</span><br><span class=\"line\">\tversion info: develop</span><br><span class=\"line\">\tDM Database Server x64 V8 1-2-84-21.10.21-149328-10032-ENT  startup...</span><br><span class=\"line\">\tNormal of FAST</span><br><span class=\"line\">\tNormal of DEFAULT</span><br><span class=\"line\">\tNormal of RECYCLE</span><br><span class=\"line\">\tNormal of KEEP</span><br><span class=\"line\">\tNormal of ROLL</span><br><span class=\"line\">\tDatabase mode = 0, oguid = 0</span><br><span class=\"line\">\tLicense will expire on 2022-10-21</span><br><span class=\"line\">\tfile lsn: 30600</span><br><span class=\"line\">\tndct db load finished</span><br><span class=\"line\">\tndct second level fill fast pool finished</span><br><span class=\"line\">\tndct third level fill fast pool finished</span><br><span class=\"line\">\tndct fill fast pool finished</span><br><span class=\"line\">\tnsvr_startup end.</span><br><span class=\"line\">\taud sys init success.</span><br><span class=\"line\">\taud rt sys init success.</span><br><span class=\"line\">\tsystables desc init success.</span><br><span class=\"line\">\tndct_db_load_info success.</span><br><span class=\"line\">\tSYSTEM IS READY.</span><br><span class=\"line\">\tcheckpoint requested, rlog free space[536862720], used space[0]</span><br><span class=\"line\">\tcheckpoint generate by ckpt_interval</span><br><span class=\"line\">\tcheckpoint begin, used_space[0], free_space[536862720]...</span><br><span class=\"line\">\tcheckpoint end, 0 pages flushed, used_space[0], free_space[536862720].</span><br><span class=\"line\">\tcheckpoint requested by CKPT_INTERVAL, rlog free space[536862720], used space[0]</span><br><span class=\"line\">\tcheckpoint generate by ckpt_interval</span><br><span class=\"line\">\tcheckpoint begin, used_space[0], free_space[536862720]...</span><br><span class=\"line\">\tcheckpoint end, 0 pages flushed, used_space[0], free_space[536862720].</span><br></pre></td></tr></table></figure>\n\n<p><strong>一直到显示SYSTEM IS READY启动完成。此时不要关闭这个窗口，重新在主服务器上开启一个窗口。</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@prddb03 ~]# su - dmdba</span><br><span class=\"line\">[dmdba@prddb03 ~]$ cd /mnt/dmdba/dmdata/bin</span><br><span class=\"line\">[dmdba@prddb03 bin]$ ./disql SYSDBA/SYSDBA@localhost:5236</span><br><span class=\"line\">服务器[localhost:5236]:处于主库打开状态</span><br><span class=\"line\">登录使用时间 : 1.616(ms)</span><br><span class=\"line\">上次登录ip       : ::ffff:192.168.118.18</span><br><span class=\"line\">上次登录时间   : 2022-05-29 22:55:12</span><br><span class=\"line\">登录失败次数   : 0</span><br><span class=\"line\">口令是否过期   : 未过期</span><br><span class=\"line\">disql V8</span><br><span class=\"line\">SQL&gt;sp_set_para_value(1,&#x27;ALTER_MODE_STATUS&#x27;,1);</span><br><span class=\"line\">DMSQL 过程已成功完成</span><br><span class=\"line\">已用时间: 4.570(毫秒). 执行号:0.</span><br><span class=\"line\">SQL&gt; sp_set_oguid(453332);</span><br><span class=\"line\">DMSQL 过程已成功完成</span><br><span class=\"line\">已用时间: 5.223(毫秒). 执行号:1.</span><br><span class=\"line\">SQL&gt; sp_set_para_value(1,&#x27;ALTER_MODE_STATUS&#x27;,0);</span><br><span class=\"line\">DMSQL 过程已成功完成</span><br><span class=\"line\">已用时间: 4.021(毫秒). 执行号:2.</span><br><span class=\"line\">SQL&gt; alter database standby;</span><br><span class=\"line\">操作已执行</span><br><span class=\"line\">已用时间: 8.797(毫秒). 执行号:0.</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"注册服务\"><a href=\"#注册服务\" class=\"headerlink\" title=\"注册服务\"></a>注册服务</h2><h3 id=\"使用root用户在主库（192-168-118-18）上执行以下命令\"><a href=\"#使用root用户在主库（192-168-118-18）上执行以下命令\" class=\"headerlink\" title=\"使用root用户在主库（192.168.118.18）上执行以下命令\"></a>使用root用户在主库（192.168.118.18）上执行以下命令</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@prddb01 root]# cd /mnt/dmdba/dmdata/script/root</span><br><span class=\"line\"></span><br><span class=\"line\">./dm_service_installer.sh -t dmserver -dm_ini /mnt/dmdba/dmdata/DAMENG/dm.ini -m mount -p DMSERVER01  # 注册数据库实例服务</span><br><span class=\"line\"></span><br><span class=\"line\">./dm_service_installer.sh -t dmwatcher -watcher_ini /mnt/dmdba/dmdata/DAMENG/dmwatcher.ini -p DMSERVER01  # 注册数据库实例服务</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"使用root用户在从库（192-168-118-19）上执行以下命令\"><a href=\"#使用root用户在从库（192-168-118-19）上执行以下命令\" class=\"headerlink\" title=\"使用root用户在从库（192.168.118.19）上执行以下命令\"></a>使用root用户在从库（192.168.118.19）上执行以下命令</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@prddb01 root]# cd /mnt/dmdba/dmdata/script/root</span><br><span class=\"line\"></span><br><span class=\"line\">./dm_service_installer.sh -t dmserver -dm_ini /mnt/dmdba/dmdata/DAMENG/dm.ini -m mount -p DMSERVER01  # 注册数据库实例服务</span><br><span class=\"line\"></span><br><span class=\"line\">./dm_service_installer.sh -t dmwatcher -watcher_ini /mnt/dmdba/dmdata/DAMENG/dmwatcher.ini -p DMSERVER01  # 注册数据库实例服务</span><br><span class=\"line\"></span><br><span class=\"line\">./dm_service_installer.sh -t dmmonitor -monitor_ini /mnt/dmdba/dmdata/DAMENG/dmmonitor.ini -p DMSERVER02 # 注册监视器服务（只需在监视器服务器上执行）</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"使用root用户在从库（192-168-118-20）上执行以下命令\"><a href=\"#使用root用户在从库（192-168-118-20）上执行以下命令\" class=\"headerlink\" title=\"使用root用户在从库（192.168.118.20）上执行以下命令\"></a>使用root用户在从库（192.168.118.20）上执行以下命令</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@prddb01 root]# cd /mnt/dmdba/dmdata/script/root</span><br><span class=\"line\"></span><br><span class=\"line\">./dm_service_installer.sh -t dmserver -dm_ini /mnt/dmdba/dmdata/DAMENG/dm.ini -m mount -p DMSERVER01  # 注册数据库实例服务</span><br><span class=\"line\"></span><br><span class=\"line\">./dm_service_installer.sh -t dmwatcher -watcher_ini /mnt/dmdba/dmdata/DAMENG/dmwatcher.ini -p DMSERVER01  # 注册数据库实例服务</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"启动管理集群\"><a href=\"#启动管理集群\" class=\"headerlink\" title=\"启动管理集群\"></a>启动管理集群</h2><h3 id=\"启动集群的顺序为：\"><a href=\"#启动集群的顺序为：\" class=\"headerlink\" title=\"启动集群的顺序为：\"></a>启动集群的顺序为：</h3><p><strong>主库实例—&gt;备库实例—&gt;主库守护进程—&gt;备库守护进程—&gt;监视器服务</strong></p>\n<h4 id=\"1-启动192-168-178-18主库实例\"><a href=\"#1-启动192-168-178-18主库实例\" class=\"headerlink\" title=\"1.启动192.168.178.18主库实例\"></a>1.启动192.168.178.18主库实例</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@prddb01 root]# cd /mnt/dmdba/dmdata/bin</span><br><span class=\"line\">[root@prddb01 bin]# ./DmServiceDMSERVER01 start</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-启动192-168-178-19从库实例\"><a href=\"#2-启动192-168-178-19从库实例\" class=\"headerlink\" title=\"2.启动192.168.178.19从库实例\"></a>2.启动192.168.178.19从库实例</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@prddb02 root]# cd /mnt/dmdba/dmdata/bin</span><br><span class=\"line\">[root@prddb02 bin]# ./DmServiceDMSERVER02 start</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"3-启动192-168-178-20从库实例\"><a href=\"#3-启动192-168-178-20从库实例\" class=\"headerlink\" title=\"3.启动192.168.178.20从库实例\"></a>3.启动192.168.178.20从库实例</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@prddb03 root]# cd /mnt/dmdba/dmdata/bin</span><br><span class=\"line\">[root@prddb03 bin]# ./DmServiceDMSERVER03 start</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"4-启动192-168-178-18主库守护进程\"><a href=\"#4-启动192-168-178-18主库守护进程\" class=\"headerlink\" title=\"4.启动192.168.178.18主库守护进程\"></a>4.启动192.168.178.18主库守护进程</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@prddb01 root]# cd /mnt/dmdba/dmdata/bin</span><br><span class=\"line\">[root@prddb01 bin]# ./DmWatcherServiceDMSERVER01 start</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"5-启动192-168-178-19从库守护进程\"><a href=\"#5-启动192-168-178-19从库守护进程\" class=\"headerlink\" title=\"5.启动192.168.178.19从库守护进程\"></a>5.启动192.168.178.19从库守护进程</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@prddb02 root]# cd /mnt/dmdba/dmdata/bin</span><br><span class=\"line\">[root@prddb02 bin]# ./DmWatcherServiceDMSERVER02 start</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"6-启动192-168-178-20从库守护进程\"><a href=\"#6-启动192-168-178-20从库守护进程\" class=\"headerlink\" title=\"6.启动192.168.178.20从库守护进程\"></a>6.启动192.168.178.20从库守护进程</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@prddb03 root]# cd /mnt/dmdba/dmdata/bin</span><br><span class=\"line\">[root@prddb03 bin]# ./DmWatcherServiceDMSERVER03 start</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"7-启动192-168-178-19监视服务\"><a href=\"#7-启动192-168-178-19监视服务\" class=\"headerlink\" title=\"7.启动192.168.178.19监视服务\"></a>7.启动192.168.178.19监视服务</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@prddb02 root]# cd /mnt/dmdba/dmdata/bin</span><br><span class=\"line\">[root@prddb02 bin]# ./DmMonitorServiceDMSERVER02 start</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><h2 id=\"验证主备集群同步状态\"><a href=\"#验证主备集群同步状态\" class=\"headerlink\" title=\"验证主备集群同步状态\"></a>验证主备集群同步状态</h2><h3 id=\"监视器查看读写分离集群状态\"><a href=\"#监视器查看读写分离集群状态\" class=\"headerlink\" title=\"监视器查看读写分离集群状态\"></a>监视器查看读写分离集群状态</h3><p>集群任意节点，配置普通监视器配置文件 <code>dmmonitor.ini</code>，执行以下命令：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vi /mnt/dmdba/dmdata/DAMENG/dmmonitor.ini</span><br></pre></td></tr></table></figure>\n\n<p>添加以下内容：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MON_DW_CONFIRM    = 0   #1.确认监视器模式 0.非确认监视模式</span><br><span class=\"line\">MON_LOG_PATH    = /mnt/dmdba/dmdata/log #监视器日志文件存放路径</span><br><span class=\"line\">MON_LOG_INTERVAL  = 60 #每隔 60 s 定时记录系统信息到日志文件</span><br><span class=\"line\">MON_LOG_FILE_SIZE   = 32 #每个日志文件最大 32 MB</span><br><span class=\"line\">MON_LOG_SPACE_LIMIT  = 0  #不限定日志文件总占用空间</span><br><span class=\"line\">[GRP1]</span><br><span class=\"line\"> MON_INST_OGUID    = 453332 #组 GRP_RW 的唯一 OGUID 值</span><br><span class=\"line\">#以下配置为监视器到组 GRP_RW 的守护进程的连接信息，以“IP:PORT”的形式配置</span><br><span class=\"line\">#IP 对应 dmmal.ini 中的 MAL_HOST，PORT 对应 dmmal.ini 中的 MAL_DW_PORT</span><br><span class=\"line\">MON_DW_IP = 192.168.118.18:52141</span><br><span class=\"line\">MON_DW_IP = 192.168.118.19:52142</span><br><span class=\"line\">MON_DW_IP = 192.168.118.20:52143</span><br></pre></td></tr></table></figure>\n\n<p>启动监视器，执行以下命令：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /mnt/dmdba/dmdata/bin</span><br><span class=\"line\">./dmmonitor mnt/dmdba/dmdata/DAMENG/dmmonitor.ini</span><br></pre></td></tr></table></figure>\n\n<p>输入 show 命令查看集群状态，执行以下命令：</p>\n<p><img src=\"/images/dm.png\" alt=\"dm\"></p>\n<p>其中守护进程状态 WSTATUS 为 OPEN，实例状态 ISTATUS 为 OPEN，归档类型 RTYPE 为 REALTIME，归档状态 RSTAT 为VALID。</p>\n<h2 id=\"重启集群\"><a href=\"#重启集群\" class=\"headerlink\" title=\"重启集群\"></a>重启集群</h2><p><strong>主备集群重启有顺序要求：</strong>（在/mnt/dmdba/dmdata/bin目录下执行）</p>\n<ol>\n<li>关闭监视器：./DmMonitorServiceDMSERVER02 stop</li>\n<li>关闭主库守护进程：./DmWatcherServiceDMSERVER01 stop</li>\n<li>关闭备库守护进程：./DmWatcherServiceDMSERVER02 stop</li>\n<li>关闭备库守护进程：./DmWatcherServiceDMSERVER03 stop</li>\n<li>关闭主库实例：./DmServiceDMSERVER01 stop</li>\n<li>关闭备库实例：./DmServiceDMSERVER02 stop</li>\n<li>关闭备库实例：./DmServiceDMSERVER03 stop</li>\n<li>启动主库实例：./DmServiceDMSERVER01 start</li>\n<li>启动备库实例：./DmServiceDMSERVER02 start</li>\n<li>启动备库实例：./DmServiceDMSERVER03 start</li>\n<li>启动主库守护进程：./DmWatcherServiceDMSERVER01 start</li>\n<li>启动备库守护进程：./DmWatcherServiceDMSERVER02 start</li>\n<li>启动备库守护进程：./DmWatcherServiceDMSERVER03 start</li>\n<li>启动监视器：./DmMonitorServiceDMSERVER02 start</li>\n</ol>\n<p>详见请参考官方文档：<a href=\"https://eco.dameng.com/docs/zh-cn/ops/standard-dw-cluster.html\">https://eco.dameng.com/docs/zh-cn/ops/standard-dw-cluster.html</a></p>"},{"title":"mysql导出select语句结果","date":"2022-12-16T08:13:00.000Z","_content":"\n# mysql导出select查询结果\n\n\n\n<!--more-->\n\n```\n方法一：\n\nmysql -hxx -uxx -pxx -e \"query statement\" db > file\n\n　　-h：后面跟的是链接的host（主机）\n\n　　-u:后面跟的是用户名\n\n　　-p:后面跟的是密码\n\n　　db:你要查询的数据库\n\n　　file:你要写入的文件，绝对路径\n\n例如：\nmysql -h127.0.0.1 -uroot -p000000 -e\"select * from a\" test > 1.txt\n```\n\n```\n方法二：into outfile\nmysql -hxxx -uxx -pxx \nselect * from table into outfile 'xxx.txt';\n\n问题：使用into outfile报错：ERROR 1290 (HY000): The MySQL server is running with the --secure-file-priv option so it cannot execute this statement\n\n\n解决办法：先执行命令show variables like '%secure%';(查询数据库默认导出路径)\nmysql> show variables like '%secure%';\n+--------------------------+-----------------------+\n| Variable_name            | Value                 |\n+--------------------------+-----------------------+\n| require_secure_transport | OFF                   |\n| secure_auth              | ON                    |\n| secure_file_priv         | /var/lib/mysql-files/ |\n+--------------------------+-----------------------+\n3 rows in set (0.00 sec)\n\n\n执行into outfile导出时加上secure_file_priv的路径\n例如：\nmysql -hxxx -uxx -pxx \nselect * from table into outfile '/var/lib/mysql-files/xxx.txt';\n命令执行成功后就会在/var/lib/mysql-files/目录下生成导出的文件。\n```\n\n","source":"_posts/mysql导出select语句结果.md","raw":"---\ntitle: mysql导出select语句结果\ndate: 2022-12-16 16:13:00\ntags: mysql\n---\n\n# mysql导出select查询结果\n\n\n\n<!--more-->\n\n```\n方法一：\n\nmysql -hxx -uxx -pxx -e \"query statement\" db > file\n\n　　-h：后面跟的是链接的host（主机）\n\n　　-u:后面跟的是用户名\n\n　　-p:后面跟的是密码\n\n　　db:你要查询的数据库\n\n　　file:你要写入的文件，绝对路径\n\n例如：\nmysql -h127.0.0.1 -uroot -p000000 -e\"select * from a\" test > 1.txt\n```\n\n```\n方法二：into outfile\nmysql -hxxx -uxx -pxx \nselect * from table into outfile 'xxx.txt';\n\n问题：使用into outfile报错：ERROR 1290 (HY000): The MySQL server is running with the --secure-file-priv option so it cannot execute this statement\n\n\n解决办法：先执行命令show variables like '%secure%';(查询数据库默认导出路径)\nmysql> show variables like '%secure%';\n+--------------------------+-----------------------+\n| Variable_name            | Value                 |\n+--------------------------+-----------------------+\n| require_secure_transport | OFF                   |\n| secure_auth              | ON                    |\n| secure_file_priv         | /var/lib/mysql-files/ |\n+--------------------------+-----------------------+\n3 rows in set (0.00 sec)\n\n\n执行into outfile导出时加上secure_file_priv的路径\n例如：\nmysql -hxxx -uxx -pxx \nselect * from table into outfile '/var/lib/mysql-files/xxx.txt';\n命令执行成功后就会在/var/lib/mysql-files/目录下生成导出的文件。\n```\n\n","slug":"mysql导出select语句结果","published":1,"updated":"2023-01-03T06:17:51.245Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clcfuykyt000f3wrs0mg731oq","content":"<h1 id=\"mysql导出select查询结果\"><a href=\"#mysql导出select查询结果\" class=\"headerlink\" title=\"mysql导出select查询结果\"></a>mysql导出select查询结果</h1><span id=\"more\"></span>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">方法一：</span><br><span class=\"line\"></span><br><span class=\"line\">mysql -hxx -uxx -pxx -e &quot;query statement&quot; db &gt; file</span><br><span class=\"line\"></span><br><span class=\"line\">　　-h：后面跟的是链接的host（主机）</span><br><span class=\"line\"></span><br><span class=\"line\">　　-u:后面跟的是用户名</span><br><span class=\"line\"></span><br><span class=\"line\">　　-p:后面跟的是密码</span><br><span class=\"line\"></span><br><span class=\"line\">　　db:你要查询的数据库</span><br><span class=\"line\"></span><br><span class=\"line\">　　file:你要写入的文件，绝对路径</span><br><span class=\"line\"></span><br><span class=\"line\">例如：</span><br><span class=\"line\">mysql -h127.0.0.1 -uroot -p000000 -e&quot;select * from a&quot; test &gt; 1.txt</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">方法二：into outfile</span><br><span class=\"line\">mysql -hxxx -uxx -pxx </span><br><span class=\"line\">select * from table into outfile &#x27;xxx.txt&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">问题：使用into outfile报错：ERROR 1290 (HY000): The MySQL server is running with the --secure-file-priv option so it cannot execute this statement</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">解决办法：先执行命令show variables like &#x27;%secure%&#x27;;(查询数据库默认导出路径)</span><br><span class=\"line\">mysql&gt; show variables like &#x27;%secure%&#x27;;</span><br><span class=\"line\">+--------------------------+-----------------------+</span><br><span class=\"line\">| Variable_name            | Value                 |</span><br><span class=\"line\">+--------------------------+-----------------------+</span><br><span class=\"line\">| require_secure_transport | OFF                   |</span><br><span class=\"line\">| secure_auth              | ON                    |</span><br><span class=\"line\">| secure_file_priv         | /var/lib/mysql-files/ |</span><br><span class=\"line\">+--------------------------+-----------------------+</span><br><span class=\"line\">3 rows in set (0.00 sec)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">执行into outfile导出时加上secure_file_priv的路径</span><br><span class=\"line\">例如：</span><br><span class=\"line\">mysql -hxxx -uxx -pxx </span><br><span class=\"line\">select * from table into outfile &#x27;/var/lib/mysql-files/xxx.txt&#x27;;</span><br><span class=\"line\">命令执行成功后就会在/var/lib/mysql-files/目录下生成导出的文件。</span><br></pre></td></tr></table></figure>\n\n","site":{"data":{}},"excerpt":"<h1 id=\"mysql导出select查询结果\"><a href=\"#mysql导出select查询结果\" class=\"headerlink\" title=\"mysql导出select查询结果\"></a>mysql导出select查询结果</h1>","more":"<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">方法一：</span><br><span class=\"line\"></span><br><span class=\"line\">mysql -hxx -uxx -pxx -e &quot;query statement&quot; db &gt; file</span><br><span class=\"line\"></span><br><span class=\"line\">　　-h：后面跟的是链接的host（主机）</span><br><span class=\"line\"></span><br><span class=\"line\">　　-u:后面跟的是用户名</span><br><span class=\"line\"></span><br><span class=\"line\">　　-p:后面跟的是密码</span><br><span class=\"line\"></span><br><span class=\"line\">　　db:你要查询的数据库</span><br><span class=\"line\"></span><br><span class=\"line\">　　file:你要写入的文件，绝对路径</span><br><span class=\"line\"></span><br><span class=\"line\">例如：</span><br><span class=\"line\">mysql -h127.0.0.1 -uroot -p000000 -e&quot;select * from a&quot; test &gt; 1.txt</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">方法二：into outfile</span><br><span class=\"line\">mysql -hxxx -uxx -pxx </span><br><span class=\"line\">select * from table into outfile &#x27;xxx.txt&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">问题：使用into outfile报错：ERROR 1290 (HY000): The MySQL server is running with the --secure-file-priv option so it cannot execute this statement</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">解决办法：先执行命令show variables like &#x27;%secure%&#x27;;(查询数据库默认导出路径)</span><br><span class=\"line\">mysql&gt; show variables like &#x27;%secure%&#x27;;</span><br><span class=\"line\">+--------------------------+-----------------------+</span><br><span class=\"line\">| Variable_name            | Value                 |</span><br><span class=\"line\">+--------------------------+-----------------------+</span><br><span class=\"line\">| require_secure_transport | OFF                   |</span><br><span class=\"line\">| secure_auth              | ON                    |</span><br><span class=\"line\">| secure_file_priv         | /var/lib/mysql-files/ |</span><br><span class=\"line\">+--------------------------+-----------------------+</span><br><span class=\"line\">3 rows in set (0.00 sec)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">执行into outfile导出时加上secure_file_priv的路径</span><br><span class=\"line\">例如：</span><br><span class=\"line\">mysql -hxxx -uxx -pxx </span><br><span class=\"line\">select * from table into outfile &#x27;/var/lib/mysql-files/xxx.txt&#x27;;</span><br><span class=\"line\">命令执行成功后就会在/var/lib/mysql-files/目录下生成导出的文件。</span><br></pre></td></tr></table></figure>"},{"title":"达梦数据库单机安装","date":"2022-10-20T07:54:19.000Z","_content":"\n# 达梦数据库单机安装\n\n# 单机部署\n\n<!--more-->\n\n## 服务器硬件需求\n\n按实际业务需求，选择合适的服务器，参考如下：\n\n| 硬件       | 要求                                   |\n| :--------- | :------------------------------------- |\n| 物理内存   | >= 16 GB                               |\n| 交换区     | Swap 空间>=物理内存                    |\n| /tmp大小   | > 1000 MB                              |\n| 网络       | 物理机器需要 2 个网卡，2 个网卡做 band |\n| 磁盘       | 根据实际应用系统需要挂载合适大小磁盘   |\n| 时间服务器 | 按机房要求配置连接时间服务器           |\n\n## 操作系统要求\n\n### 操作系统版本安装\n\nDM 数据库安装在 Linux 操作系统所需条件：glibc 2.3 以上，内核 2.6，预先安装 UnixODBC，系统性能监控等组件。\n\n### 目录与存储规划\n\n| 用途               | 目录路径 | 备注                           |\n| :----------------- | :------- | :----------------------------- |\n| 数据库软件安装目录 | /dm8     | 可用空间> 50 GB                |\n| 实例安装目录       | /dmdata  | 单独挂载性能最好的磁盘建议 SSD |\n| 归档日志存放目录   | /dmarch  | 单独挂载磁盘                   |\n| 备份文件存放目录   | /dmbak   | 单独挂载磁盘                   |\n\n### 用户与组\n\nDM 数据库不应该使用 root 用户安装和维护。需要在安装之前为 DM 数据库创建一个专用的系统用户 (dmdba) 和用户组 (dinstall)。\n\n执行以下命令，新建用户组 dinstall：\n\n```\ngroupadd dinstall\n```\n\n执行以下命令，新建用户 dmdba：\n\n```\nuseradd  -g dinstall -m -d /home/dmdba -s /bin/bash  dmdba\n```\n\n执行以下命令，修改 dmdba 用户密码：\n\n```\npasswd dmdba\n```\n\n输入密码并确认。\n\n### 修改安装目录权限\n\n将新建的安装路径目录权限的用户修改为 dmdba，用户组修改为 dinstall。命令如下：\n\n```\nchown dmdba:dinstall -R /dm8/\n```\n\n给安装路径下的文件设置 755 权限。命令如下：\n\n```\nchmod -R 755 /dm8\n```\n\n### 用户资源限制\n\n执行以下命令，修改 dmdba 用户资源限制：\n\n```\nvim /etc/security/limits.conf\n```\n\n文件末尾添加如下内容：\n\n```\ndmdba soft core unlimited\ndmdba hard core unlimited\ndmdba soft nofile 65536\ndmdba hard nofile 65536\ndmdba soft nproc  65536\ndmdba hard nproc  65536\ndmdba soft stack  65536\ndmdba hard stack  65536\n```\n\n### 用户环境变量\n\n执行以下命令，修改 dmdba 用户环境变量：\n\n```\nvi /home/dmdba/.bash_profile\n```\n\n文件末尾添加如下内容：\n\n```\nexport DM_HOME=/dm8\nexport PATH=$PATH:$DM_HOME/bin\nexport LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$DM_HOME/bin\n```\n\n### 防火墙设置\n\n生产环境应该对特定客户端开放数据库监听端口，并修改 DM 数据库默认的 5236 监听端口。\n\n## 安装数据库\n\n### 软件申请\n\n可访问达梦云适配中心[https://eco.dameng.com/download/?_blank](https://eco.dameng.com/download/?_blank)，下载 DM8 数据库试用版，如需其他版本，请联系达梦销售人员。\n\n查询操作系统（内核）版本，CPU 架构命令：`uname -a`。\n\n如上图所示，需申请 rh7，x86 版本数据库软件。\n\n以 iso 文件安装包为例，安装包命名规则如下：`dm8_20200930_x86_rh6_64_ent_8.1.1.134.iso`\n\n```\ndm8：数据库大版本为 dm8\n20200930：数据库版本发布日期\nx86：安装包匹配的 CPU 架构\nrh6：安装包匹配的系统版本 (redhat 6)\nent：数据库为企业版\n8.1.1.134：数据库详细版本号\n```\n\n### 安装数据库软件\n\n将安装包上传到服务器后使用 root 用户挂载 iso 安装包文件到 `/mnt` 目录下：\n\n```\nmount -oloop dm8_20200930_x86_rh6_64_ent_8.1.1.134.iso /mnt\n```\n\n执行以下命令，切换到 dmdba 用户：\n\n```\nsu - dmdba\n```\n\n执行以下命令，切换到/mnt 目录下：\n\n```\ncd /mnt\n```\n\n执行以下命令，查看文件：\n\n```\nll\n```\n\n执行 `DMInstall.bin` 文件开始安装，选择【-i】参数以命令行方式安装：\n\n1）执行安装命令\n\n在终端进入到安装程序所在文件夹，执行以下命令进行命令行安装：\n\n```shell\n[dmdba@~]# /mnt/DMInstall.bin -i\n```\n\n2）选择安装语言\n\n根据系统配置选择相应语言，输入选项，回车进行下一步。如下所示：\n\n```shell\n请选择安装语言(C/c:中文 E/e:英文) [C/c]：C\n解压安装程序..........\n欢迎使用达梦数据库安装程序\n```\n\n3）验证 key 文件\n\n可以选择是否输入 Key 文件路径。不输入则进入下一步安装，输入 Key 文件路径，安装程序将显示 Key 文件的详细信息，如果是合法的 Key 文件且在有效期内，可以继续安装。如下所示：\n\n```shell\n是否输入Key文件路径? (Y/y:是 N/n:否) [Y/y]：Y\n请输入Key文件的路径地址 [dm.key]：/opt/dmsetup/dm.key\n有效日期: 2020-12-25\n服务器颁布类型: 企业版\n发布类型: 试用版\n用户名称: 武汉达梦公司疫情期间临时授权\n授权用户数: 无限制\n并发连接数: 无限制\n```\n\n4）输入时区\n\n可以选择的时区信息。如下所示：\n\n```shell\n是否设置时区? (Y/y:是 N/n:否) [Y/y]：Y\n设置时区:\n[ 1]: GTM-12=日界线西\n[ 2]: GTM-11=萨摩亚群岛\n[ 3]: GTM-10=夏威夷\n[ 4]: GTM-09=阿拉斯加\n[ 5]: GTM-08=太平洋时间（美国和加拿大）\n[ 6]: GTM-07=亚利桑那\n[ 7]: GTM-06=中部时间（美国和加拿大）\n[ 8]: GTM-05=东部部时间（美国和加拿大）\n[ 9]: GTM-04=大西洋时间（美国和加拿大）\n[10]: GTM-03=巴西利亚\n[11]: GTM-02=中大西洋\n[12]: GTM-01=亚速尔群岛\n[13]: GTM=格林威治标准时间\n[14]: GTM+01=萨拉热窝\n[15]: GTM+02=开罗\n[16]: GTM+03=莫斯科\n[17]: GTM+04=阿布扎比\n[18]: GTM+05=伊斯兰堡\n[19]: GTM+06=达卡\n[20]: GTM+07=曼谷，河内\n[21]: GTM+08=中国标准时间\n[22]: GTM+09=汉城\n[23]: GTM+10=关岛\n[24]: GTM+11=所罗门群岛\n[25]: GTM+12=斐济\n[26]: GTM+13=努库阿勒法\n[27]: GTM+14=基里巴斯\n请选择设置时区 [21]：21\n```\n\n5）选择安装类型\n\n数据库软件安装程序提供四种安装方式：“典型安装”、“服务器安装”、“客户端安装”和“自定义安装”，用户可根据实际情况灵活地选择。如下所示：\n\n典型安装包括：服务器、客户端、驱动、用户手册、数据库服务。\n服务器安装包括：服务器、驱动、用户手册、数据库服务。\n客户端安装包括：客户端、驱动、用户手册。\n自定义安装包括：用户根据需求勾选组件，可以是服务器、客户端、驱动、用户手册、数据库服务中的任意组合。\n生产环境可以根据实际需求选择，一般情况下选择\"典型安装\"即可。\n\n```shell\n安装类型:\n1 典型安装\n2 服务器\n3 客户端\n4 自定义\n请选择安装类型的数字序号 [1 典型安装]：1\n所需空间: 1010M\n```\n\n6）选择安装路径\n\n输入数据库软件的安装路径，不输入则使用默认路径，默认路径为 `$HOME/dmdbms` (如果安装用户为 root ，则默认安装路径为 `/opt/dmdbms` ，但不建议使用 root 系统用户来安装)。如下所示：\n\n```shell\n请选择安装目录 [/home/dmdba/dmdbms]：/opt/dmdbms\n可用空间: 11G\n```\n\n> 注意\n>\n> 安装路径里的目录名由英文字母、数字和下划线等组成，不建议使用包含空格和中文字符等的路径。\n\n7）安装小结\n\n安装程序将打印用户之前输入的部分安装信息。如下所示：\n\n```shell\n是否确认安装路径(/opt/dmdbms)? (Y/y:是 N/n:否)  [Y/y]：Y\n安装前小结\n安装位置: /opt/dmdbms\n所需空间: 1010M\n可用空间: 11G\n版本信息: 企业版\n有效日期: 2020-12-25\n安装类型: 典型安装\n```\n\n8）安装\n\n```shell\nCopy是否确认安装? (Y/y:是 N/n:否)：Y\n2020-12-24 21:52:38 \n[INFO] 安装达梦数据库...\n2020-12-24 21:52:39 \n[INFO] 安装 基础 模块...\n2020-12-24 21:52:48 \n[INFO] 安装 服务器 模块...\n2020-12-24 21:52:48 \n[INFO] 安装 客户端 模块...\n2020-12-24 21:52:56 \n[INFO] 安装 驱动 模块...\n2020-12-24 21:52:58 \n[INFO] 安装 手册 模块...\n2020-12-24 21:53:00 \n[INFO] 安装 服务 模块...\n2020-12-24 21:53:02 \n[INFO] 移动ant日志文件。\n2020-12-24 21:53:03 \n[INFO] 安装达梦数据库完成。\n\n请以root系统用户执行命令:\n/opt/dmdbms/script/root/root_installer.sh\n\n安装结束\n```\n\n9）注册数据库服务\n\n当安装进度完成时将会弹出对话框，提示使用 root 系统用户执行相关命令。用户可根据对话框的说明完成相关操作，之后可关闭此对话框，点击“完成”按钮结束安装。如下所示：\n\n```shell\nCopy[dmdba@~]# su - root\n密码：<输入密码>\n[root@~]# /opt/dmdbms/script/root/root_installer.sh\n移动 /opt/dmdbms/bin/dm_svc.conf 到/etc目录\n修改服务器权限\n创建DmAPService服务\nCreated symlink from /etc/systemd/system/multiuser.target.wants/DmAPService.service to /usr/lib/systemd/system/DmAPService.service\n创建服务(DmAPService)完成\n启动DmAPService服务\n```\n\n### 使用 dminit 工具初始化实例\n\n执行以下命令，切换到 /opt/dmdbms/bin目录。\n\n快速查看参数`./dminit help`\n\n```\n[dmdba@localhost bin]$ ./dminit help\ninitdb V7.6.0.142-Build(2019.03.12-103811)ENT \ndb version: 0x7000a\nfile dm.key not found, use default license!\nLicense will expire on 2020-03-12\n格式: ./dminit     KEYWORD=value\n\n例程: ./dminit     PATH=/public/dmdb/dmData PAGE_SIZE=16\n\n关键字                     说明（默认值）\n--------------------------------------------------------------------------------\nINI_FILE                   初始化文件dm.ini存放的路径\nPATH                       初始数据库存放的路径\nCTL_PATH                   控制文件路径\nLOG_PATH                   日志文件路径\nEXTENT_SIZE                数据文件使用的簇大小(16)，可选值：16、32，单位：页\nPAGE_SIZE                  数据页大小(8)，可选值：4、8、16、32，单位：K\nLOG_SIZE                   日志文件大小(256)，单位为：M，范围为：64M ~ 2G\nCASE_SENSITIVE             大小敏感(Y)，可选值：Y/N，1/0\nCHARSET/UNICODE_FLAG       字符集(0)，可选值：0[GB18030]，1[UTF-8]，2[EUC-KR]\nLENGTH_IN_CHAR             VARCHAR类型长度是否以字符为单位(N)，可选值：Y/N，1/0\nSYSDBA_PWD                 设置SYSDBA密码(SYSDBA)，密码长度为9到48\nSYSAUDITOR_PWD             设置SYSAUDITOR密码(SYSAUDITOR)，密码长度为9到48\nDB_NAME                    数据库名(DAMENG)\nINSTANCE_NAME              实例名(DMSERVER)\nPORT_NUM                   监听端口号(5236)\nTIME_ZONE                  设置时区(+08:00)\nPAGE_CHECK                 页检查模式(0)，可选值：0/1/2\nEXTERNAL_CIPHER_NAME       设置默认加密算法\nEXTERNAL_HASH_NAME         设置默认HASH算法\nEXTERNAL_CRYPTO_NAME       设置根密钥加密引擎\nRLOG_ENC_FLAG              设置日志文件是否加密(N)，可选值：Y/N，1/0\nUSBKEY_PIN                 设置USBKEY PIN\nENCRYPT_NAME               设置全库加密算法\nBLANK_PAD_MODE             设置空格填充模式(0)，可选值：0/1\nSYSTEM_MIRROR_PATH         SYSTEM数据文件镜像路径\nMAIN_MIRROR_PATH           MAIN数据文件镜像\nROLL_MIRROR_PATH           回滚文件镜像路径\nMAL_FLAG                   初始化时设置dm.ini中的MAL_INI(0)\nARCH_FLAG                  初始化时设置dm.ini中的ARCH_INI(0)\nMPP_FLAG                   Mpp系统内的库初始化时设置dm.ini中的mpp_ini(0)\nCONTROL                    初始化配置文件（配置文件格式见系统管理员手册）\nAUTO_OVERWRITE             是否覆盖所有同名文件(0) 0:不覆盖 1:部分覆盖 2:完全覆盖\nUSE_NEW_HASH               是否使用改进的字符类型HASH算法(1)\nDCP_MODE                   是否是DCP代理模式(0)\nDCP_PORT_NUM               DCP代理模式下管理端口\nELOG_PATH                  指定初始化过程中生成的日志文件所在路径\nAP_PORT_NUM                ECS模式下AP协同工作的监听端口\nHELP                       打印帮助信息\n```\n\n通过执行dminit文件初始化实例参数来创建实例\n\n```\ncd /opt/dmdbms/bin\n./dminit path=/mnt/dm/dmdbms/data PAGE_SIZE=32 EXTENT_SIZE=32 CASE_SENSITIVE=0 LENGTH_IN_CHAR=1 CHARSET=1\n```\n\n> **注意**\n>\n> 初始化参数中除了 path 参数必须指定，其它参数都有默认值，如果需求与默认值不同，初始化的时候请指定需要的值。因为部分参数初始化后是无法修改的例如：page_size（页大小），charset（字符集），case_sensitive（大小写敏感）等。更多参数`./dminit help` 查看，是否无法修改的参数可以查询 v$dm_ini 视图，para_type=’READ ONLY’ 表示无法修改。\n\n### 启动实例\n\n以系统服务方式启动实例，DM 提供脚本将数据库实例注册为操作系统服务。\n\nroot 用户下切换到 `/opt/dmdbms/script/root/`：\n\n```\ncd /opt/dmdbms/script/root/\n```\n\n执行以下命令，执行脚本注册服务：\n\n```\n./dm_service_installer.sh -t dmserver -p dmserver -dm_ini /opt/dmdbms/data/DAMENG/dm.ini\n```\n\n服务名为 `DmService+-p` 参数后的内容，即 `DmServicedmserver`。\n\n> 提示\n>\n> `-t` 指服务类型是 dmserver；`-p` 为服务名的后缀；`-dm_ini` 为实例的 dm.ini 文件的绝对路径。\n\n执行以下命令，以服务方式启动实例：\n\n```\nsystemctl start DmServicedmserver\n```\n\n### 关闭实例\n\n对于以服务方式启动的实例，则以服务方式关闭实例：\n\n```\nsystemctl stop DmServicedmserver\n```\n\n> 建议\n>\n> 每个实例都建议注册为操作系统服务，这样不仅方便启动和关闭实例，而且注册为服务后，在服务器重启时，实例将随系统启动而自动启动。\n\n### 连接数据库\n\n执行以下命令，切换到 `/dm8/bin` 目录：\n\n```\ncd /opt/dmdbms/bin\n```\n\n执行以下命令，使用 disql 工具连接数据库：\n\n```\n./disql SYSDBA/SYSDBA@localhost:5236\n```\n\n> 提示\n>\n> 默认创建的实例，管理员用户 SYSDBA 的密码为 SYSDBA ，实例端口为 5236，字符集为 GB18030，大小写敏感。\n\n## 参数优化\n\n安装完成需要调整 `dm.ini` 文件参数。\n\n| 参数名称              | 参数含义                                           | 参数默认值 | 参数建议                       |\n| :-------------------- | :------------------------------------------------- | :--------- | :----------------------------- |\n| BUFFER                | 系统缓冲区大小，以 MB 为单位                       | 100        | 系统物理内存的 60%~80%         |\n| BUFFER_POOLS          | BUFFER 系统分区数                                  | 19         | 物理内存 64 GB 以下 53 GB 以上 |\n| HJ_BUF_GLOBAL_SIZE    | HASH 连接操作符的数据总缓存大小，以 MB 为单位      | 500        | 5000                           |\n| HJ_BUF_SIZE           | 单个 HASH 连接操作符的数据总缓存大小，以 MB 为单位 | 50         | 500                            |\n| DICT_BUF_SIZE         | 字典缓冲区大小，以 MB 为单位                       | 5          | 100                            |\n| TASK_THREADS          | 任务线程个数                                       | 4          | CPU 核数                       |\n| IO_THR_GROUPS         | 非 Windows 下有效，表示 IO 线程组个数              | 2          | CPU 核数/2                     |\n| MAX_SESSIONS          | 系统允许同时连接的最大数                           | 100        | 1000                           |\n| MAX_SESSION_STATEMENT | 单个会话上允许同时打开的语句句柄最大数             | 100        | 20000                          |\n| CACHE_POOL_SIZE       | SQL 缓冲池大小，以 MB 为单位                       | 20         | 200                            |\n\n参考脚本如下：\n\n```\nSP_SET_PARA_VALUE (2,'HJ_BUF_GLOBAL_SIZE',5000);\nSP_SET_PARA_VALUE (2,'HJ_BUF_SIZE',500);\nSP_SET_PARA_VALUE (2,'MAX_SESSIONS',1000);\nSP_SET_PARA_VALUE (2,'MAX_SESSION_STATEMENT',20000);\nSP_SET_PARA_VALUE (2,'CACHE_POOL_SIZE',200);\nSP_SET_PARA_VALUE (2,'DICT_BUF_SIZE',100);\n\ndeclare\nv_mem_mb int;\nv_cpus int;\nBUFFER int;\nBUFFER_POOLS INT;\nbegin\n    SELECT TOP 1 N_CPU,TOTAL_PHY_SIZE/1024/1024 INTO v_cpus,v_mem_mb FROM V$SYSTEMINFO;\n\n    v_mem_mb=round(v_mem_mb,-3);\n    SP_SET_PARA_VALUE(2,'TASK_THREADS',v_cpus);\n    SP_SET_PARA_VALUE(2,'IO_THR_GROUPS',v_cpus/2);\n    IF v_mem_mb >= 64000  THEN \n         BUFFER_POOLS :=101;\n      ELSE\n         BUFFER_POOLS :=53;\n    END IF;\n\n    BUFFER := round(cast(v_mem_mb * 0.8 as int),-3);\n    SP_SET_PARA_VALUE(2,'BUFFER',  BUFFER);\n    SP_SET_PARA_VALUE(2,'BUFFER_POOLS', BUFFER_POOLS);\nend;\n```\n\n> 注意\n>\n> 修改完参数后，需要重启数据库生效。\n\n## 归档配置\n\n生产环境必须开启归档日志，且必须限制归档日志保留量，限制方法：\n\n1. 设置归档空间大小限制即指定 `SPACE_LIMIT` 参数（单位是 MB）。\n2. 定期删除归档日志（设置定时作业）。\n\n例如开启归档并限制归档空间为 100 GB，如下所示：\n\n```\nalter database mount;\nalter database add archivelog 'dest=/dmarch/,TYPE=local,FILE_SIZE=1024,SPACE_LIMIT=102400';\nalter database archivelog;\nalter database open;\n```\n\n## 定制备份策略\n\n上线前必须规划好备份策略，可以使用 DM 作业系统，定时备份。\n\n根据应用需求，定制备份策略如下所示：\n\n| 备份类型 | 备份周期 | 备份时间           |\n| :------- | :------- | :----------------- |\n| 全量备份 | 每周     | 每周五 23 点       |\n| 增量备份 | 每天     | 除周五外每天 23 点 |\n| 删除备份 | 每天     | 每天 23 点 30      |\n\n执行以下命令，创建作业系统表：\n\n```\nSP_INIT_JOB_SYS(1);\n```\n\n全量备份（每周五 23 点全备）：\n\nCopy\n\n```\ncall SP_CREATE_JOB('bakfull',1,0,'',0,0,'',0,'');\n\ncall SP_JOB_CONFIG_START('bakfull');\n\ncall SP_ADD_JOB_STEP('bakfull', 'bak01', 6, '01000000/dmbak', 1, 2, 0, 0, NULL, 0);\n\ncall SP_ADD_JOB_SCHEDULE('bakfull', 'bak01', 1, 2, 1, 32, 0, '23:00:00', NULL, '2020-11-02 14:42:15', NULL, '');\n\ncall SP_JOB_CONFIG_COMMIT('bakfull');\n```\n\n增量备份（每周除周五外每天 23 点增量备份）：\n\n```\ncall SP_CREATE_JOB('bakincr',1,0,'',0,0,'',0,'');\n\ncall SP_JOB_CONFIG_START('bakincr');\n\ncall SP_ADD_JOB_STEP('bakincr', 'bak02', 6, '11000000/dmbak', 1, 2, 0, 0, NULL, 0);\n\ncall SP_ADD_JOB_SCHEDULE('bakincr', 'bak2', 1, 2, 1, 95, 0, '23:00:00', NULL, '2020-11-02 14:44:30', NULL, '');\n\ncall SP_JOB_CONFIG_COMMIT('bakincr');\n```\n\n备份定期删除（每天 23：30 删除 14 天前备份）：\n\n```\ncall SP_CREATE_JOB('delbak',1,0,'',0,0,'',0,'');\ncall SP_JOB_CONFIG_START('delbak');\ncall SP_ADD_JOB_STEP('delbak', 'bak1', 0, 'SF_BAKSET_BACKUP_DIR_ADD(''DISK'',''/dmbak'');call sp_db_bakset_remove_batch(''DISK'',now()-14);', 1, 2, 0, 0, NULL, 0);\ncall SP_ADD_JOB_SCHEDULE('delbak', 'del01', 1, 1, 1, 0, 0, '23:30:00', NULL, '2020-11-02 14:48:41', NULL, '');\ncall SP_JOB_CONFIG_COMMIT('delbak');\n```\n\n> 注意\n>\n> 备份的基本要求是：保留最少一次全备+全备（或者全备后的增备）时间点到当前的全部归档日志。删除备份前尽量将备份文件拷贝到单独的备份服务器上。\n\n详见请参考：https://eco.dameng.com/docs/zh-cn/ops/standard-stand-alone.html\n","source":"_posts/达梦数据库单机安装.md","raw":"---\ntitle: 达梦数据库单机安装\ndate: 2022-10-20 15:54:19\ntags: 达梦\n---\n\n# 达梦数据库单机安装\n\n# 单机部署\n\n<!--more-->\n\n## 服务器硬件需求\n\n按实际业务需求，选择合适的服务器，参考如下：\n\n| 硬件       | 要求                                   |\n| :--------- | :------------------------------------- |\n| 物理内存   | >= 16 GB                               |\n| 交换区     | Swap 空间>=物理内存                    |\n| /tmp大小   | > 1000 MB                              |\n| 网络       | 物理机器需要 2 个网卡，2 个网卡做 band |\n| 磁盘       | 根据实际应用系统需要挂载合适大小磁盘   |\n| 时间服务器 | 按机房要求配置连接时间服务器           |\n\n## 操作系统要求\n\n### 操作系统版本安装\n\nDM 数据库安装在 Linux 操作系统所需条件：glibc 2.3 以上，内核 2.6，预先安装 UnixODBC，系统性能监控等组件。\n\n### 目录与存储规划\n\n| 用途               | 目录路径 | 备注                           |\n| :----------------- | :------- | :----------------------------- |\n| 数据库软件安装目录 | /dm8     | 可用空间> 50 GB                |\n| 实例安装目录       | /dmdata  | 单独挂载性能最好的磁盘建议 SSD |\n| 归档日志存放目录   | /dmarch  | 单独挂载磁盘                   |\n| 备份文件存放目录   | /dmbak   | 单独挂载磁盘                   |\n\n### 用户与组\n\nDM 数据库不应该使用 root 用户安装和维护。需要在安装之前为 DM 数据库创建一个专用的系统用户 (dmdba) 和用户组 (dinstall)。\n\n执行以下命令，新建用户组 dinstall：\n\n```\ngroupadd dinstall\n```\n\n执行以下命令，新建用户 dmdba：\n\n```\nuseradd  -g dinstall -m -d /home/dmdba -s /bin/bash  dmdba\n```\n\n执行以下命令，修改 dmdba 用户密码：\n\n```\npasswd dmdba\n```\n\n输入密码并确认。\n\n### 修改安装目录权限\n\n将新建的安装路径目录权限的用户修改为 dmdba，用户组修改为 dinstall。命令如下：\n\n```\nchown dmdba:dinstall -R /dm8/\n```\n\n给安装路径下的文件设置 755 权限。命令如下：\n\n```\nchmod -R 755 /dm8\n```\n\n### 用户资源限制\n\n执行以下命令，修改 dmdba 用户资源限制：\n\n```\nvim /etc/security/limits.conf\n```\n\n文件末尾添加如下内容：\n\n```\ndmdba soft core unlimited\ndmdba hard core unlimited\ndmdba soft nofile 65536\ndmdba hard nofile 65536\ndmdba soft nproc  65536\ndmdba hard nproc  65536\ndmdba soft stack  65536\ndmdba hard stack  65536\n```\n\n### 用户环境变量\n\n执行以下命令，修改 dmdba 用户环境变量：\n\n```\nvi /home/dmdba/.bash_profile\n```\n\n文件末尾添加如下内容：\n\n```\nexport DM_HOME=/dm8\nexport PATH=$PATH:$DM_HOME/bin\nexport LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$DM_HOME/bin\n```\n\n### 防火墙设置\n\n生产环境应该对特定客户端开放数据库监听端口，并修改 DM 数据库默认的 5236 监听端口。\n\n## 安装数据库\n\n### 软件申请\n\n可访问达梦云适配中心[https://eco.dameng.com/download/?_blank](https://eco.dameng.com/download/?_blank)，下载 DM8 数据库试用版，如需其他版本，请联系达梦销售人员。\n\n查询操作系统（内核）版本，CPU 架构命令：`uname -a`。\n\n如上图所示，需申请 rh7，x86 版本数据库软件。\n\n以 iso 文件安装包为例，安装包命名规则如下：`dm8_20200930_x86_rh6_64_ent_8.1.1.134.iso`\n\n```\ndm8：数据库大版本为 dm8\n20200930：数据库版本发布日期\nx86：安装包匹配的 CPU 架构\nrh6：安装包匹配的系统版本 (redhat 6)\nent：数据库为企业版\n8.1.1.134：数据库详细版本号\n```\n\n### 安装数据库软件\n\n将安装包上传到服务器后使用 root 用户挂载 iso 安装包文件到 `/mnt` 目录下：\n\n```\nmount -oloop dm8_20200930_x86_rh6_64_ent_8.1.1.134.iso /mnt\n```\n\n执行以下命令，切换到 dmdba 用户：\n\n```\nsu - dmdba\n```\n\n执行以下命令，切换到/mnt 目录下：\n\n```\ncd /mnt\n```\n\n执行以下命令，查看文件：\n\n```\nll\n```\n\n执行 `DMInstall.bin` 文件开始安装，选择【-i】参数以命令行方式安装：\n\n1）执行安装命令\n\n在终端进入到安装程序所在文件夹，执行以下命令进行命令行安装：\n\n```shell\n[dmdba@~]# /mnt/DMInstall.bin -i\n```\n\n2）选择安装语言\n\n根据系统配置选择相应语言，输入选项，回车进行下一步。如下所示：\n\n```shell\n请选择安装语言(C/c:中文 E/e:英文) [C/c]：C\n解压安装程序..........\n欢迎使用达梦数据库安装程序\n```\n\n3）验证 key 文件\n\n可以选择是否输入 Key 文件路径。不输入则进入下一步安装，输入 Key 文件路径，安装程序将显示 Key 文件的详细信息，如果是合法的 Key 文件且在有效期内，可以继续安装。如下所示：\n\n```shell\n是否输入Key文件路径? (Y/y:是 N/n:否) [Y/y]：Y\n请输入Key文件的路径地址 [dm.key]：/opt/dmsetup/dm.key\n有效日期: 2020-12-25\n服务器颁布类型: 企业版\n发布类型: 试用版\n用户名称: 武汉达梦公司疫情期间临时授权\n授权用户数: 无限制\n并发连接数: 无限制\n```\n\n4）输入时区\n\n可以选择的时区信息。如下所示：\n\n```shell\n是否设置时区? (Y/y:是 N/n:否) [Y/y]：Y\n设置时区:\n[ 1]: GTM-12=日界线西\n[ 2]: GTM-11=萨摩亚群岛\n[ 3]: GTM-10=夏威夷\n[ 4]: GTM-09=阿拉斯加\n[ 5]: GTM-08=太平洋时间（美国和加拿大）\n[ 6]: GTM-07=亚利桑那\n[ 7]: GTM-06=中部时间（美国和加拿大）\n[ 8]: GTM-05=东部部时间（美国和加拿大）\n[ 9]: GTM-04=大西洋时间（美国和加拿大）\n[10]: GTM-03=巴西利亚\n[11]: GTM-02=中大西洋\n[12]: GTM-01=亚速尔群岛\n[13]: GTM=格林威治标准时间\n[14]: GTM+01=萨拉热窝\n[15]: GTM+02=开罗\n[16]: GTM+03=莫斯科\n[17]: GTM+04=阿布扎比\n[18]: GTM+05=伊斯兰堡\n[19]: GTM+06=达卡\n[20]: GTM+07=曼谷，河内\n[21]: GTM+08=中国标准时间\n[22]: GTM+09=汉城\n[23]: GTM+10=关岛\n[24]: GTM+11=所罗门群岛\n[25]: GTM+12=斐济\n[26]: GTM+13=努库阿勒法\n[27]: GTM+14=基里巴斯\n请选择设置时区 [21]：21\n```\n\n5）选择安装类型\n\n数据库软件安装程序提供四种安装方式：“典型安装”、“服务器安装”、“客户端安装”和“自定义安装”，用户可根据实际情况灵活地选择。如下所示：\n\n典型安装包括：服务器、客户端、驱动、用户手册、数据库服务。\n服务器安装包括：服务器、驱动、用户手册、数据库服务。\n客户端安装包括：客户端、驱动、用户手册。\n自定义安装包括：用户根据需求勾选组件，可以是服务器、客户端、驱动、用户手册、数据库服务中的任意组合。\n生产环境可以根据实际需求选择，一般情况下选择\"典型安装\"即可。\n\n```shell\n安装类型:\n1 典型安装\n2 服务器\n3 客户端\n4 自定义\n请选择安装类型的数字序号 [1 典型安装]：1\n所需空间: 1010M\n```\n\n6）选择安装路径\n\n输入数据库软件的安装路径，不输入则使用默认路径，默认路径为 `$HOME/dmdbms` (如果安装用户为 root ，则默认安装路径为 `/opt/dmdbms` ，但不建议使用 root 系统用户来安装)。如下所示：\n\n```shell\n请选择安装目录 [/home/dmdba/dmdbms]：/opt/dmdbms\n可用空间: 11G\n```\n\n> 注意\n>\n> 安装路径里的目录名由英文字母、数字和下划线等组成，不建议使用包含空格和中文字符等的路径。\n\n7）安装小结\n\n安装程序将打印用户之前输入的部分安装信息。如下所示：\n\n```shell\n是否确认安装路径(/opt/dmdbms)? (Y/y:是 N/n:否)  [Y/y]：Y\n安装前小结\n安装位置: /opt/dmdbms\n所需空间: 1010M\n可用空间: 11G\n版本信息: 企业版\n有效日期: 2020-12-25\n安装类型: 典型安装\n```\n\n8）安装\n\n```shell\nCopy是否确认安装? (Y/y:是 N/n:否)：Y\n2020-12-24 21:52:38 \n[INFO] 安装达梦数据库...\n2020-12-24 21:52:39 \n[INFO] 安装 基础 模块...\n2020-12-24 21:52:48 \n[INFO] 安装 服务器 模块...\n2020-12-24 21:52:48 \n[INFO] 安装 客户端 模块...\n2020-12-24 21:52:56 \n[INFO] 安装 驱动 模块...\n2020-12-24 21:52:58 \n[INFO] 安装 手册 模块...\n2020-12-24 21:53:00 \n[INFO] 安装 服务 模块...\n2020-12-24 21:53:02 \n[INFO] 移动ant日志文件。\n2020-12-24 21:53:03 \n[INFO] 安装达梦数据库完成。\n\n请以root系统用户执行命令:\n/opt/dmdbms/script/root/root_installer.sh\n\n安装结束\n```\n\n9）注册数据库服务\n\n当安装进度完成时将会弹出对话框，提示使用 root 系统用户执行相关命令。用户可根据对话框的说明完成相关操作，之后可关闭此对话框，点击“完成”按钮结束安装。如下所示：\n\n```shell\nCopy[dmdba@~]# su - root\n密码：<输入密码>\n[root@~]# /opt/dmdbms/script/root/root_installer.sh\n移动 /opt/dmdbms/bin/dm_svc.conf 到/etc目录\n修改服务器权限\n创建DmAPService服务\nCreated symlink from /etc/systemd/system/multiuser.target.wants/DmAPService.service to /usr/lib/systemd/system/DmAPService.service\n创建服务(DmAPService)完成\n启动DmAPService服务\n```\n\n### 使用 dminit 工具初始化实例\n\n执行以下命令，切换到 /opt/dmdbms/bin目录。\n\n快速查看参数`./dminit help`\n\n```\n[dmdba@localhost bin]$ ./dminit help\ninitdb V7.6.0.142-Build(2019.03.12-103811)ENT \ndb version: 0x7000a\nfile dm.key not found, use default license!\nLicense will expire on 2020-03-12\n格式: ./dminit     KEYWORD=value\n\n例程: ./dminit     PATH=/public/dmdb/dmData PAGE_SIZE=16\n\n关键字                     说明（默认值）\n--------------------------------------------------------------------------------\nINI_FILE                   初始化文件dm.ini存放的路径\nPATH                       初始数据库存放的路径\nCTL_PATH                   控制文件路径\nLOG_PATH                   日志文件路径\nEXTENT_SIZE                数据文件使用的簇大小(16)，可选值：16、32，单位：页\nPAGE_SIZE                  数据页大小(8)，可选值：4、8、16、32，单位：K\nLOG_SIZE                   日志文件大小(256)，单位为：M，范围为：64M ~ 2G\nCASE_SENSITIVE             大小敏感(Y)，可选值：Y/N，1/0\nCHARSET/UNICODE_FLAG       字符集(0)，可选值：0[GB18030]，1[UTF-8]，2[EUC-KR]\nLENGTH_IN_CHAR             VARCHAR类型长度是否以字符为单位(N)，可选值：Y/N，1/0\nSYSDBA_PWD                 设置SYSDBA密码(SYSDBA)，密码长度为9到48\nSYSAUDITOR_PWD             设置SYSAUDITOR密码(SYSAUDITOR)，密码长度为9到48\nDB_NAME                    数据库名(DAMENG)\nINSTANCE_NAME              实例名(DMSERVER)\nPORT_NUM                   监听端口号(5236)\nTIME_ZONE                  设置时区(+08:00)\nPAGE_CHECK                 页检查模式(0)，可选值：0/1/2\nEXTERNAL_CIPHER_NAME       设置默认加密算法\nEXTERNAL_HASH_NAME         设置默认HASH算法\nEXTERNAL_CRYPTO_NAME       设置根密钥加密引擎\nRLOG_ENC_FLAG              设置日志文件是否加密(N)，可选值：Y/N，1/0\nUSBKEY_PIN                 设置USBKEY PIN\nENCRYPT_NAME               设置全库加密算法\nBLANK_PAD_MODE             设置空格填充模式(0)，可选值：0/1\nSYSTEM_MIRROR_PATH         SYSTEM数据文件镜像路径\nMAIN_MIRROR_PATH           MAIN数据文件镜像\nROLL_MIRROR_PATH           回滚文件镜像路径\nMAL_FLAG                   初始化时设置dm.ini中的MAL_INI(0)\nARCH_FLAG                  初始化时设置dm.ini中的ARCH_INI(0)\nMPP_FLAG                   Mpp系统内的库初始化时设置dm.ini中的mpp_ini(0)\nCONTROL                    初始化配置文件（配置文件格式见系统管理员手册）\nAUTO_OVERWRITE             是否覆盖所有同名文件(0) 0:不覆盖 1:部分覆盖 2:完全覆盖\nUSE_NEW_HASH               是否使用改进的字符类型HASH算法(1)\nDCP_MODE                   是否是DCP代理模式(0)\nDCP_PORT_NUM               DCP代理模式下管理端口\nELOG_PATH                  指定初始化过程中生成的日志文件所在路径\nAP_PORT_NUM                ECS模式下AP协同工作的监听端口\nHELP                       打印帮助信息\n```\n\n通过执行dminit文件初始化实例参数来创建实例\n\n```\ncd /opt/dmdbms/bin\n./dminit path=/mnt/dm/dmdbms/data PAGE_SIZE=32 EXTENT_SIZE=32 CASE_SENSITIVE=0 LENGTH_IN_CHAR=1 CHARSET=1\n```\n\n> **注意**\n>\n> 初始化参数中除了 path 参数必须指定，其它参数都有默认值，如果需求与默认值不同，初始化的时候请指定需要的值。因为部分参数初始化后是无法修改的例如：page_size（页大小），charset（字符集），case_sensitive（大小写敏感）等。更多参数`./dminit help` 查看，是否无法修改的参数可以查询 v$dm_ini 视图，para_type=’READ ONLY’ 表示无法修改。\n\n### 启动实例\n\n以系统服务方式启动实例，DM 提供脚本将数据库实例注册为操作系统服务。\n\nroot 用户下切换到 `/opt/dmdbms/script/root/`：\n\n```\ncd /opt/dmdbms/script/root/\n```\n\n执行以下命令，执行脚本注册服务：\n\n```\n./dm_service_installer.sh -t dmserver -p dmserver -dm_ini /opt/dmdbms/data/DAMENG/dm.ini\n```\n\n服务名为 `DmService+-p` 参数后的内容，即 `DmServicedmserver`。\n\n> 提示\n>\n> `-t` 指服务类型是 dmserver；`-p` 为服务名的后缀；`-dm_ini` 为实例的 dm.ini 文件的绝对路径。\n\n执行以下命令，以服务方式启动实例：\n\n```\nsystemctl start DmServicedmserver\n```\n\n### 关闭实例\n\n对于以服务方式启动的实例，则以服务方式关闭实例：\n\n```\nsystemctl stop DmServicedmserver\n```\n\n> 建议\n>\n> 每个实例都建议注册为操作系统服务，这样不仅方便启动和关闭实例，而且注册为服务后，在服务器重启时，实例将随系统启动而自动启动。\n\n### 连接数据库\n\n执行以下命令，切换到 `/dm8/bin` 目录：\n\n```\ncd /opt/dmdbms/bin\n```\n\n执行以下命令，使用 disql 工具连接数据库：\n\n```\n./disql SYSDBA/SYSDBA@localhost:5236\n```\n\n> 提示\n>\n> 默认创建的实例，管理员用户 SYSDBA 的密码为 SYSDBA ，实例端口为 5236，字符集为 GB18030，大小写敏感。\n\n## 参数优化\n\n安装完成需要调整 `dm.ini` 文件参数。\n\n| 参数名称              | 参数含义                                           | 参数默认值 | 参数建议                       |\n| :-------------------- | :------------------------------------------------- | :--------- | :----------------------------- |\n| BUFFER                | 系统缓冲区大小，以 MB 为单位                       | 100        | 系统物理内存的 60%~80%         |\n| BUFFER_POOLS          | BUFFER 系统分区数                                  | 19         | 物理内存 64 GB 以下 53 GB 以上 |\n| HJ_BUF_GLOBAL_SIZE    | HASH 连接操作符的数据总缓存大小，以 MB 为单位      | 500        | 5000                           |\n| HJ_BUF_SIZE           | 单个 HASH 连接操作符的数据总缓存大小，以 MB 为单位 | 50         | 500                            |\n| DICT_BUF_SIZE         | 字典缓冲区大小，以 MB 为单位                       | 5          | 100                            |\n| TASK_THREADS          | 任务线程个数                                       | 4          | CPU 核数                       |\n| IO_THR_GROUPS         | 非 Windows 下有效，表示 IO 线程组个数              | 2          | CPU 核数/2                     |\n| MAX_SESSIONS          | 系统允许同时连接的最大数                           | 100        | 1000                           |\n| MAX_SESSION_STATEMENT | 单个会话上允许同时打开的语句句柄最大数             | 100        | 20000                          |\n| CACHE_POOL_SIZE       | SQL 缓冲池大小，以 MB 为单位                       | 20         | 200                            |\n\n参考脚本如下：\n\n```\nSP_SET_PARA_VALUE (2,'HJ_BUF_GLOBAL_SIZE',5000);\nSP_SET_PARA_VALUE (2,'HJ_BUF_SIZE',500);\nSP_SET_PARA_VALUE (2,'MAX_SESSIONS',1000);\nSP_SET_PARA_VALUE (2,'MAX_SESSION_STATEMENT',20000);\nSP_SET_PARA_VALUE (2,'CACHE_POOL_SIZE',200);\nSP_SET_PARA_VALUE (2,'DICT_BUF_SIZE',100);\n\ndeclare\nv_mem_mb int;\nv_cpus int;\nBUFFER int;\nBUFFER_POOLS INT;\nbegin\n    SELECT TOP 1 N_CPU,TOTAL_PHY_SIZE/1024/1024 INTO v_cpus,v_mem_mb FROM V$SYSTEMINFO;\n\n    v_mem_mb=round(v_mem_mb,-3);\n    SP_SET_PARA_VALUE(2,'TASK_THREADS',v_cpus);\n    SP_SET_PARA_VALUE(2,'IO_THR_GROUPS',v_cpus/2);\n    IF v_mem_mb >= 64000  THEN \n         BUFFER_POOLS :=101;\n      ELSE\n         BUFFER_POOLS :=53;\n    END IF;\n\n    BUFFER := round(cast(v_mem_mb * 0.8 as int),-3);\n    SP_SET_PARA_VALUE(2,'BUFFER',  BUFFER);\n    SP_SET_PARA_VALUE(2,'BUFFER_POOLS', BUFFER_POOLS);\nend;\n```\n\n> 注意\n>\n> 修改完参数后，需要重启数据库生效。\n\n## 归档配置\n\n生产环境必须开启归档日志，且必须限制归档日志保留量，限制方法：\n\n1. 设置归档空间大小限制即指定 `SPACE_LIMIT` 参数（单位是 MB）。\n2. 定期删除归档日志（设置定时作业）。\n\n例如开启归档并限制归档空间为 100 GB，如下所示：\n\n```\nalter database mount;\nalter database add archivelog 'dest=/dmarch/,TYPE=local,FILE_SIZE=1024,SPACE_LIMIT=102400';\nalter database archivelog;\nalter database open;\n```\n\n## 定制备份策略\n\n上线前必须规划好备份策略，可以使用 DM 作业系统，定时备份。\n\n根据应用需求，定制备份策略如下所示：\n\n| 备份类型 | 备份周期 | 备份时间           |\n| :------- | :------- | :----------------- |\n| 全量备份 | 每周     | 每周五 23 点       |\n| 增量备份 | 每天     | 除周五外每天 23 点 |\n| 删除备份 | 每天     | 每天 23 点 30      |\n\n执行以下命令，创建作业系统表：\n\n```\nSP_INIT_JOB_SYS(1);\n```\n\n全量备份（每周五 23 点全备）：\n\nCopy\n\n```\ncall SP_CREATE_JOB('bakfull',1,0,'',0,0,'',0,'');\n\ncall SP_JOB_CONFIG_START('bakfull');\n\ncall SP_ADD_JOB_STEP('bakfull', 'bak01', 6, '01000000/dmbak', 1, 2, 0, 0, NULL, 0);\n\ncall SP_ADD_JOB_SCHEDULE('bakfull', 'bak01', 1, 2, 1, 32, 0, '23:00:00', NULL, '2020-11-02 14:42:15', NULL, '');\n\ncall SP_JOB_CONFIG_COMMIT('bakfull');\n```\n\n增量备份（每周除周五外每天 23 点增量备份）：\n\n```\ncall SP_CREATE_JOB('bakincr',1,0,'',0,0,'',0,'');\n\ncall SP_JOB_CONFIG_START('bakincr');\n\ncall SP_ADD_JOB_STEP('bakincr', 'bak02', 6, '11000000/dmbak', 1, 2, 0, 0, NULL, 0);\n\ncall SP_ADD_JOB_SCHEDULE('bakincr', 'bak2', 1, 2, 1, 95, 0, '23:00:00', NULL, '2020-11-02 14:44:30', NULL, '');\n\ncall SP_JOB_CONFIG_COMMIT('bakincr');\n```\n\n备份定期删除（每天 23：30 删除 14 天前备份）：\n\n```\ncall SP_CREATE_JOB('delbak',1,0,'',0,0,'',0,'');\ncall SP_JOB_CONFIG_START('delbak');\ncall SP_ADD_JOB_STEP('delbak', 'bak1', 0, 'SF_BAKSET_BACKUP_DIR_ADD(''DISK'',''/dmbak'');call sp_db_bakset_remove_batch(''DISK'',now()-14);', 1, 2, 0, 0, NULL, 0);\ncall SP_ADD_JOB_SCHEDULE('delbak', 'del01', 1, 1, 1, 0, 0, '23:30:00', NULL, '2020-11-02 14:48:41', NULL, '');\ncall SP_JOB_CONFIG_COMMIT('delbak');\n```\n\n> 注意\n>\n> 备份的基本要求是：保留最少一次全备+全备（或者全备后的增备）时间点到当前的全部归档日志。删除备份前尽量将备份文件拷贝到单独的备份服务器上。\n\n详见请参考：https://eco.dameng.com/docs/zh-cn/ops/standard-stand-alone.html\n","slug":"达梦数据库单机安装","published":1,"updated":"2023-01-03T06:17:51.246Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clcfuykyu000h3wrs5jnvft3a","content":"<h1 id=\"达梦数据库单机安装\"><a href=\"#达梦数据库单机安装\" class=\"headerlink\" title=\"达梦数据库单机安装\"></a>达梦数据库单机安装</h1><h1 id=\"单机部署\"><a href=\"#单机部署\" class=\"headerlink\" title=\"单机部署\"></a>单机部署</h1><span id=\"more\"></span>\n\n<h2 id=\"服务器硬件需求\"><a href=\"#服务器硬件需求\" class=\"headerlink\" title=\"服务器硬件需求\"></a>服务器硬件需求</h2><p>按实际业务需求，选择合适的服务器，参考如下：</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">硬件</th>\n<th align=\"left\">要求</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\">物理内存</td>\n<td align=\"left\">&gt;= 16 GB</td>\n</tr>\n<tr>\n<td align=\"left\">交换区</td>\n<td align=\"left\">Swap 空间&gt;=物理内存</td>\n</tr>\n<tr>\n<td align=\"left\">/tmp大小</td>\n<td align=\"left\">&gt; 1000 MB</td>\n</tr>\n<tr>\n<td align=\"left\">网络</td>\n<td align=\"left\">物理机器需要 2 个网卡，2 个网卡做 band</td>\n</tr>\n<tr>\n<td align=\"left\">磁盘</td>\n<td align=\"left\">根据实际应用系统需要挂载合适大小磁盘</td>\n</tr>\n<tr>\n<td align=\"left\">时间服务器</td>\n<td align=\"left\">按机房要求配置连接时间服务器</td>\n</tr>\n</tbody></table>\n<h2 id=\"操作系统要求\"><a href=\"#操作系统要求\" class=\"headerlink\" title=\"操作系统要求\"></a>操作系统要求</h2><h3 id=\"操作系统版本安装\"><a href=\"#操作系统版本安装\" class=\"headerlink\" title=\"操作系统版本安装\"></a>操作系统版本安装</h3><p>DM 数据库安装在 Linux 操作系统所需条件：glibc 2.3 以上，内核 2.6，预先安装 UnixODBC，系统性能监控等组件。</p>\n<h3 id=\"目录与存储规划\"><a href=\"#目录与存储规划\" class=\"headerlink\" title=\"目录与存储规划\"></a>目录与存储规划</h3><table>\n<thead>\n<tr>\n<th align=\"left\">用途</th>\n<th align=\"left\">目录路径</th>\n<th align=\"left\">备注</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\">数据库软件安装目录</td>\n<td align=\"left\">/dm8</td>\n<td align=\"left\">可用空间&gt; 50 GB</td>\n</tr>\n<tr>\n<td align=\"left\">实例安装目录</td>\n<td align=\"left\">/dmdata</td>\n<td align=\"left\">单独挂载性能最好的磁盘建议 SSD</td>\n</tr>\n<tr>\n<td align=\"left\">归档日志存放目录</td>\n<td align=\"left\">/dmarch</td>\n<td align=\"left\">单独挂载磁盘</td>\n</tr>\n<tr>\n<td align=\"left\">备份文件存放目录</td>\n<td align=\"left\">/dmbak</td>\n<td align=\"left\">单独挂载磁盘</td>\n</tr>\n</tbody></table>\n<h3 id=\"用户与组\"><a href=\"#用户与组\" class=\"headerlink\" title=\"用户与组\"></a>用户与组</h3><p>DM 数据库不应该使用 root 用户安装和维护。需要在安装之前为 DM 数据库创建一个专用的系统用户 (dmdba) 和用户组 (dinstall)。</p>\n<p>执行以下命令，新建用户组 dinstall：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">groupadd dinstall</span><br></pre></td></tr></table></figure>\n\n<p>执行以下命令，新建用户 dmdba：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">useradd  -g dinstall -m -d /home/dmdba -s /bin/bash  dmdba</span><br></pre></td></tr></table></figure>\n\n<p>执行以下命令，修改 dmdba 用户密码：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">passwd dmdba</span><br></pre></td></tr></table></figure>\n\n<p>输入密码并确认。</p>\n<h3 id=\"修改安装目录权限\"><a href=\"#修改安装目录权限\" class=\"headerlink\" title=\"修改安装目录权限\"></a>修改安装目录权限</h3><p>将新建的安装路径目录权限的用户修改为 dmdba，用户组修改为 dinstall。命令如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chown dmdba:dinstall -R /dm8/</span><br></pre></td></tr></table></figure>\n\n<p>给安装路径下的文件设置 755 权限。命令如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chmod -R 755 /dm8</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"用户资源限制\"><a href=\"#用户资源限制\" class=\"headerlink\" title=\"用户资源限制\"></a>用户资源限制</h3><p>执行以下命令，修改 dmdba 用户资源限制：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /etc/security/limits.conf</span><br></pre></td></tr></table></figure>\n\n<p>文件末尾添加如下内容：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dmdba soft core unlimited</span><br><span class=\"line\">dmdba hard core unlimited</span><br><span class=\"line\">dmdba soft nofile 65536</span><br><span class=\"line\">dmdba hard nofile 65536</span><br><span class=\"line\">dmdba soft nproc  65536</span><br><span class=\"line\">dmdba hard nproc  65536</span><br><span class=\"line\">dmdba soft stack  65536</span><br><span class=\"line\">dmdba hard stack  65536</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"用户环境变量\"><a href=\"#用户环境变量\" class=\"headerlink\" title=\"用户环境变量\"></a>用户环境变量</h3><p>执行以下命令，修改 dmdba 用户环境变量：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vi /home/dmdba/.bash_profile</span><br></pre></td></tr></table></figure>\n\n<p>文件末尾添加如下内容：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export DM_HOME=/dm8</span><br><span class=\"line\">export PATH=$PATH:$DM_HOME/bin</span><br><span class=\"line\">export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$DM_HOME/bin</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"防火墙设置\"><a href=\"#防火墙设置\" class=\"headerlink\" title=\"防火墙设置\"></a>防火墙设置</h3><p>生产环境应该对特定客户端开放数据库监听端口，并修改 DM 数据库默认的 5236 监听端口。</p>\n<h2 id=\"安装数据库\"><a href=\"#安装数据库\" class=\"headerlink\" title=\"安装数据库\"></a>安装数据库</h2><h3 id=\"软件申请\"><a href=\"#软件申请\" class=\"headerlink\" title=\"软件申请\"></a>软件申请</h3><p>可访问达梦云适配中心<a href=\"https://eco.dameng.com/download/?_blank\">https://eco.dameng.com/download/?_blank</a>，下载 DM8 数据库试用版，如需其他版本，请联系达梦销售人员。</p>\n<p>查询操作系统（内核）版本，CPU 架构命令：<code>uname -a</code>。</p>\n<p>如上图所示，需申请 rh7，x86 版本数据库软件。</p>\n<p>以 iso 文件安装包为例，安装包命名规则如下：<code>dm8_20200930_x86_rh6_64_ent_8.1.1.134.iso</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dm8：数据库大版本为 dm8</span><br><span class=\"line\">20200930：数据库版本发布日期</span><br><span class=\"line\">x86：安装包匹配的 CPU 架构</span><br><span class=\"line\">rh6：安装包匹配的系统版本 (redhat 6)</span><br><span class=\"line\">ent：数据库为企业版</span><br><span class=\"line\">8.1.1.134：数据库详细版本号</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"安装数据库软件\"><a href=\"#安装数据库软件\" class=\"headerlink\" title=\"安装数据库软件\"></a>安装数据库软件</h3><p>将安装包上传到服务器后使用 root 用户挂载 iso 安装包文件到 <code>/mnt</code> 目录下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mount -oloop dm8_20200930_x86_rh6_64_ent_8.1.1.134.iso /mnt</span><br></pre></td></tr></table></figure>\n\n<p>执行以下命令，切换到 dmdba 用户：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">su - dmdba</span><br></pre></td></tr></table></figure>\n\n<p>执行以下命令，切换到/mnt 目录下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /mnt</span><br></pre></td></tr></table></figure>\n\n<p>执行以下命令，查看文件：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ll</span><br></pre></td></tr></table></figure>\n\n<p>执行 <code>DMInstall.bin</code> 文件开始安装，选择【-i】参数以命令行方式安装：</p>\n<p>1）执行安装命令</p>\n<p>在终端进入到安装程序所在文件夹，执行以下命令进行命令行安装：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">[dmdba@~]# </span><span class=\"language-bash\">/mnt/DMInstall.bin -i</span></span><br></pre></td></tr></table></figure>\n\n<p>2）选择安装语言</p>\n<p>根据系统配置选择相应语言，输入选项，回车进行下一步。如下所示：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">请选择安装语言(C/c:中文 E/e:英文) [C/c]：C</span><br><span class=\"line\">解压安装程序..........</span><br><span class=\"line\">欢迎使用达梦数据库安装程序</span><br></pre></td></tr></table></figure>\n\n<p>3）验证 key 文件</p>\n<p>可以选择是否输入 Key 文件路径。不输入则进入下一步安装，输入 Key 文件路径，安装程序将显示 Key 文件的详细信息，如果是合法的 Key 文件且在有效期内，可以继续安装。如下所示：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">是否输入Key文件路径? (Y/y:是 N/n:否) [Y/y]：Y</span><br><span class=\"line\">请输入Key文件的路径地址 [dm.key]：/opt/dmsetup/dm.key</span><br><span class=\"line\">有效日期: 2020-12-25</span><br><span class=\"line\">服务器颁布类型: 企业版</span><br><span class=\"line\">发布类型: 试用版</span><br><span class=\"line\">用户名称: 武汉达梦公司疫情期间临时授权</span><br><span class=\"line\">授权用户数: 无限制</span><br><span class=\"line\">并发连接数: 无限制</span><br></pre></td></tr></table></figure>\n\n<p>4）输入时区</p>\n<p>可以选择的时区信息。如下所示：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">是否设置时区? (Y/y:是 N/n:否) [Y/y]：Y</span><br><span class=\"line\">设置时区:</span><br><span class=\"line\">[ 1]: GTM-12=日界线西</span><br><span class=\"line\">[ 2]: GTM-11=萨摩亚群岛</span><br><span class=\"line\">[ 3]: GTM-10=夏威夷</span><br><span class=\"line\">[ 4]: GTM-09=阿拉斯加</span><br><span class=\"line\">[ 5]: GTM-08=太平洋时间（美国和加拿大）</span><br><span class=\"line\">[ 6]: GTM-07=亚利桑那</span><br><span class=\"line\">[ 7]: GTM-06=中部时间（美国和加拿大）</span><br><span class=\"line\">[ 8]: GTM-05=东部部时间（美国和加拿大）</span><br><span class=\"line\">[ 9]: GTM-04=大西洋时间（美国和加拿大）</span><br><span class=\"line\">[10]: GTM-03=巴西利亚</span><br><span class=\"line\">[11]: GTM-02=中大西洋</span><br><span class=\"line\">[12]: GTM-01=亚速尔群岛</span><br><span class=\"line\">[13]: GTM=格林威治标准时间</span><br><span class=\"line\">[14]: GTM+01=萨拉热窝</span><br><span class=\"line\">[15]: GTM+02=开罗</span><br><span class=\"line\">[16]: GTM+03=莫斯科</span><br><span class=\"line\">[17]: GTM+04=阿布扎比</span><br><span class=\"line\">[18]: GTM+05=伊斯兰堡</span><br><span class=\"line\">[19]: GTM+06=达卡</span><br><span class=\"line\">[20]: GTM+07=曼谷，河内</span><br><span class=\"line\">[21]: GTM+08=中国标准时间</span><br><span class=\"line\">[22]: GTM+09=汉城</span><br><span class=\"line\">[23]: GTM+10=关岛</span><br><span class=\"line\">[24]: GTM+11=所罗门群岛</span><br><span class=\"line\">[25]: GTM+12=斐济</span><br><span class=\"line\">[26]: GTM+13=努库阿勒法</span><br><span class=\"line\">[27]: GTM+14=基里巴斯</span><br><span class=\"line\">请选择设置时区 [21]：21</span><br></pre></td></tr></table></figure>\n\n<p>5）选择安装类型</p>\n<p>数据库软件安装程序提供四种安装方式：“典型安装”、“服务器安装”、“客户端安装”和“自定义安装”，用户可根据实际情况灵活地选择。如下所示：</p>\n<p>典型安装包括：服务器、客户端、驱动、用户手册、数据库服务。<br>服务器安装包括：服务器、驱动、用户手册、数据库服务。<br>客户端安装包括：客户端、驱动、用户手册。<br>自定义安装包括：用户根据需求勾选组件，可以是服务器、客户端、驱动、用户手册、数据库服务中的任意组合。<br>生产环境可以根据实际需求选择，一般情况下选择”典型安装”即可。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">安装类型:</span><br><span class=\"line\">1 典型安装</span><br><span class=\"line\">2 服务器</span><br><span class=\"line\">3 客户端</span><br><span class=\"line\">4 自定义</span><br><span class=\"line\">请选择安装类型的数字序号 [1 典型安装]：1</span><br><span class=\"line\">所需空间: 1010M</span><br></pre></td></tr></table></figure>\n\n<p>6）选择安装路径</p>\n<p>输入数据库软件的安装路径，不输入则使用默认路径，默认路径为 <code>$HOME/dmdbms</code> (如果安装用户为 root ，则默认安装路径为 <code>/opt/dmdbms</code> ，但不建议使用 root 系统用户来安装)。如下所示：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">请选择安装目录 [/home/dmdba/dmdbms]：/opt/dmdbms</span><br><span class=\"line\">可用空间: 11G</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>注意</p>\n<p>安装路径里的目录名由英文字母、数字和下划线等组成，不建议使用包含空格和中文字符等的路径。</p>\n</blockquote>\n<p>7）安装小结</p>\n<p>安装程序将打印用户之前输入的部分安装信息。如下所示：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">是否确认安装路径(/opt/dmdbms)? (Y/y:是 N/n:否)  [Y/y]：Y</span><br><span class=\"line\">安装前小结</span><br><span class=\"line\">安装位置: /opt/dmdbms</span><br><span class=\"line\">所需空间: 1010M</span><br><span class=\"line\">可用空间: 11G</span><br><span class=\"line\">版本信息: 企业版</span><br><span class=\"line\">有效日期: 2020-12-25</span><br><span class=\"line\">安装类型: 典型安装</span><br></pre></td></tr></table></figure>\n\n<p>8）安装</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Copy是否确认安装? (Y/y:是 N/n:否)：Y</span><br><span class=\"line\">2020-12-24 21:52:38 </span><br><span class=\"line\">[INFO] 安装达梦数据库...</span><br><span class=\"line\">2020-12-24 21:52:39 </span><br><span class=\"line\">[INFO] 安装 基础 模块...</span><br><span class=\"line\">2020-12-24 21:52:48 </span><br><span class=\"line\">[INFO] 安装 服务器 模块...</span><br><span class=\"line\">2020-12-24 21:52:48 </span><br><span class=\"line\">[INFO] 安装 客户端 模块...</span><br><span class=\"line\">2020-12-24 21:52:56 </span><br><span class=\"line\">[INFO] 安装 驱动 模块...</span><br><span class=\"line\">2020-12-24 21:52:58 </span><br><span class=\"line\">[INFO] 安装 手册 模块...</span><br><span class=\"line\">2020-12-24 21:53:00 </span><br><span class=\"line\">[INFO] 安装 服务 模块...</span><br><span class=\"line\">2020-12-24 21:53:02 </span><br><span class=\"line\">[INFO] 移动ant日志文件。</span><br><span class=\"line\">2020-12-24 21:53:03 </span><br><span class=\"line\">[INFO] 安装达梦数据库完成。</span><br><span class=\"line\"></span><br><span class=\"line\">请以root系统用户执行命令:</span><br><span class=\"line\">/opt/dmdbms/script/root/root_installer.sh</span><br><span class=\"line\"></span><br><span class=\"line\">安装结束</span><br></pre></td></tr></table></figure>\n\n<p>9）注册数据库服务</p>\n<p>当安装进度完成时将会弹出对话框，提示使用 root 系统用户执行相关命令。用户可根据对话框的说明完成相关操作，之后可关闭此对话框，点击“完成”按钮结束安装。如下所示：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">Copy[dmdba@~]# </span><span class=\"language-bash\">su - root</span></span><br><span class=\"line\">密码：&lt;输入密码&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\">[root@~]# </span><span class=\"language-bash\">/opt/dmdbms/script/root/root_installer.sh</span></span><br><span class=\"line\">移动 /opt/dmdbms/bin/dm_svc.conf 到/etc目录</span><br><span class=\"line\">修改服务器权限</span><br><span class=\"line\">创建DmAPService服务</span><br><span class=\"line\">Created symlink from /etc/systemd/system/multiuser.target.wants/DmAPService.service to /usr/lib/systemd/system/DmAPService.service</span><br><span class=\"line\">创建服务(DmAPService)完成</span><br><span class=\"line\">启动DmAPService服务</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"使用-dminit-工具初始化实例\"><a href=\"#使用-dminit-工具初始化实例\" class=\"headerlink\" title=\"使用 dminit 工具初始化实例\"></a>使用 dminit 工具初始化实例</h3><p>执行以下命令，切换到 /opt/dmdbms/bin目录。</p>\n<p>快速查看参数<code>./dminit help</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@localhost bin]$ ./dminit help</span><br><span class=\"line\">initdb V7.6.0.142-Build(2019.03.12-103811)ENT </span><br><span class=\"line\">db version: 0x7000a</span><br><span class=\"line\">file dm.key not found, use default license!</span><br><span class=\"line\">License will expire on 2020-03-12</span><br><span class=\"line\">格式: ./dminit     KEYWORD=value</span><br><span class=\"line\"></span><br><span class=\"line\">例程: ./dminit     PATH=/public/dmdb/dmData PAGE_SIZE=16</span><br><span class=\"line\"></span><br><span class=\"line\">关键字                     说明（默认值）</span><br><span class=\"line\">--------------------------------------------------------------------------------</span><br><span class=\"line\">INI_FILE                   初始化文件dm.ini存放的路径</span><br><span class=\"line\">PATH                       初始数据库存放的路径</span><br><span class=\"line\">CTL_PATH                   控制文件路径</span><br><span class=\"line\">LOG_PATH                   日志文件路径</span><br><span class=\"line\">EXTENT_SIZE                数据文件使用的簇大小(16)，可选值：16、32，单位：页</span><br><span class=\"line\">PAGE_SIZE                  数据页大小(8)，可选值：4、8、16、32，单位：K</span><br><span class=\"line\">LOG_SIZE                   日志文件大小(256)，单位为：M，范围为：64M ~ 2G</span><br><span class=\"line\">CASE_SENSITIVE             大小敏感(Y)，可选值：Y/N，1/0</span><br><span class=\"line\">CHARSET/UNICODE_FLAG       字符集(0)，可选值：0[GB18030]，1[UTF-8]，2[EUC-KR]</span><br><span class=\"line\">LENGTH_IN_CHAR             VARCHAR类型长度是否以字符为单位(N)，可选值：Y/N，1/0</span><br><span class=\"line\">SYSDBA_PWD                 设置SYSDBA密码(SYSDBA)，密码长度为9到48</span><br><span class=\"line\">SYSAUDITOR_PWD             设置SYSAUDITOR密码(SYSAUDITOR)，密码长度为9到48</span><br><span class=\"line\">DB_NAME                    数据库名(DAMENG)</span><br><span class=\"line\">INSTANCE_NAME              实例名(DMSERVER)</span><br><span class=\"line\">PORT_NUM                   监听端口号(5236)</span><br><span class=\"line\">TIME_ZONE                  设置时区(+08:00)</span><br><span class=\"line\">PAGE_CHECK                 页检查模式(0)，可选值：0/1/2</span><br><span class=\"line\">EXTERNAL_CIPHER_NAME       设置默认加密算法</span><br><span class=\"line\">EXTERNAL_HASH_NAME         设置默认HASH算法</span><br><span class=\"line\">EXTERNAL_CRYPTO_NAME       设置根密钥加密引擎</span><br><span class=\"line\">RLOG_ENC_FLAG              设置日志文件是否加密(N)，可选值：Y/N，1/0</span><br><span class=\"line\">USBKEY_PIN                 设置USBKEY PIN</span><br><span class=\"line\">ENCRYPT_NAME               设置全库加密算法</span><br><span class=\"line\">BLANK_PAD_MODE             设置空格填充模式(0)，可选值：0/1</span><br><span class=\"line\">SYSTEM_MIRROR_PATH         SYSTEM数据文件镜像路径</span><br><span class=\"line\">MAIN_MIRROR_PATH           MAIN数据文件镜像</span><br><span class=\"line\">ROLL_MIRROR_PATH           回滚文件镜像路径</span><br><span class=\"line\">MAL_FLAG                   初始化时设置dm.ini中的MAL_INI(0)</span><br><span class=\"line\">ARCH_FLAG                  初始化时设置dm.ini中的ARCH_INI(0)</span><br><span class=\"line\">MPP_FLAG                   Mpp系统内的库初始化时设置dm.ini中的mpp_ini(0)</span><br><span class=\"line\">CONTROL                    初始化配置文件（配置文件格式见系统管理员手册）</span><br><span class=\"line\">AUTO_OVERWRITE             是否覆盖所有同名文件(0) 0:不覆盖 1:部分覆盖 2:完全覆盖</span><br><span class=\"line\">USE_NEW_HASH               是否使用改进的字符类型HASH算法(1)</span><br><span class=\"line\">DCP_MODE                   是否是DCP代理模式(0)</span><br><span class=\"line\">DCP_PORT_NUM               DCP代理模式下管理端口</span><br><span class=\"line\">ELOG_PATH                  指定初始化过程中生成的日志文件所在路径</span><br><span class=\"line\">AP_PORT_NUM                ECS模式下AP协同工作的监听端口</span><br><span class=\"line\">HELP                       打印帮助信息</span><br></pre></td></tr></table></figure>\n\n<p>通过执行dminit文件初始化实例参数来创建实例</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /opt/dmdbms/bin</span><br><span class=\"line\">./dminit path=/mnt/dm/dmdbms/data PAGE_SIZE=32 EXTENT_SIZE=32 CASE_SENSITIVE=0 LENGTH_IN_CHAR=1 CHARSET=1</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p><strong>注意</strong></p>\n<p>初始化参数中除了 path 参数必须指定，其它参数都有默认值，如果需求与默认值不同，初始化的时候请指定需要的值。因为部分参数初始化后是无法修改的例如：page_size（页大小），charset（字符集），case_sensitive（大小写敏感）等。更多参数<code>./dminit help</code> 查看，是否无法修改的参数可以查询 v$dm_ini 视图，para_type=’READ ONLY’ 表示无法修改。</p>\n</blockquote>\n<h3 id=\"启动实例\"><a href=\"#启动实例\" class=\"headerlink\" title=\"启动实例\"></a>启动实例</h3><p>以系统服务方式启动实例，DM 提供脚本将数据库实例注册为操作系统服务。</p>\n<p>root 用户下切换到 <code>/opt/dmdbms/script/root/</code>：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /opt/dmdbms/script/root/</span><br></pre></td></tr></table></figure>\n\n<p>执行以下命令，执行脚本注册服务：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./dm_service_installer.sh -t dmserver -p dmserver -dm_ini /opt/dmdbms/data/DAMENG/dm.ini</span><br></pre></td></tr></table></figure>\n\n<p>服务名为 <code>DmService+-p</code> 参数后的内容，即 <code>DmServicedmserver</code>。</p>\n<blockquote>\n<p>提示</p>\n<p><code>-t</code> 指服务类型是 dmserver；<code>-p</code> 为服务名的后缀；<code>-dm_ini</code> 为实例的 dm.ini 文件的绝对路径。</p>\n</blockquote>\n<p>执行以下命令，以服务方式启动实例：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl start DmServicedmserver</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"关闭实例\"><a href=\"#关闭实例\" class=\"headerlink\" title=\"关闭实例\"></a>关闭实例</h3><p>对于以服务方式启动的实例，则以服务方式关闭实例：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl stop DmServicedmserver</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>建议</p>\n<p>每个实例都建议注册为操作系统服务，这样不仅方便启动和关闭实例，而且注册为服务后，在服务器重启时，实例将随系统启动而自动启动。</p>\n</blockquote>\n<h3 id=\"连接数据库\"><a href=\"#连接数据库\" class=\"headerlink\" title=\"连接数据库\"></a>连接数据库</h3><p>执行以下命令，切换到 <code>/dm8/bin</code> 目录：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /opt/dmdbms/bin</span><br></pre></td></tr></table></figure>\n\n<p>执行以下命令，使用 disql 工具连接数据库：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./disql SYSDBA/SYSDBA@localhost:5236</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>提示</p>\n<p>默认创建的实例，管理员用户 SYSDBA 的密码为 SYSDBA ，实例端口为 5236，字符集为 GB18030，大小写敏感。</p>\n</blockquote>\n<h2 id=\"参数优化\"><a href=\"#参数优化\" class=\"headerlink\" title=\"参数优化\"></a>参数优化</h2><p>安装完成需要调整 <code>dm.ini</code> 文件参数。</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">参数名称</th>\n<th align=\"left\">参数含义</th>\n<th align=\"left\">参数默认值</th>\n<th align=\"left\">参数建议</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\">BUFFER</td>\n<td align=\"left\">系统缓冲区大小，以 MB 为单位</td>\n<td align=\"left\">100</td>\n<td align=\"left\">系统物理内存的 60%~80%</td>\n</tr>\n<tr>\n<td align=\"left\">BUFFER_POOLS</td>\n<td align=\"left\">BUFFER 系统分区数</td>\n<td align=\"left\">19</td>\n<td align=\"left\">物理内存 64 GB 以下 53 GB 以上</td>\n</tr>\n<tr>\n<td align=\"left\">HJ_BUF_GLOBAL_SIZE</td>\n<td align=\"left\">HASH 连接操作符的数据总缓存大小，以 MB 为单位</td>\n<td align=\"left\">500</td>\n<td align=\"left\">5000</td>\n</tr>\n<tr>\n<td align=\"left\">HJ_BUF_SIZE</td>\n<td align=\"left\">单个 HASH 连接操作符的数据总缓存大小，以 MB 为单位</td>\n<td align=\"left\">50</td>\n<td align=\"left\">500</td>\n</tr>\n<tr>\n<td align=\"left\">DICT_BUF_SIZE</td>\n<td align=\"left\">字典缓冲区大小，以 MB 为单位</td>\n<td align=\"left\">5</td>\n<td align=\"left\">100</td>\n</tr>\n<tr>\n<td align=\"left\">TASK_THREADS</td>\n<td align=\"left\">任务线程个数</td>\n<td align=\"left\">4</td>\n<td align=\"left\">CPU 核数</td>\n</tr>\n<tr>\n<td align=\"left\">IO_THR_GROUPS</td>\n<td align=\"left\">非 Windows 下有效，表示 IO 线程组个数</td>\n<td align=\"left\">2</td>\n<td align=\"left\">CPU 核数/2</td>\n</tr>\n<tr>\n<td align=\"left\">MAX_SESSIONS</td>\n<td align=\"left\">系统允许同时连接的最大数</td>\n<td align=\"left\">100</td>\n<td align=\"left\">1000</td>\n</tr>\n<tr>\n<td align=\"left\">MAX_SESSION_STATEMENT</td>\n<td align=\"left\">单个会话上允许同时打开的语句句柄最大数</td>\n<td align=\"left\">100</td>\n<td align=\"left\">20000</td>\n</tr>\n<tr>\n<td align=\"left\">CACHE_POOL_SIZE</td>\n<td align=\"left\">SQL 缓冲池大小，以 MB 为单位</td>\n<td align=\"left\">20</td>\n<td align=\"left\">200</td>\n</tr>\n</tbody></table>\n<p>参考脚本如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SP_SET_PARA_VALUE (2,&#x27;HJ_BUF_GLOBAL_SIZE&#x27;,5000);</span><br><span class=\"line\">SP_SET_PARA_VALUE (2,&#x27;HJ_BUF_SIZE&#x27;,500);</span><br><span class=\"line\">SP_SET_PARA_VALUE (2,&#x27;MAX_SESSIONS&#x27;,1000);</span><br><span class=\"line\">SP_SET_PARA_VALUE (2,&#x27;MAX_SESSION_STATEMENT&#x27;,20000);</span><br><span class=\"line\">SP_SET_PARA_VALUE (2,&#x27;CACHE_POOL_SIZE&#x27;,200);</span><br><span class=\"line\">SP_SET_PARA_VALUE (2,&#x27;DICT_BUF_SIZE&#x27;,100);</span><br><span class=\"line\"></span><br><span class=\"line\">declare</span><br><span class=\"line\">v_mem_mb int;</span><br><span class=\"line\">v_cpus int;</span><br><span class=\"line\">BUFFER int;</span><br><span class=\"line\">BUFFER_POOLS INT;</span><br><span class=\"line\">begin</span><br><span class=\"line\">    SELECT TOP 1 N_CPU,TOTAL_PHY_SIZE/1024/1024 INTO v_cpus,v_mem_mb FROM V$SYSTEMINFO;</span><br><span class=\"line\"></span><br><span class=\"line\">    v_mem_mb=round(v_mem_mb,-3);</span><br><span class=\"line\">    SP_SET_PARA_VALUE(2,&#x27;TASK_THREADS&#x27;,v_cpus);</span><br><span class=\"line\">    SP_SET_PARA_VALUE(2,&#x27;IO_THR_GROUPS&#x27;,v_cpus/2);</span><br><span class=\"line\">    IF v_mem_mb &gt;= 64000  THEN </span><br><span class=\"line\">         BUFFER_POOLS :=101;</span><br><span class=\"line\">      ELSE</span><br><span class=\"line\">         BUFFER_POOLS :=53;</span><br><span class=\"line\">    END IF;</span><br><span class=\"line\"></span><br><span class=\"line\">    BUFFER := round(cast(v_mem_mb * 0.8 as int),-3);</span><br><span class=\"line\">    SP_SET_PARA_VALUE(2,&#x27;BUFFER&#x27;,  BUFFER);</span><br><span class=\"line\">    SP_SET_PARA_VALUE(2,&#x27;BUFFER_POOLS&#x27;, BUFFER_POOLS);</span><br><span class=\"line\">end;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>注意</p>\n<p>修改完参数后，需要重启数据库生效。</p>\n</blockquote>\n<h2 id=\"归档配置\"><a href=\"#归档配置\" class=\"headerlink\" title=\"归档配置\"></a>归档配置</h2><p>生产环境必须开启归档日志，且必须限制归档日志保留量，限制方法：</p>\n<ol>\n<li>设置归档空间大小限制即指定 <code>SPACE_LIMIT</code> 参数（单位是 MB）。</li>\n<li>定期删除归档日志（设置定时作业）。</li>\n</ol>\n<p>例如开启归档并限制归档空间为 100 GB，如下所示：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">alter database mount;</span><br><span class=\"line\">alter database add archivelog &#x27;dest=/dmarch/,TYPE=local,FILE_SIZE=1024,SPACE_LIMIT=102400&#x27;;</span><br><span class=\"line\">alter database archivelog;</span><br><span class=\"line\">alter database open;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"定制备份策略\"><a href=\"#定制备份策略\" class=\"headerlink\" title=\"定制备份策略\"></a>定制备份策略</h2><p>上线前必须规划好备份策略，可以使用 DM 作业系统，定时备份。</p>\n<p>根据应用需求，定制备份策略如下所示：</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">备份类型</th>\n<th align=\"left\">备份周期</th>\n<th align=\"left\">备份时间</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\">全量备份</td>\n<td align=\"left\">每周</td>\n<td align=\"left\">每周五 23 点</td>\n</tr>\n<tr>\n<td align=\"left\">增量备份</td>\n<td align=\"left\">每天</td>\n<td align=\"left\">除周五外每天 23 点</td>\n</tr>\n<tr>\n<td align=\"left\">删除备份</td>\n<td align=\"left\">每天</td>\n<td align=\"left\">每天 23 点 30</td>\n</tr>\n</tbody></table>\n<p>执行以下命令，创建作业系统表：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SP_INIT_JOB_SYS(1);</span><br></pre></td></tr></table></figure>\n\n<p>全量备份（每周五 23 点全备）：</p>\n<p>Copy</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">call SP_CREATE_JOB(&#x27;bakfull&#x27;,1,0,&#x27;&#x27;,0,0,&#x27;&#x27;,0,&#x27;&#x27;);</span><br><span class=\"line\"></span><br><span class=\"line\">call SP_JOB_CONFIG_START(&#x27;bakfull&#x27;);</span><br><span class=\"line\"></span><br><span class=\"line\">call SP_ADD_JOB_STEP(&#x27;bakfull&#x27;, &#x27;bak01&#x27;, 6, &#x27;01000000/dmbak&#x27;, 1, 2, 0, 0, NULL, 0);</span><br><span class=\"line\"></span><br><span class=\"line\">call SP_ADD_JOB_SCHEDULE(&#x27;bakfull&#x27;, &#x27;bak01&#x27;, 1, 2, 1, 32, 0, &#x27;23:00:00&#x27;, NULL, &#x27;2020-11-02 14:42:15&#x27;, NULL, &#x27;&#x27;);</span><br><span class=\"line\"></span><br><span class=\"line\">call SP_JOB_CONFIG_COMMIT(&#x27;bakfull&#x27;);</span><br></pre></td></tr></table></figure>\n\n<p>增量备份（每周除周五外每天 23 点增量备份）：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">call SP_CREATE_JOB(&#x27;bakincr&#x27;,1,0,&#x27;&#x27;,0,0,&#x27;&#x27;,0,&#x27;&#x27;);</span><br><span class=\"line\"></span><br><span class=\"line\">call SP_JOB_CONFIG_START(&#x27;bakincr&#x27;);</span><br><span class=\"line\"></span><br><span class=\"line\">call SP_ADD_JOB_STEP(&#x27;bakincr&#x27;, &#x27;bak02&#x27;, 6, &#x27;11000000/dmbak&#x27;, 1, 2, 0, 0, NULL, 0);</span><br><span class=\"line\"></span><br><span class=\"line\">call SP_ADD_JOB_SCHEDULE(&#x27;bakincr&#x27;, &#x27;bak2&#x27;, 1, 2, 1, 95, 0, &#x27;23:00:00&#x27;, NULL, &#x27;2020-11-02 14:44:30&#x27;, NULL, &#x27;&#x27;);</span><br><span class=\"line\"></span><br><span class=\"line\">call SP_JOB_CONFIG_COMMIT(&#x27;bakincr&#x27;);</span><br></pre></td></tr></table></figure>\n\n<p>备份定期删除（每天 23：30 删除 14 天前备份）：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">call SP_CREATE_JOB(&#x27;delbak&#x27;,1,0,&#x27;&#x27;,0,0,&#x27;&#x27;,0,&#x27;&#x27;);</span><br><span class=\"line\">call SP_JOB_CONFIG_START(&#x27;delbak&#x27;);</span><br><span class=\"line\">call SP_ADD_JOB_STEP(&#x27;delbak&#x27;, &#x27;bak1&#x27;, 0, &#x27;SF_BAKSET_BACKUP_DIR_ADD(&#x27;&#x27;DISK&#x27;&#x27;,&#x27;&#x27;/dmbak&#x27;&#x27;);call sp_db_bakset_remove_batch(&#x27;&#x27;DISK&#x27;&#x27;,now()-14);&#x27;, 1, 2, 0, 0, NULL, 0);</span><br><span class=\"line\">call SP_ADD_JOB_SCHEDULE(&#x27;delbak&#x27;, &#x27;del01&#x27;, 1, 1, 1, 0, 0, &#x27;23:30:00&#x27;, NULL, &#x27;2020-11-02 14:48:41&#x27;, NULL, &#x27;&#x27;);</span><br><span class=\"line\">call SP_JOB_CONFIG_COMMIT(&#x27;delbak&#x27;);</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>注意</p>\n<p>备份的基本要求是：保留最少一次全备+全备（或者全备后的增备）时间点到当前的全部归档日志。删除备份前尽量将备份文件拷贝到单独的备份服务器上。</p>\n</blockquote>\n<p>详见请参考：<a href=\"https://eco.dameng.com/docs/zh-cn/ops/standard-stand-alone.html\">https://eco.dameng.com/docs/zh-cn/ops/standard-stand-alone.html</a></p>\n","site":{"data":{}},"excerpt":"<h1 id=\"达梦数据库单机安装\"><a href=\"#达梦数据库单机安装\" class=\"headerlink\" title=\"达梦数据库单机安装\"></a>达梦数据库单机安装</h1><h1 id=\"单机部署\"><a href=\"#单机部署\" class=\"headerlink\" title=\"单机部署\"></a>单机部署</h1>","more":"<h2 id=\"服务器硬件需求\"><a href=\"#服务器硬件需求\" class=\"headerlink\" title=\"服务器硬件需求\"></a>服务器硬件需求</h2><p>按实际业务需求，选择合适的服务器，参考如下：</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">硬件</th>\n<th align=\"left\">要求</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\">物理内存</td>\n<td align=\"left\">&gt;= 16 GB</td>\n</tr>\n<tr>\n<td align=\"left\">交换区</td>\n<td align=\"left\">Swap 空间&gt;=物理内存</td>\n</tr>\n<tr>\n<td align=\"left\">/tmp大小</td>\n<td align=\"left\">&gt; 1000 MB</td>\n</tr>\n<tr>\n<td align=\"left\">网络</td>\n<td align=\"left\">物理机器需要 2 个网卡，2 个网卡做 band</td>\n</tr>\n<tr>\n<td align=\"left\">磁盘</td>\n<td align=\"left\">根据实际应用系统需要挂载合适大小磁盘</td>\n</tr>\n<tr>\n<td align=\"left\">时间服务器</td>\n<td align=\"left\">按机房要求配置连接时间服务器</td>\n</tr>\n</tbody></table>\n<h2 id=\"操作系统要求\"><a href=\"#操作系统要求\" class=\"headerlink\" title=\"操作系统要求\"></a>操作系统要求</h2><h3 id=\"操作系统版本安装\"><a href=\"#操作系统版本安装\" class=\"headerlink\" title=\"操作系统版本安装\"></a>操作系统版本安装</h3><p>DM 数据库安装在 Linux 操作系统所需条件：glibc 2.3 以上，内核 2.6，预先安装 UnixODBC，系统性能监控等组件。</p>\n<h3 id=\"目录与存储规划\"><a href=\"#目录与存储规划\" class=\"headerlink\" title=\"目录与存储规划\"></a>目录与存储规划</h3><table>\n<thead>\n<tr>\n<th align=\"left\">用途</th>\n<th align=\"left\">目录路径</th>\n<th align=\"left\">备注</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\">数据库软件安装目录</td>\n<td align=\"left\">/dm8</td>\n<td align=\"left\">可用空间&gt; 50 GB</td>\n</tr>\n<tr>\n<td align=\"left\">实例安装目录</td>\n<td align=\"left\">/dmdata</td>\n<td align=\"left\">单独挂载性能最好的磁盘建议 SSD</td>\n</tr>\n<tr>\n<td align=\"left\">归档日志存放目录</td>\n<td align=\"left\">/dmarch</td>\n<td align=\"left\">单独挂载磁盘</td>\n</tr>\n<tr>\n<td align=\"left\">备份文件存放目录</td>\n<td align=\"left\">/dmbak</td>\n<td align=\"left\">单独挂载磁盘</td>\n</tr>\n</tbody></table>\n<h3 id=\"用户与组\"><a href=\"#用户与组\" class=\"headerlink\" title=\"用户与组\"></a>用户与组</h3><p>DM 数据库不应该使用 root 用户安装和维护。需要在安装之前为 DM 数据库创建一个专用的系统用户 (dmdba) 和用户组 (dinstall)。</p>\n<p>执行以下命令，新建用户组 dinstall：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">groupadd dinstall</span><br></pre></td></tr></table></figure>\n\n<p>执行以下命令，新建用户 dmdba：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">useradd  -g dinstall -m -d /home/dmdba -s /bin/bash  dmdba</span><br></pre></td></tr></table></figure>\n\n<p>执行以下命令，修改 dmdba 用户密码：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">passwd dmdba</span><br></pre></td></tr></table></figure>\n\n<p>输入密码并确认。</p>\n<h3 id=\"修改安装目录权限\"><a href=\"#修改安装目录权限\" class=\"headerlink\" title=\"修改安装目录权限\"></a>修改安装目录权限</h3><p>将新建的安装路径目录权限的用户修改为 dmdba，用户组修改为 dinstall。命令如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chown dmdba:dinstall -R /dm8/</span><br></pre></td></tr></table></figure>\n\n<p>给安装路径下的文件设置 755 权限。命令如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chmod -R 755 /dm8</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"用户资源限制\"><a href=\"#用户资源限制\" class=\"headerlink\" title=\"用户资源限制\"></a>用户资源限制</h3><p>执行以下命令，修改 dmdba 用户资源限制：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /etc/security/limits.conf</span><br></pre></td></tr></table></figure>\n\n<p>文件末尾添加如下内容：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dmdba soft core unlimited</span><br><span class=\"line\">dmdba hard core unlimited</span><br><span class=\"line\">dmdba soft nofile 65536</span><br><span class=\"line\">dmdba hard nofile 65536</span><br><span class=\"line\">dmdba soft nproc  65536</span><br><span class=\"line\">dmdba hard nproc  65536</span><br><span class=\"line\">dmdba soft stack  65536</span><br><span class=\"line\">dmdba hard stack  65536</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"用户环境变量\"><a href=\"#用户环境变量\" class=\"headerlink\" title=\"用户环境变量\"></a>用户环境变量</h3><p>执行以下命令，修改 dmdba 用户环境变量：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vi /home/dmdba/.bash_profile</span><br></pre></td></tr></table></figure>\n\n<p>文件末尾添加如下内容：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export DM_HOME=/dm8</span><br><span class=\"line\">export PATH=$PATH:$DM_HOME/bin</span><br><span class=\"line\">export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$DM_HOME/bin</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"防火墙设置\"><a href=\"#防火墙设置\" class=\"headerlink\" title=\"防火墙设置\"></a>防火墙设置</h3><p>生产环境应该对特定客户端开放数据库监听端口，并修改 DM 数据库默认的 5236 监听端口。</p>\n<h2 id=\"安装数据库\"><a href=\"#安装数据库\" class=\"headerlink\" title=\"安装数据库\"></a>安装数据库</h2><h3 id=\"软件申请\"><a href=\"#软件申请\" class=\"headerlink\" title=\"软件申请\"></a>软件申请</h3><p>可访问达梦云适配中心<a href=\"https://eco.dameng.com/download/?_blank\">https://eco.dameng.com/download/?_blank</a>，下载 DM8 数据库试用版，如需其他版本，请联系达梦销售人员。</p>\n<p>查询操作系统（内核）版本，CPU 架构命令：<code>uname -a</code>。</p>\n<p>如上图所示，需申请 rh7，x86 版本数据库软件。</p>\n<p>以 iso 文件安装包为例，安装包命名规则如下：<code>dm8_20200930_x86_rh6_64_ent_8.1.1.134.iso</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dm8：数据库大版本为 dm8</span><br><span class=\"line\">20200930：数据库版本发布日期</span><br><span class=\"line\">x86：安装包匹配的 CPU 架构</span><br><span class=\"line\">rh6：安装包匹配的系统版本 (redhat 6)</span><br><span class=\"line\">ent：数据库为企业版</span><br><span class=\"line\">8.1.1.134：数据库详细版本号</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"安装数据库软件\"><a href=\"#安装数据库软件\" class=\"headerlink\" title=\"安装数据库软件\"></a>安装数据库软件</h3><p>将安装包上传到服务器后使用 root 用户挂载 iso 安装包文件到 <code>/mnt</code> 目录下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mount -oloop dm8_20200930_x86_rh6_64_ent_8.1.1.134.iso /mnt</span><br></pre></td></tr></table></figure>\n\n<p>执行以下命令，切换到 dmdba 用户：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">su - dmdba</span><br></pre></td></tr></table></figure>\n\n<p>执行以下命令，切换到/mnt 目录下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /mnt</span><br></pre></td></tr></table></figure>\n\n<p>执行以下命令，查看文件：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ll</span><br></pre></td></tr></table></figure>\n\n<p>执行 <code>DMInstall.bin</code> 文件开始安装，选择【-i】参数以命令行方式安装：</p>\n<p>1）执行安装命令</p>\n<p>在终端进入到安装程序所在文件夹，执行以下命令进行命令行安装：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">[dmdba@~]# </span><span class=\"language-bash\">/mnt/DMInstall.bin -i</span></span><br></pre></td></tr></table></figure>\n\n<p>2）选择安装语言</p>\n<p>根据系统配置选择相应语言，输入选项，回车进行下一步。如下所示：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">请选择安装语言(C/c:中文 E/e:英文) [C/c]：C</span><br><span class=\"line\">解压安装程序..........</span><br><span class=\"line\">欢迎使用达梦数据库安装程序</span><br></pre></td></tr></table></figure>\n\n<p>3）验证 key 文件</p>\n<p>可以选择是否输入 Key 文件路径。不输入则进入下一步安装，输入 Key 文件路径，安装程序将显示 Key 文件的详细信息，如果是合法的 Key 文件且在有效期内，可以继续安装。如下所示：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">是否输入Key文件路径? (Y/y:是 N/n:否) [Y/y]：Y</span><br><span class=\"line\">请输入Key文件的路径地址 [dm.key]：/opt/dmsetup/dm.key</span><br><span class=\"line\">有效日期: 2020-12-25</span><br><span class=\"line\">服务器颁布类型: 企业版</span><br><span class=\"line\">发布类型: 试用版</span><br><span class=\"line\">用户名称: 武汉达梦公司疫情期间临时授权</span><br><span class=\"line\">授权用户数: 无限制</span><br><span class=\"line\">并发连接数: 无限制</span><br></pre></td></tr></table></figure>\n\n<p>4）输入时区</p>\n<p>可以选择的时区信息。如下所示：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">是否设置时区? (Y/y:是 N/n:否) [Y/y]：Y</span><br><span class=\"line\">设置时区:</span><br><span class=\"line\">[ 1]: GTM-12=日界线西</span><br><span class=\"line\">[ 2]: GTM-11=萨摩亚群岛</span><br><span class=\"line\">[ 3]: GTM-10=夏威夷</span><br><span class=\"line\">[ 4]: GTM-09=阿拉斯加</span><br><span class=\"line\">[ 5]: GTM-08=太平洋时间（美国和加拿大）</span><br><span class=\"line\">[ 6]: GTM-07=亚利桑那</span><br><span class=\"line\">[ 7]: GTM-06=中部时间（美国和加拿大）</span><br><span class=\"line\">[ 8]: GTM-05=东部部时间（美国和加拿大）</span><br><span class=\"line\">[ 9]: GTM-04=大西洋时间（美国和加拿大）</span><br><span class=\"line\">[10]: GTM-03=巴西利亚</span><br><span class=\"line\">[11]: GTM-02=中大西洋</span><br><span class=\"line\">[12]: GTM-01=亚速尔群岛</span><br><span class=\"line\">[13]: GTM=格林威治标准时间</span><br><span class=\"line\">[14]: GTM+01=萨拉热窝</span><br><span class=\"line\">[15]: GTM+02=开罗</span><br><span class=\"line\">[16]: GTM+03=莫斯科</span><br><span class=\"line\">[17]: GTM+04=阿布扎比</span><br><span class=\"line\">[18]: GTM+05=伊斯兰堡</span><br><span class=\"line\">[19]: GTM+06=达卡</span><br><span class=\"line\">[20]: GTM+07=曼谷，河内</span><br><span class=\"line\">[21]: GTM+08=中国标准时间</span><br><span class=\"line\">[22]: GTM+09=汉城</span><br><span class=\"line\">[23]: GTM+10=关岛</span><br><span class=\"line\">[24]: GTM+11=所罗门群岛</span><br><span class=\"line\">[25]: GTM+12=斐济</span><br><span class=\"line\">[26]: GTM+13=努库阿勒法</span><br><span class=\"line\">[27]: GTM+14=基里巴斯</span><br><span class=\"line\">请选择设置时区 [21]：21</span><br></pre></td></tr></table></figure>\n\n<p>5）选择安装类型</p>\n<p>数据库软件安装程序提供四种安装方式：“典型安装”、“服务器安装”、“客户端安装”和“自定义安装”，用户可根据实际情况灵活地选择。如下所示：</p>\n<p>典型安装包括：服务器、客户端、驱动、用户手册、数据库服务。<br>服务器安装包括：服务器、驱动、用户手册、数据库服务。<br>客户端安装包括：客户端、驱动、用户手册。<br>自定义安装包括：用户根据需求勾选组件，可以是服务器、客户端、驱动、用户手册、数据库服务中的任意组合。<br>生产环境可以根据实际需求选择，一般情况下选择”典型安装”即可。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">安装类型:</span><br><span class=\"line\">1 典型安装</span><br><span class=\"line\">2 服务器</span><br><span class=\"line\">3 客户端</span><br><span class=\"line\">4 自定义</span><br><span class=\"line\">请选择安装类型的数字序号 [1 典型安装]：1</span><br><span class=\"line\">所需空间: 1010M</span><br></pre></td></tr></table></figure>\n\n<p>6）选择安装路径</p>\n<p>输入数据库软件的安装路径，不输入则使用默认路径，默认路径为 <code>$HOME/dmdbms</code> (如果安装用户为 root ，则默认安装路径为 <code>/opt/dmdbms</code> ，但不建议使用 root 系统用户来安装)。如下所示：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">请选择安装目录 [/home/dmdba/dmdbms]：/opt/dmdbms</span><br><span class=\"line\">可用空间: 11G</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>注意</p>\n<p>安装路径里的目录名由英文字母、数字和下划线等组成，不建议使用包含空格和中文字符等的路径。</p>\n</blockquote>\n<p>7）安装小结</p>\n<p>安装程序将打印用户之前输入的部分安装信息。如下所示：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">是否确认安装路径(/opt/dmdbms)? (Y/y:是 N/n:否)  [Y/y]：Y</span><br><span class=\"line\">安装前小结</span><br><span class=\"line\">安装位置: /opt/dmdbms</span><br><span class=\"line\">所需空间: 1010M</span><br><span class=\"line\">可用空间: 11G</span><br><span class=\"line\">版本信息: 企业版</span><br><span class=\"line\">有效日期: 2020-12-25</span><br><span class=\"line\">安装类型: 典型安装</span><br></pre></td></tr></table></figure>\n\n<p>8）安装</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Copy是否确认安装? (Y/y:是 N/n:否)：Y</span><br><span class=\"line\">2020-12-24 21:52:38 </span><br><span class=\"line\">[INFO] 安装达梦数据库...</span><br><span class=\"line\">2020-12-24 21:52:39 </span><br><span class=\"line\">[INFO] 安装 基础 模块...</span><br><span class=\"line\">2020-12-24 21:52:48 </span><br><span class=\"line\">[INFO] 安装 服务器 模块...</span><br><span class=\"line\">2020-12-24 21:52:48 </span><br><span class=\"line\">[INFO] 安装 客户端 模块...</span><br><span class=\"line\">2020-12-24 21:52:56 </span><br><span class=\"line\">[INFO] 安装 驱动 模块...</span><br><span class=\"line\">2020-12-24 21:52:58 </span><br><span class=\"line\">[INFO] 安装 手册 模块...</span><br><span class=\"line\">2020-12-24 21:53:00 </span><br><span class=\"line\">[INFO] 安装 服务 模块...</span><br><span class=\"line\">2020-12-24 21:53:02 </span><br><span class=\"line\">[INFO] 移动ant日志文件。</span><br><span class=\"line\">2020-12-24 21:53:03 </span><br><span class=\"line\">[INFO] 安装达梦数据库完成。</span><br><span class=\"line\"></span><br><span class=\"line\">请以root系统用户执行命令:</span><br><span class=\"line\">/opt/dmdbms/script/root/root_installer.sh</span><br><span class=\"line\"></span><br><span class=\"line\">安装结束</span><br></pre></td></tr></table></figure>\n\n<p>9）注册数据库服务</p>\n<p>当安装进度完成时将会弹出对话框，提示使用 root 系统用户执行相关命令。用户可根据对话框的说明完成相关操作，之后可关闭此对话框，点击“完成”按钮结束安装。如下所示：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">Copy[dmdba@~]# </span><span class=\"language-bash\">su - root</span></span><br><span class=\"line\">密码：&lt;输入密码&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\">[root@~]# </span><span class=\"language-bash\">/opt/dmdbms/script/root/root_installer.sh</span></span><br><span class=\"line\">移动 /opt/dmdbms/bin/dm_svc.conf 到/etc目录</span><br><span class=\"line\">修改服务器权限</span><br><span class=\"line\">创建DmAPService服务</span><br><span class=\"line\">Created symlink from /etc/systemd/system/multiuser.target.wants/DmAPService.service to /usr/lib/systemd/system/DmAPService.service</span><br><span class=\"line\">创建服务(DmAPService)完成</span><br><span class=\"line\">启动DmAPService服务</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"使用-dminit-工具初始化实例\"><a href=\"#使用-dminit-工具初始化实例\" class=\"headerlink\" title=\"使用 dminit 工具初始化实例\"></a>使用 dminit 工具初始化实例</h3><p>执行以下命令，切换到 /opt/dmdbms/bin目录。</p>\n<p>快速查看参数<code>./dminit help</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[dmdba@localhost bin]$ ./dminit help</span><br><span class=\"line\">initdb V7.6.0.142-Build(2019.03.12-103811)ENT </span><br><span class=\"line\">db version: 0x7000a</span><br><span class=\"line\">file dm.key not found, use default license!</span><br><span class=\"line\">License will expire on 2020-03-12</span><br><span class=\"line\">格式: ./dminit     KEYWORD=value</span><br><span class=\"line\"></span><br><span class=\"line\">例程: ./dminit     PATH=/public/dmdb/dmData PAGE_SIZE=16</span><br><span class=\"line\"></span><br><span class=\"line\">关键字                     说明（默认值）</span><br><span class=\"line\">--------------------------------------------------------------------------------</span><br><span class=\"line\">INI_FILE                   初始化文件dm.ini存放的路径</span><br><span class=\"line\">PATH                       初始数据库存放的路径</span><br><span class=\"line\">CTL_PATH                   控制文件路径</span><br><span class=\"line\">LOG_PATH                   日志文件路径</span><br><span class=\"line\">EXTENT_SIZE                数据文件使用的簇大小(16)，可选值：16、32，单位：页</span><br><span class=\"line\">PAGE_SIZE                  数据页大小(8)，可选值：4、8、16、32，单位：K</span><br><span class=\"line\">LOG_SIZE                   日志文件大小(256)，单位为：M，范围为：64M ~ 2G</span><br><span class=\"line\">CASE_SENSITIVE             大小敏感(Y)，可选值：Y/N，1/0</span><br><span class=\"line\">CHARSET/UNICODE_FLAG       字符集(0)，可选值：0[GB18030]，1[UTF-8]，2[EUC-KR]</span><br><span class=\"line\">LENGTH_IN_CHAR             VARCHAR类型长度是否以字符为单位(N)，可选值：Y/N，1/0</span><br><span class=\"line\">SYSDBA_PWD                 设置SYSDBA密码(SYSDBA)，密码长度为9到48</span><br><span class=\"line\">SYSAUDITOR_PWD             设置SYSAUDITOR密码(SYSAUDITOR)，密码长度为9到48</span><br><span class=\"line\">DB_NAME                    数据库名(DAMENG)</span><br><span class=\"line\">INSTANCE_NAME              实例名(DMSERVER)</span><br><span class=\"line\">PORT_NUM                   监听端口号(5236)</span><br><span class=\"line\">TIME_ZONE                  设置时区(+08:00)</span><br><span class=\"line\">PAGE_CHECK                 页检查模式(0)，可选值：0/1/2</span><br><span class=\"line\">EXTERNAL_CIPHER_NAME       设置默认加密算法</span><br><span class=\"line\">EXTERNAL_HASH_NAME         设置默认HASH算法</span><br><span class=\"line\">EXTERNAL_CRYPTO_NAME       设置根密钥加密引擎</span><br><span class=\"line\">RLOG_ENC_FLAG              设置日志文件是否加密(N)，可选值：Y/N，1/0</span><br><span class=\"line\">USBKEY_PIN                 设置USBKEY PIN</span><br><span class=\"line\">ENCRYPT_NAME               设置全库加密算法</span><br><span class=\"line\">BLANK_PAD_MODE             设置空格填充模式(0)，可选值：0/1</span><br><span class=\"line\">SYSTEM_MIRROR_PATH         SYSTEM数据文件镜像路径</span><br><span class=\"line\">MAIN_MIRROR_PATH           MAIN数据文件镜像</span><br><span class=\"line\">ROLL_MIRROR_PATH           回滚文件镜像路径</span><br><span class=\"line\">MAL_FLAG                   初始化时设置dm.ini中的MAL_INI(0)</span><br><span class=\"line\">ARCH_FLAG                  初始化时设置dm.ini中的ARCH_INI(0)</span><br><span class=\"line\">MPP_FLAG                   Mpp系统内的库初始化时设置dm.ini中的mpp_ini(0)</span><br><span class=\"line\">CONTROL                    初始化配置文件（配置文件格式见系统管理员手册）</span><br><span class=\"line\">AUTO_OVERWRITE             是否覆盖所有同名文件(0) 0:不覆盖 1:部分覆盖 2:完全覆盖</span><br><span class=\"line\">USE_NEW_HASH               是否使用改进的字符类型HASH算法(1)</span><br><span class=\"line\">DCP_MODE                   是否是DCP代理模式(0)</span><br><span class=\"line\">DCP_PORT_NUM               DCP代理模式下管理端口</span><br><span class=\"line\">ELOG_PATH                  指定初始化过程中生成的日志文件所在路径</span><br><span class=\"line\">AP_PORT_NUM                ECS模式下AP协同工作的监听端口</span><br><span class=\"line\">HELP                       打印帮助信息</span><br></pre></td></tr></table></figure>\n\n<p>通过执行dminit文件初始化实例参数来创建实例</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /opt/dmdbms/bin</span><br><span class=\"line\">./dminit path=/mnt/dm/dmdbms/data PAGE_SIZE=32 EXTENT_SIZE=32 CASE_SENSITIVE=0 LENGTH_IN_CHAR=1 CHARSET=1</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p><strong>注意</strong></p>\n<p>初始化参数中除了 path 参数必须指定，其它参数都有默认值，如果需求与默认值不同，初始化的时候请指定需要的值。因为部分参数初始化后是无法修改的例如：page_size（页大小），charset（字符集），case_sensitive（大小写敏感）等。更多参数<code>./dminit help</code> 查看，是否无法修改的参数可以查询 v$dm_ini 视图，para_type=’READ ONLY’ 表示无法修改。</p>\n</blockquote>\n<h3 id=\"启动实例\"><a href=\"#启动实例\" class=\"headerlink\" title=\"启动实例\"></a>启动实例</h3><p>以系统服务方式启动实例，DM 提供脚本将数据库实例注册为操作系统服务。</p>\n<p>root 用户下切换到 <code>/opt/dmdbms/script/root/</code>：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /opt/dmdbms/script/root/</span><br></pre></td></tr></table></figure>\n\n<p>执行以下命令，执行脚本注册服务：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./dm_service_installer.sh -t dmserver -p dmserver -dm_ini /opt/dmdbms/data/DAMENG/dm.ini</span><br></pre></td></tr></table></figure>\n\n<p>服务名为 <code>DmService+-p</code> 参数后的内容，即 <code>DmServicedmserver</code>。</p>\n<blockquote>\n<p>提示</p>\n<p><code>-t</code> 指服务类型是 dmserver；<code>-p</code> 为服务名的后缀；<code>-dm_ini</code> 为实例的 dm.ini 文件的绝对路径。</p>\n</blockquote>\n<p>执行以下命令，以服务方式启动实例：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl start DmServicedmserver</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"关闭实例\"><a href=\"#关闭实例\" class=\"headerlink\" title=\"关闭实例\"></a>关闭实例</h3><p>对于以服务方式启动的实例，则以服务方式关闭实例：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl stop DmServicedmserver</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>建议</p>\n<p>每个实例都建议注册为操作系统服务，这样不仅方便启动和关闭实例，而且注册为服务后，在服务器重启时，实例将随系统启动而自动启动。</p>\n</blockquote>\n<h3 id=\"连接数据库\"><a href=\"#连接数据库\" class=\"headerlink\" title=\"连接数据库\"></a>连接数据库</h3><p>执行以下命令，切换到 <code>/dm8/bin</code> 目录：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /opt/dmdbms/bin</span><br></pre></td></tr></table></figure>\n\n<p>执行以下命令，使用 disql 工具连接数据库：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./disql SYSDBA/SYSDBA@localhost:5236</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>提示</p>\n<p>默认创建的实例，管理员用户 SYSDBA 的密码为 SYSDBA ，实例端口为 5236，字符集为 GB18030，大小写敏感。</p>\n</blockquote>\n<h2 id=\"参数优化\"><a href=\"#参数优化\" class=\"headerlink\" title=\"参数优化\"></a>参数优化</h2><p>安装完成需要调整 <code>dm.ini</code> 文件参数。</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">参数名称</th>\n<th align=\"left\">参数含义</th>\n<th align=\"left\">参数默认值</th>\n<th align=\"left\">参数建议</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\">BUFFER</td>\n<td align=\"left\">系统缓冲区大小，以 MB 为单位</td>\n<td align=\"left\">100</td>\n<td align=\"left\">系统物理内存的 60%~80%</td>\n</tr>\n<tr>\n<td align=\"left\">BUFFER_POOLS</td>\n<td align=\"left\">BUFFER 系统分区数</td>\n<td align=\"left\">19</td>\n<td align=\"left\">物理内存 64 GB 以下 53 GB 以上</td>\n</tr>\n<tr>\n<td align=\"left\">HJ_BUF_GLOBAL_SIZE</td>\n<td align=\"left\">HASH 连接操作符的数据总缓存大小，以 MB 为单位</td>\n<td align=\"left\">500</td>\n<td align=\"left\">5000</td>\n</tr>\n<tr>\n<td align=\"left\">HJ_BUF_SIZE</td>\n<td align=\"left\">单个 HASH 连接操作符的数据总缓存大小，以 MB 为单位</td>\n<td align=\"left\">50</td>\n<td align=\"left\">500</td>\n</tr>\n<tr>\n<td align=\"left\">DICT_BUF_SIZE</td>\n<td align=\"left\">字典缓冲区大小，以 MB 为单位</td>\n<td align=\"left\">5</td>\n<td align=\"left\">100</td>\n</tr>\n<tr>\n<td align=\"left\">TASK_THREADS</td>\n<td align=\"left\">任务线程个数</td>\n<td align=\"left\">4</td>\n<td align=\"left\">CPU 核数</td>\n</tr>\n<tr>\n<td align=\"left\">IO_THR_GROUPS</td>\n<td align=\"left\">非 Windows 下有效，表示 IO 线程组个数</td>\n<td align=\"left\">2</td>\n<td align=\"left\">CPU 核数/2</td>\n</tr>\n<tr>\n<td align=\"left\">MAX_SESSIONS</td>\n<td align=\"left\">系统允许同时连接的最大数</td>\n<td align=\"left\">100</td>\n<td align=\"left\">1000</td>\n</tr>\n<tr>\n<td align=\"left\">MAX_SESSION_STATEMENT</td>\n<td align=\"left\">单个会话上允许同时打开的语句句柄最大数</td>\n<td align=\"left\">100</td>\n<td align=\"left\">20000</td>\n</tr>\n<tr>\n<td align=\"left\">CACHE_POOL_SIZE</td>\n<td align=\"left\">SQL 缓冲池大小，以 MB 为单位</td>\n<td align=\"left\">20</td>\n<td align=\"left\">200</td>\n</tr>\n</tbody></table>\n<p>参考脚本如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SP_SET_PARA_VALUE (2,&#x27;HJ_BUF_GLOBAL_SIZE&#x27;,5000);</span><br><span class=\"line\">SP_SET_PARA_VALUE (2,&#x27;HJ_BUF_SIZE&#x27;,500);</span><br><span class=\"line\">SP_SET_PARA_VALUE (2,&#x27;MAX_SESSIONS&#x27;,1000);</span><br><span class=\"line\">SP_SET_PARA_VALUE (2,&#x27;MAX_SESSION_STATEMENT&#x27;,20000);</span><br><span class=\"line\">SP_SET_PARA_VALUE (2,&#x27;CACHE_POOL_SIZE&#x27;,200);</span><br><span class=\"line\">SP_SET_PARA_VALUE (2,&#x27;DICT_BUF_SIZE&#x27;,100);</span><br><span class=\"line\"></span><br><span class=\"line\">declare</span><br><span class=\"line\">v_mem_mb int;</span><br><span class=\"line\">v_cpus int;</span><br><span class=\"line\">BUFFER int;</span><br><span class=\"line\">BUFFER_POOLS INT;</span><br><span class=\"line\">begin</span><br><span class=\"line\">    SELECT TOP 1 N_CPU,TOTAL_PHY_SIZE/1024/1024 INTO v_cpus,v_mem_mb FROM V$SYSTEMINFO;</span><br><span class=\"line\"></span><br><span class=\"line\">    v_mem_mb=round(v_mem_mb,-3);</span><br><span class=\"line\">    SP_SET_PARA_VALUE(2,&#x27;TASK_THREADS&#x27;,v_cpus);</span><br><span class=\"line\">    SP_SET_PARA_VALUE(2,&#x27;IO_THR_GROUPS&#x27;,v_cpus/2);</span><br><span class=\"line\">    IF v_mem_mb &gt;= 64000  THEN </span><br><span class=\"line\">         BUFFER_POOLS :=101;</span><br><span class=\"line\">      ELSE</span><br><span class=\"line\">         BUFFER_POOLS :=53;</span><br><span class=\"line\">    END IF;</span><br><span class=\"line\"></span><br><span class=\"line\">    BUFFER := round(cast(v_mem_mb * 0.8 as int),-3);</span><br><span class=\"line\">    SP_SET_PARA_VALUE(2,&#x27;BUFFER&#x27;,  BUFFER);</span><br><span class=\"line\">    SP_SET_PARA_VALUE(2,&#x27;BUFFER_POOLS&#x27;, BUFFER_POOLS);</span><br><span class=\"line\">end;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>注意</p>\n<p>修改完参数后，需要重启数据库生效。</p>\n</blockquote>\n<h2 id=\"归档配置\"><a href=\"#归档配置\" class=\"headerlink\" title=\"归档配置\"></a>归档配置</h2><p>生产环境必须开启归档日志，且必须限制归档日志保留量，限制方法：</p>\n<ol>\n<li>设置归档空间大小限制即指定 <code>SPACE_LIMIT</code> 参数（单位是 MB）。</li>\n<li>定期删除归档日志（设置定时作业）。</li>\n</ol>\n<p>例如开启归档并限制归档空间为 100 GB，如下所示：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">alter database mount;</span><br><span class=\"line\">alter database add archivelog &#x27;dest=/dmarch/,TYPE=local,FILE_SIZE=1024,SPACE_LIMIT=102400&#x27;;</span><br><span class=\"line\">alter database archivelog;</span><br><span class=\"line\">alter database open;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"定制备份策略\"><a href=\"#定制备份策略\" class=\"headerlink\" title=\"定制备份策略\"></a>定制备份策略</h2><p>上线前必须规划好备份策略，可以使用 DM 作业系统，定时备份。</p>\n<p>根据应用需求，定制备份策略如下所示：</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">备份类型</th>\n<th align=\"left\">备份周期</th>\n<th align=\"left\">备份时间</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\">全量备份</td>\n<td align=\"left\">每周</td>\n<td align=\"left\">每周五 23 点</td>\n</tr>\n<tr>\n<td align=\"left\">增量备份</td>\n<td align=\"left\">每天</td>\n<td align=\"left\">除周五外每天 23 点</td>\n</tr>\n<tr>\n<td align=\"left\">删除备份</td>\n<td align=\"left\">每天</td>\n<td align=\"left\">每天 23 点 30</td>\n</tr>\n</tbody></table>\n<p>执行以下命令，创建作业系统表：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SP_INIT_JOB_SYS(1);</span><br></pre></td></tr></table></figure>\n\n<p>全量备份（每周五 23 点全备）：</p>\n<p>Copy</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">call SP_CREATE_JOB(&#x27;bakfull&#x27;,1,0,&#x27;&#x27;,0,0,&#x27;&#x27;,0,&#x27;&#x27;);</span><br><span class=\"line\"></span><br><span class=\"line\">call SP_JOB_CONFIG_START(&#x27;bakfull&#x27;);</span><br><span class=\"line\"></span><br><span class=\"line\">call SP_ADD_JOB_STEP(&#x27;bakfull&#x27;, &#x27;bak01&#x27;, 6, &#x27;01000000/dmbak&#x27;, 1, 2, 0, 0, NULL, 0);</span><br><span class=\"line\"></span><br><span class=\"line\">call SP_ADD_JOB_SCHEDULE(&#x27;bakfull&#x27;, &#x27;bak01&#x27;, 1, 2, 1, 32, 0, &#x27;23:00:00&#x27;, NULL, &#x27;2020-11-02 14:42:15&#x27;, NULL, &#x27;&#x27;);</span><br><span class=\"line\"></span><br><span class=\"line\">call SP_JOB_CONFIG_COMMIT(&#x27;bakfull&#x27;);</span><br></pre></td></tr></table></figure>\n\n<p>增量备份（每周除周五外每天 23 点增量备份）：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">call SP_CREATE_JOB(&#x27;bakincr&#x27;,1,0,&#x27;&#x27;,0,0,&#x27;&#x27;,0,&#x27;&#x27;);</span><br><span class=\"line\"></span><br><span class=\"line\">call SP_JOB_CONFIG_START(&#x27;bakincr&#x27;);</span><br><span class=\"line\"></span><br><span class=\"line\">call SP_ADD_JOB_STEP(&#x27;bakincr&#x27;, &#x27;bak02&#x27;, 6, &#x27;11000000/dmbak&#x27;, 1, 2, 0, 0, NULL, 0);</span><br><span class=\"line\"></span><br><span class=\"line\">call SP_ADD_JOB_SCHEDULE(&#x27;bakincr&#x27;, &#x27;bak2&#x27;, 1, 2, 1, 95, 0, &#x27;23:00:00&#x27;, NULL, &#x27;2020-11-02 14:44:30&#x27;, NULL, &#x27;&#x27;);</span><br><span class=\"line\"></span><br><span class=\"line\">call SP_JOB_CONFIG_COMMIT(&#x27;bakincr&#x27;);</span><br></pre></td></tr></table></figure>\n\n<p>备份定期删除（每天 23：30 删除 14 天前备份）：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">call SP_CREATE_JOB(&#x27;delbak&#x27;,1,0,&#x27;&#x27;,0,0,&#x27;&#x27;,0,&#x27;&#x27;);</span><br><span class=\"line\">call SP_JOB_CONFIG_START(&#x27;delbak&#x27;);</span><br><span class=\"line\">call SP_ADD_JOB_STEP(&#x27;delbak&#x27;, &#x27;bak1&#x27;, 0, &#x27;SF_BAKSET_BACKUP_DIR_ADD(&#x27;&#x27;DISK&#x27;&#x27;,&#x27;&#x27;/dmbak&#x27;&#x27;);call sp_db_bakset_remove_batch(&#x27;&#x27;DISK&#x27;&#x27;,now()-14);&#x27;, 1, 2, 0, 0, NULL, 0);</span><br><span class=\"line\">call SP_ADD_JOB_SCHEDULE(&#x27;delbak&#x27;, &#x27;del01&#x27;, 1, 1, 1, 0, 0, &#x27;23:30:00&#x27;, NULL, &#x27;2020-11-02 14:48:41&#x27;, NULL, &#x27;&#x27;);</span><br><span class=\"line\">call SP_JOB_CONFIG_COMMIT(&#x27;delbak&#x27;);</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>注意</p>\n<p>备份的基本要求是：保留最少一次全备+全备（或者全备后的增备）时间点到当前的全部归档日志。删除备份前尽量将备份文件拷贝到单独的备份服务器上。</p>\n</blockquote>\n<p>详见请参考：<a href=\"https://eco.dameng.com/docs/zh-cn/ops/standard-stand-alone.html\">https://eco.dameng.com/docs/zh-cn/ops/standard-stand-alone.html</a></p>"},{"title":"postgresql常用命令","date":"2022-10-08T06:31:21.000Z","_content":"\n# postgresql常用命令\n\n\n\n<!--more-->\n\n```perl\n1.修改密码\npostgres=# ALTER ROLE postgres WITH PASSWORD 'Ftlp_2077';\n\n2.查看已经存在的数据库\npostgres=# \\l\n\n3.查看表\npostgres=# \\dt\n\n4.查看表结构\npostgres=# \\d tablename\n\n5.使用数据库\npostgres=# \\c databasename\n\n6.查看库大小\npostgres=# select datname, pg_size_pretty (pg_database_size(datname)) AS size from pg_database;\n\n7.查看表大小\npostgres=# \\c corehr\nYou are now connected to database \"corehr\" as user \"postgres\".\ncorehr=# select relname, pg_size_pretty(pg_total_relation_size(relid)) as size from pg_stat_user_tables;\n\n8.备份所有的库\npg_dumpall -U postgres -c > all_backup_20211018.sql\n\n9.导入所有备份库\npsql -U postgres < all_backup_20211018.sql\n\n10.备份某个库\npg_dump -U postgres -c platform > platform_backup_20211018.sql\n\n11.导入某个备份库\npsql -U postgres platform< platform_backup_20211018.sql\n\n12.备份某个表\npg_dump -U postgres -c platform -t sec_page_t > sec_page_t.sql\n\n13.导入sql\npsql -U postgres -d platform < sec_page_t.sql\n\n14.备份某个库的表结构不备份数据\npg_dump -U postgres -c -s ecs_proxy > uat_ecs_proxy_20211116.sql\n\n15.导入某个库的表结构\npsql \"host=pg51pb29.postgresql.db.cloud.papub  port=3738 user=laopai password=xxx dbname=ecs_proxy\" < uat_ecs_proxy_20211116.sql\n\n16.关闭链接\n如果删除数据库的时候提示有连接，可以先将连接的关掉，如删除platform库时。\nSELECT pg_terminate_backend(pg_stat_activity.pid) FROM pg_stat_activity WHERE datname='platform' AND pid<>pg_backend_pid();\n```\n\n","source":"_posts/postgresql常用命令.md","raw":"---\ntitle: postgresql常用命令\ndate: 2022-10-08 14:31:21\ntags: postgres\n---\n\n# postgresql常用命令\n\n\n\n<!--more-->\n\n```perl\n1.修改密码\npostgres=# ALTER ROLE postgres WITH PASSWORD 'Ftlp_2077';\n\n2.查看已经存在的数据库\npostgres=# \\l\n\n3.查看表\npostgres=# \\dt\n\n4.查看表结构\npostgres=# \\d tablename\n\n5.使用数据库\npostgres=# \\c databasename\n\n6.查看库大小\npostgres=# select datname, pg_size_pretty (pg_database_size(datname)) AS size from pg_database;\n\n7.查看表大小\npostgres=# \\c corehr\nYou are now connected to database \"corehr\" as user \"postgres\".\ncorehr=# select relname, pg_size_pretty(pg_total_relation_size(relid)) as size from pg_stat_user_tables;\n\n8.备份所有的库\npg_dumpall -U postgres -c > all_backup_20211018.sql\n\n9.导入所有备份库\npsql -U postgres < all_backup_20211018.sql\n\n10.备份某个库\npg_dump -U postgres -c platform > platform_backup_20211018.sql\n\n11.导入某个备份库\npsql -U postgres platform< platform_backup_20211018.sql\n\n12.备份某个表\npg_dump -U postgres -c platform -t sec_page_t > sec_page_t.sql\n\n13.导入sql\npsql -U postgres -d platform < sec_page_t.sql\n\n14.备份某个库的表结构不备份数据\npg_dump -U postgres -c -s ecs_proxy > uat_ecs_proxy_20211116.sql\n\n15.导入某个库的表结构\npsql \"host=pg51pb29.postgresql.db.cloud.papub  port=3738 user=laopai password=xxx dbname=ecs_proxy\" < uat_ecs_proxy_20211116.sql\n\n16.关闭链接\n如果删除数据库的时候提示有连接，可以先将连接的关掉，如删除platform库时。\nSELECT pg_terminate_backend(pg_stat_activity.pid) FROM pg_stat_activity WHERE datname='platform' AND pid<>pg_backend_pid();\n```\n\n","slug":"postgresql常用命令","published":1,"updated":"2023-01-03T06:17:51.245Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clcfuykyv000j3wrs5utf7w9m","content":"<h1 id=\"postgresql常用命令\"><a href=\"#postgresql常用命令\" class=\"headerlink\" title=\"postgresql常用命令\"></a>postgresql常用命令</h1><span id=\"more\"></span>\n\n<figure class=\"highlight perl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span>.修改密码</span><br><span class=\"line\">postgres=<span class=\"comment\"># ALTER ROLE postgres WITH PASSWORD &#x27;Ftlp_2077&#x27;;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">2</span>.查看已经存在的数据库</span><br><span class=\"line\">postgres=<span class=\"comment\"># \\l</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">3</span>.查看表</span><br><span class=\"line\">postgres=<span class=\"comment\"># \\dt</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">4</span>.查看表结构</span><br><span class=\"line\">postgres=<span class=\"comment\"># \\d tablename</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">5</span>.使用数据库</span><br><span class=\"line\">postgres=<span class=\"comment\"># \\c databasename</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">6</span>.查看库大小</span><br><span class=\"line\">postgres=<span class=\"comment\"># select datname, pg_size_pretty (pg_database_size(datname)) AS size from pg_database;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">7</span>.查看表大小</span><br><span class=\"line\">postgres=<span class=\"comment\"># \\c corehr</span></span><br><span class=\"line\">You are now connected to database <span class=\"string\">&quot;corehr&quot;</span> as user <span class=\"string\">&quot;postgres&quot;</span>.</span><br><span class=\"line\">corehr=<span class=\"comment\"># select relname, pg_size_pretty(pg_total_relation_size(relid)) as size from pg_stat_user_tables;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">8</span>.备份所有的库</span><br><span class=\"line\">pg_dumpall -U postgres -c &gt; all_backup_20211018.sql</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">9</span>.导入所有备份库</span><br><span class=\"line\">psql -U postgres &lt; all_backup_20211018.sql</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">10</span>.备份某个库</span><br><span class=\"line\">pg_dump -U postgres -c platform &gt; platform_backup_20211018.sql</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">11</span>.导入某个备份库</span><br><span class=\"line\">psql -U postgres platform&lt; platform_backup_20211018.sql</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">12</span>.备份某个表</span><br><span class=\"line\">pg_dump -U postgres -c platform -t sec_page_t &gt; sec_page_t.sql</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">13</span>.导入sql</span><br><span class=\"line\">psql -U postgres -d platform &lt; sec_page_t.sql</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">14</span>.备份某个库的表结构不备份数据</span><br><span class=\"line\">pg_dump -U postgres -c -s ecs_proxy &gt; uat_ecs_proxy_20211116.sql</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">15</span>.导入某个库的表结构</span><br><span class=\"line\">psql <span class=\"string\">&quot;host=pg51pb29.postgresql.db.cloud.papub  port=3738 user=laopai password=xxx dbname=ecs_proxy&quot;</span> &lt; uat_ecs_proxy_20211116.sql</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">16</span>.关闭链接</span><br><span class=\"line\">如果删除数据库的时候提示有连接，可以先将连接的关掉，如删除platform库时。</span><br><span class=\"line\">SELECT pg_terminate_backend(pg_stat_activity.pid) FROM pg_stat_activity WHERE datname=<span class=\"string\">&#x27;platform&#x27;</span> AND pid&lt;&gt;pg_backend_pid();</span><br></pre></td></tr></table></figure>\n\n","site":{"data":{}},"excerpt":"<h1 id=\"postgresql常用命令\"><a href=\"#postgresql常用命令\" class=\"headerlink\" title=\"postgresql常用命令\"></a>postgresql常用命令</h1>","more":"<figure class=\"highlight perl\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span>.修改密码</span><br><span class=\"line\">postgres=<span class=\"comment\"># ALTER ROLE postgres WITH PASSWORD &#x27;Ftlp_2077&#x27;;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">2</span>.查看已经存在的数据库</span><br><span class=\"line\">postgres=<span class=\"comment\"># \\l</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">3</span>.查看表</span><br><span class=\"line\">postgres=<span class=\"comment\"># \\dt</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">4</span>.查看表结构</span><br><span class=\"line\">postgres=<span class=\"comment\"># \\d tablename</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">5</span>.使用数据库</span><br><span class=\"line\">postgres=<span class=\"comment\"># \\c databasename</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">6</span>.查看库大小</span><br><span class=\"line\">postgres=<span class=\"comment\"># select datname, pg_size_pretty (pg_database_size(datname)) AS size from pg_database;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">7</span>.查看表大小</span><br><span class=\"line\">postgres=<span class=\"comment\"># \\c corehr</span></span><br><span class=\"line\">You are now connected to database <span class=\"string\">&quot;corehr&quot;</span> as user <span class=\"string\">&quot;postgres&quot;</span>.</span><br><span class=\"line\">corehr=<span class=\"comment\"># select relname, pg_size_pretty(pg_total_relation_size(relid)) as size from pg_stat_user_tables;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">8</span>.备份所有的库</span><br><span class=\"line\">pg_dumpall -U postgres -c &gt; all_backup_20211018.sql</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">9</span>.导入所有备份库</span><br><span class=\"line\">psql -U postgres &lt; all_backup_20211018.sql</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">10</span>.备份某个库</span><br><span class=\"line\">pg_dump -U postgres -c platform &gt; platform_backup_20211018.sql</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">11</span>.导入某个备份库</span><br><span class=\"line\">psql -U postgres platform&lt; platform_backup_20211018.sql</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">12</span>.备份某个表</span><br><span class=\"line\">pg_dump -U postgres -c platform -t sec_page_t &gt; sec_page_t.sql</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">13</span>.导入sql</span><br><span class=\"line\">psql -U postgres -d platform &lt; sec_page_t.sql</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">14</span>.备份某个库的表结构不备份数据</span><br><span class=\"line\">pg_dump -U postgres -c -s ecs_proxy &gt; uat_ecs_proxy_20211116.sql</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">15</span>.导入某个库的表结构</span><br><span class=\"line\">psql <span class=\"string\">&quot;host=pg51pb29.postgresql.db.cloud.papub  port=3738 user=laopai password=xxx dbname=ecs_proxy&quot;</span> &lt; uat_ecs_proxy_20211116.sql</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">16</span>.关闭链接</span><br><span class=\"line\">如果删除数据库的时候提示有连接，可以先将连接的关掉，如删除platform库时。</span><br><span class=\"line\">SELECT pg_terminate_backend(pg_stat_activity.pid) FROM pg_stat_activity WHERE datname=<span class=\"string\">&#x27;platform&#x27;</span> AND pid&lt;&gt;pg_backend_pid();</span><br></pre></td></tr></table></figure>"},{"title":"达梦数据库常用操作","date":"2022-11-24T09:34:42.000Z","_content":"\n# 达梦数据库常用操作\n\n## 1、常用功能及命令\n\n<!--more-->\n\n前提，命令行登录：\n./disql SYSDBA/SYSDBA@localhost:5236 # 管理员用户 SYSDBA 的密码为 SYSDBA ，实例端口为 5236\n\n模式查询\nSQL> select distinct owner from dba_objects;\n\n获取当前模式名\nSQL> select sys_context(‘userenv’, ‘current_schema’) from dual;\n\n设置当前模式\nSQL> set schema<模式名>; #只能设置到属于自己的模式。\n\n用户查询\nSQL> select username from dba_users;\n\n查看某个模式下的所有表\nSQL> select table_name from all_tables where owner='模式名'; #注意大小写\n\n查看表结构\nSQL> desc DRAGON_DATA.ACTIVE_DEVICE;\n\n创建用户\nSQL> create user dragon identified by “123456” default tablespace MAIN;\n\n用户授权\nSQL> grant SYS_ADMIN to dragon ;\nSQL> grant DBA,RESOURCE,PUBLIC to dragon with admin option;\nSQL> grant EXECUTE on SYS.DBMS_XMLGEN to dragon;\n\n\n\n## 2、直接执行语句\n\n使用-E 参数，将在运行 DIsql 时直接执行后续的一条或多条 SQL 语句。\n\n```cpp\n[root@localhost bin]#cd /opt/dmdbms/bin\n[root@localhost bin]#./disql SYSDBA/SYSDBA -e \"SELECT * FROM DRAGON_USER;\"\n12\n```\n\n## 3、修改系统用户密码\n\n方式一\n\n```cpp\n[root@localhost bin]cd /opt/dmdbms/bin/\n[root@localhost bin]./disql SYSDBA/SYSDBA@localhost:5236\nSQL> alter user sysdba identified by \"123456\" default tablespace MAIN;\n123\n```\n\n方式二\n\n```cpp\n./disql userid=SYSDBA/SYSDBA@localhost:5236 -e \"alter user sysdba identified by \"123456\" default tablespace MAIN;\"\n1\n```\n\n## 4、执行sql脚本\n\n1）进入Disql执行sql脚本\nSQL> start /data/dm/test.sql #通过start命令执行脚本\nSQL> `/data/dm/test.sql（文件名test.sql前是反撇，通常在ESC键下方)\n\n2）启动时执行sql脚本\n如果在启动时运行，只能使用<`运行脚本>，同时需要加\\或’进行转义。\n\n```cpp\n[root@localhost bin]# ./disql SYSDBA/SYSDBA  \\`/data/dm/test.sql\n1\n```\n\n## 5、导入导出数据\n\n### 1）全量导出导入\n\n导出\n将用户名和密码均为SYSDBA，端口号为5236的数据库采用FULL方式完全导出。导出文件名为db_all.dmp，导出的日志文件名为db_all_export.log， 导出文件的路径为/data/dm。\n\n```cpp\n./dexp SYSDBA/SYSDBA FILE=db_all.dmp DIRECTORY=/data/dm LOG=db_all_export.log FULL=Y\n1\n```\n\n导入\n将逻辑备份导入到用户名和密码为SYSDBA，IP地址为192.168.1.100，端口号为60000的数据库。导入文件名为db_all.dmp， 导入的日志文件名为db_all.log，导入文件路径为/data/dm。\n\n```c\n./dimp USERID=SYSDBA/SYSDBA@192.168.1.100:60000 FILE=db_all.dmp DIRECTORY=/data/dm_bak LOG=db_all_import.log FULL=Y\n1\n```\n\n**注意：导入之前原表已存在时，默认为直接报错，需要设置TABLE_EXISTS_ACTION参数**\n语法如下：\nTABLE_EXISTS_ACTION=[SKIP | APPEND | TRUNCATE | REPLACE]\nSKIP：跳过此表。\nAPPEND：直接向现有表中导入数据\nTRUNCATE：先删除现有表中的数据，再向表中导入数据\nREPLACE：先删除现有表，再导数据\n\n### 2）指定库导入导出\n\n导出\n导出时不用FULL=Y，通过SCHEMAS指定模式，导出指定模式库。\n\n```cpp\n./dexp USERID=SYSDBA/SYSDBA FILE=db_vnap_user.dmp DIRECTORY=/data/dm LOG=db_vnap_user_export.log  SCHEMAS=VNAP_USER\n1\n```\n\n导入\n导出时可以采用FULL=Y，全部导入指定模式库，也可通过SCHEMAS指定模式，导入部分库。\n\n```cpp\n./dimp USERID=SYSDBA/SYSDBA@192.168.1.100:60000 FILE=db_vnap_user.dmp DIRECTORY=/data/dm LOG=db_all_import.log  SCHEMAS=VNAP_USER\n```\n\n\n\n# 达梦数据库常用SQL\n\n```\n--达梦数据库创建表\ncreate table TEST_TABLE(\n\tscid varchar2(10) primary key,\n\tscname varchar2(20),           \n\tscsm number(6),                  \n\tscprice number(4,2)\n);\n\n---------------------当前用户--------------------------\n--达梦数据库-获取当前用户拥有的表\nselect table_name from user_tables;\n\n--达梦数据库-获取当前用户所属的某个表的字段\nselect * from user_tab_columns where table_name='表名';\n\n--达梦数据库-获取当前用户某个表的注释\nselect * from user_tab_comments where table_name='表名';\n\n--达梦数据库-获取当前用户某个表某个字段的注释\nselect * from user_col_comments where table_name='表名' where column_name='字段名';\n\n\n---------------------所有用户(不包括系统表)--------------------------\n--达梦数据库-所有用户的表(单独判断某个表是否存在，要加owner条件)(不包括系统表)\nselect table_name from all_tables;\n\n--达梦数据库-获取所有用户所属的某个表的字段(不包括系统表)\nselect * from all_tab_columns where table_name='表名';\n\n--达梦数据库-获取所有用户所属的某个表的注释(不包括系统表)\nselect * from all_tab_comments where table_name='表名';\n\n--达梦数据库-获取所有用户某个表某个字段的注释(不包括系统表)\nselect * from all_col_comments where table_name='表名' where column_name='字段名';\n\n\n---------------------所有用户(包括系统表)--------------------------\n--达梦数据库-所有用户的表,包括(包括系统表)(单独判断某个表是否存在，要加owner条件)\nselect table_name from dba_tables;\n\n--达梦数据库-获取所有用户所属的某个表(包括系统表)的字段\nselect * from dba_tab_columns where table_name='表名';\n\n--达梦数据库-获取所有用户所属的某个表(包括系统表)的注释\nselect * from dba_tab_comments where table_name='表名';\n\n--达梦数据库-获取所有用户某个表某个字段的注释(包括系统表)\nselect * from dba_col_comments where table_name='表名' where column_name='字段名';\n\n\n\n--达梦数据库-添加字段\nalter table 表名 add 字段名 varchar(15);\n\n--达梦数据库-修改字段长度\nalter table 表名 modify 字段名 varchar(60);\n\n--达梦数据库-修改表名\nalter table 表名 rename to 新表名;\n\n--达梦数据库-修改字段名称\nalter table 表名 rename column 字段名 to 新字段名;\n\n--达梦数据库-修改表的注释\ncomment on table 表名 is '表注释内容';\n\n--达梦数据库-修改字段的注释\ncomment on column 表名.字段名 is '字段注释内容';\n\n--达梦数据库-删除表的字段\nALTER TABLE 表名 DROP 字段名 CASCADE;\n\n\n--达梦数据库-获取数据表所有字段，以逗号分隔--\nSELECT listagg(column_name,',')WITHIN GROUP(ORDER BY COLUMN_ID) FROM user_tab_cols WHERE table_name='TEST_TABLE';\n\n\n```\n\n\n\n# 数据库简单使用\n\n## 模式\n\n模式：是数据库中全体数据的逻辑结构和特征的描述，在关系型数据库中，模式的具体表现是一系列表及表与表之间的联系。\n\n-- 创建模式，名称为dmtest\n\n```sql\ncreate schema dmtest;\n# 创建模式的语句的结束标识符不是(分号;)而是回车后第二行加 /\n```\n\n## 基本表\n\n基本表：基本表就是一个关系及属性的描述，如：学生（学好，姓名，性别，班级）\n\n-- 创建数据表\n\n```\ndrop table if exists t_student_info;\n\ncreate table t_student_info(\n\nstu_no bigint,\n\nstu_name varchar2(30),\n\nstu_sex_code char(1),\n\nstu_class varchar2(20)\n\n);\n```\n\n-- 表添加注释\n\n```\ncomment on table t_student_info is '学生信息';\n```\n\n-- 列添加注释\n\n```\ncomment on column t_student_info.stu_no is '学号';\n\ncomment on column t_student_info.stu_name is '姓名';\n\ncomment on column t_student_info.stu_sex_code is '性别';\n\ncomment on column t_student_info.stu_class is '班级';\n```\n\n-- 创建数据表\n\n```\ndrop table if exists tr_sex;\n\ncreate table tr_sex(\n\nstu_sex_code char(1),\n\nstu_sex_name char(2)\n\n);\n```\n\n-- 表添加注释\n\n```\ncomment on table tr_sex is '性别维表';\n```\n\n-- 列添加注释\n\n```\ncomment on column tr_sex.stu_sex_code is '性别编码';\n\ncomment on column tr_sex.stu_sex_name is '性别名称';\n```\n\n-- 插入数据到表中\n\n```\ninsert into t_student_info(stu_no,stu_name,stu_sex_code,stu_class) values (10001,'张三','1','三年级2班');\n\ninsert into t_student_info(stu_no,stu_name,stu_sex_code,stu_class) values (10002,'李四','1','五年级3班');\n\ninsert into t_student_info(stu_no,stu_name,stu_sex_code,stu_class) values (10003,'王琳','2','二年级1班');\n\ninsert into tr_sex(stu_sex_code,stu_sex_name) values ('1','男');\n\ninsert into tr_sex(stu_sex_code,stu_sex_name) values ('2','女');\n```\n\n-- 查询表记录\n\n```\nselect * from t_student_info;\n```\n\n\n\n## 视图\n\n视图：视图是一种外模式，是建立在基础表之上的数据查询（单表或者多表关联）\n\n-- 单表创建视图\n\n```\ncreate or replace view v_t_student_info_1 as select * from t_student_info;\n```\n\n-- 查询视图数据\n\n```\nselect * from v_t_student_info_1;\n```\n\n\n\n-- 创建表关联视图\n\ncreate or replace view v_t_student_info_2 as select a.*,b.stu_sex_name from t_student_info a inner join tr_sex b on a.stu_sex_code = b.stu_sex_code;\n\n-- 查询视图数据ALTER\n\nselect * from v_t_student_info_2;\n\n\n\n## 索引\n\n索引：数据库表中一列或多列的值进行排序的一种结构，使用索引可快速访问数据库表中的特定信模式的作用\n\n-- 索引\n\n```\ncreate index idx_t_student_info on t_student_info(stu_no);\n```\n\n-- 查看SQL的执行计划\n\n```\nexplain select * from t_student_info where stu_no = 10102;\n```\n\n如下图的执行计划解析，可以看出来，已经正确使用索引，进行SQL条件过滤数据\n\n# 达梦数据库设置登录密码不过期和解除是密码锁定时间限制\n\n对于已经过期的密码需要首先去修改密码\nALTER USER \"SYSDBA\" IDENTIFIED BY \"password\";\n\n设置密码永不过期，在安全员内执行\nALTER USER SYSDBA LIMIT PASSWORD_LIFE_TIME UNLIMITED;\n\n解除锁定密码时间限制\nALTER USER SYSDBA LIMIT PASSWORD_LOCK_TIME UNLIMITED;\n","source":"_posts/达梦数据库常用操作.md","raw":"---\ntitle: 达梦数据库常用操作\ndate: 2022-11-24 17:34:42\ntags: 达梦\n---\n\n# 达梦数据库常用操作\n\n## 1、常用功能及命令\n\n<!--more-->\n\n前提，命令行登录：\n./disql SYSDBA/SYSDBA@localhost:5236 # 管理员用户 SYSDBA 的密码为 SYSDBA ，实例端口为 5236\n\n模式查询\nSQL> select distinct owner from dba_objects;\n\n获取当前模式名\nSQL> select sys_context(‘userenv’, ‘current_schema’) from dual;\n\n设置当前模式\nSQL> set schema<模式名>; #只能设置到属于自己的模式。\n\n用户查询\nSQL> select username from dba_users;\n\n查看某个模式下的所有表\nSQL> select table_name from all_tables where owner='模式名'; #注意大小写\n\n查看表结构\nSQL> desc DRAGON_DATA.ACTIVE_DEVICE;\n\n创建用户\nSQL> create user dragon identified by “123456” default tablespace MAIN;\n\n用户授权\nSQL> grant SYS_ADMIN to dragon ;\nSQL> grant DBA,RESOURCE,PUBLIC to dragon with admin option;\nSQL> grant EXECUTE on SYS.DBMS_XMLGEN to dragon;\n\n\n\n## 2、直接执行语句\n\n使用-E 参数，将在运行 DIsql 时直接执行后续的一条或多条 SQL 语句。\n\n```cpp\n[root@localhost bin]#cd /opt/dmdbms/bin\n[root@localhost bin]#./disql SYSDBA/SYSDBA -e \"SELECT * FROM DRAGON_USER;\"\n12\n```\n\n## 3、修改系统用户密码\n\n方式一\n\n```cpp\n[root@localhost bin]cd /opt/dmdbms/bin/\n[root@localhost bin]./disql SYSDBA/SYSDBA@localhost:5236\nSQL> alter user sysdba identified by \"123456\" default tablespace MAIN;\n123\n```\n\n方式二\n\n```cpp\n./disql userid=SYSDBA/SYSDBA@localhost:5236 -e \"alter user sysdba identified by \"123456\" default tablespace MAIN;\"\n1\n```\n\n## 4、执行sql脚本\n\n1）进入Disql执行sql脚本\nSQL> start /data/dm/test.sql #通过start命令执行脚本\nSQL> `/data/dm/test.sql（文件名test.sql前是反撇，通常在ESC键下方)\n\n2）启动时执行sql脚本\n如果在启动时运行，只能使用<`运行脚本>，同时需要加\\或’进行转义。\n\n```cpp\n[root@localhost bin]# ./disql SYSDBA/SYSDBA  \\`/data/dm/test.sql\n1\n```\n\n## 5、导入导出数据\n\n### 1）全量导出导入\n\n导出\n将用户名和密码均为SYSDBA，端口号为5236的数据库采用FULL方式完全导出。导出文件名为db_all.dmp，导出的日志文件名为db_all_export.log， 导出文件的路径为/data/dm。\n\n```cpp\n./dexp SYSDBA/SYSDBA FILE=db_all.dmp DIRECTORY=/data/dm LOG=db_all_export.log FULL=Y\n1\n```\n\n导入\n将逻辑备份导入到用户名和密码为SYSDBA，IP地址为192.168.1.100，端口号为60000的数据库。导入文件名为db_all.dmp， 导入的日志文件名为db_all.log，导入文件路径为/data/dm。\n\n```c\n./dimp USERID=SYSDBA/SYSDBA@192.168.1.100:60000 FILE=db_all.dmp DIRECTORY=/data/dm_bak LOG=db_all_import.log FULL=Y\n1\n```\n\n**注意：导入之前原表已存在时，默认为直接报错，需要设置TABLE_EXISTS_ACTION参数**\n语法如下：\nTABLE_EXISTS_ACTION=[SKIP | APPEND | TRUNCATE | REPLACE]\nSKIP：跳过此表。\nAPPEND：直接向现有表中导入数据\nTRUNCATE：先删除现有表中的数据，再向表中导入数据\nREPLACE：先删除现有表，再导数据\n\n### 2）指定库导入导出\n\n导出\n导出时不用FULL=Y，通过SCHEMAS指定模式，导出指定模式库。\n\n```cpp\n./dexp USERID=SYSDBA/SYSDBA FILE=db_vnap_user.dmp DIRECTORY=/data/dm LOG=db_vnap_user_export.log  SCHEMAS=VNAP_USER\n1\n```\n\n导入\n导出时可以采用FULL=Y，全部导入指定模式库，也可通过SCHEMAS指定模式，导入部分库。\n\n```cpp\n./dimp USERID=SYSDBA/SYSDBA@192.168.1.100:60000 FILE=db_vnap_user.dmp DIRECTORY=/data/dm LOG=db_all_import.log  SCHEMAS=VNAP_USER\n```\n\n\n\n# 达梦数据库常用SQL\n\n```\n--达梦数据库创建表\ncreate table TEST_TABLE(\n\tscid varchar2(10) primary key,\n\tscname varchar2(20),           \n\tscsm number(6),                  \n\tscprice number(4,2)\n);\n\n---------------------当前用户--------------------------\n--达梦数据库-获取当前用户拥有的表\nselect table_name from user_tables;\n\n--达梦数据库-获取当前用户所属的某个表的字段\nselect * from user_tab_columns where table_name='表名';\n\n--达梦数据库-获取当前用户某个表的注释\nselect * from user_tab_comments where table_name='表名';\n\n--达梦数据库-获取当前用户某个表某个字段的注释\nselect * from user_col_comments where table_name='表名' where column_name='字段名';\n\n\n---------------------所有用户(不包括系统表)--------------------------\n--达梦数据库-所有用户的表(单独判断某个表是否存在，要加owner条件)(不包括系统表)\nselect table_name from all_tables;\n\n--达梦数据库-获取所有用户所属的某个表的字段(不包括系统表)\nselect * from all_tab_columns where table_name='表名';\n\n--达梦数据库-获取所有用户所属的某个表的注释(不包括系统表)\nselect * from all_tab_comments where table_name='表名';\n\n--达梦数据库-获取所有用户某个表某个字段的注释(不包括系统表)\nselect * from all_col_comments where table_name='表名' where column_name='字段名';\n\n\n---------------------所有用户(包括系统表)--------------------------\n--达梦数据库-所有用户的表,包括(包括系统表)(单独判断某个表是否存在，要加owner条件)\nselect table_name from dba_tables;\n\n--达梦数据库-获取所有用户所属的某个表(包括系统表)的字段\nselect * from dba_tab_columns where table_name='表名';\n\n--达梦数据库-获取所有用户所属的某个表(包括系统表)的注释\nselect * from dba_tab_comments where table_name='表名';\n\n--达梦数据库-获取所有用户某个表某个字段的注释(包括系统表)\nselect * from dba_col_comments where table_name='表名' where column_name='字段名';\n\n\n\n--达梦数据库-添加字段\nalter table 表名 add 字段名 varchar(15);\n\n--达梦数据库-修改字段长度\nalter table 表名 modify 字段名 varchar(60);\n\n--达梦数据库-修改表名\nalter table 表名 rename to 新表名;\n\n--达梦数据库-修改字段名称\nalter table 表名 rename column 字段名 to 新字段名;\n\n--达梦数据库-修改表的注释\ncomment on table 表名 is '表注释内容';\n\n--达梦数据库-修改字段的注释\ncomment on column 表名.字段名 is '字段注释内容';\n\n--达梦数据库-删除表的字段\nALTER TABLE 表名 DROP 字段名 CASCADE;\n\n\n--达梦数据库-获取数据表所有字段，以逗号分隔--\nSELECT listagg(column_name,',')WITHIN GROUP(ORDER BY COLUMN_ID) FROM user_tab_cols WHERE table_name='TEST_TABLE';\n\n\n```\n\n\n\n# 数据库简单使用\n\n## 模式\n\n模式：是数据库中全体数据的逻辑结构和特征的描述，在关系型数据库中，模式的具体表现是一系列表及表与表之间的联系。\n\n-- 创建模式，名称为dmtest\n\n```sql\ncreate schema dmtest;\n# 创建模式的语句的结束标识符不是(分号;)而是回车后第二行加 /\n```\n\n## 基本表\n\n基本表：基本表就是一个关系及属性的描述，如：学生（学好，姓名，性别，班级）\n\n-- 创建数据表\n\n```\ndrop table if exists t_student_info;\n\ncreate table t_student_info(\n\nstu_no bigint,\n\nstu_name varchar2(30),\n\nstu_sex_code char(1),\n\nstu_class varchar2(20)\n\n);\n```\n\n-- 表添加注释\n\n```\ncomment on table t_student_info is '学生信息';\n```\n\n-- 列添加注释\n\n```\ncomment on column t_student_info.stu_no is '学号';\n\ncomment on column t_student_info.stu_name is '姓名';\n\ncomment on column t_student_info.stu_sex_code is '性别';\n\ncomment on column t_student_info.stu_class is '班级';\n```\n\n-- 创建数据表\n\n```\ndrop table if exists tr_sex;\n\ncreate table tr_sex(\n\nstu_sex_code char(1),\n\nstu_sex_name char(2)\n\n);\n```\n\n-- 表添加注释\n\n```\ncomment on table tr_sex is '性别维表';\n```\n\n-- 列添加注释\n\n```\ncomment on column tr_sex.stu_sex_code is '性别编码';\n\ncomment on column tr_sex.stu_sex_name is '性别名称';\n```\n\n-- 插入数据到表中\n\n```\ninsert into t_student_info(stu_no,stu_name,stu_sex_code,stu_class) values (10001,'张三','1','三年级2班');\n\ninsert into t_student_info(stu_no,stu_name,stu_sex_code,stu_class) values (10002,'李四','1','五年级3班');\n\ninsert into t_student_info(stu_no,stu_name,stu_sex_code,stu_class) values (10003,'王琳','2','二年级1班');\n\ninsert into tr_sex(stu_sex_code,stu_sex_name) values ('1','男');\n\ninsert into tr_sex(stu_sex_code,stu_sex_name) values ('2','女');\n```\n\n-- 查询表记录\n\n```\nselect * from t_student_info;\n```\n\n\n\n## 视图\n\n视图：视图是一种外模式，是建立在基础表之上的数据查询（单表或者多表关联）\n\n-- 单表创建视图\n\n```\ncreate or replace view v_t_student_info_1 as select * from t_student_info;\n```\n\n-- 查询视图数据\n\n```\nselect * from v_t_student_info_1;\n```\n\n\n\n-- 创建表关联视图\n\ncreate or replace view v_t_student_info_2 as select a.*,b.stu_sex_name from t_student_info a inner join tr_sex b on a.stu_sex_code = b.stu_sex_code;\n\n-- 查询视图数据ALTER\n\nselect * from v_t_student_info_2;\n\n\n\n## 索引\n\n索引：数据库表中一列或多列的值进行排序的一种结构，使用索引可快速访问数据库表中的特定信模式的作用\n\n-- 索引\n\n```\ncreate index idx_t_student_info on t_student_info(stu_no);\n```\n\n-- 查看SQL的执行计划\n\n```\nexplain select * from t_student_info where stu_no = 10102;\n```\n\n如下图的执行计划解析，可以看出来，已经正确使用索引，进行SQL条件过滤数据\n\n# 达梦数据库设置登录密码不过期和解除是密码锁定时间限制\n\n对于已经过期的密码需要首先去修改密码\nALTER USER \"SYSDBA\" IDENTIFIED BY \"password\";\n\n设置密码永不过期，在安全员内执行\nALTER USER SYSDBA LIMIT PASSWORD_LIFE_TIME UNLIMITED;\n\n解除锁定密码时间限制\nALTER USER SYSDBA LIMIT PASSWORD_LOCK_TIME UNLIMITED;\n","slug":"达梦数据库常用操作","published":1,"updated":"2023-01-03T06:17:51.246Z","comments":1,"layout":"post","photos":[],"link":"","_id":"clcfuykyw000l3wrs8rdpfz55","content":"<h1 id=\"达梦数据库常用操作\"><a href=\"#达梦数据库常用操作\" class=\"headerlink\" title=\"达梦数据库常用操作\"></a>达梦数据库常用操作</h1><h2 id=\"1、常用功能及命令\"><a href=\"#1、常用功能及命令\" class=\"headerlink\" title=\"1、常用功能及命令\"></a>1、常用功能及命令</h2><span id=\"more\"></span>\n\n<p>前提，命令行登录：<br>./disql SYSDBA/SYSDBA@localhost:5236 # 管理员用户 SYSDBA 的密码为 SYSDBA ，实例端口为 5236</p>\n<p>模式查询<br>SQL&gt; select distinct owner from dba_objects;</p>\n<p>获取当前模式名<br>SQL&gt; select sys_context(‘userenv’, ‘current_schema’) from dual;</p>\n<p>设置当前模式<br>SQL&gt; set schema&lt;模式名&gt;; #只能设置到属于自己的模式。</p>\n<p>用户查询<br>SQL&gt; select username from dba_users;</p>\n<p>查看某个模式下的所有表<br>SQL&gt; select table_name from all_tables where owner=’模式名’; #注意大小写</p>\n<p>查看表结构<br>SQL&gt; desc DRAGON_DATA.ACTIVE_DEVICE;</p>\n<p>创建用户<br>SQL&gt; create user dragon identified by “123456” default tablespace MAIN;</p>\n<p>用户授权<br>SQL&gt; grant SYS_ADMIN to dragon ;<br>SQL&gt; grant DBA,RESOURCE,PUBLIC to dragon with admin option;<br>SQL&gt; grant EXECUTE on SYS.DBMS_XMLGEN to dragon;</p>\n<h2 id=\"2、直接执行语句\"><a href=\"#2、直接执行语句\" class=\"headerlink\" title=\"2、直接执行语句\"></a>2、直接执行语句</h2><p>使用-E 参数，将在运行 DIsql 时直接执行后续的一条或多条 SQL 语句。</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@localhost bin]<span class=\"meta\">#cd /opt/dmdbms/bin</span></span><br><span class=\"line\">[root@localhost bin]#./disql SYSDBA/SYSDBA -e <span class=\"string\">&quot;SELECT * FROM DRAGON_USER;&quot;</span></span><br><span class=\"line\"><span class=\"number\">12</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3、修改系统用户密码\"><a href=\"#3、修改系统用户密码\" class=\"headerlink\" title=\"3、修改系统用户密码\"></a>3、修改系统用户密码</h2><p>方式一</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@localhost bin]cd /opt/dmdbms/bin/</span><br><span class=\"line\">[root@localhost bin]./disql SYSDBA/SYSDBA@localhost:<span class=\"number\">5236</span></span><br><span class=\"line\">SQL&gt; alter user sysdba identified by <span class=\"string\">&quot;123456&quot;</span> <span class=\"keyword\">default</span> tablespace MAIN;</span><br><span class=\"line\"><span class=\"number\">123</span></span><br></pre></td></tr></table></figure>\n\n<p>方式二</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./disql userid=SYSDBA/SYSDBA@localhost:<span class=\"number\">5236</span> -e <span class=\"string\">&quot;alter user sysdba identified by &quot;</span><span class=\"number\">123456</span><span class=\"string\">&quot; default tablespace MAIN;&quot;</span></span><br><span class=\"line\"><span class=\"number\">1</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"4、执行sql脚本\"><a href=\"#4、执行sql脚本\" class=\"headerlink\" title=\"4、执行sql脚本\"></a>4、执行sql脚本</h2><p>1）进入Disql执行sql脚本<br>SQL&gt; start /data/dm/test.sql #通过start命令执行脚本<br>SQL&gt; `/data/dm/test.sql（文件名test.sql前是反撇，通常在ESC键下方)</p>\n<p>2）启动时执行sql脚本<br>如果在启动时运行，只能使用&lt;`运行脚本&gt;，同时需要加\\或’进行转义。</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@localhost bin]# ./disql SYSDBA/SYSDBA  \\`/data/dm/test.sql</span><br><span class=\"line\"><span class=\"number\">1</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"5、导入导出数据\"><a href=\"#5、导入导出数据\" class=\"headerlink\" title=\"5、导入导出数据\"></a>5、导入导出数据</h2><h3 id=\"1）全量导出导入\"><a href=\"#1）全量导出导入\" class=\"headerlink\" title=\"1）全量导出导入\"></a>1）全量导出导入</h3><p>导出<br>将用户名和密码均为SYSDBA，端口号为5236的数据库采用FULL方式完全导出。导出文件名为db_all.dmp，导出的日志文件名为db_all_export.log， 导出文件的路径为/data/dm。</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./dexp SYSDBA/SYSDBA FILE=db_all.dmp DIRECTORY=/data/dm LOG=db_all_export.log FULL=Y</span><br><span class=\"line\"><span class=\"number\">1</span></span><br></pre></td></tr></table></figure>\n\n<p>导入<br>将逻辑备份导入到用户名和密码为SYSDBA，IP地址为192.168.1.100，端口号为60000的数据库。导入文件名为db_all.dmp， 导入的日志文件名为db_all.log，导入文件路径为/data/dm。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./dimp USERID=SYSDBA/SYSDBA@<span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.100</span>:<span class=\"number\">60000</span> FILE=db_all.dmp DIRECTORY=/data/dm_bak LOG=db_all_import.<span class=\"built_in\">log</span> FULL=Y</span><br><span class=\"line\"><span class=\"number\">1</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>注意：导入之前原表已存在时，默认为直接报错，需要设置TABLE_EXISTS_ACTION参数</strong><br>语法如下：<br>TABLE_EXISTS_ACTION=[SKIP | APPEND | TRUNCATE | REPLACE]<br>SKIP：跳过此表。<br>APPEND：直接向现有表中导入数据<br>TRUNCATE：先删除现有表中的数据，再向表中导入数据<br>REPLACE：先删除现有表，再导数据</p>\n<h3 id=\"2）指定库导入导出\"><a href=\"#2）指定库导入导出\" class=\"headerlink\" title=\"2）指定库导入导出\"></a>2）指定库导入导出</h3><p>导出<br>导出时不用FULL=Y，通过SCHEMAS指定模式，导出指定模式库。</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./dexp USERID=SYSDBA/SYSDBA FILE=db_vnap_user.dmp DIRECTORY=/data/dm LOG=db_vnap_user_export.log  SCHEMAS=VNAP_USER</span><br><span class=\"line\"><span class=\"number\">1</span></span><br></pre></td></tr></table></figure>\n\n<p>导入<br>导出时可以采用FULL=Y，全部导入指定模式库，也可通过SCHEMAS指定模式，导入部分库。</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./dimp USERID=SYSDBA/SYSDBA@<span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.100</span>:<span class=\"number\">60000</span> FILE=db_vnap_user.dmp DIRECTORY=/data/dm LOG=db_all_import.log  SCHEMAS=VNAP_USER</span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"达梦数据库常用SQL\"><a href=\"#达梦数据库常用SQL\" class=\"headerlink\" title=\"达梦数据库常用SQL\"></a>达梦数据库常用SQL</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">--达梦数据库创建表</span><br><span class=\"line\">create table TEST_TABLE(</span><br><span class=\"line\">\tscid varchar2(10) primary key,</span><br><span class=\"line\">\tscname varchar2(20),           </span><br><span class=\"line\">\tscsm number(6),                  </span><br><span class=\"line\">\tscprice number(4,2)</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\">---------------------当前用户--------------------------</span><br><span class=\"line\">--达梦数据库-获取当前用户拥有的表</span><br><span class=\"line\">select table_name from user_tables;</span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-获取当前用户所属的某个表的字段</span><br><span class=\"line\">select * from user_tab_columns where table_name=&#x27;表名&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-获取当前用户某个表的注释</span><br><span class=\"line\">select * from user_tab_comments where table_name=&#x27;表名&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-获取当前用户某个表某个字段的注释</span><br><span class=\"line\">select * from user_col_comments where table_name=&#x27;表名&#x27; where column_name=&#x27;字段名&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">---------------------所有用户(不包括系统表)--------------------------</span><br><span class=\"line\">--达梦数据库-所有用户的表(单独判断某个表是否存在，要加owner条件)(不包括系统表)</span><br><span class=\"line\">select table_name from all_tables;</span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-获取所有用户所属的某个表的字段(不包括系统表)</span><br><span class=\"line\">select * from all_tab_columns where table_name=&#x27;表名&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-获取所有用户所属的某个表的注释(不包括系统表)</span><br><span class=\"line\">select * from all_tab_comments where table_name=&#x27;表名&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-获取所有用户某个表某个字段的注释(不包括系统表)</span><br><span class=\"line\">select * from all_col_comments where table_name=&#x27;表名&#x27; where column_name=&#x27;字段名&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">---------------------所有用户(包括系统表)--------------------------</span><br><span class=\"line\">--达梦数据库-所有用户的表,包括(包括系统表)(单独判断某个表是否存在，要加owner条件)</span><br><span class=\"line\">select table_name from dba_tables;</span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-获取所有用户所属的某个表(包括系统表)的字段</span><br><span class=\"line\">select * from dba_tab_columns where table_name=&#x27;表名&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-获取所有用户所属的某个表(包括系统表)的注释</span><br><span class=\"line\">select * from dba_tab_comments where table_name=&#x27;表名&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-获取所有用户某个表某个字段的注释(包括系统表)</span><br><span class=\"line\">select * from dba_col_comments where table_name=&#x27;表名&#x27; where column_name=&#x27;字段名&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-添加字段</span><br><span class=\"line\">alter table 表名 add 字段名 varchar(15);</span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-修改字段长度</span><br><span class=\"line\">alter table 表名 modify 字段名 varchar(60);</span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-修改表名</span><br><span class=\"line\">alter table 表名 rename to 新表名;</span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-修改字段名称</span><br><span class=\"line\">alter table 表名 rename column 字段名 to 新字段名;</span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-修改表的注释</span><br><span class=\"line\">comment on table 表名 is &#x27;表注释内容&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-修改字段的注释</span><br><span class=\"line\">comment on column 表名.字段名 is &#x27;字段注释内容&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-删除表的字段</span><br><span class=\"line\">ALTER TABLE 表名 DROP 字段名 CASCADE;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-获取数据表所有字段，以逗号分隔--</span><br><span class=\"line\">SELECT listagg(column_name,&#x27;,&#x27;)WITHIN GROUP(ORDER BY COLUMN_ID) FROM user_tab_cols WHERE table_name=&#x27;TEST_TABLE&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"数据库简单使用\"><a href=\"#数据库简单使用\" class=\"headerlink\" title=\"数据库简单使用\"></a>数据库简单使用</h1><h2 id=\"模式\"><a href=\"#模式\" class=\"headerlink\" title=\"模式\"></a>模式</h2><p>模式：是数据库中全体数据的逻辑结构和特征的描述，在关系型数据库中，模式的具体表现是一系列表及表与表之间的联系。</p>\n<p>– 创建模式，名称为dmtest</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">create</span> schema dmtest;</span><br><span class=\"line\"># 创建模式的语句的结束标识符不是(分号;)而是回车后第二行加 <span class=\"operator\">/</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"基本表\"><a href=\"#基本表\" class=\"headerlink\" title=\"基本表\"></a>基本表</h2><p>基本表：基本表就是一个关系及属性的描述，如：学生（学好，姓名，性别，班级）</p>\n<p>– 创建数据表</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">drop table if exists t_student_info;</span><br><span class=\"line\"></span><br><span class=\"line\">create table t_student_info(</span><br><span class=\"line\"></span><br><span class=\"line\">stu_no bigint,</span><br><span class=\"line\"></span><br><span class=\"line\">stu_name varchar2(30),</span><br><span class=\"line\"></span><br><span class=\"line\">stu_sex_code char(1),</span><br><span class=\"line\"></span><br><span class=\"line\">stu_class varchar2(20)</span><br><span class=\"line\"></span><br><span class=\"line\">);</span><br></pre></td></tr></table></figure>\n\n<p>– 表添加注释</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">comment on table t_student_info is &#x27;学生信息&#x27;;</span><br></pre></td></tr></table></figure>\n\n<p>– 列添加注释</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">comment on column t_student_info.stu_no is &#x27;学号&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">comment on column t_student_info.stu_name is &#x27;姓名&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">comment on column t_student_info.stu_sex_code is &#x27;性别&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">comment on column t_student_info.stu_class is &#x27;班级&#x27;;</span><br></pre></td></tr></table></figure>\n\n<p>– 创建数据表</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">drop table if exists tr_sex;</span><br><span class=\"line\"></span><br><span class=\"line\">create table tr_sex(</span><br><span class=\"line\"></span><br><span class=\"line\">stu_sex_code char(1),</span><br><span class=\"line\"></span><br><span class=\"line\">stu_sex_name char(2)</span><br><span class=\"line\"></span><br><span class=\"line\">);</span><br></pre></td></tr></table></figure>\n\n<p>– 表添加注释</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">comment on table tr_sex is &#x27;性别维表&#x27;;</span><br></pre></td></tr></table></figure>\n\n<p>– 列添加注释</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">comment on column tr_sex.stu_sex_code is &#x27;性别编码&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">comment on column tr_sex.stu_sex_name is &#x27;性别名称&#x27;;</span><br></pre></td></tr></table></figure>\n\n<p>– 插入数据到表中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">insert into t_student_info(stu_no,stu_name,stu_sex_code,stu_class) values (10001,&#x27;张三&#x27;,&#x27;1&#x27;,&#x27;三年级2班&#x27;);</span><br><span class=\"line\"></span><br><span class=\"line\">insert into t_student_info(stu_no,stu_name,stu_sex_code,stu_class) values (10002,&#x27;李四&#x27;,&#x27;1&#x27;,&#x27;五年级3班&#x27;);</span><br><span class=\"line\"></span><br><span class=\"line\">insert into t_student_info(stu_no,stu_name,stu_sex_code,stu_class) values (10003,&#x27;王琳&#x27;,&#x27;2&#x27;,&#x27;二年级1班&#x27;);</span><br><span class=\"line\"></span><br><span class=\"line\">insert into tr_sex(stu_sex_code,stu_sex_name) values (&#x27;1&#x27;,&#x27;男&#x27;);</span><br><span class=\"line\"></span><br><span class=\"line\">insert into tr_sex(stu_sex_code,stu_sex_name) values (&#x27;2&#x27;,&#x27;女&#x27;);</span><br></pre></td></tr></table></figure>\n\n<p>– 查询表记录</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select * from t_student_info;</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"视图\"><a href=\"#视图\" class=\"headerlink\" title=\"视图\"></a>视图</h2><p>视图：视图是一种外模式，是建立在基础表之上的数据查询（单表或者多表关联）</p>\n<p>– 单表创建视图</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">create or replace view v_t_student_info_1 as select * from t_student_info;</span><br></pre></td></tr></table></figure>\n\n<p>– 查询视图数据</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select * from v_t_student_info_1;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>– 创建表关联视图</p>\n<p>create or replace view v_t_student_info_2 as select a.*,b.stu_sex_name from t_student_info a inner join tr_sex b on a.stu_sex_code = b.stu_sex_code;</p>\n<p>– 查询视图数据ALTER</p>\n<p>select * from v_t_student_info_2;</p>\n<h2 id=\"索引\"><a href=\"#索引\" class=\"headerlink\" title=\"索引\"></a>索引</h2><p>索引：数据库表中一列或多列的值进行排序的一种结构，使用索引可快速访问数据库表中的特定信模式的作用</p>\n<p>– 索引</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">create index idx_t_student_info on t_student_info(stu_no);</span><br></pre></td></tr></table></figure>\n\n<p>– 查看SQL的执行计划</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">explain select * from t_student_info where stu_no = 10102;</span><br></pre></td></tr></table></figure>\n\n<p>如下图的执行计划解析，可以看出来，已经正确使用索引，进行SQL条件过滤数据</p>\n<h1 id=\"达梦数据库设置登录密码不过期和解除是密码锁定时间限制\"><a href=\"#达梦数据库设置登录密码不过期和解除是密码锁定时间限制\" class=\"headerlink\" title=\"达梦数据库设置登录密码不过期和解除是密码锁定时间限制\"></a>达梦数据库设置登录密码不过期和解除是密码锁定时间限制</h1><p>对于已经过期的密码需要首先去修改密码<br>ALTER USER “SYSDBA” IDENTIFIED BY “password”;</p>\n<p>设置密码永不过期，在安全员内执行<br>ALTER USER SYSDBA LIMIT PASSWORD_LIFE_TIME UNLIMITED;</p>\n<p>解除锁定密码时间限制<br>ALTER USER SYSDBA LIMIT PASSWORD_LOCK_TIME UNLIMITED;</p>\n","site":{"data":{}},"excerpt":"<h1 id=\"达梦数据库常用操作\"><a href=\"#达梦数据库常用操作\" class=\"headerlink\" title=\"达梦数据库常用操作\"></a>达梦数据库常用操作</h1><h2 id=\"1、常用功能及命令\"><a href=\"#1、常用功能及命令\" class=\"headerlink\" title=\"1、常用功能及命令\"></a>1、常用功能及命令</h2>","more":"<p>前提，命令行登录：<br>./disql SYSDBA/SYSDBA@localhost:5236 # 管理员用户 SYSDBA 的密码为 SYSDBA ，实例端口为 5236</p>\n<p>模式查询<br>SQL&gt; select distinct owner from dba_objects;</p>\n<p>获取当前模式名<br>SQL&gt; select sys_context(‘userenv’, ‘current_schema’) from dual;</p>\n<p>设置当前模式<br>SQL&gt; set schema&lt;模式名&gt;; #只能设置到属于自己的模式。</p>\n<p>用户查询<br>SQL&gt; select username from dba_users;</p>\n<p>查看某个模式下的所有表<br>SQL&gt; select table_name from all_tables where owner=’模式名’; #注意大小写</p>\n<p>查看表结构<br>SQL&gt; desc DRAGON_DATA.ACTIVE_DEVICE;</p>\n<p>创建用户<br>SQL&gt; create user dragon identified by “123456” default tablespace MAIN;</p>\n<p>用户授权<br>SQL&gt; grant SYS_ADMIN to dragon ;<br>SQL&gt; grant DBA,RESOURCE,PUBLIC to dragon with admin option;<br>SQL&gt; grant EXECUTE on SYS.DBMS_XMLGEN to dragon;</p>\n<h2 id=\"2、直接执行语句\"><a href=\"#2、直接执行语句\" class=\"headerlink\" title=\"2、直接执行语句\"></a>2、直接执行语句</h2><p>使用-E 参数，将在运行 DIsql 时直接执行后续的一条或多条 SQL 语句。</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@localhost bin]<span class=\"meta\">#cd /opt/dmdbms/bin</span></span><br><span class=\"line\">[root@localhost bin]#./disql SYSDBA/SYSDBA -e <span class=\"string\">&quot;SELECT * FROM DRAGON_USER;&quot;</span></span><br><span class=\"line\"><span class=\"number\">12</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3、修改系统用户密码\"><a href=\"#3、修改系统用户密码\" class=\"headerlink\" title=\"3、修改系统用户密码\"></a>3、修改系统用户密码</h2><p>方式一</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@localhost bin]cd /opt/dmdbms/bin/</span><br><span class=\"line\">[root@localhost bin]./disql SYSDBA/SYSDBA@localhost:<span class=\"number\">5236</span></span><br><span class=\"line\">SQL&gt; alter user sysdba identified by <span class=\"string\">&quot;123456&quot;</span> <span class=\"keyword\">default</span> tablespace MAIN;</span><br><span class=\"line\"><span class=\"number\">123</span></span><br></pre></td></tr></table></figure>\n\n<p>方式二</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./disql userid=SYSDBA/SYSDBA@localhost:<span class=\"number\">5236</span> -e <span class=\"string\">&quot;alter user sysdba identified by &quot;</span><span class=\"number\">123456</span><span class=\"string\">&quot; default tablespace MAIN;&quot;</span></span><br><span class=\"line\"><span class=\"number\">1</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"4、执行sql脚本\"><a href=\"#4、执行sql脚本\" class=\"headerlink\" title=\"4、执行sql脚本\"></a>4、执行sql脚本</h2><p>1）进入Disql执行sql脚本<br>SQL&gt; start /data/dm/test.sql #通过start命令执行脚本<br>SQL&gt; `/data/dm/test.sql（文件名test.sql前是反撇，通常在ESC键下方)</p>\n<p>2）启动时执行sql脚本<br>如果在启动时运行，只能使用&lt;`运行脚本&gt;，同时需要加\\或’进行转义。</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@localhost bin]# ./disql SYSDBA/SYSDBA  \\`/data/dm/test.sql</span><br><span class=\"line\"><span class=\"number\">1</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"5、导入导出数据\"><a href=\"#5、导入导出数据\" class=\"headerlink\" title=\"5、导入导出数据\"></a>5、导入导出数据</h2><h3 id=\"1）全量导出导入\"><a href=\"#1）全量导出导入\" class=\"headerlink\" title=\"1）全量导出导入\"></a>1）全量导出导入</h3><p>导出<br>将用户名和密码均为SYSDBA，端口号为5236的数据库采用FULL方式完全导出。导出文件名为db_all.dmp，导出的日志文件名为db_all_export.log， 导出文件的路径为/data/dm。</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./dexp SYSDBA/SYSDBA FILE=db_all.dmp DIRECTORY=/data/dm LOG=db_all_export.log FULL=Y</span><br><span class=\"line\"><span class=\"number\">1</span></span><br></pre></td></tr></table></figure>\n\n<p>导入<br>将逻辑备份导入到用户名和密码为SYSDBA，IP地址为192.168.1.100，端口号为60000的数据库。导入文件名为db_all.dmp， 导入的日志文件名为db_all.log，导入文件路径为/data/dm。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./dimp USERID=SYSDBA/SYSDBA@<span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.100</span>:<span class=\"number\">60000</span> FILE=db_all.dmp DIRECTORY=/data/dm_bak LOG=db_all_import.<span class=\"built_in\">log</span> FULL=Y</span><br><span class=\"line\"><span class=\"number\">1</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>注意：导入之前原表已存在时，默认为直接报错，需要设置TABLE_EXISTS_ACTION参数</strong><br>语法如下：<br>TABLE_EXISTS_ACTION=[SKIP | APPEND | TRUNCATE | REPLACE]<br>SKIP：跳过此表。<br>APPEND：直接向现有表中导入数据<br>TRUNCATE：先删除现有表中的数据，再向表中导入数据<br>REPLACE：先删除现有表，再导数据</p>\n<h3 id=\"2）指定库导入导出\"><a href=\"#2）指定库导入导出\" class=\"headerlink\" title=\"2）指定库导入导出\"></a>2）指定库导入导出</h3><p>导出<br>导出时不用FULL=Y，通过SCHEMAS指定模式，导出指定模式库。</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./dexp USERID=SYSDBA/SYSDBA FILE=db_vnap_user.dmp DIRECTORY=/data/dm LOG=db_vnap_user_export.log  SCHEMAS=VNAP_USER</span><br><span class=\"line\"><span class=\"number\">1</span></span><br></pre></td></tr></table></figure>\n\n<p>导入<br>导出时可以采用FULL=Y，全部导入指定模式库，也可通过SCHEMAS指定模式，导入部分库。</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./dimp USERID=SYSDBA/SYSDBA@<span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.100</span>:<span class=\"number\">60000</span> FILE=db_vnap_user.dmp DIRECTORY=/data/dm LOG=db_all_import.log  SCHEMAS=VNAP_USER</span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"达梦数据库常用SQL\"><a href=\"#达梦数据库常用SQL\" class=\"headerlink\" title=\"达梦数据库常用SQL\"></a>达梦数据库常用SQL</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">--达梦数据库创建表</span><br><span class=\"line\">create table TEST_TABLE(</span><br><span class=\"line\">\tscid varchar2(10) primary key,</span><br><span class=\"line\">\tscname varchar2(20),           </span><br><span class=\"line\">\tscsm number(6),                  </span><br><span class=\"line\">\tscprice number(4,2)</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\">---------------------当前用户--------------------------</span><br><span class=\"line\">--达梦数据库-获取当前用户拥有的表</span><br><span class=\"line\">select table_name from user_tables;</span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-获取当前用户所属的某个表的字段</span><br><span class=\"line\">select * from user_tab_columns where table_name=&#x27;表名&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-获取当前用户某个表的注释</span><br><span class=\"line\">select * from user_tab_comments where table_name=&#x27;表名&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-获取当前用户某个表某个字段的注释</span><br><span class=\"line\">select * from user_col_comments where table_name=&#x27;表名&#x27; where column_name=&#x27;字段名&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">---------------------所有用户(不包括系统表)--------------------------</span><br><span class=\"line\">--达梦数据库-所有用户的表(单独判断某个表是否存在，要加owner条件)(不包括系统表)</span><br><span class=\"line\">select table_name from all_tables;</span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-获取所有用户所属的某个表的字段(不包括系统表)</span><br><span class=\"line\">select * from all_tab_columns where table_name=&#x27;表名&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-获取所有用户所属的某个表的注释(不包括系统表)</span><br><span class=\"line\">select * from all_tab_comments where table_name=&#x27;表名&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-获取所有用户某个表某个字段的注释(不包括系统表)</span><br><span class=\"line\">select * from all_col_comments where table_name=&#x27;表名&#x27; where column_name=&#x27;字段名&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">---------------------所有用户(包括系统表)--------------------------</span><br><span class=\"line\">--达梦数据库-所有用户的表,包括(包括系统表)(单独判断某个表是否存在，要加owner条件)</span><br><span class=\"line\">select table_name from dba_tables;</span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-获取所有用户所属的某个表(包括系统表)的字段</span><br><span class=\"line\">select * from dba_tab_columns where table_name=&#x27;表名&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-获取所有用户所属的某个表(包括系统表)的注释</span><br><span class=\"line\">select * from dba_tab_comments where table_name=&#x27;表名&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-获取所有用户某个表某个字段的注释(包括系统表)</span><br><span class=\"line\">select * from dba_col_comments where table_name=&#x27;表名&#x27; where column_name=&#x27;字段名&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-添加字段</span><br><span class=\"line\">alter table 表名 add 字段名 varchar(15);</span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-修改字段长度</span><br><span class=\"line\">alter table 表名 modify 字段名 varchar(60);</span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-修改表名</span><br><span class=\"line\">alter table 表名 rename to 新表名;</span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-修改字段名称</span><br><span class=\"line\">alter table 表名 rename column 字段名 to 新字段名;</span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-修改表的注释</span><br><span class=\"line\">comment on table 表名 is &#x27;表注释内容&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-修改字段的注释</span><br><span class=\"line\">comment on column 表名.字段名 is &#x27;字段注释内容&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-删除表的字段</span><br><span class=\"line\">ALTER TABLE 表名 DROP 字段名 CASCADE;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">--达梦数据库-获取数据表所有字段，以逗号分隔--</span><br><span class=\"line\">SELECT listagg(column_name,&#x27;,&#x27;)WITHIN GROUP(ORDER BY COLUMN_ID) FROM user_tab_cols WHERE table_name=&#x27;TEST_TABLE&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"数据库简单使用\"><a href=\"#数据库简单使用\" class=\"headerlink\" title=\"数据库简单使用\"></a>数据库简单使用</h1><h2 id=\"模式\"><a href=\"#模式\" class=\"headerlink\" title=\"模式\"></a>模式</h2><p>模式：是数据库中全体数据的逻辑结构和特征的描述，在关系型数据库中，模式的具体表现是一系列表及表与表之间的联系。</p>\n<p>– 创建模式，名称为dmtest</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">create</span> schema dmtest;</span><br><span class=\"line\"># 创建模式的语句的结束标识符不是(分号;)而是回车后第二行加 <span class=\"operator\">/</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"基本表\"><a href=\"#基本表\" class=\"headerlink\" title=\"基本表\"></a>基本表</h2><p>基本表：基本表就是一个关系及属性的描述，如：学生（学好，姓名，性别，班级）</p>\n<p>– 创建数据表</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">drop table if exists t_student_info;</span><br><span class=\"line\"></span><br><span class=\"line\">create table t_student_info(</span><br><span class=\"line\"></span><br><span class=\"line\">stu_no bigint,</span><br><span class=\"line\"></span><br><span class=\"line\">stu_name varchar2(30),</span><br><span class=\"line\"></span><br><span class=\"line\">stu_sex_code char(1),</span><br><span class=\"line\"></span><br><span class=\"line\">stu_class varchar2(20)</span><br><span class=\"line\"></span><br><span class=\"line\">);</span><br></pre></td></tr></table></figure>\n\n<p>– 表添加注释</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">comment on table t_student_info is &#x27;学生信息&#x27;;</span><br></pre></td></tr></table></figure>\n\n<p>– 列添加注释</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">comment on column t_student_info.stu_no is &#x27;学号&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">comment on column t_student_info.stu_name is &#x27;姓名&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">comment on column t_student_info.stu_sex_code is &#x27;性别&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">comment on column t_student_info.stu_class is &#x27;班级&#x27;;</span><br></pre></td></tr></table></figure>\n\n<p>– 创建数据表</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">drop table if exists tr_sex;</span><br><span class=\"line\"></span><br><span class=\"line\">create table tr_sex(</span><br><span class=\"line\"></span><br><span class=\"line\">stu_sex_code char(1),</span><br><span class=\"line\"></span><br><span class=\"line\">stu_sex_name char(2)</span><br><span class=\"line\"></span><br><span class=\"line\">);</span><br></pre></td></tr></table></figure>\n\n<p>– 表添加注释</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">comment on table tr_sex is &#x27;性别维表&#x27;;</span><br></pre></td></tr></table></figure>\n\n<p>– 列添加注释</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">comment on column tr_sex.stu_sex_code is &#x27;性别编码&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">comment on column tr_sex.stu_sex_name is &#x27;性别名称&#x27;;</span><br></pre></td></tr></table></figure>\n\n<p>– 插入数据到表中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">insert into t_student_info(stu_no,stu_name,stu_sex_code,stu_class) values (10001,&#x27;张三&#x27;,&#x27;1&#x27;,&#x27;三年级2班&#x27;);</span><br><span class=\"line\"></span><br><span class=\"line\">insert into t_student_info(stu_no,stu_name,stu_sex_code,stu_class) values (10002,&#x27;李四&#x27;,&#x27;1&#x27;,&#x27;五年级3班&#x27;);</span><br><span class=\"line\"></span><br><span class=\"line\">insert into t_student_info(stu_no,stu_name,stu_sex_code,stu_class) values (10003,&#x27;王琳&#x27;,&#x27;2&#x27;,&#x27;二年级1班&#x27;);</span><br><span class=\"line\"></span><br><span class=\"line\">insert into tr_sex(stu_sex_code,stu_sex_name) values (&#x27;1&#x27;,&#x27;男&#x27;);</span><br><span class=\"line\"></span><br><span class=\"line\">insert into tr_sex(stu_sex_code,stu_sex_name) values (&#x27;2&#x27;,&#x27;女&#x27;);</span><br></pre></td></tr></table></figure>\n\n<p>– 查询表记录</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select * from t_student_info;</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"视图\"><a href=\"#视图\" class=\"headerlink\" title=\"视图\"></a>视图</h2><p>视图：视图是一种外模式，是建立在基础表之上的数据查询（单表或者多表关联）</p>\n<p>– 单表创建视图</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">create or replace view v_t_student_info_1 as select * from t_student_info;</span><br></pre></td></tr></table></figure>\n\n<p>– 查询视图数据</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select * from v_t_student_info_1;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>– 创建表关联视图</p>\n<p>create or replace view v_t_student_info_2 as select a.*,b.stu_sex_name from t_student_info a inner join tr_sex b on a.stu_sex_code = b.stu_sex_code;</p>\n<p>– 查询视图数据ALTER</p>\n<p>select * from v_t_student_info_2;</p>\n<h2 id=\"索引\"><a href=\"#索引\" class=\"headerlink\" title=\"索引\"></a>索引</h2><p>索引：数据库表中一列或多列的值进行排序的一种结构，使用索引可快速访问数据库表中的特定信模式的作用</p>\n<p>– 索引</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">create index idx_t_student_info on t_student_info(stu_no);</span><br></pre></td></tr></table></figure>\n\n<p>– 查看SQL的执行计划</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">explain select * from t_student_info where stu_no = 10102;</span><br></pre></td></tr></table></figure>\n\n<p>如下图的执行计划解析，可以看出来，已经正确使用索引，进行SQL条件过滤数据</p>\n<h1 id=\"达梦数据库设置登录密码不过期和解除是密码锁定时间限制\"><a href=\"#达梦数据库设置登录密码不过期和解除是密码锁定时间限制\" class=\"headerlink\" title=\"达梦数据库设置登录密码不过期和解除是密码锁定时间限制\"></a>达梦数据库设置登录密码不过期和解除是密码锁定时间限制</h1><p>对于已经过期的密码需要首先去修改密码<br>ALTER USER “SYSDBA” IDENTIFIED BY “password”;</p>\n<p>设置密码永不过期，在安全员内执行<br>ALTER USER SYSDBA LIMIT PASSWORD_LIFE_TIME UNLIMITED;</p>\n<p>解除锁定密码时间限制<br>ALTER USER SYSDBA LIMIT PASSWORD_LOCK_TIME UNLIMITED;</p>"}],"PostAsset":[],"PostCategory":[],"PostTag":[{"post_id":"clcfuykye00003wrs3alxge71","tag_id":"clcfuykyk00023wrs4abs2oj3","_id":"clcfuykyp00073wrsdsq9b5rd"},{"post_id":"clcfuykyj00013wrs2gxph6zu","tag_id":"clcfuykyo00063wrs14w239e6","_id":"clcfuykys000c3wrsgeuu7tx0"},{"post_id":"clcfuykym00033wrsbuf6de01","tag_id":"clcfuykyk00023wrs4abs2oj3","_id":"clcfuykyu000g3wrse0yf594s"},{"post_id":"clcfuykyn00043wrs3vxsfox8","tag_id":"clcfuykyt000e3wrsao9t8rzk","_id":"clcfuykyv000k3wrs17p6fprn"},{"post_id":"clcfuykyn00053wrsd1uzhrtr","tag_id":"clcfuykyv000i3wrsf4anakd7","_id":"clcfuykyw000n3wrs59zy3gwj"},{"post_id":"clcfuykyp00083wrs5ra94g2h","tag_id":"clcfuykyw000m3wrs76kudhf2","_id":"clcfuykyx000p3wrsfenubf28"},{"post_id":"clcfuykyp00093wrsh4otc2j6","tag_id":"clcfuykyw000o3wrsdmny6dsj","_id":"clcfuykyx000r3wrsh6j6dbhk"},{"post_id":"clcfuykyr000b3wrs3e3i918y","tag_id":"clcfuykyx000q3wrsa8c4baoc","_id":"clcfuykyx000t3wrs0t7p863w"},{"post_id":"clcfuykys000d3wrs2e6bhzst","tag_id":"clcfuykyx000s3wrshkfg92r6","_id":"clcfuykyy000v3wrsbz701104"},{"post_id":"clcfuykyt000f3wrs0mg731oq","tag_id":"clcfuykyx000u3wrs71693kto","_id":"clcfuykyy000x3wrsesfu5daa"},{"post_id":"clcfuykyu000h3wrs5jnvft3a","tag_id":"clcfuykyx000s3wrshkfg92r6","_id":"clcfuykyz000z3wrsbabjau5a"},{"post_id":"clcfuykyv000j3wrs5utf7w9m","tag_id":"clcfuykyy000y3wrseqk0cjji","_id":"clcfuykyz00113wrsdcgkgu8e"},{"post_id":"clcfuykyw000l3wrs8rdpfz55","tag_id":"clcfuykyx000s3wrshkfg92r6","_id":"clcfuykyz00123wrs28vpcrfy"}],"Tag":[{"name":"Zookeeper","_id":"clcfuykyk00023wrs4abs2oj3"},{"name":"Kubesphere","_id":"clcfuykyo00063wrs14w239e6"},{"name":"harbor部署","_id":"clcfuykyt000e3wrsao9t8rzk"},{"name":"ingress-nginx","_id":"clcfuykyv000i3wrsf4anakd7"},{"name":"kubesphere","_id":"clcfuykyw000m3wrs76kudhf2"},{"name":"lvm扩容","_id":"clcfuykyw000o3wrsdmny6dsj"},{"name":"registry部署","_id":"clcfuykyx000q3wrsa8c4baoc"},{"name":"达梦","_id":"clcfuykyx000s3wrshkfg92r6"},{"name":"mysql","_id":"clcfuykyx000u3wrs71693kto"},{"name":"postgres","_id":"clcfuykyy000y3wrseqk0cjji"}]}}